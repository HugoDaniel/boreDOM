<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>boreDOM Palette Test</title>
    <style>
      /* Global Variables - Shared across components */
      :root {
        --bg-color: #ffffff;
        --text-color: #333333;
        --accent-color: #3b82f6; /* Blue */
      }
      
      /* Theme Classes */
      body.dark-mode {
        --bg-color: #1f2937;
        --text-color: #f3f4f6;
        --accent-color: #ef4444; /* Red */
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: sans-serif;
        padding: 2rem;
        transition: background-color 0.2s;
      }
    </style>

    <!-- COMPONENT 1: Theme Switcher -->
    <style data-component="theme-switcher">
      @layer components.theme-switcher {
        theme-switcher .container {
          display: flex;
          gap: 1rem;
          margin-bottom: 2rem;
          padding: 1rem;
          border: 1px solid var(--text-color);
          border-radius: 8px;
          align-items: center;
        }
        theme-switcher button {
          padding: 0.5rem 1rem;
          cursor: pointer;
          border: 3px solid green; 
          background: var(--bg-color);
          color: var(--text-color);
        }
        theme-switcher .debug {
          margin-left: auto;
          font-family: monospace;
          font-size: 0.9rem;
        }
      }
    </style>

    <!-- COMPONENT 2: Display Card -->
    <style data-component="display-card">
      @layer components.display-card {
        display-card .card {
          padding: 2rem;
          border-radius: 12px;
          background-color: var(--accent-color);
          color: white;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        display-card h2 { margin: 0; }
        display-card p { opacity: 0.9; }
        display-card code {
          background: rgba(0,0,0,0.2);
          padding: 0.2rem 0.4rem;
          border-radius: 4px;
        }
        
        display-card button {
          margin-top: 1rem;
          border: none;
          padding: 0.5rem 1rem;
          border-radius: 4px;
          background: rgba(255,255,255,0.2);
          color: white;
        }
      }
    </style>
  </head>

  <body>
    <script id="initial-state" type="application/json">
      { "theme": "light", "activeColor": "..." }
    </script>

    <h1>Palette & Isolation Test</h1>
    
    <theme-switcher></theme-switcher>
    <display-card></display-card>

    <!-- TEMPLATES -->
    <template data-component="theme-switcher">
      <div class="container">
        <strong>Choose Theme:</strong>
        <button data-dispatch="setLight">Light (Blue)</button>
        <button data-dispatch="setDark">Dark (Red)</button>
        <span class="debug" data-ref="debugInfo">Current Accent: <strong data-text="state.activeColor"></strong></span>
      </div>
    </template>

    <template data-component="display-card">
      <div class="card">
        <h2 data-text="state.theme + ' Mode'"></h2>
        <p>I am colored by <code>var(--accent-color)</code>.</p>
        <p>Computed Value: <code data-text="state.activeColor"></code></p>
        <button>I am an isolated button</button>
      </div>
    </template>

    <!-- LOGIC -->
    <script type="text/boredom" data-component="theme-switcher">
      export default ({ on, onUpdate }) => {
        on("setLight", ({ state }) => { state.theme = "light"; });
        on("setDark", ({ state }) => { state.theme = "dark"; });

        onUpdate(({ state }) => {
          // 1. Apply Theme
          const cls = state.theme === "dark" ? "dark-mode" : "";
          if (document.body.className !== cls) {
             document.body.className = cls;
          }

          // 2. Read Computed Style (Async to allow paint/calc)
          requestAnimationFrame(() => {
             const color = getComputedStyle(document.body).getPropertyValue('--accent-color').trim();
             // Only update if changed to avoid infinite loops
             if (state.activeColor !== color) {
                 state.activeColor = color;
             }
          });
        });
      };
    </script>

    <!-- display-card intentionally has no script -->

    <!-- RUNTIME -->
    <script src="./boreDOM.js" data-state="#initial-state"></script>
  </body>
</html>
