#!/usr/bin/env node
"use strict";
var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
  // If the importer is in node compatibility mode or this is not an ESM
  // file that has been converted to a CommonJS file using a Babel-
  // compatible transform (i.e. "__esModule" has not been set), then set
  // "default" to the CommonJS "module.exports" for node compatibility.
  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
  mod
));
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// boreDOMCLI/generated_cli.js
var generated_cli_exports = {};
__export(generated_cli_exports, {
  BUILD_DIR: () => BUILD_DIR,
  build: () => build,
  buildRelativeServePath: () => buildRelativeServePath,
  copyBoreDOM: () => copyBoreDOM,
  getServePaths: () => getServePaths,
  normalizeServePath: () => normalizeServePath,
  options: () => options,
  processComponents: () => processComponents,
  setServePaths: () => setServePaths,
  updateIndex: () => updateIndex
});
module.exports = __toCommonJS(generated_cli_exports);
var import_fs_extra = __toESM(require("fs-extra"));
var import_mime_types = __toESM(require("mime-types"));
var import_path = __toESM(require("path"));
var glob = __toESM(require("glob"));
var cheerio = __toESM(require("cheerio"));
var import_commander = require("commander");
var import_http = __toESM(require("http"));
var import_finalhandler = __toESM(require("finalhandler"));
var import_js_beautify = __toESM(require("js-beautify"));
var import_chokidar = __toESM(require("chokidar"));
var import_serve_handler = __toESM(require("serve-handler"));
var boredom = `
Ly8gc3JjL2RvbS50cwp2YXIgZHluYW1pY0ltcG9ydFNjcmlwdHMgPSBhc3luYyAobmFtZXMpID0+IHsKICBjb25zdCByZXN1bHQgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGZvciAobGV0IGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyArK2kpIHsKICAgIGNvbnN0IHNjcmlwdHMgPSBBcnJheS5mcm9tKHF1ZXJ5QWxsKCJzY3JpcHRbc3JjXSIpKTsKICAgIGNvbnN0IG1hdGNoaW5nU2NyaXB0ID0gc2NyaXB0cy5maW5kKChzY3JpcHQpID0+IHsKICAgICAgY29uc3Qgc3JjID0gc2NyaXB0LmdldEF0dHJpYnV0ZSgic3JjIikgPz8gIiI7CiAgICAgIGNvbnN0IGZpbGVuYW1lID0gc3JjLnNwbGl0KCIvIikucG9wKCkgPz8gIiI7CiAgICAgIHJldHVybiBmaWxlbmFtZSA9PT0gYCR7bmFtZXNbaV19LmpzYDsKICAgIH0pOwogICAgY29uc3Qgc2NyaXB0TG9jYXRpb24gPSBtYXRjaGluZ1NjcmlwdD8uZ2V0QXR0cmlidXRlKCJzcmMiKTsKICAgIGxldCBmID0gbnVsbDsKICAgIGlmIChzY3JpcHRMb2NhdGlvbikgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IG1vZHVsZVVybCA9IG5ldyBVUkwoc2NyaXB0TG9jYXRpb24sIGRvY3VtZW50LmJhc2VVUkkpLmhyZWY7CiAgICAgICAgY29uc3QgZXhwb3J0cyA9IGF3YWl0IGltcG9ydChtb2R1bGVVcmwpOwogICAgICAgIGZvciAoY29uc3QgZXhwb3J0ZWQgb2YgT2JqZWN0LmtleXMoZXhwb3J0cykpIHsKICAgICAgICAgIGYgPSBleHBvcnRzW2V4cG9ydGVkXTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICByZXN1bHQuc2V0KG5hbWVzW2ldLCBmKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFVuYWJsZSB0byBpbXBvcnQgIiR7c2NyaXB0TG9jYXRpb259ImAsIGUpOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn07CnZhciBzZWFyY2hGb3JDb21wb25lbnRzID0gKCkgPT4gewogIHJldHVybiBBcnJheS5mcm9tKHF1ZXJ5QWxsKCJ0ZW1wbGF0ZVtkYXRhLWNvbXBvbmVudF0iKSkuZmlsdGVyKChlbGVtKSA9PiBlbGVtIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpLm1hcCgodCkgPT4gewogICAgY29uc3QgcmVzdWx0ID0gewogICAgICBuYW1lOiAiIiwKICAgICAgYXR0cmlidXRlczogW10KICAgIH07CiAgICBmb3IgKGNvbnN0IGF0dHJpYnV0ZSBpbiB0LmRhdGFzZXQpIHsKICAgICAgaWYgKGF0dHJpYnV0ZSA9PT0gImNvbXBvbmVudCIpIHsKICAgICAgICByZXN1bHQubmFtZSA9IHQuZGF0YXNldFthdHRyaWJ1dGVdID8/ICIiOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5hdHRyaWJ1dGVzLnB1c2goWwogICAgICAgICAgZGVjYW1lbGl6ZShhdHRyaWJ1dGUpLAogICAgICAgICAgdC5kYXRhc2V0W2F0dHJpYnV0ZV0gPz8gIiIKICAgICAgICBdKTsKICAgICAgfQogICAgfQogICAgaWYgKHJlc3VsdC5uYW1lID09PSAiIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgYEEgPHRlbXBsYXRlPiB3YXMgZm91bmQgd2l0aCBhbiBpbnZhbGlkIGRhdGEtY29tcG9uZW50OiAiJHt0LmRhdGFzZXQuY29tcG9uZW50fSJgCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0pLm1hcCgoeyBuYW1lLCBhdHRyaWJ1dGVzIH0pID0+IHsKICAgIGNvbXBvbmVudChuYW1lLCB7IGF0dHJpYnV0ZXMgfSk7CiAgICByZXR1cm4gbmFtZTsKICB9KTsKfTsKdmFyIGNyZWF0ZUNvbXBvbmVudCA9IChuYW1lLCB1cGRhdGUpID0+IHsKICBjb25zdCBlbGVtZW50ID0gY3JlYXRlKG5hbWUpOwogIGlmICghaXNCb3JlZChlbGVtZW50KSkgewogICAgY29uc3QgZXJyb3IgPSBgVGhlIHRhZyBuYW1lICIke25hbWV9IiBpcyBub3QgYSBCb3JlRE9NICBjb21wb25lbnQuCiAgICAgIAoiY3JlYXRlQ29tcG9uZW50IiBvbmx5IGFjY2VwdHMgdGFnLW5hbWVzIHdpdGggbWF0Y2hpbmcgPHRlbXBsYXRlPiB0YWdzIHRoYXQgaGF2ZSBhIGRhdGEtY29tcG9uZW50IGF0dHJpYnV0ZSBpbiB0aGVtLmA7CiAgICBjb25zb2xlLmVycm9yKGVycm9yKTsKICAgIHRocm93IG5ldyBFcnJvcihlcnJvcik7CiAgfQogIGlmICh1cGRhdGUpIHsKICAgIGVsZW1lbnQucmVuZGVyQ2FsbGJhY2sgPSB1cGRhdGU7CiAgfQogIHJldHVybiBlbGVtZW50Owp9Owp2YXIgcXVlcnlDb21wb25lbnQgPSAocSkgPT4gewogIGNvbnN0IGVsZW0gPSBxdWVyeShxKTsKICBpZiAoZWxlbSA9PT0gbnVsbCB8fCAhaXNCb3JlZChlbGVtKSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGVsZW07Cn07CnZhciBxdWVyeSA9IChxdWVyeTIpID0+IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IocXVlcnkyKTsKdmFyIHF1ZXJ5QWxsID0gKHF1ZXJ5MikgPT4gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChxdWVyeTIpOwp2YXIgY3JlYXRlID0gKHRhZ05hbWUsIGNoaWxkcmVuKSA9PiB7CiAgY29uc3QgZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7CiAgaWYgKGNoaWxkcmVuICYmIEFycmF5LmlzQXJyYXkoY2hpbGRyZW4pICYmIGNoaWxkcmVuLmxlbmd0aCA+IDApIHsKICAgIGNoaWxkcmVuLm1hcCgoYykgPT4gZS5hcHBlbmRDaGlsZChjKSk7CiAgfQogIHJldHVybiBlOwp9Owp2YXIgZGlzcGF0Y2ggPSAobmFtZSwgZGV0YWlsKSA9PiB7CiAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJsb2FkaW5nIikgewogICAgYWRkRXZlbnRMaXN0ZW5lcigKICAgICAgIkRPTUNvbnRlbnRMb2FkZWQiLAogICAgICAoKSA9PiBkaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudChuYW1lLCB7IGRldGFpbCB9KSkKICAgICk7CiAgfSBlbHNlIHsKICAgIGRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KG5hbWUsIHsgZGV0YWlsIH0pKTsKICB9Cn07CnZhciBpc09iamVjdCA9ICh0KSA9PiB0eXBlb2YgdCA9PT0gIm9iamVjdCI7CnZhciBpc0Z1bmN0aW9uID0gKHQpID0+IHR5cGVvZiB0ID09PSAiZnVuY3Rpb24iOwp2YXIgaXNCb3JlZCA9ICh0KSA9PiBpc09iamVjdCh0KSAmJiAiaXNCb3JlZCIgaW4gdCAmJiBCb29sZWFuKHQuaXNCb3JlZCk7CnZhciBkZWNhbWVsaXplID0gKHN0cikgPT4gewogIGlmIChzdHIgPT09ICIiIHx8ICFzdHIuc3BsaXQoIiIpLnNvbWUoKGNoYXIpID0+IGNoYXIgIT09IGNoYXIudG9Mb3dlckNhc2UoKSkpIHsKICAgIHJldHVybiBzdHI7CiAgfQogIGxldCByZXN1bHQgPSAiIjsKICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ci5sZW5ndGg7IGkrKykgewogICAgY29uc3QgY2hhciA9IHN0cltpXTsKICAgIGlmIChjaGFyID09PSBjaGFyLnRvVXBwZXJDYXNlKCkgJiYgaSAhPT0gMCkgewogICAgICByZXN1bHQgKz0gIi0iOwogICAgfQogICAgcmVzdWx0ICs9IGNoYXIudG9Mb3dlckNhc2UoKTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfTsKdmFyIGlzU3RhcnRzV2l0aE9uID0gKHMpID0+IHMuc3RhcnRzV2l0aCgib24iKTsKdmFyIGlzU3RhcnRzV2l0aFF1ZXJpZWRPbiA9IChzKSA9PiBzLnN0YXJ0c1dpdGgoInF1ZXJpZWRPbiIpOwp2YXIgZ2V0RXZlbnROYW1lID0gKHMpID0+IHsKICBpZiAoaXNTdGFydHNXaXRoT24ocykpIHsKICAgIHJldHVybiBzLnNsaWNlKDIpLnRvTG93ZXJDYXNlKCk7CiAgfQogIHJldHVybiBzLnNsaWNlKDkpLnRvTG93ZXJDYXNlKCk7Cn07CnZhciBCb3JlZCA9IGNsYXNzIGV4dGVuZHMgSFRNTEVsZW1lbnQgewp9Owp2YXIgY29tcG9uZW50ID0gKHRhZywgcHJvcHMgPSB7fSkgPT4gewogIGlmIChjdXN0b21FbGVtZW50cy5nZXQodGFnKSkgcmV0dXJuOwogIGN1c3RvbUVsZW1lbnRzLmRlZmluZSgKICAgIHRhZywKICAgIGNsYXNzIGV4dGVuZHMgQm9yZWQgewogICAgICAvLyBTcGVjaWZ5IG9ic2VydmVkIGF0dHJpYnV0ZXMgc28gdGhhdAogICAgICAvLyBhdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sgd2lsbCB3b3JrCiAgICAgIHN0YXRpYyBnZXQgb2JzZXJ2ZWRBdHRyaWJ1dGVzKCkgewogICAgICAgIGlmICh0eXBlb2YgcHJvcHMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrID09PSAib2JqZWN0IikgewogICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHByb3BzLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICBzdXBlcigpOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBVc2VmdWwgdG8ga25vdyBpZiBhIGdpdmVuIEhUTUxFbGVtZW50IGlzIGEgQm9yZWQgY29tcG9uZW50LgogICAgICAgKiBAc2VlIGBpc0JvcmVkKClgIHR5cGVndWFyZAogICAgICAgKi8KICAgICAgaXNCb3JlZCA9IHRydWU7CiAgICAgIHRyYXZlcnNlKGYsIHsgdHJhdmVyc2VTaGFkb3dSb290LCBxdWVyeTogcXVlcnkyIH0gPSB7fSkgewogICAgICAgIEFycmF5LmZyb20oCiAgICAgICAgICB0cmF2ZXJzZVNoYWRvd1Jvb3QgPyB0aGlzLnNoYWRvd1Jvb3Q/LnF1ZXJ5U2VsZWN0b3JBbGwocXVlcnkyID8/ICIqIikgPz8gW10gOiBbXQogICAgICAgICkuY29uY2F0KEFycmF5LmZyb20odGhpcy5xdWVyeVNlbGVjdG9yQWxsKHF1ZXJ5MiA/PyAiKiIpKSkuZmlsdGVyKChuKSA9PiBuIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpLmZvckVhY2goZik7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIFJldHVybnMgdGhlIGxpc3Qgb2YgY3VzdG9tIGV2ZW50IG5hbWVzIGZyb20gYSBzdHJpbmcgdGhhdCBpcyBzaGFwZWQgbGlrZToKICAgICAgICogYCJkaXNwYXRjaCgnZXZlbnQxJywgJ2V2ZW50MicsIC4uLikiYAogICAgICAgKgogICAgICAgKiBUaGlzIGlzIHVzZWZ1bCB3aGVuIHRyYXZlcnNpbmcgZm9yIGV2ZW50IGhhbmRsZXJzIHRvIGJlIHJlcGxhY2VkCiAgICAgICAqIHdpdGggY3VzdG9tIGRpc3BhdGNoZXJzLgogICAgICAgKiBAcmV0dXJucyBhbiBhcnJheSBvZiBzdHJpbmdzCiAgICAgICAqLwogICAgICAvKiogRXh0cmFjdHMgZXZlbnQgbmFtZXMgZnJvbSBzdHJpbmdzIGxpa2UgImRpc3BhdGNoKCdhJywnYicpIiAqLwogICAgICAjcGFyc2VDdXN0b21FdmVudE5hbWVzKHN0cikgewogICAgICAgIHJldHVybiBzdHIuc3BsaXQoIiciKS5maWx0ZXIoCiAgICAgICAgICAocykgPT4gcy5sZW5ndGggPiAyICYmICEocy5pbmNsdWRlcygiKCIpIHx8IHMuaW5jbHVkZXMoIiwiKSB8fCBzLmluY2x1ZGVzKCIpIikpCiAgICAgICAgKTsKICAgICAgfQogICAgICAvKioKICAgICAgICogUmVwbGFjZXMgaW5saW5lIG9uKiBhdHRyaWJ1dGVzIHdpdGhpbiB0aGUgY29tcG9uZW50IERPTSB3aXRoIHJlYWwKICAgICAgICogbGlzdGVuZXJzIHRoYXQgZGlzcGF0Y2ggY3VzdG9tIGV2ZW50cyB1c2luZyBkaXNwYXRjaCgpLgogICAgICAgKi8KICAgICAgI2NyZWF0ZURpc3BhdGNoZXJzKCkgewogICAgICAgIGxldCBob3N0OwogICAgICAgIHRoaXMudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgIGlmIChub2RlIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHsKICAgICAgICAgICAgY29uc3QgaXNXZWJDb21wb25lbnQgPSBjdXN0b21FbGVtZW50cy5nZXQoCiAgICAgICAgICAgICAgbm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGlzV2ViQ29tcG9uZW50KSBob3N0ID0gbm9kZTsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLmF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBub2RlLmF0dHJpYnV0ZXNbaV07CiAgICAgICAgICAgICAgaWYgKGlzU3RhcnRzV2l0aE9uKGF0dHJpYnV0ZS5uYW1lKSkgewogICAgICAgICAgICAgICAgY29uc3QgZXZlbnROYW1lcyA9IHRoaXMuI3BhcnNlQ3VzdG9tRXZlbnROYW1lcyhhdHRyaWJ1dGUudmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKGV2ZW50TmFtZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICBldmVudE5hbWVzLmZvckVhY2goKGN1c3RvbUV2ZW50TmFtZSkgPT4gewogICAgICAgICAgICAgICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcigKICAgICAgICAgICAgICAgICAgICAgIGdldEV2ZW50TmFtZShhdHRyaWJ1dGUubmFtZSksCiAgICAgICAgICAgICAgICAgICAgICAoZSkgPT4gZGlzcGF0Y2goY3VzdG9tRXZlbnROYW1lLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50OiBlLAogICAgICAgICAgICAgICAgICAgICAgICBkaXNwYXRjaGVyOiBub2RlLAogICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnQ6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiB0aGlzLnBhcmVudEVsZW1lbnQgPyBBcnJheS5mcm9tKHRoaXMucGFyZW50RWxlbWVudC5jaGlsZHJlbikuaW5kZXhPZigKICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzCiAgICAgICAgICAgICAgICAgICAgICAgICkgOiAtMQogICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKAogICAgICAgICAgICAgICAgICBgZGF0YS0ke2F0dHJpYnV0ZS5uYW1lfS1kaXNwYXRjaGVzYCwKICAgICAgICAgICAgICAgICAgZXZlbnROYW1lcy5qb2luKCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGUubmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgeyB0cmF2ZXJzZVNoYWRvd1Jvb3Q6IHRydWUgfSk7CiAgICAgIH0KICAgICAgaXNJbml0aWFsaXplZCA9IGZhbHNlOwogICAgICAjaW5pdCgpIHsKICAgICAgICBsZXQgdGVtcGxhdGUgPSBxdWVyeShgW2RhdGEtY29tcG9uZW50PSIke3RhZ30iXWApID8/IGNyZWF0ZSgidGVtcGxhdGUiKTsKICAgICAgICBjb25zdCBpc1RlbXBsYXRlU2hhZG93Um9vdCA9IHRlbXBsYXRlLmdldEF0dHJpYnV0ZSgic2hhZG93cm9vdG1vZGUiKTsKICAgICAgICBjb25zdCBpc1NoYWRvd1Jvb3ROZWVkZWQgPSBwcm9wcy5zdHlsZSB8fCBwcm9wcy5zaGFkb3cgfHwgaXNUZW1wbGF0ZVNoYWRvd1Jvb3Q7CiAgICAgICAgaWYgKGlzU2hhZG93Um9vdE5lZWRlZCkgewogICAgICAgICAgY29uc3Qgc2hhZG93Um9vdE1vZGUgPSBwcm9wcy5zaGFkb3dyb290bW9kZSA/PyBpc1RlbXBsYXRlU2hhZG93Um9vdCA/PyAib3BlbiI7CiAgICAgICAgICBjb25zdCBzaGFkb3dSb290ID0gdGhpcy5hdHRhY2hTaGFkb3coeyBtb2RlOiBzaGFkb3dSb290TW9kZSB9KTsKICAgICAgICAgIGlmIChwcm9wcy5zdHlsZSkgewogICAgICAgICAgICBjb25zdCBzdHlsZSA9IGNyZWF0ZSgic3R5bGUiKTsKICAgICAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBwcm9wcy5zdHlsZTsKICAgICAgICAgICAgc2hhZG93Um9vdC5hcHBlbmRDaGlsZChzdHlsZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvcHMuc2hhZG93KSB7CiAgICAgICAgICAgIGNvbnN0IHRtcCA9IGNyZWF0ZSgidGVtcGxhdGUiKTsKICAgICAgICAgICAgdG1wLmlubmVySFRNTCA9IHByb3BzLnNoYWRvdzsKICAgICAgICAgICAgc2hhZG93Um9vdC5hcHBlbmRDaGlsZCh0bXAuY29udGVudC5jbG9uZU5vZGUodHJ1ZSkpOwogICAgICAgICAgfSBlbHNlIGlmIChpc1RlbXBsYXRlU2hhZG93Um9vdCkgewogICAgICAgICAgICBzaGFkb3dSb290LmFwcGVuZENoaWxkKHRlbXBsYXRlLmNvbnRlbnQuY2xvbmVOb2RlKHRydWUpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRlbXBsYXRlICYmICFpc1RlbXBsYXRlU2hhZG93Um9vdCkgewogICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZCh0ZW1wbGF0ZS5jb250ZW50LmNsb25lTm9kZSh0cnVlKSk7CiAgICAgICAgfQogICAgICAgIGlmIChwcm9wcy5vblNsb3RDaGFuZ2UpIHsKICAgICAgICAgIHRoaXMudHJhdmVyc2UoKGVsZW0pID0+IHsKICAgICAgICAgICAgaWYgKCEoZWxlbSBpbnN0YW5jZW9mIEhUTUxTbG90RWxlbWVudCkpIHJldHVybjsKICAgICAgICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKCJzbG90Y2hhbmdlIiwgKGUpID0+IHByb3BzLm9uU2xvdENoYW5nZT8uKGUpKTsKICAgICAgICAgIH0sIHsgdHJhdmVyc2VTaGFkb3dSb290OiB0cnVlIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoaXNGdW5jdGlvbihwcm9wcy5vbkNsaWNrKSkgewogICAgICAgICAgdGhpcy5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHByb3BzLm9uQ2xpY2spOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhwcm9wcykpIHsKICAgICAgICAgIGlmIChpc1N0YXJ0c1dpdGhPbihrZXkpKSB7CiAgICAgICAgICAgIGlmICghaXNGdW5jdGlvbih2YWx1ZSkpIGNvbnRpbnVlOwogICAgICAgICAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoZ2V0RXZlbnROYW1lKGtleSksIHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNTdGFydHNXaXRoUXVlcmllZE9uKGtleSkpIHsKICAgICAgICAgICAgY29uc3QgcXVlcmllcyA9IHZhbHVlOwogICAgICAgICAgICBpZiAoIWlzT2JqZWN0KHF1ZXJpZXMpKSBjb250aW51ZTsKICAgICAgICAgICAgY29uc3QgZXZlbnROYW1lID0gZ2V0RXZlbnROYW1lKGtleSk7CiAgICAgICAgICAgIGZvciAoY29uc3QgW3F1ZXJ5MiwgaGFuZGxlcl0gb2YgT2JqZWN0LmVudHJpZXMocXVlcmllcykpIHsKICAgICAgICAgICAgICB0aGlzLnRyYXZlcnNlKChub2RlKSA9PiB7CiAgICAgICAgICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBoYW5kbGVyKTsKICAgICAgICAgICAgICB9LCB7IHRyYXZlcnNlU2hhZG93Um9vdDogdHJ1ZSwgcXVlcnk6IHF1ZXJ5MiB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAocHJvcHMuYXR0cmlidXRlcyAmJiBBcnJheS5pc0FycmF5KHByb3BzLmF0dHJpYnV0ZXMpKSB7CiAgICAgICAgICBwcm9wcy5hdHRyaWJ1dGVzLm1hcCgKICAgICAgICAgICAgKFthdHRyLCB2YWx1ZV0pID0+IHRoaXMuc2V0QXR0cmlidXRlKGF0dHIsIHZhbHVlKQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgdGhpcy4jY3JlYXRlRGlzcGF0Y2hlcnMoKTsKICAgICAgICB0aGlzLmlzSW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBVc2VyLXByb3ZpZGVkIHJlbmRlcmVyIGlzIGFzc2lnbmVkIGhlcmUgYnkgY3JlYXRlQ29tcG9uZW50LgogICAgICAgKiBDYWxsZWQgb24gY29ubmVjdCBhbmQgd2hlbmV2ZXIgc3RhdGUgdHJpZ2dlcnMgc3Vic2NyaXB0aW9ucy4KICAgICAgICovCiAgICAgIHJlbmRlckNhbGxiYWNrID0gKF8pID0+IHsKICAgICAgfTsKICAgICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgaWYgKCF0aGlzLmlzSW5pdGlhbGl6ZWQpIHRoaXMuI2luaXQoKTsKICAgICAgICB0aGlzLnJlbmRlckNhbGxiYWNrKHRoaXMpOwogICAgICAgIHByb3BzLmNvbm5lY3RlZENhbGxiYWNrPy4odGhpcyk7CiAgICAgIH0KICAgICAgc2xvdHMgPSBjcmVhdGVTbG90c0FjY2Vzc29yKHRoaXMpOwogICAgICAvKgogICAgICAgICAgICAjY3JlYXRlU2xvdHMoKSB7CiAgICAgICAgICAgICAgY29uc3Qgc2xvdHMgPSBBcnJheS5mcm9tKHRoaXMucXVlcnlTZWxlY3RvckFsbCgic2xvdCIpKTsKICAgICAgICAgICAgICBjb25zdCB3ZWJDb21wb25lbnQgPSB0aGlzOwogICAgICAKICAgICAgICAgICAgICBzbG90cy5mb3JFYWNoKChzbG90KSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBzbG90TmFtZSA9IHNsb3QuZ2V0QXR0cmlidXRlKCJuYW1lIik7CiAgICAgICAgICAgICAgICBpZiAoIXNsb3ROYW1lKSByZXR1cm47CiAgICAgIAogICAgICAgICAgICAgICAgY29uc3QgY2FtZWxpemVkU2xvdE5hbWUgPSBjYW1lbGl6ZShzbG90TmFtZSk7CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2ViQ29tcG9uZW50LnNsb3RzLCBjYW1lbGl6ZWRTbG90TmFtZSwgewogICAgICAgICAgICAgICAgICBnZXQoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdlYkNvbXBvbmVudC5xdWVyeVNlbGVjdG9yKGBbZGF0YS1zbG90PSIke3Nsb3ROYW1lfSJdYCk7CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHNldCh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBlbGVtID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnNldEF0dHJpYnV0ZSgiZGF0YS1zbG90Iiwgc2xvdE5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgICAgZWxlbSA9IGNyZWF0ZSgic3BhbiIpOwogICAgICAgICAgICAgICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoImRhdGEtc2xvdCIsIHNsb3ROYW1lKTsKICAgICAgICAgICAgICAgICAgICAgIGVsZW0uaW5uZXJUZXh0ID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAKICAgICAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZ1Nsb3QgPSB0aGlzW2NhbWVsaXplZFNsb3ROYW1lXTsKICAgICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdTbG90KSB7CiAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1Nsb3QucGFyZW50RWxlbWVudC5yZXBsYWNlQ2hpbGQoZWxlbSwgZXhpc3RpbmdTbG90KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgc2xvdC5wYXJlbnRFbGVtZW50Py5yZXBsYWNlQ2hpbGQoZWxlbSwgc2xvdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKi8KICAgICAgdXBkYXRlU2xvdChzbG90TmFtZSwgY29udGVudCwgd2l0aGluVGFnKSB7CiAgICAgICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh3aXRoaW5UYWcpOwogICAgICAgIGNvbnRhaW5lci5zZXRBdHRyaWJ1dGUoInNsb3QiLCBzbG90TmFtZSk7CiAgICAgIH0KICAgICAgLyoKICAgICAgICAgICAgI2NyZWF0ZVByb3BlcnRpZXMoKSB7CiAgICAgICAgICAgICAgY29uc3QgZWxlbWVudHNGb3VuZCA9IGRvY3VtZW50LmV2YWx1YXRlKAogICAgICAgICAgICAgICAgIi8vKltjb250YWlucyh0ZXh0KCksJ3RoaXMuJyldIiwKICAgICAgICAgICAgICAgIGRvY3VtZW50LAogICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgIFhQYXRoUmVzdWx0Lk9SREVSRURfTk9ERV9JVEVSQVRPUl9UWVBFLAogICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICApOwogICAgICAKICAgICAgICAgICAgICBsZXQgZWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgICAgd2hpbGUgKGVsZW1lbnQgPSBlbGVtZW50c0ZvdW5kLml0ZXJhdGVOZXh0KCkpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJGb3VuZCAiLCBlbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKi8KICAgICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgcHJvcHMuZGlzY29ubmVjdGVkQ2FsbGJhY2s/Lih0aGlzKTsKICAgICAgfQogICAgICBhZG9wdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgcHJvcHMuYWRvcHRlZENhbGxiYWNrPy4odGhpcyk7CiAgICAgIH0KICAgICAgYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKG5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkgewogICAgICAgIGlmICghcHJvcHMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKSByZXR1cm47CiAgICAgICAgcHJvcHMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrW25hbWVdKHsKICAgICAgICAgIGVsZW1lbnQ6IHRoaXMsCiAgICAgICAgICBuYW1lLAogICAgICAgICAgb2xkVmFsdWUsCiAgICAgICAgICBuZXdWYWx1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgKTsKfTsKdmFyIHJlZ2lzdGVyQ29tcG9uZW50ID0gKHRhZ05hbWUpID0+IHsKICBjb21wb25lbnQodGFnTmFtZSwge30pOwp9OwoKLy8gc3JjL3V0aWxzL2FjY2Vzcy50cwpmdW5jdGlvbiBhY2Nlc3MocGF0aCwgb2JqKSB7CiAgbGV0IHJlc3VsdCA9IG9iajsKICBpZiAob2JqID09PSBudWxsKSByZXR1cm4gcmVzdWx0OwogIHBhdGguZm9yRWFjaCgoYXR0cmlidXRlKSA9PiB7CiAgICByZXN1bHQgPSByZXN1bHRbYXR0cmlidXRlXTsKICB9KTsKICByZXR1cm4gcmVzdWx0Owp9CgovLyBzcmMvdXRpbHMvZmxhdHRlbi50cwpmdW5jdGlvbiBmbGF0dGVuKG9iaiwgaWdub3JlID0gW10pIHsKICBjb25zdCBzdGFjayA9IFt7CiAgICBwYXRoOiBbXSwKICAgIG9iagogIH1dOwogIGNvbnN0IHJlc3VsdCA9IFtdOwogIGNvbnN0IHZpc2l0ZWQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKTsKICB3aGlsZSAoc3RhY2subGVuZ3RoID4gMCkgewogICAgY29uc3QgeyBwYXRoLCBvYmo6IG9iajIgfSA9IHN0YWNrLnBvcCgpOwogICAgaWYgKHZpc2l0ZWQuaGFzKG9iajIpKSBjb250aW51ZTsKICAgIHZpc2l0ZWQuYWRkKG9iajIpOwogICAgZm9yIChjb25zdCBrZXkgaW4gb2JqMikgewogICAgICBpZiAoaWdub3JlLmluY2x1ZGVzKGtleSkpIGNvbnRpbnVlOwogICAgICBjb25zdCB2YWx1ZSA9IG9iajJba2V5XTsKICAgICAgY29uc3QgbmV3UGF0aCA9IHBhdGguY29uY2F0KGtleSk7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsICYmICF2aXNpdGVkLmhhcyh2YWx1ZSkpIHsKICAgICAgICBzdGFjay5wdXNoKHsKICAgICAgICAgIHBhdGg6IG5ld1BhdGgsCiAgICAgICAgICBvYmo6IHZhbHVlCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmVzdWx0LnB1c2goeyBwYXRoOiBuZXdQYXRoLCB2YWx1ZSB9KTsKICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQoKLy8gc3JjL3V0aWxzL2lzUG9qby50cwpmdW5jdGlvbiBpc1BPSk8oYXJnKSB7CiAgaWYgKGFyZyA9PSBudWxsIHx8IHR5cGVvZiBhcmcgIT09ICJvYmplY3QiKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGNvbnN0IHByb3RvID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGFyZyk7CiAgaWYgKHByb3RvID09IG51bGwpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gcHJvdG8gPT09IE9iamVjdC5wcm90b3R5cGU7Cn0KCi8vIHNyYy9ib3JlLnRzCmZ1bmN0aW9uIGNyZWF0ZUV2ZW50c0hhbmRsZXIoYywgYXBwLCBkZXRhaWwpIHsKICByZXR1cm4gKGV2ZW50TmFtZSwgaGFuZGxlcikgPT4gewogICAgYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIChldmVudCkgPT4gewogICAgICBsZXQgdGFyZ2V0ID0gZXZlbnQ/LmRldGFpbD8uZXZlbnQuY3VycmVudFRhcmdldDsKICAgICAgbGV0IGVtaXRlckVsZW0gPSB2b2lkIDA7CiAgICAgIHdoaWxlICh0YXJnZXQpIHsKICAgICAgICBpZiAodGFyZ2V0ID09PSBjKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBtYXliZVByb21pc2UgPSBoYW5kbGVyKHsKICAgICAgICAgICAgICBzdGF0ZTogYXBwLAogICAgICAgICAgICAgIGU6IGV2ZW50LmRldGFpbCwKICAgICAgICAgICAgICBkZXRhaWwKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIFByb21pc2UucmVzb2x2ZShtYXliZVByb21pc2UpLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAgICAgICBgRXJyb3IgaW4gYXN5bmMgaGFuZGxlciBmb3IgIiR7ZXZlbnROYW1lfSIgZXZlbnRgLAogICAgICAgICAgICAgICAgZXJyb3IKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIGluIGhhbmRsZXIgZm9yICIke2V2ZW50TmFtZX0iIGV2ZW50YCwgZXJyb3IpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGFyZ2V0IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHsKICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnRFbGVtZW50OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0YXJnZXQgPSB2b2lkIDA7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9Owp9CmZ1bmN0aW9uIGNyZWF0ZVJlZnNBY2Nlc3NvcihjKSB7CiAgcmV0dXJuIG5ldyBQcm94eSh7fSwgewogICAgZ2V0KHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpIHsKICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoCiAgICAgICAgYFJlZiAiJHtTdHJpbmcocHJvcCl9IiBub3QgZm91bmQgaW4gPCR7Yy50YWdOYW1lfT5gCiAgICAgICk7CiAgICAgIGlmICh0eXBlb2YgcHJvcCA9PT0gInN0cmluZyIpIHsKICAgICAgICBjb25zdCBub2RlTGlzdCA9IGMucXVlcnlTZWxlY3RvckFsbChgW2RhdGEtcmVmPSIke3Byb3B9Il1gKTsKICAgICAgICBpZiAoIW5vZGVMaXN0KSB0aHJvdyBlcnJvcjsKICAgICAgICBjb25zdCByZWZzID0gQXJyYXkuZnJvbShub2RlTGlzdCkuZmlsdGVyKAogICAgICAgICAgKHJlZikgPT4gcmVmIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQKICAgICAgICApOwogICAgICAgIGlmIChyZWZzLmxlbmd0aCA9PT0gMCkgdGhyb3cgZXJyb3I7CiAgICAgICAgaWYgKHJlZnMubGVuZ3RoID09PSAxKSByZXR1cm4gcmVmc1swXTsKICAgICAgICByZXR1cm4gcmVmczsKICAgICAgfQogICAgfQogIH0pOwp9CmZ1bmN0aW9uIGNyZWF0ZVNsb3RzQWNjZXNzb3IoYykgewogIHJldHVybiBuZXcgUHJveHkoe30sIHsKICAgIGdldCh0YXJnZXQsIHByb3AsIHJlY2lldmVyKSB7CiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKAogICAgICAgIGBTbG90ICIke1N0cmluZyhwcm9wKX0iIG5vdCBmb3VuZCBpbiA8JHtjLnRhZ05hbWV9PmAKICAgICAgKTsKICAgICAgaWYgKHR5cGVvZiBwcm9wID09PSAic3RyaW5nIikgewogICAgICAgIGNvbnN0IG5vZGVMaXN0ID0gYy5xdWVyeVNlbGVjdG9yQWxsKGBzbG90W25hbWU9IiR7cHJvcH0iXWApOwogICAgICAgIGlmICghbm9kZUxpc3QpIHRocm93IGVycm9yOwogICAgICAgIGNvbnN0IHJlZnMgPSBBcnJheS5mcm9tKG5vZGVMaXN0KS5maWx0ZXIoCiAgICAgICAgICAocmVmKSA9PiByZWYgaW5zdGFuY2VvZiBIVE1MU2xvdEVsZW1lbnQKICAgICAgICApOwogICAgICAgIGlmIChyZWZzLmxlbmd0aCA9PT0gMCkgdGhyb3cgZXJyb3I7CiAgICAgICAgaWYgKHJlZnMubGVuZ3RoID09PSAxKSByZXR1cm4gcmVmc1swXTsKICAgICAgICByZXR1cm4gcmVmczsKICAgICAgfQogICAgfSwKICAgIHNldCh0YXJnZXQsIHByb3AsIHZhbHVlKSB7CiAgICAgIGlmICh0eXBlb2YgcHJvcCAhPT0gInN0cmluZyIpIHJldHVybiBmYWxzZTsKICAgICAgbGV0IGVsZW0gPSB2YWx1ZTsKICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHsKICAgICAgICB2YWx1ZS5zZXRBdHRyaWJ1dGUoImRhdGEtc2xvdCIsIHByb3ApOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHsKICAgICAgICBlbGVtID0gY3JlYXRlKCJzcGFuIik7CiAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoImRhdGEtc2xvdCIsIHByb3ApOwogICAgICAgIGVsZW0uaW5uZXJUZXh0ID0gdmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHZhbHVlIGZvciBzbG90ICR7cHJvcH0gaW4gPCR7Yy50YWdOYW1lfT5gKTsKICAgICAgfQogICAgICBjb25zdCBleGlzdGluZ1Nsb3RzID0gQXJyYXkuZnJvbSgKICAgICAgICBjLnF1ZXJ5U2VsZWN0b3JBbGwoYFtkYXRhLXNsb3Q9IiR7cHJvcH0iXWApCiAgICAgICk7CiAgICAgIGlmIChleGlzdGluZ1Nsb3RzLmxlbmd0aCA+IDApIHsKICAgICAgICBleGlzdGluZ1Nsb3RzLmZvckVhY2goKHMpID0+IHMucGFyZW50RWxlbWVudD8ucmVwbGFjZUNoaWxkKGVsZW0sIHMpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBzbG90cyA9IEFycmF5LmZyb20oYy5xdWVyeVNlbGVjdG9yQWxsKGBzbG90W25hbWU9IiR7cHJvcH0iXWApKTsKICAgICAgICBzbG90cy5mb3JFYWNoKChzKSA9PiBzLnBhcmVudEVsZW1lbnQ/LnJlcGxhY2VDaGlsZChlbGVtLCBzKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gY3JlYXRlU3RhdGVBY2Nlc3NvcihzdGF0ZSwgbG9nLCBhY2N1bSkgewogIGNvbnN0IGN1cnJlbnQgPSBhY2N1bSB8fCB7IHRhcmdldHM6IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpLCBwYXRoOiBbXSB9OwogIGlmIChzdGF0ZSA9PT0gdm9pZCAwKSByZXR1cm4gdm9pZCAwOwogIHJldHVybiBuZXcgUHJveHkoc3RhdGUsIHsKICAgIC8vIFN0YXRlIGFjY2Vzc29ycyBhcmUgcmVhZC1vbmx5OgogICAgc2V0KHRhcmdldCwgcHJvcCwgbmV3VmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiBwcm9wID09PSAic3RyaW5nIikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICBgU3RhdGUgaXMgcmVhZC1vbmx5IGZvciB3ZWIgY29tcG9uZW50cy4gVW5hYmxlIHRvIHNldCAnJHtwcm9wfScuYAogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIC8vIFJlY3Vyc2l2ZWx5IGJ1aWxkIGEgcHJveHkgZm9yIGVhY2ggc3RhdGUgcHJvcCBiZWluZyByZWFkOgogICAgZ2V0KHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpIHsKICAgICAgY29uc3QgdmFsdWUgPSBSZWZsZWN0LmdldCh0YXJnZXQsIHByb3AsIHJlY2VpdmVyKTsKICAgICAgY29uc3QgaXNQcm90byA9IHByb3AgPT09ICJfX3Byb3RvX18iOwogICAgICBpZiAodHlwZW9mIHByb3AgPT09ICJzdHJpbmciICYmICFpc1Byb3RvKSB7CiAgICAgICAgaWYgKCFjdXJyZW50LnRhcmdldHMuaGFzKHRhcmdldCkpIHsKICAgICAgICAgIGN1cnJlbnQudGFyZ2V0cy5zZXQodGFyZ2V0LCBjdXJyZW50LnBhdGguam9pbigiLiIpKTsKICAgICAgICAgIGN1cnJlbnQucGF0aC5wdXNoKHByb3ApOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoaXNQcm90byB8fCBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCBpc1BPSk8odmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZVN0YXRlQWNjZXNzb3IodmFsdWUsIGxvZywgY3VycmVudCk7CiAgICAgIH0KICAgICAgbGV0IHBhdGggPSBjdXJyZW50LnRhcmdldHMuZ2V0KHRhcmdldCkgPz8gIiI7CiAgICAgIGlmICh0eXBlb2YgcGF0aCA9PT0gInN0cmluZyIgJiYgdHlwZW9mIHByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGFyZ2V0KSkgewogICAgICAgICAgcGF0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGF0aCArPSBwYXRoICE9PSAiIiA/IGAuJHtwcm9wfWAgOiBwcm9wOwogICAgICAgIH0KICAgICAgICBpZiAobG9nLmluZGV4T2YocGF0aCkgPT09IC0xKSB7CiAgICAgICAgICBsb2cucHVzaChwYXRoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY3VycmVudC5wYXRoLmxlbmd0aCA9IDA7CiAgICAgIGN1cnJlbnQucGF0aC5wdXNoKHBhdGgpOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gY3JlYXRlU3Vic2NyaWJlcnNEaXNwYXRjaGVyKHN0YXRlKSB7CiAgcmV0dXJuICgpID0+IHsKICAgIGNvbnN0IHVwZGF0ZXMgPSBzdGF0ZS5pbnRlcm5hbC51cGRhdGVzOwogICAgY29uc3Qgbm90aWZpZWQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgY29uc3Qgbm90aWZ5ID0gKGZucykgPT4gewogICAgICBpZiAoIWZucykgcmV0dXJuOwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGZucy5sZW5ndGg7IGorKykgewogICAgICAgIGNvbnN0IGZuID0gZm5zW2pdOwogICAgICAgIGlmIChub3RpZmllZC5oYXMoZm4pKSBjb250aW51ZTsKICAgICAgICBub3RpZmllZC5hZGQoZm4pOwogICAgICAgIHRyeSB7CiAgICAgICAgICBmbihzdGF0ZS5hcHApOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB1cGRhdGVzLnBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcGF0aCA9IHVwZGF0ZXMucGF0aFtpXTsKICAgICAgY29uc3QgcmVsYXRpdmVQYXRoID0gcGF0aC5zbGljZShwYXRoLmluZGV4T2YoIi4iKSArIDEpOwogICAgICBub3RpZnkodXBkYXRlcy5zdWJzY3JpYmVycy5nZXQocmVsYXRpdmVQYXRoKSk7CiAgICAgIGZvciAoY29uc3QgW3N1YnNjcmliZXJQYXRoLCBmbnNdIG9mIHVwZGF0ZXMuc3Vic2NyaWJlcnMuZW50cmllcygpKSB7CiAgICAgICAgaWYgKHN1YnNjcmliZXJQYXRoID09PSByZWxhdGl2ZVBhdGgpIGNvbnRpbnVlOwogICAgICAgIGNvbnN0IHN1YnNjcmliZXJXaXRoRG90ID0gYCR7c3Vic2NyaWJlclBhdGh9LmA7CiAgICAgICAgY29uc3QgcmVsYXRpdmVXaXRoRG90ID0gYCR7cmVsYXRpdmVQYXRofS5gOwogICAgICAgIGlmIChyZWxhdGl2ZVBhdGguc3RhcnRzV2l0aChzdWJzY3JpYmVyV2l0aERvdCkgfHwgc3Vic2NyaWJlclBhdGguc3RhcnRzV2l0aChyZWxhdGl2ZVdpdGhEb3QpKSB7CiAgICAgICAgICBub3RpZnkoZm5zKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHVwZGF0ZXMucGF0aCA9IFtdOwogICAgdXBkYXRlcy52YWx1ZSA9IFtdOwogICAgdXBkYXRlcy5yYWYgPSB2b2lkIDA7CiAgfTsKfQpmdW5jdGlvbiBwcm94aWZ5KGJvcmVkb20pIHsKICBjb25zdCBydW50aW1lID0gYm9yZWRvbS5pbnRlcm5hbDsKICBjb25zdCBzdGF0ZSA9IGJvcmVkb207CiAgaWYgKHN0YXRlID09PSB2b2lkIDApIHJldHVybiBib3JlZG9tOwogIGNvbnN0IG9iamVjdHNXaXRoUHJveGllcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpOwogIGNvbnN0IFBST1hZX01BUktFUiA9IFN5bWJvbCgiYm9yZWRvbS1wcm94eSIpOwogIGZ1bmN0aW9uIGNyZWF0ZVJlYWN0aXZlUHJveHkodmFsdWUsIGRvdHRlZFBhdGgpIHsKICAgIGlmIChvYmplY3RzV2l0aFByb3hpZXMuaGFzKHZhbHVlKSkgcmV0dXJuIHZhbHVlOwogICAgY29uc3QgcHJveHkgPSBuZXcgUHJveHkodmFsdWUsIHsKICAgICAgZ2V0KHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpIHsKICAgICAgICBpZiAocHJvcCA9PT0gUFJPWFlfTUFSS0VSKSByZXR1cm4gdHJ1ZTsKICAgICAgICByZXR1cm4gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wLCByZWNlaXZlcik7CiAgICAgIH0sCiAgICAgIHNldCh0YXJnZXQsIHByb3AsIG5ld1ZhbHVlKSB7CiAgICAgICAgY29uc3QgaXNDaGFuZ2VkID0gdGFyZ2V0W3Byb3BdICE9PSBuZXdWYWx1ZTsKICAgICAgICBpZiAoIWlzQ2hhbmdlZCkgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKHR5cGVvZiBwcm9wID09PSAic3RyaW5nIikgewogICAgICAgICAgY29uc3QgbmV3UGF0aCA9IEFycmF5LmlzQXJyYXkodmFsdWUpID8gZG90dGVkUGF0aCA6IGAke2RvdHRlZFBhdGh9LiR7cHJvcH1gOwogICAgICAgICAgY29uc3QgaXNBbHJlYWR5UHJveHkgPSBuZXdWYWx1ZSAmJiBuZXdWYWx1ZVtQUk9YWV9NQVJLRVJdID09PSB0cnVlOwogICAgICAgICAgaWYgKCFpc0FscmVhZHlQcm94eSAmJiAoQXJyYXkuaXNBcnJheShuZXdWYWx1ZSkgfHwgaXNQT0pPKG5ld1ZhbHVlKSkpIHsKICAgICAgICAgICAgbmV3VmFsdWUgPSBwcm94aWZ5VmFsdWUobmV3VmFsdWUsIG5ld1BhdGgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBSZWZsZWN0LnNldCh0YXJnZXQsIHByb3AsIG5ld1ZhbHVlKTsKICAgICAgICBpZiAodHlwZW9mIHByb3AgIT09ICJzdHJpbmciKSByZXR1cm4gdHJ1ZTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIHJ1bnRpbWUudXBkYXRlcy5wYXRoLnB1c2goYCR7ZG90dGVkUGF0aH1gKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcnVudGltZS51cGRhdGVzLnBhdGgucHVzaChgJHtkb3R0ZWRQYXRofS4ke3Byb3B9YCk7CiAgICAgICAgfQogICAgICAgIHJ1bnRpbWUudXBkYXRlcy52YWx1ZS5wdXNoKHRhcmdldCk7CiAgICAgICAgaWYgKCFydW50aW1lLnVwZGF0ZXMucmFmKSB7CiAgICAgICAgICBydW50aW1lLnVwZGF0ZXMucmFmID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKAogICAgICAgICAgICBjcmVhdGVTdWJzY3JpYmVyc0Rpc3BhdGNoZXIoYm9yZWRvbSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9KTsKICAgIG9iamVjdHNXaXRoUHJveGllcy5hZGQodmFsdWUpOwogICAgb2JqZWN0c1dpdGhQcm94aWVzLmFkZChwcm94eSk7CiAgICByZXR1cm4gcHJveHk7CiAgfQogIGZ1bmN0aW9uIHByb3hpZnlWYWx1ZSh2YWx1ZSwgYmFzZVBhdGgpIHsKICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgIWlzUE9KTyh2YWx1ZSkpIHJldHVybiB2YWx1ZTsKICAgIGlmIChvYmplY3RzV2l0aFByb3hpZXMuaGFzKHZhbHVlKSkgcmV0dXJuIHZhbHVlOwogICAgaWYgKHZhbHVlICYmIHZhbHVlW1BST1hZX01BUktFUl0gPT09IHRydWUpIHJldHVybiB2YWx1ZTsKICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgaXRlbSA9IHZhbHVlW2ldOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGl0ZW0pIHx8IGlzUE9KTyhpdGVtKSkgewogICAgICAgICAgdmFsdWVbaV0gPSBwcm94aWZ5VmFsdWUoaXRlbSwgYmFzZVBhdGgpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXModmFsdWUpKSB7CiAgICAgICAgY29uc3QgaXRlbSA9IHZhbHVlW2tleV07CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkgfHwgaXNQT0pPKGl0ZW0pKSB7CiAgICAgICAgICB2YWx1ZVtrZXldID0gcHJveGlmeVZhbHVlKGl0ZW0sIGAke2Jhc2VQYXRofS4ke2tleX1gKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjcmVhdGVSZWFjdGl2ZVByb3h5KHZhbHVlLCBiYXNlUGF0aCk7CiAgfQogIGZsYXR0ZW4oYm9yZWRvbSwgWyJpbnRlcm5hbCJdKS5mb3JFYWNoKCh7IHBhdGgsIHZhbHVlIH0pID0+IHsKICAgIGNvbnN0IG5lZWRzUHJveHkgPSBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCBpc1BPSk8odmFsdWUpICYmICFvYmplY3RzV2l0aFByb3hpZXMuaGFzKHZhbHVlKTsKICAgIGlmIChuZWVkc1Byb3h5KSB7CiAgICAgIGNvbnN0IGRvdHRlZFBhdGggPSBwYXRoLmpvaW4oIi4iKTsKICAgICAgY29uc3QgcGFyZW50ID0gYWNjZXNzKHBhdGguc2xpY2UoMCwgLTEpLCBzdGF0ZSk7CiAgICAgIGNvbnN0IGlzUm9vdCA9IHBhcmVudCA9PT0gdmFsdWU7CiAgICAgIGlmIChpc1Jvb3QpIHJldHVybjsKICAgICAgcGFyZW50W3BhdGguYXQoLTEpXSA9IGNyZWF0ZVJlYWN0aXZlUHJveHkodmFsdWUsIGRvdHRlZFBhdGgpOwogICAgfQogIH0pOwogIHJldHVybiBib3JlZG9tOwp9CmZ1bmN0aW9uIHJ1bkNvbXBvbmVudHNJbml0aWFsaXplcihzdGF0ZSkgewogIGNvbnN0IHRhZ3NJbkRvbSA9IHN0YXRlLmludGVybmFsLmN1c3RvbVRhZ3MuZmlsdGVyKAogICAgKHRhZykgPT4gKAogICAgICAvLyBBIHRhZyBpcyBjb25zaWRlcmVkIHByZXNlbnQgaWYgYXQgbGVhc3Qgb25lIGluc3RhbmNlIGV4aXN0cyBpbiB0aGUgRE9NCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodGFnKSAhPT0gbnVsbAogICAgKQogICk7CiAgY29uc3QgY29tcG9uZW50cyA9IHN0YXRlLmludGVybmFsLmNvbXBvbmVudHM7CiAgZm9yIChjb25zdCBbdGFnTmFtZSwgY29kZV0gb2YgY29tcG9uZW50cy5lbnRyaWVzKCkpIHsKICAgIGlmIChjb2RlID09PSBudWxsIHx8ICF0YWdzSW5Eb20uaW5jbHVkZXModGFnTmFtZSkpIGNvbnRpbnVlOwogICAgY29uc3QgZWxlbWVudHMgPSBBcnJheS5mcm9tKAogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHRhZ05hbWUpCiAgICApLmZpbHRlcigoZWwpID0+IGlzQm9yZWQoZWwpKTsKICAgIGlmIChlbGVtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICBlbGVtZW50cy5mb3JFYWNoKChjb21wb25lbnRDbGFzcywgaW5kZXgpID0+IHsKICAgICAgY29kZShzdGF0ZSwgeyBpbmRleCwgbmFtZTogdGFnTmFtZSwgZGF0YTogdm9pZCAwIH0pKAogICAgICAgIGNvbXBvbmVudENsYXNzCiAgICAgICk7CiAgICB9KTsKICB9CiAgcmV0dXJuOwp9CmZ1bmN0aW9uIGNyZWF0ZUFuZFJ1bkNvZGUobmFtZSwgc3RhdGUsIGRldGFpbCkgewogIGNvbnN0IGNvZGUgPSBzdGF0ZS5pbnRlcm5hbC5jb21wb25lbnRzLmdldChuYW1lKTsKICBpZiAoY29kZSkgewogICAgY29uc3QgaW5mbyA9IHsgLi4uZGV0YWlsLCB0YWdOYW1lOiBuYW1lIH07CiAgICByZXR1cm4gY3JlYXRlQ29tcG9uZW50KG5hbWUsIGNvZGUoc3RhdGUsIGluZm8pKTsKICB9CiAgcmV0dXJuIGNyZWF0ZUNvbXBvbmVudChuYW1lKTsKfQoKLy8gc3JjL2RlYnVnLnRzCnZhciBkZWJ1Z0NvbmZpZyA9IHsKICBjb25zb2xlOiB0cnVlLAogIGdsb2JhbHM6IHRydWUsCiAgZXJyb3JCb3VuZGFyeTogdHJ1ZSwKICB2aXN1YWxJbmRpY2F0b3JzOiB0cnVlLAogIGVycm9ySGlzdG9yeTogdHJ1ZSwKICB2ZXJzaW9uTG9nOiB0cnVlLAogIGFwaTogdHJ1ZQp9Owp2YXIgZXJyb3JzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKdmFyIGxhc3RFcnJvciA9IG51bGw7CmZ1bmN0aW9uIGlzRGVidWdFbmFibGVkKGZlYXR1cmUpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgewogICAgaWYgKGZlYXR1cmUgPT09ICJlcnJvckJvdW5kYXJ5IikgewogICAgICByZXR1cm4gZGVidWdDb25maWcuZXJyb3JCb3VuZGFyeSA/PyB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gZGVidWdDb25maWdbZmVhdHVyZV0gPz8gdHJ1ZTsKfQpmdW5jdGlvbiBzZXREZWJ1Z0NvbmZpZyhjb25maWcpIHsKICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gImJvb2xlYW4iKSB7CiAgICBjb25zdCBlbmFibGVkID0gY29uZmlnOwogICAgZGVidWdDb25maWcgPSB7CiAgICAgIGNvbnNvbGU6IGVuYWJsZWQsCiAgICAgIGdsb2JhbHM6IGVuYWJsZWQsCiAgICAgIGVycm9yQm91bmRhcnk6IHRydWUsCiAgICAgIC8vIEFsd2F5cyBrZWVwIGVycm9yIGJvdW5kYXJ5IGZvciBzYWZldHkKICAgICAgdmlzdWFsSW5kaWNhdG9yczogZW5hYmxlZCwKICAgICAgZXJyb3JIaXN0b3J5OiBlbmFibGVkLAogICAgICB2ZXJzaW9uTG9nOiBlbmFibGVkLAogICAgICBhcGk6IGVuYWJsZWQKICAgIH07CiAgfSBlbHNlIHsKICAgIGRlYnVnQ29uZmlnID0geyAuLi5kZWJ1Z0NvbmZpZywgLi4uY29uZmlnIH07CiAgfQp9CmZ1bmN0aW9uIGdldERlYnVnQ29uZmlnKCkgewogIHJldHVybiB7IC4uLmRlYnVnQ29uZmlnIH07Cn0KZnVuY3Rpb24gZXhwb3NlR2xvYmFscyhjdHgpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImdsb2JhbHMiKSkgcmV0dXJuOwogIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgcmV0dXJuOwogIGNvbnN0IHcgPSB3aW5kb3c7CiAgdy4kc3RhdGUgPSBjdHguc3RhdGU7CiAgdy4kcmVmcyA9IGN0eC5yZWZzOwogIHcuJHNsb3RzID0gY3R4LnNsb3RzOwogIHcuJHNlbGYgPSBjdHguZWxlbWVudDsKICB3LiRlcnJvciA9IGN0eC5lcnJvcjsKICB3LiRjb21wb25lbnQgPSBjdHguY29tcG9uZW50OwogIHcuJHJlcmVuZGVyID0gY3R4LnJlcmVuZGVyOwp9CmZ1bmN0aW9uIGNsZWFyR2xvYmFscygpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImdsb2JhbHMiKSkgcmV0dXJuOwogIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgcmV0dXJuOwogIGNvbnN0IHcgPSB3aW5kb3c7CiAgZGVsZXRlIHcuJHN0YXRlOwogIGRlbGV0ZSB3LiRyZWZzOwogIGRlbGV0ZSB3LiRzbG90czsKICBkZWxldGUgdy4kc2VsZjsKICBkZWxldGUgdy4kZXJyb3I7CiAgZGVsZXRlIHcuJGNvbXBvbmVudDsKICBkZWxldGUgdy4kcmVyZW5kZXI7Cn0KZnVuY3Rpb24gbG9nRXJyb3IoY3R4KSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHJldHVybjsKICBjb25zb2xlLmxvZygKICAgICIlY1x1ezFGNTM0fSBib3JlRE9NOiBFcnJvciBpbiAlYzwlcz4lYyByZW5kZXIiLAogICAgImNvbG9yOiAjZmY2YjZiOyBmb250LXdlaWdodDogYm9sZCIsCiAgICAiY29sb3I6ICM0ZWNkYzQ7IGZvbnQtd2VpZ2h0OiBib2xkIiwKICAgIGN0eC5jb21wb25lbnQsCiAgICAiY29sb3I6ICNmZjZiNmIiCiAgKTsKICBjb25zb2xlLmVycm9yKGN0eC5lcnJvcik7CiAgaWYgKGlzRGVidWdFbmFibGVkKCJnbG9iYWxzIikpIHsKICAgIGNvbnNvbGUubG9nKCIlY1x1ezFGNENCfSBEZWJ1ZyBjb250ZXh0IGxvYWRlZDoiLCAiY29sb3I6ICM5NWE1YTY7IGZvbnQtd2VpZ2h0OiBib2xkIik7CiAgICBjb25zb2xlLmxvZygiICAgJHN0YXRlICAgICBcdTIxOTIiLCBjdHguc3RhdGUpOwogICAgY29uc29sZS5sb2coIiAgICRyZWZzICAgICAgXHUyMTkyIiwgY3R4LnJlZnMpOwogICAgY29uc29sZS5sb2coIiAgICRzbG90cyAgICAgXHUyMTkyIiwgY3R4LnNsb3RzKTsKICAgIGNvbnNvbGUubG9nKCIgICAkc2VsZiAgICAgIFx1MjE5MiIsIGN0eC5lbGVtZW50KTsKICAgIGNvbnNvbGUubG9nKCIlY1x1ezFGNEExfSBRdWljayBmaXhlczoiLCAiY29sb3I6ICNmMzljMTI7IGZvbnQtd2VpZ2h0OiBib2xkIik7CiAgICBjb25zb2xlLmxvZygiICAgJHN0YXRlLnByb3BlcnR5TmFtZSA9IHZhbHVlIik7CiAgICBjb25zb2xlLmxvZygiICAgJHJlcmVuZGVyKCkiKTsKICAgIGNvbnNvbGUubG9nKCIlY1x1ezFGNEU0fSBXaGVuIGZpeGVkOiIsICJjb2xvcjogIzI3YWU2MDsgZm9udC13ZWlnaHQ6IGJvbGQiKTsKICAgIGNvbnNvbGUubG9nKGAgICBib3JlRE9NLmV4cG9ydCgnJHtjdHguY29tcG9uZW50fScpYCk7CiAgfQp9CmZ1bmN0aW9uIGxvZ0Vycm9yTWluaW1hbChjb21wb25lbnQyLCBlcnJvcikgewogIGNvbnNvbGUuZXJyb3IoYFtib3JlRE9NXSBSZW5kZXIgZXJyb3IgaW4gPCR7Y29tcG9uZW50Mn0+OiAke2Vycm9yLm1lc3NhZ2V9YCk7Cn0KZnVuY3Rpb24gbG9nSW5pdEVycm9yKGNvbXBvbmVudDIsIGVycm9yKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHJldHVybjsKICBjb25zb2xlLmxvZygKICAgICIlY1x1ezFGNTM0fSBib3JlRE9NOiBFcnJvciBpbiAlYzwlcz4lYyBpbml0IiwKICAgICJjb2xvcjogI2ZmNmI2YjsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgImNvbG9yOiAjNGVjZGM0OyBmb250LXdlaWdodDogYm9sZCIsCiAgICBjb21wb25lbnQyLAogICAgImNvbG9yOiAjZmY2YjZiIgogICk7CiAgY29uc29sZS5lcnJvcihlcnJvcik7Cn0KZnVuY3Rpb24gc3RvcmVFcnJvcihjdHgpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImVycm9ySGlzdG9yeSIpKSByZXR1cm47CiAgZXJyb3JzLnNldChjdHguY29tcG9uZW50LCBjdHgpOwogIGxhc3RFcnJvciA9IGN0eDsKfQpmdW5jdGlvbiBjbGVhckVycm9yKGNvbXBvbmVudDIpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImVycm9ySGlzdG9yeSIpKSByZXR1cm47CiAgaWYgKGNvbXBvbmVudDIpIHsKICAgIGVycm9ycy5kZWxldGUoY29tcG9uZW50Mik7CiAgICBpZiAobGFzdEVycm9yPy5jb21wb25lbnQgPT09IGNvbXBvbmVudDIpIHsKICAgICAgbGFzdEVycm9yID0gbnVsbDsKICAgIH0KICB9IGVsc2UgaWYgKGxhc3RFcnJvcikgewogICAgZXJyb3JzLmRlbGV0ZShsYXN0RXJyb3IuY29tcG9uZW50KTsKICAgIGxhc3RFcnJvciA9IG51bGw7CiAgfQp9CmZ1bmN0aW9uIG1hcmtDb21wb25lbnRFcnJvcihlbGVtZW50KSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJ2aXN1YWxJbmRpY2F0b3JzIikpIHJldHVybjsKICBlbGVtZW50LnNldEF0dHJpYnV0ZSgiZGF0YS1ib3JlZG9tLWVycm9yIiwgInRydWUiKTsKfQpmdW5jdGlvbiBjbGVhckNvbXBvbmVudEVycm9yTWFyayhlbGVtZW50KSB7CiAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoImRhdGEtYm9yZWRvbS1lcnJvciIpOwp9CmZ1bmN0aW9uIGV4cG9ydFN0YXRlKHRhZ05hbWUpIHsKICBjb25zdCBjdHggPSB0YWdOYW1lID8gZXJyb3JzLmdldCh0YWdOYW1lKSA6IGxhc3RFcnJvcjsKICBpZiAoIWN0eCkgcmV0dXJuIG51bGw7CiAgdHJ5IHsKICAgIHJldHVybiB7CiAgICAgIGNvbXBvbmVudDogY3R4LmNvbXBvbmVudCwKICAgICAgc3RhdGU6IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlKSksCiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoY3R4LnRpbWVzdGFtcCkudG9JU09TdHJpbmcoKSwKICAgICAgZXJyb3I6IGN0eC5lcnJvci5tZXNzYWdlCiAgICB9OwogIH0gY2F0Y2ggKGUpIHsKICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgIGNvbnNvbGUud2FybigKICAgICAgICBgW2JvcmVET01dIGV4cG9ydFN0YXRlOiBVbmFibGUgdG8gc2VyaWFsaXplIHN0YXRlIGZvciA8JHtjdHguY29tcG9uZW50fT46YCwKICAgICAgICBlIGluc3RhbmNlb2YgRXJyb3IgPyBlLm1lc3NhZ2UgOiBlCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gewogICAgICBjb21wb25lbnQ6IGN0eC5jb21wb25lbnQsCiAgICAgIHN0YXRlOiAiW1VuYWJsZSB0byBzZXJpYWxpemUgLSBjb250YWlucyBjaXJjdWxhciByZWZlcmVuY2VzIG9yIGZ1bmN0aW9uc10iLAogICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKGN0eC50aW1lc3RhbXApLnRvSVNPU3RyaW5nKCksCiAgICAgIGVycm9yOiBjdHguZXJyb3IubWVzc2FnZQogICAgfTsKICB9Cn0KdmFyIGRlYnVnQVBJID0gewogIC8qKiBNYXAgb2YgYWxsIGN1cnJlbnQgZXJyb3JzIGJ5IGNvbXBvbmVudCBuYW1lICovCiAgZ2V0IGVycm9ycygpIHsKICAgIHJldHVybiBlcnJvcnM7CiAgfSwKICAvKiogTW9zdCByZWNlbnQgZXJyb3IgY29udGV4dCAqLwogIGdldCBsYXN0RXJyb3IoKSB7CiAgICByZXR1cm4gbGFzdEVycm9yOwogIH0sCiAgLyoqIFJlLXJlbmRlciBhIHNwZWNpZmljIGNvbXBvbmVudCBvciB0aGUgbGFzdCBlcnJvcmVkIG9uZSAqLwogIHJlcmVuZGVyKHRhZ05hbWUpIHsKICAgIGNvbnN0IGN0eCA9IHRhZ05hbWUgPyBlcnJvcnMuZ2V0KHRhZ05hbWUpIDogbGFzdEVycm9yOwogICAgaWYgKGN0eCkgewogICAgICBjdHgucmVyZW5kZXIoKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnNvbGUud2FybigiW2JvcmVET01dIE5vIGVycm9yIGNvbnRleHQgZm91bmQgdG8gcmVyZW5kZXIiKTsKICAgIH0KICB9LAogIC8qKiBDbGVhciBlcnJvciBzdGF0ZSBmb3IgYSBjb21wb25lbnQgKi8KICBjbGVhckVycm9yKHRhZ05hbWUpIHsKICAgIGNvbnN0IGN0eCA9IHRhZ05hbWUgPyBlcnJvcnMuZ2V0KHRhZ05hbWUpIDogbGFzdEVycm9yOwogICAgaWYgKGN0eCkgewogICAgICBjbGVhckNvbXBvbmVudEVycm9yTWFyayhjdHguZWxlbWVudCk7CiAgICAgIGNsZWFyRXJyb3IodGFnTmFtZSk7CiAgICAgIGNsZWFyR2xvYmFscygpOwogICAgfSBlbHNlIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgIGNvbnNvbGUud2FybigKICAgICAgICB0YWdOYW1lID8gYFtib3JlRE9NXSBjbGVhckVycm9yOiBObyBlcnJvciBmb3VuZCBmb3IgPCR7dGFnTmFtZX0+YCA6ICJbYm9yZURPTV0gY2xlYXJFcnJvcjogTm8gZXJyb3IgdG8gY2xlYXIiCiAgICAgICk7CiAgICB9CiAgfSwKICAvKiogRXhwb3J0IHN0YXRlIHNuYXBzaG90ICovCiAgZXhwb3J0OiBleHBvcnRTdGF0ZSwKICAvKiogQ3VycmVudCBkZWJ1ZyBjb25maWd1cmF0aW9uIChyZWFkLW9ubHkpICovCiAgZ2V0IGNvbmZpZygpIHsKICAgIHJldHVybiBnZXREZWJ1Z0NvbmZpZygpOwogIH0KfTsKCi8vIHNyYy9jb25zb2xlLWFwaS50cwp2YXIgV0VCX0NPTVBPTkVOVF9NQVJLRVIgPSBTeW1ib2woImJvcmVET00ud2ViQ29tcG9uZW50Iik7CnZhciBjdXJyZW50QXBwU3RhdGUgPSBudWxsOwp2YXIgc3RvcmVkV2ViQ29tcG9uZW50ID0gbnVsbDsKdmFyIHN0b3JlZFJlZ2lzdGVyQ29tcG9uZW50ID0gbnVsbDsKdmFyIGNvbXBvbmVudENvbnRleHRzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CmZ1bmN0aW9uIHNldEN1cnJlbnRBcHBTdGF0ZShzdGF0ZSwgd2ViQ29tcG9uZW50Rm4sIHJlZ2lzdGVyQ29tcG9uZW50Rm4pIHsKICBjdXJyZW50QXBwU3RhdGUgPSBzdGF0ZTsKICBpZiAod2ViQ29tcG9uZW50Rm4pIHN0b3JlZFdlYkNvbXBvbmVudCA9IHdlYkNvbXBvbmVudEZuOwogIGlmIChyZWdpc3RlckNvbXBvbmVudEZuKSBzdG9yZWRSZWdpc3RlckNvbXBvbmVudCA9IHJlZ2lzdGVyQ29tcG9uZW50Rm47Cn0KZnVuY3Rpb24gc3RvcmVDb21wb25lbnRDb250ZXh0KGVsZW1lbnQsIGNvbnRleHQpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImFwaSIpKSByZXR1cm47CiAgY29tcG9uZW50Q29udGV4dHMuc2V0KGVsZW1lbnQsIGNvbnRleHQpOwp9CmZ1bmN0aW9uIGlzV2ViQ29tcG9uZW50UmVzdWx0KGZuKSB7CiAgcmV0dXJuIHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIiAmJiBmbltXRUJfQ09NUE9ORU5UX01BUktFUl0gPT09IHRydWU7Cn0KZnVuY3Rpb24gZGVmaW5lKHRhZ05hbWUsIHRlbXBsYXRlLCBsb2dpYykgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICBjb25zb2xlLndhcm4oIltib3JlRE9NXSBkZWZpbmUoKSBpcyBub3QgYXZhaWxhYmxlIGluIHByb2R1Y3Rpb24gYnVpbGQiKTsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgiYXBpIikpIHsKICAgIGNvbnNvbGUud2FybigiW2JvcmVET01dIGRlZmluZSgpIGlzIGRpc2FibGVkIChkZWJ1Zy5hcGkgaXMgZmFsc2UpIik7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmICghY3VycmVudEFwcFN0YXRlKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIltib3JlRE9NXSBDYW5ub3QgZGVmaW5lIGNvbXBvbmVudCBiZWZvcmUgaW5mbGljdEJvcmVET00oKSIpOwogIH0KICBpZiAoIXRhZ05hbWUuaW5jbHVkZXMoIi0iKSkgewogICAgdGhyb3cgbmV3IEVycm9yKGBbYm9yZURPTV0gSW52YWxpZCB0YWcgbmFtZSAiJHt0YWdOYW1lfSI6IG11c3QgY29udGFpbiBhIGh5cGhlbmApOwogIH0KICBpZiAoY3VzdG9tRWxlbWVudHMuZ2V0KHRhZ05hbWUpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYFtib3JlRE9NXSBDb21wb25lbnQgIiR7dGFnTmFtZX0iIGlzIGFscmVhZHkgZGVmaW5lZGApOwogIH0KICBpZiAoIXN0b3JlZFdlYkNvbXBvbmVudCB8fCAhc3RvcmVkUmVnaXN0ZXJDb21wb25lbnQpIHsKICAgIHRocm93IG5ldyBFcnJvcigiW2JvcmVET01dIENvbnNvbGUgQVBJIG5vdCBpbml0aWFsaXplZC4gQ2FsbCBpbmZsaWN0Qm9yZURPTSgpIGZpcnN0LiIpOwogIH0KICBjb25zdCBhcHBTdGF0ZSA9IGN1cnJlbnRBcHBTdGF0ZTsKICBjb25zdCB3ZWJDb21wb25lbnRGbiA9IHN0b3JlZFdlYkNvbXBvbmVudDsKICBjb25zdCByZWdpc3RlckNvbXBvbmVudEZuID0gc3RvcmVkUmVnaXN0ZXJDb21wb25lbnQ7CiAgY29uc3QgdGVtcGxhdGVFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRlbXBsYXRlIik7CiAgdGVtcGxhdGVFbC5pbm5lckhUTUwgPSB0ZW1wbGF0ZTsKICB0ZW1wbGF0ZUVsLnNldEF0dHJpYnV0ZSgiZGF0YS1jb21wb25lbnQiLCB0YWdOYW1lKTsKICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRlbXBsYXRlRWwpOwogIGNvbnN0IGNvbXBvbmVudExvZ2ljID0gaXNXZWJDb21wb25lbnRSZXN1bHQobG9naWMpID8gbG9naWMgOiB3ZWJDb21wb25lbnRGbihsb2dpYyk7CiAgYXBwU3RhdGUuaW50ZXJuYWwuY29tcG9uZW50cy5zZXQodGFnTmFtZSwgY29tcG9uZW50TG9naWMpOwogIGFwcFN0YXRlLmludGVybmFsLmN1c3RvbVRhZ3MucHVzaCh0YWdOYW1lKTsKICByZWdpc3RlckNvbXBvbmVudEZuKHRhZ05hbWUpOwogIGluaXRpYWxpemVFeGlzdGluZ0VsZW1lbnRzKHRhZ05hbWUsIGNvbXBvbmVudExvZ2ljKTsKICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgY29uc29sZS5sb2coCiAgICAgICIlY1x1MjcwNSBib3JlRE9NOiBEZWZpbmVkICVjPCVzPiIsCiAgICAgICJjb2xvcjogIzI3YWU2MDsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgICAiY29sb3I6ICM0ZWNkYzQ7IGZvbnQtd2VpZ2h0OiBib2xkIiwKICAgICAgdGFnTmFtZQogICAgKTsKICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gaW5pdGlhbGl6ZUV4aXN0aW5nRWxlbWVudHModGFnTmFtZSwgbG9naWMpIHsKICBpZiAoIWN1cnJlbnRBcHBTdGF0ZSkgcmV0dXJuOwogIGNvbnN0IGVsZW1lbnRzID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHRhZ05hbWUpKTsKICBjb25zdCBmYWlsZWRDb3VudCA9IHsgY291bnQ6IDAgfTsKICBlbGVtZW50cy5mb3JFYWNoKChlbGVtLCBpbmRleCkgPT4gewogICAgaWYgKGVsZW0gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCAmJiAicmVuZGVyQ2FsbGJhY2siIGluIGVsZW0pIHsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCBkZXRhaWwgPSB7IGluZGV4LCBuYW1lOiB0YWdOYW1lLCBkYXRhOiB2b2lkIDAgfTsKICAgICAgICBjb25zdCByZW5kZXJDYWxsYmFjayA9IGxvZ2ljKGN1cnJlbnRBcHBTdGF0ZSwgZGV0YWlsKTsKICAgICAgICBlbGVtLnJlbmRlckNhbGxiYWNrID0gcmVuZGVyQ2FsbGJhY2s7CiAgICAgICAgcmVuZGVyQ2FsbGJhY2soZWxlbSk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgZmFpbGVkQ291bnQuY291bnQrKzsKICAgICAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICAgICAgY29uc29sZS5lcnJvcigKICAgICAgICAgICAgYFtib3JlRE9NXSBGYWlsZWQgdG8gaW5pdGlhbGl6ZSA8JHt0YWdOYW1lfT4gaW5zdGFuY2UgJHtpbmRleH06YCwKICAgICAgICAgICAgZXJyb3IKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CiAgaWYgKGZhaWxlZENvdW50LmNvdW50ID4gMCAmJiBpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICBjb25zb2xlLndhcm4oCiAgICAgIGBbYm9yZURPTV0gJHtmYWlsZWRDb3VudC5jb3VudH0gb2YgJHtlbGVtZW50cy5sZW5ndGh9IDwke3RhZ05hbWV9PiBpbnN0YW5jZXMgZmFpbGVkIHRvIGluaXRpYWxpemVgCiAgICApOwogIH0KfQpmdW5jdGlvbiBvcGVyYXRlKHNlbGVjdG9yT3JFbGVtZW50LCBpbmRleCA9IDApIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgewogICAgY29uc29sZS53YXJuKCJbYm9yZURPTV0gb3BlcmF0ZSgpIGlzIG5vdCBhdmFpbGFibGUgaW4gcHJvZHVjdGlvbiBidWlsZCIpOwogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgiYXBpIikpIHsKICAgIGNvbnNvbGUud2FybigiW2JvcmVET01dIG9wZXJhdGUoKSBpcyBkaXNhYmxlZCAoZGVidWcuYXBpIGlzIGZhbHNlKSIpOwogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgbGV0IGVsZW1lbnQgPSBudWxsOwogIGlmICh0eXBlb2Ygc2VsZWN0b3JPckVsZW1lbnQgPT09ICJzdHJpbmciKSB7CiAgICBjb25zdCBlbGVtZW50cyA9IEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvck9yRWxlbWVudCkpLmZpbHRlcigoZWwpID0+IGVsIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpOwogICAgZWxlbWVudCA9IGVsZW1lbnRzW2luZGV4XSA/PyBudWxsOwogIH0gZWxzZSB7CiAgICBlbGVtZW50ID0gc2VsZWN0b3JPckVsZW1lbnQ7CiAgfQogIGlmICghZWxlbWVudCkgewogICAgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgICAgY29uc29sZS53YXJuKGBbYm9yZURPTV0gb3BlcmF0ZSgpOiBObyBlbGVtZW50IGZvdW5kIGZvciAiJHtzZWxlY3Rvck9yRWxlbWVudH0iYCk7CiAgICB9CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBjb25zdCBjb250ZXh0ID0gY29tcG9uZW50Q29udGV4dHMuZ2V0KGVsZW1lbnQpOwogIGlmICghY29udGV4dCkgewogICAgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgICAgY29uc29sZS53YXJuKGBbYm9yZURPTV0gb3BlcmF0ZSgpOiBFbGVtZW50IGlzIG5vdCBhIGJvcmVET00gY29tcG9uZW50IG9yIG5vdCBpbml0aWFsaXplZGApOwogICAgfQogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGNvbnRleHQ7Cn0KZnVuY3Rpb24gZXhwb3J0Q29tcG9uZW50KHNlbGVjdG9yKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHsKICAgIGNvbnNvbGUud2FybigiW2JvcmVET01dIGV4cG9ydENvbXBvbmVudCgpIGlzIG5vdCBhdmFpbGFibGUgaW4gcHJvZHVjdGlvbiBidWlsZCIpOwogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImFwaSIpKSB7CiAgICBjb25zb2xlLndhcm4oIltib3JlRE9NXSBleHBvcnRDb21wb25lbnQoKSBpcyBkaXNhYmxlZCAoZGVidWcuYXBpIGlzIGZhbHNlKSIpOwogICAgcmV0dXJuIG51bGw7CiAgfQogIGNvbnN0IGN0eCA9IG9wZXJhdGUoc2VsZWN0b3IpOwogIGlmICghY3R4KSByZXR1cm4gbnVsbDsKICBjb25zdCB0ZW1wbGF0ZUVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgdGVtcGxhdGVbZGF0YS1jb21wb25lbnQ9IiR7Y3R4LmRldGFpbC5uYW1lfSJdYCk7CiAgY29uc3QgdGVtcGxhdGVIdG1sID0gdGVtcGxhdGVFbD8uaW5uZXJIVE1MID8/IHZvaWQgMDsKICB0cnkgewogICAgcmV0dXJuIHsKICAgICAgY29tcG9uZW50OiBjdHguZGV0YWlsLm5hbWUsCiAgICAgIHN0YXRlOiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGN0eC5zdGF0ZSkpLAogICAgICB0ZW1wbGF0ZTogdGVtcGxhdGVIdG1sLAogICAgICB0aW1lc3RhbXA6ICgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSkudG9JU09TdHJpbmcoKQogICAgfTsKICB9IGNhdGNoIChlKSB7CiAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICBjb25zb2xlLndhcm4oCiAgICAgICAgYFtib3JlRE9NXSBleHBvcnRDb21wb25lbnQ6IFVuYWJsZSB0byBzZXJpYWxpemUgc3RhdGUgZm9yIDwke2N0eC5kZXRhaWwubmFtZX0+OmAsCiAgICAgICAgZSBpbnN0YW5jZW9mIEVycm9yID8gZS5tZXNzYWdlIDogZQogICAgICApOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgY29tcG9uZW50OiBjdHguZGV0YWlsLm5hbWUsCiAgICAgIHN0YXRlOiAiW1VuYWJsZSB0byBzZXJpYWxpemUgLSBjb250YWlucyBjaXJjdWxhciByZWZlcmVuY2VzIG9yIGZ1bmN0aW9uc10iLAogICAgICB0ZW1wbGF0ZTogdGVtcGxhdGVIdG1sLAogICAgICB0aW1lc3RhbXA6ICgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSkudG9JU09TdHJpbmcoKQogICAgfTsKICB9Cn0KdmFyIGNvbnNvbGVBUEkgPSB7CiAgZGVmaW5lLAogIG9wZXJhdGUsCiAgZXhwb3J0Q29tcG9uZW50Cn07CgovLyBzcmMvdmVyc2lvbi50cwp2YXIgVkVSU0lPTiA9ICIwLjI1LjI1IjsKCi8vIHNyYy9pbmRleC50cwp2YXIgaGFzTG9nZ2VkVmVyc2lvbiA9IGZhbHNlOwp2YXIgYm9yZURPTSA9IHsKICAvKiogTWFwIG9mIGFsbCBjdXJyZW50IGVycm9ycyBieSBjb21wb25lbnQgbmFtZSAqLwogIGdldCBlcnJvcnMoKSB7CiAgICByZXR1cm4gZGVidWdBUEkuZXJyb3JzOwogIH0sCiAgLyoqIE1vc3QgcmVjZW50IGVycm9yIGNvbnRleHQgKi8KICBnZXQgbGFzdEVycm9yKCkgewogICAgcmV0dXJuIGRlYnVnQVBJLmxhc3RFcnJvcjsKICB9LAogIC8qKiBSZS1yZW5kZXIgYSBzcGVjaWZpYyBjb21wb25lbnQgb3IgdGhlIGxhc3QgZXJyb3JlZCBvbmUgKi8KICByZXJlbmRlcjogZGVidWdBUEkucmVyZW5kZXIsCiAgLyoqIENsZWFyIGVycm9yIHN0YXRlIGZvciBhIGNvbXBvbmVudCAqLwogIGNsZWFyRXJyb3I6IGRlYnVnQVBJLmNsZWFyRXJyb3IsCiAgLyoqIEV4cG9ydCBzdGF0ZSBzbmFwc2hvdCAqLwogIGV4cG9ydDogZGVidWdBUEkuZXhwb3J0LAogIC8qKiBDdXJyZW50IGRlYnVnIGNvbmZpZ3VyYXRpb24gKHJlYWQtb25seSkgKi8KICBnZXQgY29uZmlnKCkgewogICAgcmV0dXJuIGRlYnVnQVBJLmNvbmZpZzsKICB9LAogIC8qKiBGcmFtZXdvcmsgdmVyc2lvbiAqLwogIHZlcnNpb246IFZFUlNJT04sCiAgLy8gQ29uc29sZSBBUEkgKFBoYXNlIDIpCiAgLyoqIERlZmluZSBhIG5ldyBjb21wb25lbnQgYXQgcnVudGltZSAqLwogIGRlZmluZTogY29uc29sZUFQSS5kZWZpbmUsCiAgLyoqIEdldCBsaXZlIGFjY2VzcyB0byBhIGNvbXBvbmVudCdzIGludGVybmFscyAqLwogIG9wZXJhdGU6IGNvbnNvbGVBUEkub3BlcmF0ZSwKICAvKiogRXhwb3J0IGNvbXBvbmVudCBzdGF0ZSBhbmQgdGVtcGxhdGUgKi8KICBleHBvcnRDb21wb25lbnQ6IGNvbnNvbGVBUEkuZXhwb3J0Q29tcG9uZW50Cn07CmlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIikgewogIHdpbmRvdy5ib3JlRE9NID0gYm9yZURPTTsKfQphc3luYyBmdW5jdGlvbiBpbmZsaWN0Qm9yZURPTShzdGF0ZSwgY29tcG9uZW50c0xvZ2ljLCBjb25maWcpIHsKICBpZiAoY29uZmlnPy5kZWJ1ZyAhPT0gdm9pZCAwKSB7CiAgICBzZXREZWJ1Z0NvbmZpZyhjb25maWcuZGVidWcpOwogIH0KICBpZiAoIWhhc0xvZ2dlZFZlcnNpb24gJiYgaXNEZWJ1Z0VuYWJsZWQoInZlcnNpb25Mb2ciKSkgewogICAgaGFzTG9nZ2VkVmVyc2lvbiA9IHRydWU7CiAgICBpZiAodHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBjb25zb2xlLmluZm8gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgY29uc29sZS5pbmZvKGBbYm9yZURPTV0gdiR7VkVSU0lPTn1gKTsKICAgIH0KICB9CiAgY29uc3QgcmVnaXN0ZXJlZE5hbWVzID0gc2VhcmNoRm9yQ29tcG9uZW50cygpOwogIGNvbnN0IGNvbXBvbmVudHNDb2RlID0gYXdhaXQgZHluYW1pY0ltcG9ydFNjcmlwdHMocmVnaXN0ZXJlZE5hbWVzKTsKICBpZiAoY29tcG9uZW50c0xvZ2ljKSB7CiAgICBmb3IgKGNvbnN0IHRhZ05hbWUgb2YgT2JqZWN0LmtleXMoY29tcG9uZW50c0xvZ2ljKSkgewogICAgICBjb21wb25lbnRzQ29kZS5zZXQodGFnTmFtZSwgY29tcG9uZW50c0xvZ2ljW3RhZ05hbWVdKTsKICAgIH0KICB9CiAgY29uc3QgaW5pdGlhbFN0YXRlID0gewogICAgYXBwOiBzdGF0ZSwKICAgIGludGVybmFsOiB7CiAgICAgIGN1c3RvbVRhZ3M6IHJlZ2lzdGVyZWROYW1lcywKICAgICAgY29tcG9uZW50czogY29tcG9uZW50c0NvZGUsCiAgICAgIHVwZGF0ZXM6IHsKICAgICAgICBwYXRoOiBbXSwKICAgICAgICB2YWx1ZTogW10sCiAgICAgICAgcmFmOiB2b2lkIDAsCiAgICAgICAgc3Vic2NyaWJlcnM6IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkKICAgICAgfQogICAgfQogIH07CiAgY29uc3QgcHJveGlmaWVkU3RhdGUgPSBwcm94aWZ5KGluaXRpYWxTdGF0ZSk7CiAgcHJveGlmaWVkU3RhdGUuaW50ZXJuYWwudXBkYXRlcy5wYXRoID0gW107CiAgcHJveGlmaWVkU3RhdGUuaW50ZXJuYWwudXBkYXRlcy52YWx1ZSA9IFtdOwogIGlmIChwcm94aWZpZWRTdGF0ZS5pbnRlcm5hbC51cGRhdGVzLnJhZikgewogICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUocHJveGlmaWVkU3RhdGUuaW50ZXJuYWwudXBkYXRlcy5yYWYpOwogICAgcHJveGlmaWVkU3RhdGUuaW50ZXJuYWwudXBkYXRlcy5yYWYgPSB2b2lkIDA7CiAgfQogIHNldEN1cnJlbnRBcHBTdGF0ZShwcm94aWZpZWRTdGF0ZSwgd2ViQ29tcG9uZW50LCByZWdpc3RlckNvbXBvbmVudCk7CiAgcnVuQ29tcG9uZW50c0luaXRpYWxpemVyKHByb3hpZmllZFN0YXRlKTsKICByZXR1cm4gcHJveGlmaWVkU3RhdGUuYXBwOwp9CmZ1bmN0aW9uIHdlYkNvbXBvbmVudChpbml0RnVuY3Rpb24pIHsKICBsZXQgaXNJbml0aWFsaXplZCA9IG51bGw7CiAgbGV0IHJlbmRlckZ1bmN0aW9uOwogIGNvbnN0IHJlc3VsdCA9IChhcHBTdGF0ZSwgZGV0YWlsKSA9PiAoYykgPT4gewogICAgY29uc3QgeyBpbnRlcm5hbCwgYXBwIH0gPSBhcHBTdGF0ZTsKICAgIGxldCBsb2cgPSBbXTsKICAgIGNvbnN0IHN0YXRlID0gY3JlYXRlU3RhdGVBY2Nlc3NvcihhcHAsIGxvZyk7CiAgICBjb25zdCByZWZzID0gY3JlYXRlUmVmc0FjY2Vzc29yKGMpOwogICAgY29uc3Qgc2xvdHMgPSBjcmVhdGVTbG90c0FjY2Vzc29yKGMpOwogICAgY29uc3Qgb24gPSBjcmVhdGVFdmVudHNIYW5kbGVyKGMsIGFwcCwgZGV0YWlsKTsKICAgIGlmIChpc0luaXRpYWxpemVkICE9PSBjKSB7CiAgICAgIGNvbnN0IHVwZGF0ZVN1YnNjcmliZXJzID0gYXN5bmMgKCkgPT4gewogICAgICAgIGNvbnN0IHN1YnNjcmliZXJzID0gaW50ZXJuYWwudXBkYXRlcy5zdWJzY3JpYmVyczsKICAgICAgICBmb3IgKGxldCBwYXRoIG9mIGxvZykgewogICAgICAgICAgY29uc3QgZnVuY3Rpb25zID0gc3Vic2NyaWJlcnMuZ2V0KHBhdGgpOwogICAgICAgICAgaWYgKGZ1bmN0aW9ucykgewogICAgICAgICAgICBpZiAoIWZ1bmN0aW9ucy5pbmNsdWRlcyhyZW5kZXJGdW5jdGlvbikpIHsKICAgICAgICAgICAgICBmdW5jdGlvbnMucHVzaChyZW5kZXJGdW5jdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN1YnNjcmliZXJzLnNldChwYXRoLCBbcmVuZGVyRnVuY3Rpb25dKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIGxldCB1c2VyRGVmaW5lZFJlbmRlcmVyOwogICAgICB0cnkgewogICAgICAgIHVzZXJEZWZpbmVkUmVuZGVyZXIgPSBpbml0RnVuY3Rpb24oewogICAgICAgICAgZGV0YWlsLAogICAgICAgICAgc3RhdGUsCiAgICAgICAgICByZWZzLAogICAgICAgICAgb24sCiAgICAgICAgICBzZWxmOiBjCiAgICAgICAgfSk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc3QgZXJyID0gZXJyb3I7CiAgICAgICAgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgICAgICAgIGxvZ0luaXRFcnJvcihkZXRhaWw/Lm5hbWUgPz8gYy50YWdOYW1lLnRvTG93ZXJDYXNlKCksIGVycik7CiAgICAgICAgfQogICAgICAgIHVzZXJEZWZpbmVkUmVuZGVyZXIgPSAoKSA9PiB7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZW5kZXJGdW5jdGlvbiA9IChyZW5kZXJTdGF0ZSkgPT4gewogICAgICAgIGNvbnN0IGNvbXBvbmVudE5hbWUgPSBkZXRhaWw/Lm5hbWUgPz8gYy50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKGlzRGVidWdFbmFibGVkKCJlcnJvckJvdW5kYXJ5IikpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHVzZXJEZWZpbmVkUmVuZGVyZXIoewogICAgICAgICAgICAgIHN0YXRlOiByZW5kZXJTdGF0ZSwKICAgICAgICAgICAgICByZWZzLAogICAgICAgICAgICAgIHNsb3RzLAogICAgICAgICAgICAgIHNlbGY6IGMsCiAgICAgICAgICAgICAgZGV0YWlsLAogICAgICAgICAgICAgIG1ha2VDb21wb25lbnQ6ICh0YWcsIG9wdHMpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVBbmRSdW5Db2RlKHRhZywgYXBwU3RhdGUsIG9wdHM/LmRldGFpbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdXBkYXRlU3Vic2NyaWJlcnMoKTsKICAgICAgICAgICAgY2xlYXJDb21wb25lbnRFcnJvck1hcmsoYyk7CiAgICAgICAgICAgIGNsZWFyRXJyb3IoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBjb25zdCBlcnIgPSBlcnJvcjsKICAgICAgICAgICAgY29uc3QgY3R4ID0gewogICAgICAgICAgICAgIGNvbXBvbmVudDogY29tcG9uZW50TmFtZSwKICAgICAgICAgICAgICBlbGVtZW50OiBjLAogICAgICAgICAgICAgIGVycm9yOiBlcnIsCiAgICAgICAgICAgICAgc3RhdGU6IGFwcCwKICAgICAgICAgICAgICAvLyBXcml0ZSBwcm94eSAtIE1VVEFCTEUKICAgICAgICAgICAgICByZWZzLAogICAgICAgICAgICAgIHNsb3RzLAogICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICByZXJlbmRlcjogKCkgPT4gcmVuZGVyRnVuY3Rpb24ocmVuZGVyU3RhdGUpLAogICAgICAgICAgICAgIHN0YWNrOiBlcnIuc3RhY2sgPz8gIiIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgICAgICAgICAgICBsb2dFcnJvcihjdHgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxvZ0Vycm9yTWluaW1hbChjb21wb25lbnROYW1lLCBlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV4cG9zZUdsb2JhbHMoY3R4KTsKICAgICAgICAgICAgc3RvcmVFcnJvcihjdHgpOwogICAgICAgICAgICBtYXJrQ29tcG9uZW50RXJyb3IoYyk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHVzZXJEZWZpbmVkUmVuZGVyZXIoewogICAgICAgICAgICBzdGF0ZTogcmVuZGVyU3RhdGUsCiAgICAgICAgICAgIHJlZnMsCiAgICAgICAgICAgIHNsb3RzLAogICAgICAgICAgICBzZWxmOiBjLAogICAgICAgICAgICBkZXRhaWwsCiAgICAgICAgICAgIG1ha2VDb21wb25lbnQ6ICh0YWcsIG9wdHMpID0+IHsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlQW5kUnVuQ29kZSh0YWcsIGFwcFN0YXRlLCBvcHRzPy5kZXRhaWwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHVwZGF0ZVN1YnNjcmliZXJzKCk7CiAgICAgICAgfQogICAgICB9OwogICAgICBzdG9yZUNvbXBvbmVudENvbnRleHQoYywgewogICAgICAgIHN0YXRlOiBhcHAsCiAgICAgICAgcmVmcywKICAgICAgICBzbG90cywKICAgICAgICBzZWxmOiBjLAogICAgICAgIGRldGFpbCwKICAgICAgICByZXJlbmRlcjogKCkgPT4gcmVuZGVyRnVuY3Rpb24oYXBwKQogICAgICB9KTsKICAgIH0KICAgIHJlbmRlckZ1bmN0aW9uKHN0YXRlKTsKICAgIGlzSW5pdGlhbGl6ZWQgPSBjOwogIH07CiAgcmVzdWx0W1dFQl9DT01QT05FTlRfTUFSS0VSXSA9IHRydWU7CiAgcmV0dXJuIHJlc3VsdDsKfQpleHBvcnQgewogIFZFUlNJT04sCiAgYm9yZURPTSwKICBjbGVhckdsb2JhbHMsCiAgaW5mbGljdEJvcmVET00sCiAgaXNEZWJ1Z0VuYWJsZWQsCiAgcXVlcnlDb21wb25lbnQsCiAgcmVnaXN0ZXJDb21wb25lbnQsCiAgc2V0RGVidWdDb25maWcsCiAgd2ViQ29tcG9uZW50Cn07Cg==
`;
var beautify = import_js_beautify.default.html;
var DEFAULT_COMPONENTS_DIR = "components";
var DEFAULT_STATIC_DIR = "src";
var DEFAULT_STATIC_SERVE = "";
var BUILD_DIR = "build";
var serverStarted = false;
var numberOfRefreshes = 0;
function collectMultiValue(value, previous) {
  const next = Array.isArray(previous) ? [...previous] : [];
  next.push(value);
  return next;
}
console.log("## boreDOM CLI options");
console.log(
  "## ",
  "--index <path to default html>",
  "The base HTML file to serve",
  "defaults to ./index.html"
);
console.log(
  "## ",
  "--html <folder>",
  "Folder containing HTML component files",
  'defaults to "./components"'
);
console.log(
  "## ",
  "--static <folder>",
  "Static files folder, all files in here are copied as is",
  'defaults to "./src"'
);
console.log(
  "## ",
  "--static-serve <folder>",
  "Build subfolder used to serve static assets",
  'defaults to "./"'
);
import_commander.program.option("--index <path to file>", "Index file to serve", "index.html").option(
  "--html <folder>",
  "Folder containing HTML component files",
  DEFAULT_COMPONENTS_DIR
).option(
  "--static <folder>",
  "Folder containing static files to be copied as is",
  collectMultiValue,
  [DEFAULT_STATIC_DIR]
).option(
  "--components-serve <folder>",
  "Build subfolder used to serve processed components",
  DEFAULT_COMPONENTS_DIR
).option(
  "--static-serve <folder>",
  "Build subfolder used to serve static assets",
  DEFAULT_STATIC_SERVE
);
var isTestMode = Boolean(process.env.BOREDOM_CLI_TEST_MODE);
if (isTestMode) {
  import_commander.program.parse([], { from: "user" });
} else {
  import_commander.program.parse(process.argv);
}
var options = import_commander.program.opts();
function sanitizeServeInput(value) {
  const normalizedSlashes = value.replace(/\\+/g, "/").trim();
  if (!normalizedSlashes) {
    return { fsPath: "", urlPath: "" };
  }
  if (["/", "./"].includes(normalizedSlashes)) {
    return { fsPath: "", urlPath: "/" };
  }
  let working = normalizedSlashes;
  while (working.startsWith("./")) {
    working = working.slice(2);
  }
  const isAbsolute = working.startsWith("/");
  if (isAbsolute) {
    working = working.replace(/^\/+/, "");
  }
  working = working.replace(/\/+$/, "");
  const fsPath = working;
  if (!fsPath) {
    return { fsPath: "", urlPath: isAbsolute ? "/" : "" };
  }
  const urlPath = isAbsolute ? `/${fsPath}` : fsPath;
  return { fsPath, urlPath };
}
function normalizeServePath(input, fallback) {
  if (typeof input === "undefined" || input === null) {
    return sanitizeServeInput(fallback);
  }
  const trimmed = String(input).trim();
  if (!trimmed) {
    return sanitizeServeInput(fallback);
  }
  return sanitizeServeInput(trimmed);
}
function buildRelativeServePath(base, ...segments) {
  const cleanSegments = segments.filter(Boolean).map((segment) => {
    return segment.replace(/^\/+/, "").replace(/\/+$/, "");
  });
  const ensureModuleRelative = (candidate) => {
    if (!candidate) {
      return candidate;
    }
    if (candidate.startsWith("/") || candidate.startsWith("./") || candidate.startsWith("../")) {
      return candidate;
    }
    return `./${candidate}`;
  };
  if (!base || base === ".") {
    return ensureModuleRelative(cleanSegments.join("/"));
  }
  if (base === "/") {
    const joined = cleanSegments.join("/");
    return joined ? `/${joined}` : "/";
  }
  const cleanBase = base.replace(/\/+$/, "");
  return ensureModuleRelative([cleanBase, ...cleanSegments].join("/"));
}
var componentsServePath;
var staticServePath;
var componentsServeUrlPath;
var staticServeUrlPath;
function setServePaths(currentOptions = options) {
  const componentsPaths = normalizeServePath(
    currentOptions.componentsServe,
    "components"
  );
  const staticPaths = normalizeServePath(
    currentOptions.staticServe,
    DEFAULT_STATIC_SERVE
  );
  componentsServePath = componentsPaths.fsPath;
  componentsServeUrlPath = componentsPaths.urlPath;
  staticServePath = staticPaths.fsPath;
  staticServeUrlPath = staticPaths.urlPath;
  return {
    componentsServePath,
    componentsServeUrlPath,
    staticServePath,
    staticServeUrlPath
  };
}
function getServePaths() {
  return {
    componentsServePath,
    componentsServeUrlPath,
    staticServePath,
    staticServeUrlPath
  };
}
setServePaths();
async function copyStatic() {
  const staticFolders = Array.isArray(options.static) ? options.static : [options.static].filter(Boolean);
  if (staticFolders.length === 0) {
    return;
  }
  for (const folder of staticFolders) {
    const staticDir = import_path.default.resolve(folder);
    if (await import_fs_extra.default.pathExists(staticDir)) {
      await import_fs_extra.default.copy(staticDir, import_path.default.join(BUILD_DIR, staticServePath), {
        overwrite: true,
        errorOnExist: false
      });
      console.log(`Static folder copied from ${folder}.`);
    }
  }
}
async function copyBoreDOM() {
  return import_fs_extra.default.writeFile(import_path.default.join(BUILD_DIR, "boreDOM.js"), atob(boredom));
}
async function processComponents() {
  let components = {};
  if (options.html) {
    const htmlFolder = import_path.default.resolve(options.html);
    const htmlFiles = glob.sync("**/*.html", { cwd: htmlFolder });
    for (const file of htmlFiles) {
      const filePath = import_path.default.join(htmlFolder, file);
      const content = await import_fs_extra.default.readFile(filePath, "utf-8");
      const $ = cheerio.load(content, { decodeEntities: false });
      const template = $("template[data-component]");
      if (template.length) {
        const componentName = template.attr("data-component");
        const fullTemplate = $.html(template);
        const componentBuildDir = import_path.default.join(
          BUILD_DIR,
          componentsServePath,
          componentName
        );
        await import_fs_extra.default.ensureDir(componentBuildDir);
        const destHtmlPath = import_path.default.join(
          componentBuildDir,
          `${componentName}.html`
        );
        await import_fs_extra.default.copy(filePath, destHtmlPath);
        const componentDir = import_path.default.dirname(filePath);
        const jsMatch = glob.sync(`**/${componentName}.js`, {
          cwd: componentDir
        });
        const cssMatch = glob.sync(`**/${componentName}.css`, {
          cwd: componentDir
        });
        const hasJS = jsMatch.length > 0;
        if (jsMatch.length > 0) {
          const jsSrc = import_path.default.join(componentDir, jsMatch[0]);
          const destJsPath = import_path.default.join(
            componentBuildDir,
            `${componentName}.js`
          );
          await import_fs_extra.default.copy(jsSrc, destJsPath);
          console.log(`Copied ${componentName}.js to ${componentBuildDir}`);
        }
        const hasCSS = cssMatch.length > 0;
        if (cssMatch.length > 0) {
          const cssSrc = import_path.default.join(componentDir, cssMatch[0]);
          const destCssPath = import_path.default.join(
            componentBuildDir,
            `${componentName}.css`
          );
          await import_fs_extra.default.copy(cssSrc, destCssPath);
          console.log(`Copied ${componentName}.css to ${componentBuildDir}`);
        }
        components[componentName] = {
          templateTag: fullTemplate,
          hasJS,
          hasCSS
        };
      }
    }
  }
  return components;
}
async function updateIndex(components) {
  console.log(
    "Updated index.html with components:\n\n",
    JSON.stringify(components, null, 2)
  );
  const indexPath = import_path.default.resolve(options.index);
  let indexContent = await import_fs_extra.default.readFile(indexPath, "utf-8");
  const $ = cheerio.load(indexContent, { decodeEntities: false });
  $("head").prepend(
    `
  <script type="importmap">{ "imports": {      "@mr_hugo/boredom/dist/boreDOM.full.js": "./boreDOM.js",
       "boredom": "./boreDOM.js"
     } }</script>`
  );
  $("body").append(`
  <script src="boreDOM.js" type="module"></script>`);
  Object.keys(components).forEach((component) => {
    const componentScriptPath = buildRelativeServePath(
      componentsServeUrlPath,
      component,
      `${component}.js`
    );
    const existingComponentScript = $(`script[src*="${component}.js"]`).first();
    const componentCssPath = buildRelativeServePath(
      componentsServeUrlPath,
      component,
      `${component}.css`
    );
    if (components[component].hasJS) {
      if (existingComponentScript.length > 0) {
        existingComponentScript.attr("src", componentScriptPath);
        existingComponentScript.attr("type", "module");
      } else if ($(`script[src="${componentScriptPath}"]`).length === 0) {
        $("body").append(
          `
  <script src="${componentScriptPath}" type="module"></script>`
        );
      }
    }
    if (components[component].hasCSS) {
      const existingComponentStylesheet = $(`link[href*="${component}.css"]`).first();
      if (existingComponentStylesheet.length > 0) {
        existingComponentStylesheet.attr("href", componentCssPath);
      } else if ($(`link[href="${componentCssPath}"]`).length === 0) {
        $("head").append(
          `
  <link rel="stylesheet" href="${componentCssPath}">`
        );
      }
    }
    if ($(`template[data-component="${component}"]`).length === 0) {
      const templateMarkup = `
  ${components[component].templateTag}`;
      const firstScript = $("body > script").first();
      if (firstScript.length > 0) {
        firstScript.before(templateMarkup);
      } else {
        $("body").prepend(templateMarkup);
      }
      console.log(`Injected template for ${component}`);
    }
  });
  $("template[data-component]").each((i, el) => {
    const comp = $(el).attr("data-component");
    if (!components[comp]) {
      $(el).remove();
      console.log(`Removed unused template for ${comp}`);
    }
  });
  const prettyHtml = beautify($.html(), {
    indent_size: 2,
    space_in_empty_paren: true
  });
  const buildIndex = import_path.default.join(BUILD_DIR, "index.html");
  await import_fs_extra.default.outputFile(buildIndex, prettyHtml);
  console.log("Index updated with pretty printed HTML.");
}
async function startServer() {
  if (serverStarted) return;
  function serveFile(req, res, opts) {
    let urlPath = decodeURIComponent(req.url.split(/[?#]/)[0]);
    if (urlPath === "/" || urlPath.endsWith("/")) {
      urlPath = import_path.default.posix.join(urlPath, "index.html");
    }
    const filePath = import_path.default.join(BUILD_DIR, urlPath);
    import_fs_extra.default.pathExists(filePath).then((exists) => {
      if (!exists) {
        res.writeHead(404, { "Content-Type": "text/plain" });
        return res.end("Not Found");
      }
      const contentType = import_mime_types.default.lookup(filePath) || "application/octet-stream";
      res.writeHead(200, { "Content-Type": contentType });
      import_fs_extra.default.createReadStream(filePath).pipe(res);
    }).catch((err) => {
      res.writeHead(500, { "Content-Type": "text/plain" });
      res.end("Internal Server Error");
    });
  }
  const server = import_http.default.createServer((req, res) => {
    return serveFile(req, res, {
      cleanUrls: true,
      public: import_path.default.resolve(BUILD_DIR)
    });
  });
  let port = process.env.PORT || 8080;
  const serverHandler = () => {
    const { port: actualPort } = server.address();
    console.log(`Server running at http://localhost:${actualPort}`);
  };
  server.listen(port, serverHandler);
  server.on("error", (e) => {
    if (e.code === "EADDRINUSE") {
      console.log(
        "\x1B[33m%s\x1B[0m",
        `\u26A0\uFE0F Warning: Port ${port} in use, starting with a OS assigned port.`
      );
      setTimeout(() => {
        server.close();
        server.listen(0);
      }, 1e3);
    }
  });
  serverStarted = true;
}
async function build() {
  await import_fs_extra.default.remove(BUILD_DIR);
  await import_fs_extra.default.ensureDir(BUILD_DIR);
  await copyStatic();
  await copyBoreDOM();
  const components = await processComponents();
  await updateIndex(components);
}
async function watchFiles() {
  const pathsToWatch = [];
  if (options.index) {
    pathsToWatch.push(import_path.default.resolve(options.index));
  }
  if (options.html) {
    pathsToWatch.push(import_path.default.resolve(options.html));
  }
  const staticFolders = Array.isArray(options.static) ? options.static : [options.static].filter(Boolean);
  for (const folder of staticFolders) {
    const staticDir = import_path.default.resolve(folder);
    if (await import_fs_extra.default.pathExists(staticDir)) {
      pathsToWatch.push(staticDir);
    }
  }
  console.log("Watching for file changes in:", pathsToWatch);
  const watcher = import_chokidar.default.watch(pathsToWatch, { ignoreInitial: true });
  let rebuildTimeout;
  watcher.on("all", (event, filePath) => {
    console.log(`Detected ${event} on ${filePath}. Scheduling rebuild...`);
    if (rebuildTimeout) clearTimeout(rebuildTimeout);
    rebuildTimeout = setTimeout(() => {
      build().then(() => {
        console.log(
          `#${++numberOfRefreshes} - ${(/* @__PURE__ */ new Date()).toISOString()} - Build refreshed.`
        );
      }).catch((err) => console.error("Error during rebuild:", err));
    }, 100);
  });
}
async function main() {
  console.log("The file used as the base for HTML is:", options.index);
  const indexPath = import_path.default.join(process.cwd(), options.index);
  import_fs_extra.default.ensureFile(indexPath, (err) => {
    if (err) {
      console.log(
        "\x1B[31m%s\x1B[0m",
        `\u274C Error: The file "${indexPath}" was not found.
Please specify a location for it with "--index"`
      );
      process.exit(1);
    }
  });
  await build();
  startServer();
  await watchFiles();
}
if (!isTestMode) {
  main().catch((err) => {
    console.error(err);
    process.exit(1);
  });
}
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  BUILD_DIR,
  build,
  buildRelativeServePath,
  copyBoreDOM,
  getServePaths,
  normalizeServePath,
  options,
  processComponents,
  setServePaths,
  updateIndex
});
