#!/usr/bin/env node
"use strict";
var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
  // If the importer is in node compatibility mode or this is not an ESM
  // file that has been converted to a CommonJS file using a Babel-
  // compatible transform (i.e. "__esModule" has not been set), then set
  // "default" to the CommonJS "module.exports" for node compatibility.
  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
  mod
));
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// boreDOMCLI/generated_cli.js
var generated_cli_exports = {};
__export(generated_cli_exports, {
  BUILD_DIR: () => BUILD_DIR,
  build: () => build,
  buildRelativeServePath: () => buildRelativeServePath,
  copyBoreDOM: () => copyBoreDOM,
  getServePaths: () => getServePaths,
  normalizeServePath: () => normalizeServePath,
  options: () => options,
  processComponents: () => processComponents,
  setServePaths: () => setServePaths,
  updateIndex: () => updateIndex
});
module.exports = __toCommonJS(generated_cli_exports);
var import_fs_extra = __toESM(require("fs-extra"));
var import_mime_types = __toESM(require("mime-types"));
var import_path = __toESM(require("path"));
var glob = __toESM(require("glob"));
var cheerio = __toESM(require("cheerio"));
var import_commander = require("commander");
var import_http = __toESM(require("http"));
var import_finalhandler = __toESM(require("finalhandler"));
var import_js_beautify = __toESM(require("js-beautify"));
var import_chokidar = __toESM(require("chokidar"));
var import_serve_handler = __toESM(require("serve-handler"));
var boredom = `
dmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcE5hbWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM7CnZhciBfX2VzbSA9IChmbiwgcmVzKSA9PiBmdW5jdGlvbiBfX2luaXQoKSB7CiAgcmV0dXJuIGZuICYmIChyZXMgPSAoMCwgZm5bX19nZXRPd25Qcm9wTmFtZXMoZm4pWzBdXSkoZm4gPSAwKSksIHJlczsKfTsKdmFyIF9fZXhwb3J0ID0gKHRhcmdldCwgYWxsKSA9PiB7CiAgZm9yICh2YXIgbmFtZSBpbiBhbGwpCiAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwp9OwoKLy8gc3JjL2NvbnNvbGUtYXBpLnRzCmZ1bmN0aW9uIHNldEN1cnJlbnRBcHBTdGF0ZShzdGF0ZSwgd2ViQ29tcG9uZW50Rm4sIHJlZ2lzdGVyQ29tcG9uZW50Rm4pIHsKICBjdXJyZW50QXBwU3RhdGUgPSBzdGF0ZTsKICBpZiAod2ViQ29tcG9uZW50Rm4pIHN0b3JlZFdlYkNvbXBvbmVudCA9IHdlYkNvbXBvbmVudEZuOwogIGlmIChyZWdpc3RlckNvbXBvbmVudEZuKSBzdG9yZWRSZWdpc3RlckNvbXBvbmVudCA9IHJlZ2lzdGVyQ29tcG9uZW50Rm47Cn0KZnVuY3Rpb24gZ2V0Q3VycmVudEFwcFN0YXRlKCkgewogIHJldHVybiBjdXJyZW50QXBwU3RhdGU7Cn0KZnVuY3Rpb24gc3RvcmVDb21wb25lbnRDb250ZXh0KGVsZW1lbnQsIGNvbnRleHQyKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJhcGkiKSkgcmV0dXJuOwogIGNvbXBvbmVudENvbnRleHRzLnNldChlbGVtZW50LCBjb250ZXh0Mik7Cn0KZnVuY3Rpb24gaXNXZWJDb21wb25lbnRSZXN1bHQoZm4pIHsKICByZXR1cm4gdHlwZW9mIGZuID09PSAiZnVuY3Rpb24iICYmIGZuW1dFQl9DT01QT05FTlRfTUFSS0VSXSA9PT0gdHJ1ZTsKfQpmdW5jdGlvbiBkZWZpbmUodGFnTmFtZSwgdGVtcGxhdGUsIGxvZ2ljKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHsKICAgIGNvbnNvbGUud2FybigiW2JvcmVET01dIGRlZmluZSgpIGlzIG5vdCBhdmFpbGFibGUgaW4gcHJvZHVjdGlvbiBidWlsZCIpOwogICAgcmV0dXJuIGZhbHNlOwogIH0KICBpZiAoIWlzRGVidWdFbmFibGVkKCJhcGkiKSkgewogICAgY29uc29sZS53YXJuKCJbYm9yZURPTV0gZGVmaW5lKCkgaXMgZGlzYWJsZWQgKGRlYnVnLmFwaSBpcyBmYWxzZSkiKTsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKCFjdXJyZW50QXBwU3RhdGUpIHsKICAgIHRocm93IG5ldyBFcnJvcigiW2JvcmVET01dIENhbm5vdCBkZWZpbmUgY29tcG9uZW50IGJlZm9yZSBpbmZsaWN0Qm9yZURPTSgpIik7CiAgfQogIGlmICghdGFnTmFtZS5pbmNsdWRlcygiLSIpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYFtib3JlRE9NXSBJbnZhbGlkIHRhZyBuYW1lICIke3RhZ05hbWV9IjogbXVzdCBjb250YWluIGEgaHlwaGVuYCk7CiAgfQogIGlmIChjdXN0b21FbGVtZW50cy5nZXQodGFnTmFtZSkpIHsKICAgIHRocm93IG5ldyBFcnJvcihgW2JvcmVET01dIENvbXBvbmVudCAiJHt0YWdOYW1lfSIgaXMgYWxyZWFkeSBkZWZpbmVkYCk7CiAgfQogIGlmICghc3RvcmVkV2ViQ29tcG9uZW50IHx8ICFzdG9yZWRSZWdpc3RlckNvbXBvbmVudCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJbYm9yZURPTV0gQ29uc29sZSBBUEkgbm90IGluaXRpYWxpemVkLiBDYWxsIGluZmxpY3RCb3JlRE9NKCkgZmlyc3QuIik7CiAgfQogIGNvbnN0IGFwcFN0YXRlID0gY3VycmVudEFwcFN0YXRlOwogIGNvbnN0IHdlYkNvbXBvbmVudEZuID0gc3RvcmVkV2ViQ29tcG9uZW50OwogIGNvbnN0IHJlZ2lzdGVyQ29tcG9uZW50Rm4gPSBzdG9yZWRSZWdpc3RlckNvbXBvbmVudDsKICBjb25zdCB0ZW1wbGF0ZUVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiKTsKICB0ZW1wbGF0ZUVsLmlubmVySFRNTCA9IHRlbXBsYXRlOwogIHRlbXBsYXRlRWwuc2V0QXR0cmlidXRlKCJkYXRhLWNvbXBvbmVudCIsIHRhZ05hbWUpOwogIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGVtcGxhdGVFbCk7CiAgY29uc3QgY29tcG9uZW50TG9naWMgPSBpc1dlYkNvbXBvbmVudFJlc3VsdChsb2dpYykgPyBsb2dpYyA6IHdlYkNvbXBvbmVudEZuKGxvZ2ljKTsKICBhcHBTdGF0ZS5pbnRlcm5hbC5jb21wb25lbnRzLnNldCh0YWdOYW1lLCBjb21wb25lbnRMb2dpYyk7CiAgYXBwU3RhdGUuaW50ZXJuYWwuY3VzdG9tVGFncy5wdXNoKHRhZ05hbWUpOwogIHJlZ2lzdGVyQ29tcG9uZW50Rm4odGFnTmFtZSk7CiAgaW5pdGlhbGl6ZUV4aXN0aW5nRWxlbWVudHModGFnTmFtZSwgY29tcG9uZW50TG9naWMpOwogIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICBjb25zb2xlLmxvZygKICAgICAgIiVjXHUyNzA1IGJvcmVET006IERlZmluZWQgJWM8JXM+IiwKICAgICAgImNvbG9yOiAjMjdhZTYwOyBmb250LXdlaWdodDogYm9sZCIsCiAgICAgICJjb2xvcjogIzRlY2RjNDsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgICB0YWdOYW1lCiAgICApOwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBpbml0aWFsaXplRXhpc3RpbmdFbGVtZW50cyh0YWdOYW1lLCBsb2dpYykgewogIGlmICghY3VycmVudEFwcFN0YXRlKSByZXR1cm47CiAgY29uc3QgZWxlbWVudHMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwodGFnTmFtZSkpOwogIGNvbnN0IGZhaWxlZENvdW50ID0geyBjb3VudDogMCB9OwogIGVsZW1lbnRzLmZvckVhY2goKGVsZW0sIGluZGV4KSA9PiB7CiAgICBpZiAoZWxlbSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ICYmICJyZW5kZXJDYWxsYmFjayIgaW4gZWxlbSkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IGRldGFpbCA9IHsgaW5kZXgsIG5hbWU6IHRhZ05hbWUsIGRhdGE6IHZvaWQgMCB9OwogICAgICAgIGNvbnN0IHJlbmRlckNhbGxiYWNrID0gbG9naWMoY3VycmVudEFwcFN0YXRlLCBkZXRhaWwpOwogICAgICAgIGVsZW0ucmVuZGVyQ2FsbGJhY2sgPSByZW5kZXJDYWxsYmFjazsKICAgICAgICByZW5kZXJDYWxsYmFjayhlbGVtKTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBmYWlsZWRDb3VudC5jb3VudCsrOwogICAgICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKAogICAgICAgICAgICBgW2JvcmVET01dIEZhaWxlZCB0byBpbml0aWFsaXplIDwke3RhZ05hbWV9PiBpbnN0YW5jZSAke2luZGV4fTpgLAogICAgICAgICAgICBlcnJvcgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKICBpZiAoZmFpbGVkQ291bnQuY291bnQgPiAwICYmIGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgIGNvbnNvbGUud2FybigKICAgICAgYFtib3JlRE9NXSAke2ZhaWxlZENvdW50LmNvdW50fSBvZiAke2VsZW1lbnRzLmxlbmd0aH0gPCR7dGFnTmFtZX0+IGluc3RhbmNlcyBmYWlsZWQgdG8gaW5pdGlhbGl6ZWAKICAgICk7CiAgfQp9CmZ1bmN0aW9uIG9wZXJhdGUoc2VsZWN0b3JPckVsZW1lbnQsIGluZGV4ID0gMCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICBjb25zb2xlLndhcm4oIltib3JlRE9NXSBvcGVyYXRlKCkgaXMgbm90IGF2YWlsYWJsZSBpbiBwcm9kdWN0aW9uIGJ1aWxkIik7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoIWlzRGVidWdFbmFibGVkKCJhcGkiKSkgewogICAgY29uc29sZS53YXJuKCJbYm9yZURPTV0gb3BlcmF0ZSgpIGlzIGRpc2FibGVkIChkZWJ1Zy5hcGkgaXMgZmFsc2UpIik7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBsZXQgZWxlbWVudCA9IG51bGw7CiAgaWYgKHR5cGVvZiBzZWxlY3Rvck9yRWxlbWVudCA9PT0gInN0cmluZyIpIHsKICAgIGNvbnN0IGVsZW1lbnRzID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yT3JFbGVtZW50KSkuZmlsdGVyKChlbCkgPT4gZWwgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCk7CiAgICBlbGVtZW50ID0gZWxlbWVudHNbaW5kZXhdID8/IG51bGw7CiAgfSBlbHNlIHsKICAgIGVsZW1lbnQgPSBzZWxlY3Rvck9yRWxlbWVudDsKICB9CiAgaWYgKCFlbGVtZW50KSB7CiAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICBjb25zb2xlLndhcm4oYFtib3JlRE9NXSBvcGVyYXRlKCk6IE5vIGVsZW1lbnQgZm91bmQgZm9yICIke3NlbGVjdG9yT3JFbGVtZW50fSJgKTsKICAgIH0KICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGNvbnN0IGNvbnRleHQyID0gY29tcG9uZW50Q29udGV4dHMuZ2V0KGVsZW1lbnQpOwogIGlmICghY29udGV4dDIpIHsKICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgIGNvbnNvbGUud2FybihgW2JvcmVET01dIG9wZXJhdGUoKTogRWxlbWVudCBpcyBub3QgYSBib3JlRE9NIGNvbXBvbmVudCBvciBub3QgaW5pdGlhbGl6ZWRgKTsKICAgIH0KICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBjb250ZXh0MjsKfQpmdW5jdGlvbiBleHBvcnRDb21wb25lbnQoc2VsZWN0b3IpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgewogICAgY29uc29sZS53YXJuKCJbYm9yZURPTV0gZXhwb3J0Q29tcG9uZW50KCkgaXMgbm90IGF2YWlsYWJsZSBpbiBwcm9kdWN0aW9uIGJ1aWxkIik7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgiYXBpIikpIHsKICAgIGNvbnNvbGUud2FybigiW2JvcmVET01dIGV4cG9ydENvbXBvbmVudCgpIGlzIGRpc2FibGVkIChkZWJ1Zy5hcGkgaXMgZmFsc2UpIik7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgY29uc3QgY3R4ID0gb3BlcmF0ZShzZWxlY3Rvcik7CiAgaWYgKCFjdHgpIHJldHVybiBudWxsOwogIGNvbnN0IHRlbXBsYXRlRWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGB0ZW1wbGF0ZVtkYXRhLWNvbXBvbmVudD0iJHtjdHguZGV0YWlsLm5hbWV9Il1gKTsKICBjb25zdCB0ZW1wbGF0ZUh0bWwgPSB0ZW1wbGF0ZUVsPy5pbm5lckhUTUwgPz8gdm9pZCAwOwogIHRyeSB7CiAgICByZXR1cm4gewogICAgICBjb21wb25lbnQ6IGN0eC5kZXRhaWwubmFtZSwKICAgICAgc3RhdGU6IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlKSksCiAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZUh0bWwsCiAgICAgIHRpbWVzdGFtcDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS50b0lTT1N0cmluZygpCiAgICB9OwogIH0gY2F0Y2ggKGUpIHsKICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgIGNvbnNvbGUud2FybigKICAgICAgICBgW2JvcmVET01dIGV4cG9ydENvbXBvbmVudDogVW5hYmxlIHRvIHNlcmlhbGl6ZSBzdGF0ZSBmb3IgPCR7Y3R4LmRldGFpbC5uYW1lfT46YCwKICAgICAgICBlIGluc3RhbmNlb2YgRXJyb3IgPyBlLm1lc3NhZ2UgOiBlCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gewogICAgICBjb21wb25lbnQ6IGN0eC5kZXRhaWwubmFtZSwKICAgICAgc3RhdGU6ICJbVW5hYmxlIHRvIHNlcmlhbGl6ZSAtIGNvbnRhaW5zIGNpcmN1bGFyIHJlZmVyZW5jZXMgb3IgZnVuY3Rpb25zXSIsCiAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZUh0bWwsCiAgICAgIHRpbWVzdGFtcDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS50b0lTT1N0cmluZygpCiAgICB9OwogIH0KfQp2YXIgV0VCX0NPTVBPTkVOVF9NQVJLRVIsIGN1cnJlbnRBcHBTdGF0ZSwgc3RvcmVkV2ViQ29tcG9uZW50LCBzdG9yZWRSZWdpc3RlckNvbXBvbmVudCwgY29tcG9uZW50Q29udGV4dHMsIGNvbnNvbGVBUEk7CnZhciBpbml0X2NvbnNvbGVfYXBpID0gX19lc20oewogICJzcmMvY29uc29sZS1hcGkudHMiKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgaW5pdF9kZWJ1ZygpOwogICAgV0VCX0NPTVBPTkVOVF9NQVJLRVIgPSBTeW1ib2woImJvcmVET00ud2ViQ29tcG9uZW50Iik7CiAgICBjdXJyZW50QXBwU3RhdGUgPSBudWxsOwogICAgc3RvcmVkV2ViQ29tcG9uZW50ID0gbnVsbDsKICAgIHN0b3JlZFJlZ2lzdGVyQ29tcG9uZW50ID0gbnVsbDsKICAgIGNvbXBvbmVudENvbnRleHRzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgICBjb25zb2xlQVBJID0gewogICAgICBkZWZpbmUsCiAgICAgIG9wZXJhdGUsCiAgICAgIGV4cG9ydENvbXBvbmVudAogICAgfTsKICB9Cn0pOwoKLy8gc3JjL2luc2lkZS1vdXQudHMKZnVuY3Rpb24gY3JlYXRlUmVuZGVySGVscGVycyhjb21wb25lbnROYW1lLCBlbGVtZW50LCByZXJlbmRlcikgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICByZXR1cm4ge307CiAgfQogIGlmICghaXNEZWJ1Z0VuYWJsZWQoIm1ldGhvZE1pc3NpbmciKSkgewogICAgcmV0dXJuIHt9OwogIH0KICByZXR1cm4gbmV3IFByb3h5KHt9LCB7CiAgICBnZXQoX3RhcmdldCwgcHJvcCkgewogICAgICBpZiAodHlwZW9mIHByb3AgPT09ICJzeW1ib2wiIHx8IHByb3AgPT09ICJ0aGVuIiB8fCBwcm9wID09PSAidG9KU09OIikgewogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH0KICAgICAgaWYgKHVzZXJEZWZpbmVkSGVscGVycy5oYXMocHJvcCkpIHsKICAgICAgICByZXR1cm4gdXNlckRlZmluZWRIZWxwZXJzLmdldChwcm9wKTsKICAgICAgfQogICAgICByZXR1cm4gKC4uLmFyZ3MpID0+IHsKICAgICAgICBjb25zdCBjdHggPSB7CiAgICAgICAgICBuYW1lOiBwcm9wLAogICAgICAgICAgYXJncywKICAgICAgICAgIGNvbXBvbmVudDogY29tcG9uZW50TmFtZSwKICAgICAgICAgIGVsZW1lbnQsCiAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksCiAgICAgICAgICBkZWZpbmU6IChpbXBsKSA9PiB7CiAgICAgICAgICAgIGRlZmluZUhlbHBlcihwcm9wLCBpbXBsKTsKICAgICAgICAgICAgcmVyZW5kZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGxvZ01pc3NpbmdGdW5jdGlvbihjdHgpOwogICAgICAgIHN0b3JlTWlzc2luZ0Z1bmN0aW9uKGN0eCk7CiAgICAgICAgZXhwb3NlTWlzc2luZ0dsb2JhbHMoY3R4KTsKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9OwogICAgfSwKICAgIGhhcyhfdGFyZ2V0LCBwcm9wKSB7CiAgICAgIHJldHVybiB0eXBlb2YgcHJvcCA9PT0gInN0cmluZyIgJiYgdXNlckRlZmluZWRIZWxwZXJzLmhhcyhwcm9wKTsKICAgIH0KICB9KTsKfQpmdW5jdGlvbiBkZWZpbmVIZWxwZXIobmFtZSwgaW1wbGVtZW50YXRpb24pIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoIm1ldGhvZE1pc3NpbmciKSkgcmV0dXJuOwogIHVzZXJEZWZpbmVkSGVscGVycy5zZXQobmFtZSwgaW1wbGVtZW50YXRpb24pOwogIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICBjb25zb2xlLmxvZygKICAgICAgIiVjXHUyNzA1IGJvcmVET006IERlZmluZWQgaGVscGVyICVjJXMiLAogICAgICAiY29sb3I6ICMyN2FlNjA7IGZvbnQtd2VpZ2h0OiBib2xkIiwKICAgICAgImNvbG9yOiAjOWI1OWI2OyBmb250LXdlaWdodDogYm9sZCIsCiAgICAgIG5hbWUKICAgICk7CiAgfQp9CmZ1bmN0aW9uIGNsZWFySGVscGVyKG5hbWUpIHsKICB1c2VyRGVmaW5lZEhlbHBlcnMuZGVsZXRlKG5hbWUpOwp9CmZ1bmN0aW9uIGNsZWFyTWlzc2luZ0Z1bmN0aW9ucygpIHsKICBtaXNzaW5nRnVuY3Rpb25zLmNsZWFyKCk7CiAgbGFzdE1pc3NpbmcgPSBudWxsOwp9CmZ1bmN0aW9uIGxvZ01pc3NpbmdGdW5jdGlvbihjdHgpIHsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHJldHVybjsKICBjb25zb2xlLmxvZygKICAgICIlY1x1MjZBMFx1RkUwRiBib3JlRE9NOiBNaXNzaW5nIGZ1bmN0aW9uICVjJXMlYyBpbiA8JXM+IiwKICAgICJjb2xvcjogI2YzOWMxMjsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgImNvbG9yOiAjOWI1OWI2OyBmb250LXdlaWdodDogYm9sZCIsCiAgICBjdHgubmFtZSwKICAgICJjb2xvcjogI2YzOWMxMiIsCiAgICBjdHguY29tcG9uZW50CiAgKTsKICBpZiAoY3R4LmFyZ3MubGVuZ3RoID4gMCkgewogICAgY29uc29sZS5sb2coIiAgIEFyZ3VtZW50czoiLCBjdHguYXJncyk7CiAgfQogIGNvbnNvbGUubG9nKCIlY1x1ezFGNEExfSBEZWZpbmUgaXQ6IiwgImNvbG9yOiAjMzQ5OGRiOyBmb250LXdlaWdodDogYm9sZCIpOwogIGNvbnNvbGUubG9nKGAgICAkZGVmaW5lTWlzc2luZygoJHtnZW5lcmF0ZUFyZ05hbWVzKGN0eC5hcmdzKX0pID0+IHsgLi4uIH0pYCk7CiAgY29uc29sZS5sb2coCiAgICBgICAgYm9yZURPTS5kZWZpbmVIZWxwZXIoJyR7Y3R4Lm5hbWV9JywgKCR7Z2VuZXJhdGVBcmdOYW1lcyhjdHguYXJncyl9KSA9PiB7IC4uLiB9KWAKICApOwp9CmZ1bmN0aW9uIGdlbmVyYXRlQXJnTmFtZXMoYXJncykgewogIGlmIChhcmdzLmxlbmd0aCA9PT0gMCkgcmV0dXJuICIiOwogIHJldHVybiBhcmdzLm1hcCgoYXJnLCBpKSA9PiB7CiAgICBpZiAoYXJnID09PSBudWxsIHx8IGFyZyA9PT0gdm9pZCAwKSByZXR1cm4gYGFyZyR7aX1gOwogICAgaWYgKEFycmF5LmlzQXJyYXkoYXJnKSkgcmV0dXJuICJpdGVtcyI7CiAgICBpZiAodHlwZW9mIGFyZyA9PT0gIm9iamVjdCIpIHsKICAgICAgaWYgKCJuYW1lIiBpbiBhcmcgJiYgImVtYWlsIiBpbiBhcmcpIHJldHVybiAidXNlciI7CiAgICAgIGlmICgiaWQiIGluIGFyZyAmJiAidGl0bGUiIGluIGFyZykgcmV0dXJuICJpdGVtIjsKICAgICAgaWYgKCJpZCIgaW4gYXJnKSByZXR1cm4gInJlY29yZCI7CiAgICAgIHJldHVybiAiZGF0YSI7CiAgICB9CiAgICBpZiAodHlwZW9mIGFyZyA9PT0gInN0cmluZyIpIHJldHVybiAidGV4dCI7CiAgICBpZiAodHlwZW9mIGFyZyA9PT0gIm51bWJlciIpIHJldHVybiAiY291bnQiOwogICAgaWYgKHR5cGVvZiBhcmcgPT09ICJib29sZWFuIikgcmV0dXJuICJmbGFnIjsKICAgIHJldHVybiBgYXJnJHtpfWA7CiAgfSkuam9pbigiLCAiKTsKfQpmdW5jdGlvbiBzdG9yZU1pc3NpbmdGdW5jdGlvbihjdHgpIHsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJlcnJvckhpc3RvcnkiKSkgcmV0dXJuOwogIGNvbnN0IGV4aXN0aW5nID0gbWlzc2luZ0Z1bmN0aW9ucy5nZXQoY3R4Lm5hbWUpIHx8IFtdOwogIGlmIChleGlzdGluZy5sZW5ndGggPj0gMTApIHsKICAgIGV4aXN0aW5nLnNoaWZ0KCk7CiAgfQogIGV4aXN0aW5nLnB1c2goY3R4KTsKICBtaXNzaW5nRnVuY3Rpb25zLnNldChjdHgubmFtZSwgZXhpc3RpbmcpOwogIGxhc3RNaXNzaW5nID0gY3R4Owp9CmZ1bmN0aW9uIGV4cG9zZU1pc3NpbmdHbG9iYWxzKGN0eCkgewogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImdsb2JhbHMiKSkgcmV0dXJuOwogIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgcmV0dXJuOwogIGNvbnN0IHcgPSB3aW5kb3c7CiAgdy4kbWlzc2luZ05hbWUgPSBjdHgubmFtZTsKICB3LiRtaXNzaW5nQXJncyA9IGN0eC5hcmdzOwogIHcuJG1pc3NpbmdDb21wb25lbnQgPSBjdHguY29tcG9uZW50OwogIHcuJGRlZmluZU1pc3NpbmcgPSBjdHguZGVmaW5lOwp9CmZ1bmN0aW9uIGluZmVyVGVtcGxhdGUodGFnTmFtZSwgZWxlbWVudCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSByZXR1cm4gbnVsbDsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJ0ZW1wbGF0ZUluZmVyZW5jZSIpKSByZXR1cm4gbnVsbDsKICBpZiAoaXNEZWJ1Z0VuYWJsZWQoInN0cmljdCIpKSByZXR1cm4gbnVsbDsKICBjb25zdCBwcm9wcyA9IHt9OwogIGNvbnN0IHNsb3RzID0gW107CiAgaWYgKGVsZW1lbnQpIHsKICAgIGZvciAoY29uc3QgYXR0ciBvZiBBcnJheS5mcm9tKGVsZW1lbnQuYXR0cmlidXRlcykpIHsKICAgICAgaWYgKGF0dHIubmFtZS5zdGFydHNXaXRoKCJkYXRhLSIpKSBjb250aW51ZTsKICAgICAgaWYgKFsiY2xhc3MiLCAiaWQiLCAic3R5bGUiXS5pbmNsdWRlcyhhdHRyLm5hbWUpKSBjb250aW51ZTsKICAgICAgY29uc3QgY2FtZWxOYW1lID0ga2ViYWJUb0NhbWVsKGF0dHIubmFtZSk7CiAgICAgIHByb3BzW2NhbWVsTmFtZV0gPSBwYXJzZUF0dHJpYnV0ZVZhbHVlKGF0dHIudmFsdWUpOwogICAgfQogICAgZm9yIChjb25zdCBjaGlsZCBvZiBBcnJheS5mcm9tKGVsZW1lbnQuY2hpbGRyZW4pKSB7CiAgICAgIGNvbnN0IHNsb3ROYW1lID0gY2hpbGQuZ2V0QXR0cmlidXRlKCJzbG90Iik7CiAgICAgIGlmIChzbG90TmFtZSAmJiAhc2xvdHMuaW5jbHVkZXMoc2xvdE5hbWUpKSB7CiAgICAgICAgc2xvdHMucHVzaChzbG90TmFtZSk7CiAgICAgIH0KICAgIH0KICB9CiAgY29uc3QgcHJvcHNTbG90cyA9IE9iamVjdC5rZXlzKHByb3BzKS5tYXAoKHApID0+IGAgICAgPHNsb3QgbmFtZT0iJHtjYW1lbFRvS2ViYWIocCl9Ij4ke2Zvcm1hdFZhbHVlKHByb3BzW3BdKX08L3Nsb3Q+YCkuam9pbigiXG4iKTsKICBjb25zdCBkZWZhdWx0U2xvdCA9IHNsb3RzLmxlbmd0aCA9PT0gMCAmJiBPYmplY3Qua2V5cyhwcm9wcykubGVuZ3RoID09PSAwID8gJyAgICA8c2xvdCBuYW1lPSJjb250ZW50Ij5Mb2FkaW5nLi4uPC9zbG90PicgOiAiIjsKICBjb25zdCB0ZW1wbGF0ZSA9IGA8ZGl2IGNsYXNzPSIke3RhZ05hbWV9LXNrZWxldG9uIiBkYXRhLWluZmVycmVkPgoke3Byb3BzU2xvdHMgfHwgZGVmYXVsdFNsb3R9CiAgPC9kaXY+YDsKICByZXR1cm4geyB0YWdOYW1lLCB0ZW1wbGF0ZSwgcHJvcHMsIHNsb3RzIH07Cn0KZnVuY3Rpb24gcmVnaXN0ZXJJbmZlcnJlZENvbXBvbmVudCh0YWdOYW1lLCBlbGVtZW50KSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybiBmYWxzZTsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJ0ZW1wbGF0ZUluZmVyZW5jZSIpKSByZXR1cm4gZmFsc2U7CiAgaWYgKGN1c3RvbUVsZW1lbnRzLmdldCh0YWdOYW1lKSkgcmV0dXJuIGZhbHNlOwogIGlmICghZ2V0Q3VycmVudEFwcFN0YXRlKCkpIHJldHVybiBmYWxzZTsKICBjb25zdCBpbmZlcmVuY2UgPSBpbmZlclRlbXBsYXRlKHRhZ05hbWUsIGVsZW1lbnQpOwogIGlmICghaW5mZXJlbmNlKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgeyB0ZW1wbGF0ZSwgcHJvcHMgfSA9IGluZmVyZW5jZTsKICBpbmZlcnJlZFRlbXBsYXRlcy5zZXQodGFnTmFtZSwgaW5mZXJlbmNlKTsKICBsb2dJbmZlcnJlZENvbXBvbmVudCh0YWdOYW1lLCBwcm9wcyk7CiAgdHJ5IHsKICAgIGRlZmluZSgKICAgICAgdGFnTmFtZSwKICAgICAgdGVtcGxhdGUsCiAgICAgIC8vIFN0dWIgcmVuZGVyIHRoYXQgbG9ncyB3aGF0IGl0IHJlY2VpdmVzCiAgICAgICh7IHN0YXRlIH0pID0+ICh7IHNsb3RzIH0pID0+IHsKICAgICAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICAgICAgY29uc29sZS5sb2coCiAgICAgICAgICAgICIlY1x1ezFGNTJFfSBib3JlRE9NOiBJbmZlcnJlZCA8JXM+IHJlbmRlcmluZyIsCiAgICAgICAgICAgICJjb2xvcjogIzliNTliNjsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgICAgICAgICB0YWdOYW1lCiAgICAgICAgICApOwogICAgICAgICAgY29uc29sZS5sb2coIiAgIEluZmVycmVkIHByb3BzOiIsIHByb3BzKTsKICAgICAgICAgIGNvbnNvbGUubG9nKCIgICBBcHAgc3RhdGU6Iiwgc3RhdGUpOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhwcm9wcykpIHsKICAgICAgICAgIGNvbnN0IHNsb3RLZXkgPSBjYW1lbFRvS2ViYWIoa2V5KTsKICAgICAgICAgIGlmIChzbG90c1tzbG90S2V5XSkgewogICAgICAgICAgICBzbG90c1tzbG90S2V5XSA9IFN0cmluZyh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICApOwogICAgcmV0dXJuIHRydWU7CiAgfSBjYXRjaCAoZSkgewogICAgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgICAgY29uc29sZS53YXJuKGBbYm9yZURPTV0gRmFpbGVkIHRvIHJlZ2lzdGVyIGluZmVycmVkIDwke3RhZ05hbWV9PjpgLCBlKTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9Cn0KZnVuY3Rpb24gbG9nSW5mZXJyZWRDb21wb25lbnQodGFnTmFtZSwgcHJvcHMpIHsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHJldHVybjsKICBjb25zb2xlLmxvZygKICAgICIlY1x1ezFGNTJFfSBib3JlRE9NOiBJbmZlcnJpbmcgdGVtcGxhdGUgZm9yICVjPCVzPiIsCiAgICAiY29sb3I6ICM5YjU5YjY7IGZvbnQtd2VpZ2h0OiBib2xkIiwKICAgICJjb2xvcjogIzRlY2RjNDsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgdGFnTmFtZQogICk7CiAgaWYgKE9iamVjdC5rZXlzKHByb3BzKS5sZW5ndGggPiAwKSB7CiAgICBjb25zb2xlLmxvZygiJWNcdXsxRjRDQn0gSW5mZXJyZWQgcHJvcHMgZnJvbSBhdHRyaWJ1dGVzOiIsICJjb2xvcjogIzk1YTVhNiIpOwogICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMocHJvcHMpKSB7CiAgICAgIGNvbnNvbGUubG9nKGAgICAke2tleX06ICR7SlNPTi5zdHJpbmdpZnkodmFsdWUpfWApOwogICAgfQogIH0KICBjb25zb2xlLmxvZygiJWNcdXsxRjRBMX0gRGVmaW5lIHByb3Blcmx5IHdpdGg6IiwgImNvbG9yOiAjMzQ5OGRiOyBmb250LXdlaWdodDogYm9sZCIpOwogIGNvbnNvbGUubG9nKAogICAgYCAgIGJvcmVET00uZGVmaW5lKCcke3RhZ05hbWV9JywgJzx5b3VyIHRlbXBsYXRlPicsICh7IHN0YXRlIH0pID0+ICh7IHNsb3RzIH0pID0+IHsgLi4uIH0pYAogICk7Cn0KZnVuY3Rpb24gb2JzZXJ2ZVVuZGVmaW5lZEVsZW1lbnRzKCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSByZXR1cm47CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgidGVtcGxhdGVJbmZlcmVuY2UiKSkgcmV0dXJuOwogIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgcmV0dXJuOwogIGlmICh0ZW1wbGF0ZU9ic2VydmVyKSByZXR1cm47CiAgdGVtcGxhdGVPYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKChtdXRhdGlvbnMpID0+IHsKICAgIGZvciAoY29uc3QgbXV0YXRpb24gb2YgbXV0YXRpb25zKSB7CiAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiBBcnJheS5mcm9tKG11dGF0aW9uLmFkZGVkTm9kZXMpKSB7CiAgICAgICAgaWYgKG5vZGUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCAmJiBub2RlLnRhZ05hbWUuaW5jbHVkZXMoIi0iKSkgewogICAgICAgICAgY29uc3QgdGFnTmFtZSA9IG5vZGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgaWYgKCFjdXN0b21FbGVtZW50cy5nZXQodGFnTmFtZSkpIHsKICAgICAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKAogICAgICAgICAgICAgIGB0ZW1wbGF0ZVtkYXRhLWNvbXBvbmVudD0iJHt0YWdOYW1lfSJdYAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgICAgICAgICAgcXVldWVNaWNyb3Rhc2soKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFjdXN0b21FbGVtZW50cy5nZXQodGFnTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgcmVnaXN0ZXJJbmZlcnJlZENvbXBvbmVudCh0YWdOYW1lLCBub2RlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwogIHRlbXBsYXRlT2JzZXJ2ZXIub2JzZXJ2ZShkb2N1bWVudC5ib2R5LCB7CiAgICBjaGlsZExpc3Q6IHRydWUsCiAgICBzdWJ0cmVlOiB0cnVlCiAgfSk7Cn0KZnVuY3Rpb24ga2ViYWJUb0NhbWVsKHN0cikgewogIHJldHVybiBzdHIucmVwbGFjZSgvLShbYS16XSkvZywgKF8sIGxldHRlcikgPT4gbGV0dGVyLnRvVXBwZXJDYXNlKCkpOwp9CmZ1bmN0aW9uIGNhbWVsVG9LZWJhYihzdHIpIHsKICByZXR1cm4gc3RyLnJlcGxhY2UoLyhbQS1aXSkvZywgIi0kMSIpLnRvTG93ZXJDYXNlKCk7Cn0KZnVuY3Rpb24gcGFyc2VBdHRyaWJ1dGVWYWx1ZSh2YWx1ZSkgewogIGlmICh2YWx1ZSA9PT0gInRydWUiKSByZXR1cm4gdHJ1ZTsKICBpZiAodmFsdWUgPT09ICJmYWxzZSIpIHJldHVybiBmYWxzZTsKICBjb25zdCBudW0gPSBOdW1iZXIodmFsdWUpOwogIGlmICghaXNOYU4obnVtKSAmJiB2YWx1ZSAhPT0gIiIpIHJldHVybiBudW07CiAgaWYgKHZhbHVlLnN0YXJ0c1dpdGgoInsiKSB8fCB2YWx1ZS5zdGFydHNXaXRoKCJbIikpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgIH0gY2F0Y2ggewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgfQogIHJldHVybiB2YWx1ZTsKfQpmdW5jdGlvbiBmb3JtYXRWYWx1ZSh2YWx1ZSkgewogIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdm9pZCAwKSByZXR1cm4gIiI7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7CiAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7Cn0KdmFyIHVzZXJEZWZpbmVkSGVscGVycywgbWlzc2luZ0Z1bmN0aW9ucywgbGFzdE1pc3NpbmcsIGluZmVycmVkVGVtcGxhdGVzLCB0ZW1wbGF0ZU9ic2VydmVyLCBpbnNpZGVPdXRBUEk7CnZhciBpbml0X2luc2lkZV9vdXQgPSBfX2VzbSh7CiAgInNyYy9pbnNpZGUtb3V0LnRzIigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGluaXRfZGVidWcoKTsKICAgIGluaXRfY29uc29sZV9hcGkoKTsKICAgIHVzZXJEZWZpbmVkSGVscGVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBtaXNzaW5nRnVuY3Rpb25zID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGxhc3RNaXNzaW5nID0gbnVsbDsKICAgIGluZmVycmVkVGVtcGxhdGVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIHRlbXBsYXRlT2JzZXJ2ZXIgPSBudWxsOwogICAgaW5zaWRlT3V0QVBJID0gewogICAgICAvKiogTWFwIG9mIG1pc3NpbmcgZnVuY3Rpb24gY2FsbHMgYnkgZnVuY3Rpb24gbmFtZSAqLwogICAgICBnZXQgbWlzc2luZ0Z1bmN0aW9ucygpIHsKICAgICAgICByZXR1cm4gbWlzc2luZ0Z1bmN0aW9uczsKICAgICAgfSwKICAgICAgLyoqIE1vc3QgcmVjZW50IG1pc3NpbmcgZnVuY3Rpb24gY29udGV4dCAqLwogICAgICBnZXQgbGFzdE1pc3NpbmcoKSB7CiAgICAgICAgcmV0dXJuIGxhc3RNaXNzaW5nOwogICAgICB9LAogICAgICAvKiogRGVmaW5lIGEgaGVscGVyIGZ1bmN0aW9uIGF2YWlsYWJsZSB0byBhbGwgcmVuZGVyIGZ1bmN0aW9ucyAqLwogICAgICBkZWZpbmVIZWxwZXIsCiAgICAgIC8qKiBHZXQgYWxsIGRlZmluZWQgaGVscGVycyAqLwogICAgICBnZXQgaGVscGVycygpIHsKICAgICAgICByZXR1cm4gbmV3IE1hcCh1c2VyRGVmaW5lZEhlbHBlcnMpOwogICAgICB9LAogICAgICAvKiogQ2xlYXIgYSBoZWxwZXIgZGVmaW5pdGlvbiAqLwogICAgICBjbGVhckhlbHBlciwKICAgICAgLyoqIENsZWFyIGFsbCBtaXNzaW5nIGZ1bmN0aW9uIHJlY29yZHMgKi8KICAgICAgY2xlYXJNaXNzaW5nRnVuY3Rpb25zLAogICAgICAvKiogTWFwIG9mIGluZmVycmVkIHRlbXBsYXRlcyBieSB0YWcgbmFtZSAqLwogICAgICBnZXQgaW5mZXJyZWRUZW1wbGF0ZXMoKSB7CiAgICAgICAgcmV0dXJuIGluZmVycmVkVGVtcGxhdGVzOwogICAgICB9LAogICAgICAvKiogTWFudWFsbHkgaW5mZXIgdGVtcGxhdGUgZm9yIGEgdGFnICh1c2VmdWwgZm9yIHRlc3RpbmcpICovCiAgICAgIGluZmVyVGVtcGxhdGUKICAgIH07CiAgfQp9KTsKCi8vIHNyYy92ZXJzaW9uLnRzCnZhciBWRVJTSU9OOwp2YXIgaW5pdF92ZXJzaW9uID0gX19lc20oewogICJzcmMvdmVyc2lvbi50cyIoKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBWRVJTSU9OID0gIjAuMjUuMjUiOwogIH0KfSk7CgovLyBzcmMvbGxtLnRzCnZhciBsbG1fZXhwb3J0cyA9IHt9OwpfX2V4cG9ydChsbG1fZXhwb3J0cywgewogIGNsZWFyQXR0ZW1wdHM6ICgpID0+IGNsZWFyQXR0ZW1wdHMsCiAgY29udGV4dDogKCkgPT4gY29udGV4dCwKICBjb3B5OiAoKSA9PiBjb3B5LAogIGZvY3VzOiAoKSA9PiBmb2N1cywKICBmb3JtYXRFcnJvckZvckxMTTogKCkgPT4gZm9ybWF0RXJyb3JGb3JMTE0sCiAgZ2V0QXR0ZW1wdHM6ICgpID0+IGdldEF0dGVtcHRzLAogIGlzTExNT3V0cHV0Rm9ybWF0OiAoKSA9PiBpc0xMTU91dHB1dEZvcm1hdCwKICBsbG1BUEk6ICgpID0+IGxsbUFQSSwKICBsbG1Mb2c6ICgpID0+IGxsbUxvZywKICByZWNvcmRBdHRlbXB0OiAoKSA9PiByZWNvcmRBdHRlbXB0Cn0pOwpmdW5jdGlvbiBpc1NhbWVPYmplY3QoYSwgYikgewogIGlmIChhID09PSBiKSByZXR1cm4gdHJ1ZTsKICBpZiAoIWEgfHwgIWIpIHJldHVybiBmYWxzZTsKICBpZiAodHlwZW9mIGEgIT09ICJvYmplY3QiIHx8IHR5cGVvZiBiICE9PSAib2JqZWN0IikgcmV0dXJuIGZhbHNlOwogIHRyeSB7CiAgICBjb25zdCBtYXJrZXIgPSBEYXRlLm5vdygpICsgTWF0aC5yYW5kb20oKTsKICAgIGFbQ0lSQ1VMQVJfQ0hFQ0tdID0gbWFya2VyOwogICAgY29uc3Qgc2FtZSA9IGJbQ0lSQ1VMQVJfQ0hFQ0tdID09PSBtYXJrZXI7CiAgICBkZWxldGUgYVtDSVJDVUxBUl9DSEVDS107CiAgICByZXR1cm4gc2FtZTsKICB9IGNhdGNoIHsKICAgIHJldHVybiBmYWxzZTsKICB9Cn0KZnVuY3Rpb24gZ2V0U3RhdGVQYXRocyhvYmosIHByZWZpeCA9ICIiLCBzZWVuID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCkpIHsKICBjb25zdCBwYXRocyA9IFtdOwogIGlmIChvYmogPT09IG51bGwgfHwgb2JqID09PSB2b2lkIDApIHJldHVybiBwYXRoczsKICBpZiAodHlwZW9mIG9iaiAhPT0gIm9iamVjdCIpIHJldHVybiBwYXRoczsKICBpZiAoc2Vlbi5oYXMob2JqKSkgcmV0dXJuIHBhdGhzOwogIHNlZW4uYWRkKG9iaik7CiAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMob2JqKSkgewogICAgY29uc3QgcGF0aCA9IHByZWZpeCA/IGAke3ByZWZpeH0uJHtrZXl9YCA6IGtleTsKICAgIHBhdGhzLnB1c2gocGF0aCk7CiAgICBjb25zdCB2YWx1ZSA9IG9ialtrZXldOwogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgIHBhdGhzLnB1c2goYCR7cGF0aH1bXWApOwogICAgICBpZiAodmFsdWUubGVuZ3RoID4gMCAmJiB0eXBlb2YgdmFsdWVbMF0gPT09ICJvYmplY3QiICYmIHZhbHVlWzBdICE9PSBudWxsKSB7CiAgICAgICAgcGF0aHMucHVzaCguLi5nZXRTdGF0ZVBhdGhzKHZhbHVlWzBdLCBgJHtwYXRofVswXWAsIHNlZW4pKTsKICAgICAgfQogICAgfSBlbHNlIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiKSB7CiAgICAgIHBhdGhzLnB1c2goLi4uZ2V0U3RhdGVQYXRocyh2YWx1ZSwgcGF0aCwgc2VlbikpOwogICAgfQogIH0KICByZXR1cm4gcGF0aHM7Cn0KZnVuY3Rpb24gaW5mZXJUeXBlU2hhcGUob2JqLCBzZWVuID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCkpIHsKICBpZiAob2JqID09PSBudWxsKSByZXR1cm4gIm51bGwiOwogIGlmIChvYmogPT09IHZvaWQgMCkgcmV0dXJuICJ1bmRlZmluZWQiOwogIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKICAgIGlmIChvYmoubGVuZ3RoID09PSAwKSByZXR1cm4gImFueVtdIjsKICAgIGNvbnN0IGVsZW1UeXBlID0gaW5mZXJUeXBlU2hhcGUob2JqWzBdLCBzZWVuKTsKICAgIHJldHVybiBgJHtlbGVtVHlwZX1bXWA7CiAgfQogIGlmICh0eXBlb2Ygb2JqID09PSAib2JqZWN0IikgewogICAgaWYgKHNlZW4uaGFzKG9iaikpIHJldHVybiAiLyogY2lyY3VsYXIgKi8iOwogICAgc2Vlbi5hZGQob2JqKTsKICAgIGNvbnN0IHByb3BzID0gT2JqZWN0LmVudHJpZXMob2JqKS5tYXAoKFtrLCB2XSkgPT4gYCAgJHtrfTogJHtpbmZlclR5cGVTaGFwZSh2LCBzZWVuKX1gKS5qb2luKCJcbiIpOwogICAgcmV0dXJuIGB7CiR7cHJvcHN9Cn1gOwogIH0KICByZXR1cm4gdHlwZW9mIG9iajsKfQpmdW5jdGlvbiBzYW5pdGl6ZVN0YXRlKHN0YXRlLCBzZWVuID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCksIHJvb3QpIHsKICBpZiAoc3RhdGUgPT09IG51bGwgfHwgc3RhdGUgPT09IHZvaWQgMCkgcmV0dXJuIHN0YXRlOwogIGlmICh0eXBlb2Ygc3RhdGUgIT09ICJvYmplY3QiKSByZXR1cm4gc3RhdGU7CiAgaWYgKHR5cGVvZiBzdGF0ZSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuICJbRnVuY3Rpb25dIjsKICBpZiAodHlwZW9mIHN0YXRlID09PSAic3ltYm9sIikgcmV0dXJuICJbU3ltYm9sXSI7CiAgaWYgKHN0YXRlIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuIHN0YXRlLnRvSVNPU3RyaW5nKCk7CiAgaWYgKHN0YXRlIGluc3RhbmNlb2YgUmVnRXhwKSByZXR1cm4gc3RhdGUudG9TdHJpbmcoKTsKICBpZiAoc3RhdGUgaW5zdGFuY2VvZiBNYXApIHJldHVybiAiW01hcF0iOwogIGlmIChzdGF0ZSBpbnN0YW5jZW9mIFNldCkgcmV0dXJuICJbU2V0XSI7CiAgaWYgKHJvb3QgPT09IHZvaWQgMCkgcm9vdCA9IHN0YXRlOwogIGlmIChzZWVuLmhhcyhzdGF0ZSkpIHJldHVybiAiW0NpcmN1bGFyXSI7CiAgc2Vlbi5hZGQoc3RhdGUpOwogIGNvbnN0IHNhbml0aXplZCA9IEFycmF5LmlzQXJyYXkoc3RhdGUpID8gW10gOiB7fTsKICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhzdGF0ZSkpIHsKICAgIGNvbnN0IGlzU2Vuc2l0aXZlID0gU0VOU0lUSVZFX0tFWVMuc29tZSgKICAgICAgKHMpID0+IGtleS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHMudG9Mb3dlckNhc2UoKSkKICAgICk7CiAgICBpZiAoaXNTZW5zaXRpdmUpIHsKICAgICAgc2FuaXRpemVkW2tleV0gPSAiW1JFREFDVEVEXSI7CiAgICB9IGVsc2UgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHsKICAgICAgaWYgKGlzU2FtZU9iamVjdCh2YWx1ZSwgcm9vdCkpIHsKICAgICAgICBzYW5pdGl6ZWRba2V5XSA9ICJbQ2lyY3VsYXJdIjsKICAgICAgfSBlbHNlIGlmIChzZWVuLmhhcyh2YWx1ZSkpIHsKICAgICAgICBzYW5pdGl6ZWRba2V5XSA9ICJbQ2lyY3VsYXJdIjsKICAgICAgfSBlbHNlIHsKICAgICAgICBzYW5pdGl6ZWRba2V5XSA9IHNhbml0aXplU3RhdGUodmFsdWUsIHNlZW4sIHJvb3QpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICBzYW5pdGl6ZWRba2V5XSA9ICJbRnVuY3Rpb25dIjsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAic3ltYm9sIikgewogICAgICBzYW5pdGl6ZWRba2V5XSA9ICJbU3ltYm9sXSI7CiAgICB9IGVsc2UgewogICAgICBzYW5pdGl6ZWRba2V5XSA9IHZhbHVlOwogICAgfQogIH0KICByZXR1cm4gc2FuaXRpemVkOwp9CmZ1bmN0aW9uIGdlbmVyYXRlU3VnZ2VzdGlvbihjdHgpIHsKICBjb25zdCBtc2cgPSBjdHguZXJyb3IubWVzc2FnZS50b0xvd2VyQ2FzZSgpOwogIGlmIChtc2cuaW5jbHVkZXMoInVuZGVmaW5lZCIpICYmIG1zZy5pbmNsdWRlcygicmVhZGluZyIpKSB7CiAgICBjb25zdCBtYXRjaCA9IG1zZy5tYXRjaCgvcmVhZGluZyAnKFx3KyknLyk7CiAgICBpZiAobWF0Y2gpIHsKICAgICAgcmV0dXJuIGBQcm9wZXJ0eSBhY2Nlc3Mgb24gbnVsbC91bmRlZmluZWQuIEFkZCBudWxsIGNoZWNrIGJlZm9yZSBhY2Nlc3NpbmcgJyR7bWF0Y2hbMV19JyBvciBpbml0aWFsaXplIHRoZSB2YWx1ZS5gOwogICAgfQogIH0KICBpZiAobXNnLmluY2x1ZGVzKCJpcyBub3QgYSBmdW5jdGlvbiIpKSB7CiAgICBjb25zdCBtYXRjaCA9IG1zZy5tYXRjaCgvKFx3KykgaXMgbm90IGEgZnVuY3Rpb24vKTsKICAgIGlmIChtYXRjaCkgewogICAgICByZXR1cm4gYCcke21hdGNoWzFdfScgaXMgbm90IGEgZnVuY3Rpb24uIENoZWNrIGlmIGl0J3MgZGVmaW5lZCwgaW1wb3J0ZWQsIG9yIGlmIHRoZSBvYmplY3QgZXhpc3RzLmA7CiAgICB9CiAgfQogIGlmIChtc2cuaW5jbHVkZXMoIm1hcCIpIHx8IG1zZy5pbmNsdWRlcygiZmlsdGVyIikgfHwgbXNnLmluY2x1ZGVzKCJmb3JlYWNoIikpIHsKICAgIHJldHVybiAiQXJyYXkgbWV0aG9kIGNhbGxlZCBvbiBub24tYXJyYXkuIEluaXRpYWxpemUgYXMgZW1wdHkgYXJyYXkgb3IgYWRkIHR5cGUgY2hlY2suIjsKICB9CiAgaWYgKG1zZy5pbmNsdWRlcygibnVsbCIpIHx8IG1zZy5pbmNsdWRlcygidW5kZWZpbmVkIikpIHsKICAgIHJldHVybiAiTnVsbC91bmRlZmluZWQgdmFsdWUgZW5jb3VudGVyZWQuIEFkZCBkZWZlbnNpdmUgY2hlY2tzIG9yIGluaXRpYWxpemUgZGF0YS4iOwogIH0KICByZXR1cm4gIkNoZWNrIHRoZSBlcnJvciBtZXNzYWdlIGFuZCBjb21wb25lbnQgc3RhdGUgZm9yIHRoZSByb290IGNhdXNlLiI7Cn0KZnVuY3Rpb24gZ2V0RXJyb3JNYXAoKSB7CiAgcmV0dXJuIGRlYnVnQVBJLmVycm9yczsKfQpmdW5jdGlvbiBnZXRNaXNzaW5nRnVuY3Rpb25zTWFwKCkgewogIHJldHVybiBpbnNpZGVPdXRBUEkubWlzc2luZ0Z1bmN0aW9uczsKfQpmdW5jdGlvbiBnZXREZWZpbmVkSGVscGVyc01hcCgpIHsKICByZXR1cm4gaW5zaWRlT3V0QVBJLmhlbHBlcnM7Cn0KZnVuY3Rpb24gZ2V0TWlzc2luZ0NvbXBvbmVudHMoKSB7CiAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBbXTsKICBjb25zdCBtaXNzaW5nID0gW107CiAgY29uc3QgYWxsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgiKiIpOwogIGZvciAoY29uc3QgZWwgb2YgQXJyYXkuZnJvbShhbGwpKSB7CiAgICBjb25zdCB0YWcgPSBlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICBpZiAodGFnLmluY2x1ZGVzKCItIikgJiYgIWN1c3RvbUVsZW1lbnRzLmdldCh0YWcpKSB7CiAgICAgIGlmICghbWlzc2luZy5pbmNsdWRlcyh0YWcpKSB7CiAgICAgICAgbWlzc2luZy5wdXNoKHRhZyk7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG1pc3Npbmc7Cn0KZnVuY3Rpb24gZ2V0UmVnaXN0ZXJlZENvbXBvbmVudHMoKSB7CiAgY29uc3QgYXBwU3RhdGUgPSBnZXRDdXJyZW50QXBwU3RhdGUoKTsKICBpZiAoIWFwcFN0YXRlKSByZXR1cm4gW107CiAgcmV0dXJuIGFwcFN0YXRlLmludGVybmFsLmN1c3RvbVRhZ3MgfHwgW107Cn0KZnVuY3Rpb24gZ2V0Q29tcG9uZW50VGVtcGxhdGUodGFnTmFtZSkgewogIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gbnVsbDsKICBjb25zdCB0ZW1wbGF0ZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYHRlbXBsYXRlW2RhdGEtY29tcG9uZW50PSIke3RhZ05hbWV9Il1gKTsKICByZXR1cm4gdGVtcGxhdGU/LmlubmVySFRNTCA/PyBudWxsOwp9CmZ1bmN0aW9uIGNvdW50Q29tcG9uZW50SW5zdGFuY2VzKHRhZ05hbWUpIHsKICBpZiAodHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIikgcmV0dXJuIDA7CiAgcmV0dXJuIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwodGFnTmFtZSkubGVuZ3RoOwp9CmZ1bmN0aW9uIGJ1aWxkQ29tcG9uZW50SW5mbyh0YWdOYW1lKSB7CiAgY29uc3QgYXBwU3RhdGUgPSBnZXRDdXJyZW50QXBwU3RhdGUoKTsKICBjb25zdCBoYXNMb2dpYyA9IGFwcFN0YXRlPy5pbnRlcm5hbC5jb21wb25lbnRzLmhhcyh0YWdOYW1lKSA/PyBmYWxzZTsKICBjb25zdCB0ZW1wbGF0ZSA9IGdldENvbXBvbmVudFRlbXBsYXRlKHRhZ05hbWUpOwogIGNvbnN0IGluc3RhbmNlQ291bnQgPSBjb3VudENvbXBvbmVudEluc3RhbmNlcyh0YWdOYW1lKTsKICBjb25zdCBlcnJvcnMyID0gZ2V0RXJyb3JNYXAoKTsKICBjb25zdCBoYXNFcnJvciA9IGVycm9yczIuaGFzKHRhZ05hbWUpOwogIGNvbnN0IHJlZnMgPSBbXTsKICBjb25zdCBzbG90cyA9IFtdOwogIGlmICh0ZW1wbGF0ZSkgewogICAgY29uc3QgdGVtcERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdGVtcERpdi5pbm5lckhUTUwgPSB0ZW1wbGF0ZTsKICAgIHRlbXBEaXYucXVlcnlTZWxlY3RvckFsbCgiW2RhdGEtcmVmXSIpLmZvckVhY2goKGVsKSA9PiB7CiAgICAgIGNvbnN0IHJlZk5hbWUgPSBlbC5nZXRBdHRyaWJ1dGUoImRhdGEtcmVmIik7CiAgICAgIGlmIChyZWZOYW1lKSByZWZzLnB1c2gocmVmTmFtZSk7CiAgICB9KTsKICAgIHRlbXBEaXYucXVlcnlTZWxlY3RvckFsbCgiW2RhdGEtc2xvdF0sIHNsb3RbbmFtZV0iKS5mb3JFYWNoKChlbCkgPT4gewogICAgICBjb25zdCBzbG90TmFtZSA9IGVsLmdldEF0dHJpYnV0ZSgiZGF0YS1zbG90IikgfHwgZWwuZ2V0QXR0cmlidXRlKCJuYW1lIik7CiAgICAgIGlmIChzbG90TmFtZSkgc2xvdHMucHVzaChzbG90TmFtZSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIHsKICAgIHRhZ05hbWUsCiAgICB0ZW1wbGF0ZSwKICAgIGhhc0xvZ2ljLAogICAgcmVmcywKICAgIHNsb3RzLAogICAgZXZlbnRzOiBbXSwKICAgIC8vIFdvdWxkIG5lZWQgdG8gdHJhY2sgZnJvbSBvbigpIGNhbGxzCiAgICBzdGF0ZUFjY2VzczogW10sCiAgICAvLyBXb3VsZCBuZWVkIHRvIHRyYWNrIGZyb20gc3RhdGUgYWNjZXNzCiAgICBoYXNFcnJvciwKICAgIGluc3RhbmNlQ291bnQKICB9Owp9CmZ1bmN0aW9uIGJ1aWxkQ29tcG9uZW50TWFwKCkgewogIGNvbnN0IHRhZ3MgPSBnZXRSZWdpc3RlcmVkQ29tcG9uZW50cygpOwogIGNvbnN0IG1hcCA9IHt9OwogIGZvciAoY29uc3QgdGFnIG9mIHRhZ3MpIHsKICAgIG1hcFt0YWddID0gYnVpbGRDb21wb25lbnRJbmZvKHRhZyk7CiAgfQogIHJldHVybiBtYXA7Cn0KZnVuY3Rpb24gZ2V0Q2FwYWJpbGl0aWVzKCkgewogIGNvbnN0IGNhcGFiaWxpdGllcyA9IFsicmVhY3RpdmUtc3RhdGUiLCAid2ViLWNvbXBvbmVudHMiLCAiZXZlbnQtaGFuZGxpbmciXTsKICBjb25zdCBjb25maWcgPSBnZXREZWJ1Z0NvbmZpZygpOwogIGlmIChjb25maWcuZXJyb3JCb3VuZGFyeSkgY2FwYWJpbGl0aWVzLnB1c2goImVycm9yLWJvdW5kYXJ5Iik7CiAgaWYgKGNvbmZpZy5nbG9iYWxzKSBjYXBhYmlsaXRpZXMucHVzaCgiZGVidWctZ2xvYmFscyIpOwogIGlmIChjb25maWcuYXBpKSBjYXBhYmlsaXRpZXMucHVzaCgicnVudGltZS1kZWZpbmUiKTsKICBpZiAoY29uZmlnLm1ldGhvZE1pc3NpbmcpIGNhcGFiaWxpdGllcy5wdXNoKCJtZXRob2QtbWlzc2luZyIpOwogIGlmIChjb25maWcudGVtcGxhdGVJbmZlcmVuY2UpIGNhcGFiaWxpdGllcy5wdXNoKCJ0ZW1wbGF0ZS1pbmZlcmVuY2UiKTsKICByZXR1cm4gY2FwYWJpbGl0aWVzOwp9CmZ1bmN0aW9uIGRldGVjdFBhdHRlcm5zKCkgewogIGNvbnN0IHRhZ3MgPSBnZXRSZWdpc3RlcmVkQ29tcG9uZW50cygpOwogIGNvbnN0IGNvbXBvbmVudE5hbWluZyA9IHRhZ3MubGVuZ3RoID4gMCA/IHRhZ3MuZXZlcnkoKHQpID0+IHQubWF0Y2goL15bYS16XSstW2Etel0rKC1bYS16XSspKiQvKSkgPyAia2ViYWItY2FzZSAoZS5nLiwgdXNlci1wcm9maWxlLCB0b2RvLWxpc3QpIiA6ICJtaXhlZCIgOiAidW5rbm93biI7CiAgcmV0dXJuIHsKICAgIGV2ZW50TmFtaW5nOiAidW5rbm93biIsCiAgICAvLyBXb3VsZCBuZWVkIHRvIHRyYWNrIGV2ZW50cwogICAgc3RhdGVTdHJ1Y3R1cmU6ICJ1bmtub3duIiwKICAgIC8vIFdvdWxkIG5lZWQgdG8gYW5hbHl6ZSBzdGF0ZSBzaGFwZQogICAgY29tcG9uZW50TmFtaW5nCiAgfTsKfQpmdW5jdGlvbiBpbmZlclNpZ25hdHVyZShuYW1lLCBhcmdzKSB7CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gYCR7bmFtZX0oKTogYW55YDsKICBjb25zdCBhcmdUeXBlcyA9IGFyZ3MubWFwKChhcmcsIGkpID0+IHsKICAgIGlmIChhcmcgPT09IG51bGwpIHJldHVybiBgYXJnJHtpfTogbnVsbGA7CiAgICBpZiAoYXJnID09PSB2b2lkIDApIHJldHVybiBgYXJnJHtpfTogdW5kZWZpbmVkYDsKICAgIGlmIChBcnJheS5pc0FycmF5KGFyZykpIHJldHVybiBgaXRlbXM6IGFueVtdYDsKICAgIGlmICh0eXBlb2YgYXJnID09PSAib2JqZWN0IikgcmV0dXJuIGBkYXRhOiBvYmplY3RgOwogICAgcmV0dXJuIGBhcmcke2l9OiAke3R5cGVvZiBhcmd9YDsKICB9KTsKICByZXR1cm4gYCR7bmFtZX0oJHthcmdUeXBlcy5qb2luKCIsICIpfSk6IGFueWA7Cn0KZnVuY3Rpb24gZ2V0RW1wdHlDb250ZXh0KCkgewogIHJldHVybiB7CiAgICBmcmFtZXdvcms6IHsKICAgICAgbmFtZTogImJvcmVET00iLAogICAgICB2ZXJzaW9uOiBWRVJTSU9OLAogICAgICBjYXBhYmlsaXRpZXM6IFtdCiAgICB9LAogICAgc3RhdGU6IHsKICAgICAgc2hhcGU6ICJ7fSIsCiAgICAgIHBhdGhzOiBbXSwKICAgICAgc2FtcGxlOiB7fQogICAgfSwKICAgIGNvbXBvbmVudHM6IHt9LAogICAgaXNzdWVzOiB7CiAgICAgIGVycm9yczogW10sCiAgICAgIG1pc3NpbmdGdW5jdGlvbnM6IFtdLAogICAgICBtaXNzaW5nQ29tcG9uZW50czogW10KICAgIH0sCiAgICBoZWxwZXJzOiB7CiAgICAgIGRlZmluZWQ6IHt9LAogICAgICBtaXNzaW5nOiB7fQogICAgfSwKICAgIHBhdHRlcm5zOiB7CiAgICAgIGV2ZW50TmFtaW5nOiAidW5rbm93biIsCiAgICAgIHN0YXRlU3RydWN0dXJlOiAidW5rbm93biIsCiAgICAgIGNvbXBvbmVudE5hbWluZzogInVua25vd24iCiAgICB9CiAgfTsKfQpmdW5jdGlvbiBnZXRFbXB0eUZvY3VzZWRDb250ZXh0KCkgewogIHJldHVybiB7CiAgICBpc3N1ZTogewogICAgICB0eXBlOiAibm9uZSIsCiAgICAgIGRlc2NyaXB0aW9uOiAiTExNIGZlYXR1cmVzIGRpc2FibGVkIG9yIHVuYXZhaWxhYmxlIgogICAgfSwKICAgIHJlbGV2YW50U3RhdGU6IHt9CiAgfTsKfQpmdW5jdGlvbiBjb250ZXh0KCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICByZXR1cm4gZ2V0RW1wdHlDb250ZXh0KCk7CiAgfQogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImxsbSIpKSB7CiAgICByZXR1cm4gZ2V0RW1wdHlDb250ZXh0KCk7CiAgfQogIGNvbnN0IGFwcFN0YXRlID0gZ2V0Q3VycmVudEFwcFN0YXRlKCk7CiAgY29uc3Qgc3RhdGUgPSBhcHBTdGF0ZT8uYXBwID8/IHt9OwogIGNvbnN0IGVycm9yczIgPSBnZXRFcnJvck1hcCgpOwogIGNvbnN0IG1pc3NpbmdGbnMgPSBnZXRNaXNzaW5nRnVuY3Rpb25zTWFwKCk7CiAgY29uc3QgZGVmaW5lZEhlbHBlcnMgPSBnZXREZWZpbmVkSGVscGVyc01hcCgpOwogIGNvbnN0IGVycm9ySW5mb3MgPSBBcnJheS5mcm9tKGVycm9yczIudmFsdWVzKCkpLm1hcCgoY3R4KSA9PiAoewogICAgY29tcG9uZW50OiBjdHguY29tcG9uZW50LAogICAgZXJyb3I6IGN0eC5lcnJvci5tZXNzYWdlLAogICAgc3RhY2s6IGN0eC5zdGFjaywKICAgIHN0YXRlOiBzYW5pdGl6ZVN0YXRlKGN0eC5zdGF0ZSksCiAgICB0aW1lc3RhbXA6IGN0eC50aW1lc3RhbXAKICB9KSk7CiAgY29uc3QgbWlzc2luZ0ZuSW5mb3MgPSBbXTsKICBjb25zdCBtaXNzaW5nQ2FsbEluZm9zID0ge307CiAgZm9yIChjb25zdCBbbmFtZSwgY2FsbHNdIG9mIG1pc3NpbmdGbnMuZW50cmllcygpKSB7CiAgICBjb25zdCBhbGxBcmdzID0gY2FsbHMubWFwKChjKSA9PiBjLmFyZ3MpOwogICAgY29uc3QgY29tcG9uZW50cyA9IFsuLi5uZXcgU2V0KGNhbGxzLm1hcCgoYykgPT4gYy5jb21wb25lbnQpKV07CiAgICBjb25zdCBsYXN0Q2FsbCA9IE1hdGgubWF4KC4uLmNhbGxzLm1hcCgoYykgPT4gYy50aW1lc3RhbXApKTsKICAgIG1pc3NpbmdGbkluZm9zLnB1c2goewogICAgICBuYW1lLAogICAgICBhcmdzOiBjYWxsc1swXT8uYXJncyA/PyBbXSwKICAgICAgY29tcG9uZW50OiBjYWxsc1swXT8uY29tcG9uZW50ID8/ICJ1bmtub3duIiwKICAgICAgaW5mZXJyZWRTaWduYXR1cmU6IGluZmVyU2lnbmF0dXJlKG5hbWUsIGNhbGxzWzBdPy5hcmdzID8/IFtdKSwKICAgICAgY2FsbENvdW50OiBjYWxscy5sZW5ndGgKICAgIH0pOwogICAgbWlzc2luZ0NhbGxJbmZvc1tuYW1lXSA9IHsKICAgICAgYXJnczogYWxsQXJncywKICAgICAgY29tcG9uZW50cywKICAgICAgbGFzdENhbGwKICAgIH07CiAgfQogIGNvbnN0IGRlZmluZWRIZWxwZXJTaWduYXR1cmVzID0ge307CiAgZm9yIChjb25zdCBbbmFtZSwgZm5dIG9mIGRlZmluZWRIZWxwZXJzLmVudHJpZXMoKSkgewogICAgZGVmaW5lZEhlbHBlclNpZ25hdHVyZXNbbmFtZV0gPSBgJHtuYW1lfSgke2ZuLmxlbmd0aCA+IDAgPyAiLi4uIiA6ICIifSk6IGFueWA7CiAgfQogIHJldHVybiB7CiAgICBmcmFtZXdvcms6IHsKICAgICAgbmFtZTogImJvcmVET00iLAogICAgICB2ZXJzaW9uOiBWRVJTSU9OLAogICAgICBjYXBhYmlsaXRpZXM6IGdldENhcGFiaWxpdGllcygpCiAgICB9LAogICAgc3RhdGU6IHsKICAgICAgc2hhcGU6IGluZmVyVHlwZVNoYXBlKHN0YXRlKSwKICAgICAgcGF0aHM6IGdldFN0YXRlUGF0aHMoc3RhdGUpLAogICAgICBzYW1wbGU6IHNhbml0aXplU3RhdGUoc3RhdGUpCiAgICB9LAogICAgY29tcG9uZW50czogYnVpbGRDb21wb25lbnRNYXAoKSwKICAgIGlzc3VlczogewogICAgICBlcnJvcnM6IGVycm9ySW5mb3MsCiAgICAgIG1pc3NpbmdGdW5jdGlvbnM6IG1pc3NpbmdGbkluZm9zLAogICAgICBtaXNzaW5nQ29tcG9uZW50czogZ2V0TWlzc2luZ0NvbXBvbmVudHMoKQogICAgfSwKICAgIGhlbHBlcnM6IHsKICAgICAgZGVmaW5lZDogZGVmaW5lZEhlbHBlclNpZ25hdHVyZXMsCiAgICAgIG1pc3Npbmc6IG1pc3NpbmdDYWxsSW5mb3MKICAgIH0sCiAgICBwYXR0ZXJuczogZGV0ZWN0UGF0dGVybnMoKQogIH07Cn0KZnVuY3Rpb24gZm9jdXMoKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHsKICAgIHJldHVybiBnZXRFbXB0eUZvY3VzZWRDb250ZXh0KCk7CiAgfQogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImxsbSIpKSB7CiAgICByZXR1cm4gZ2V0RW1wdHlGb2N1c2VkQ29udGV4dCgpOwogIH0KICBjb25zdCBlcnJvcnMyID0gZ2V0RXJyb3JNYXAoKTsKICBpZiAoZXJyb3JzMi5zaXplID4gMCkgewogICAgY29uc3QgZXJyb3JMaXN0ID0gQXJyYXkuZnJvbShlcnJvcnMyLnZhbHVlcygpKTsKICAgIGNvbnN0IGxhdGVzdCA9IGVycm9yTGlzdFtlcnJvckxpc3QubGVuZ3RoIC0gMV07CiAgICByZXR1cm4gewogICAgICBpc3N1ZTogewogICAgICAgIHR5cGU6ICJlcnJvciIsCiAgICAgICAgZGVzY3JpcHRpb246IGxhdGVzdC5lcnJvci5tZXNzYWdlLAogICAgICAgIGNvbXBvbmVudDogbGF0ZXN0LmNvbXBvbmVudCwKICAgICAgICBzdWdnZXN0aW9uOiBnZW5lcmF0ZVN1Z2dlc3Rpb24obGF0ZXN0KQogICAgICB9LAogICAgICBjb21wb25lbnQ6IHsKICAgICAgICAuLi5idWlsZENvbXBvbmVudEluZm8obGF0ZXN0LmNvbXBvbmVudCksCiAgICAgICAgY3VycmVudFN0YXRlOiBzYW5pdGl6ZVN0YXRlKGxhdGVzdC5zdGF0ZSkKICAgICAgfSwKICAgICAgcmVsZXZhbnRTdGF0ZTogc2FuaXRpemVTdGF0ZShsYXRlc3Quc3RhdGUpLAogICAgICBwcmV2aW91c0F0dGVtcHRzOiBnZXRSZWNlbnRBdHRlbXB0cygpCiAgICB9OwogIH0KICBjb25zdCBtaXNzaW5nRm5zID0gZ2V0TWlzc2luZ0Z1bmN0aW9uc01hcCgpOwogIGlmIChtaXNzaW5nRm5zLnNpemUgPiAwKSB7CiAgICBjb25zdCBlbnRyaWVzID0gQXJyYXkuZnJvbShtaXNzaW5nRm5zLmVudHJpZXMoKSk7CiAgICBjb25zdCBbbmFtZSwgY2FsbHNdID0gZW50cmllc1tlbnRyaWVzLmxlbmd0aCAtIDFdOwogICAgY29uc3QgbGFzdENhbGwgPSBjYWxsc1tjYWxscy5sZW5ndGggLSAxXTsKICAgIHJldHVybiB7CiAgICAgIGlzc3VlOiB7CiAgICAgICAgdHlwZTogIm1pc3NpbmdfZnVuY3Rpb24iLAogICAgICAgIGRlc2NyaXB0aW9uOiBgVW5kZWZpbmVkIGZ1bmN0aW9uICcke25hbWV9JyBjYWxsZWRgLAogICAgICAgIGNvbXBvbmVudDogbGFzdENhbGw/LmNvbXBvbmVudCwKICAgICAgICBzdWdnZXN0aW9uOiBgRGVmaW5lIGhlbHBlcjogYm9yZURPTS5kZWZpbmVIZWxwZXIoIiR7bmFtZX0iLCAoJHtpbmZlclNpZ25hdHVyZShuYW1lLCBsYXN0Q2FsbD8uYXJncyA/PyBbXSkuc3BsaXQoIigiKVsxXT8uc3BsaXQoIikiKVswXSB8fCAiIn0pID0+IHsgLyogaW1wbGVtZW50YXRpb24gKi8gfSlgCiAgICAgIH0sCiAgICAgIGNvbXBvbmVudDogbGFzdENhbGw/LmNvbXBvbmVudCA/IHsKICAgICAgICAuLi5idWlsZENvbXBvbmVudEluZm8obGFzdENhbGwuY29tcG9uZW50KSwKICAgICAgICBjdXJyZW50U3RhdGU6IHNhbml0aXplU3RhdGUoZ2V0Q3VycmVudEFwcFN0YXRlKCk/LmFwcCkKICAgICAgfSA6IHZvaWQgMCwKICAgICAgcmVsZXZhbnRTdGF0ZTogc2FuaXRpemVTdGF0ZShnZXRDdXJyZW50QXBwU3RhdGUoKT8uYXBwKSwKICAgICAgcHJldmlvdXNBdHRlbXB0czogZ2V0UmVjZW50QXR0ZW1wdHMoKQogICAgfTsKICB9CiAgY29uc3QgbWlzc2luZ0NvbXBvbmVudHMgPSBnZXRNaXNzaW5nQ29tcG9uZW50cygpOwogIGlmIChtaXNzaW5nQ29tcG9uZW50cy5sZW5ndGggPiAwKSB7CiAgICBjb25zdCB0YWdOYW1lID0gbWlzc2luZ0NvbXBvbmVudHNbMF07CiAgICByZXR1cm4gewogICAgICBpc3N1ZTogewogICAgICAgIHR5cGU6ICJtaXNzaW5nX2NvbXBvbmVudCIsCiAgICAgICAgZGVzY3JpcHRpb246IGBDdXN0b20gZWxlbWVudCA8JHt0YWdOYW1lfT4gdXNlZCBidXQgbm90IGRlZmluZWRgLAogICAgICAgIHN1Z2dlc3Rpb246IGBEZWZpbmUgY29tcG9uZW50OiBib3JlRE9NLmRlZmluZSgiJHt0YWdOYW1lfSIsICI8dGVtcGxhdGUtaHRtbD4iLCAoeyBzdGF0ZSB9KSA9PiAoeyBzbG90cyB9KSA9PiB7IC8qIHJlbmRlciAqLyB9KWAKICAgICAgfSwKICAgICAgcmVsZXZhbnRTdGF0ZTogc2FuaXRpemVTdGF0ZShnZXRDdXJyZW50QXBwU3RhdGUoKT8uYXBwKSwKICAgICAgcHJldmlvdXNBdHRlbXB0czogZ2V0UmVjZW50QXR0ZW1wdHMoKQogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIGlzc3VlOiB7CiAgICAgIHR5cGU6ICJub25lIiwKICAgICAgZGVzY3JpcHRpb246ICJObyBjdXJyZW50IGlzc3VlcyBkZXRlY3RlZCIKICAgIH0sCiAgICByZWxldmFudFN0YXRlOiBzYW5pdGl6ZVN0YXRlKGdldEN1cnJlbnRBcHBTdGF0ZSgpPy5hcHApCiAgfTsKfQpmdW5jdGlvbiBjb3B5KCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICByZXR1cm4gInt9IjsKICB9CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgibGxtIikpIHsKICAgIHJldHVybiAie30iOwogIH0KICBjb25zdCBjdHggPSBmb2N1cygpOwogIGNvbnN0IGpzb24gPSBKU09OLnN0cmluZ2lmeShjdHgsIG51bGwsIDIpOwogIGlmICh0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIiAmJiBuYXZpZ2F0b3IuY2xpcGJvYXJkKSB7CiAgICBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dChqc29uKS50aGVuKCgpID0+IHsKICAgICAgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgICIlY1x1ezFGNENCfSBib3JlRE9NOiBMTE0gY29udGV4dCBjb3BpZWQgdG8gY2xpcGJvYXJkIiwKICAgICAgICAgICJjb2xvcjogIzI3YWU2MDsgZm9udC13ZWlnaHQ6IGJvbGQiCiAgICAgICAgKTsKICAgICAgfQogICAgfSkuY2F0Y2goKCkgPT4gewogICAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgIiVjXHV7MUY0Q0J9IGJvcmVET006IENsaXBib2FyZCBhY2Nlc3MgZmFpbGVkLCBjb250ZXh0IGxvZ2dlZCBiZWxvdzoiLAogICAgICAgICAgImNvbG9yOiAjZjM5YzEyOyBmb250LXdlaWdodDogYm9sZCIKICAgICAgICApOwogICAgICAgIGNvbnNvbGUubG9nKGpzb24pOwogICAgICB9CiAgICB9KTsKICB9IGVsc2UgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgIGNvbnNvbGUubG9nKAogICAgICAiJWNcdXsxRjRDQn0gYm9yZURPTTogQ2xpcGJvYXJkIHVuYXZhaWxhYmxlLCBjb250ZXh0IGxvZ2dlZCBiZWxvdzoiLAogICAgICAiY29sb3I6ICNmMzljMTI7IGZvbnQtd2VpZ2h0OiBib2xkIgogICAgKTsKICAgIGNvbnNvbGUubG9nKGpzb24pOwogIH0KICByZXR1cm4ganNvbjsKfQpmdW5jdGlvbiByZWNvcmRBdHRlbXB0KGNvZGUsIHJlc3VsdCwgZXJyb3IpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImxsbSIpKSByZXR1cm47CiAgYXR0ZW1wdHMucHVzaCh7CiAgICBjb2RlLAogICAgcmVzdWx0LAogICAgZXJyb3IsCiAgICB0aW1lc3RhbXA6IERhdGUubm93KCkKICB9KTsKICBpZiAoYXR0ZW1wdHMubGVuZ3RoID4gMTApIHsKICAgIGF0dGVtcHRzID0gYXR0ZW1wdHMuc2xpY2UoLTEwKTsKICB9Cn0KZnVuY3Rpb24gZ2V0UmVjZW50QXR0ZW1wdHMoKSB7CiAgcmV0dXJuIFsuLi5hdHRlbXB0c107Cn0KZnVuY3Rpb24gZ2V0QXR0ZW1wdHMoKSB7CiAgcmV0dXJuIFsuLi5hdHRlbXB0c107Cn0KZnVuY3Rpb24gY2xlYXJBdHRlbXB0cygpIHsKICBhdHRlbXB0cyA9IFtdOwp9CmZ1bmN0aW9uIGZvcm1hdEVycm9yRm9yTExNKGN0eCkgewogIHJldHVybiBKU09OLnN0cmluZ2lmeSh7CiAgICB0eXBlOiAiZXJyb3IiLAogICAgY29tcG9uZW50OiBjdHguY29tcG9uZW50LAogICAgZXJyb3I6IGN0eC5lcnJvci5tZXNzYWdlLAogICAgc3RhY2s6IGN0eC5zdGFjaywKICAgIHN0YXRlOiBzYW5pdGl6ZVN0YXRlKGN0eC5zdGF0ZSksCiAgICByZWZzOiBPYmplY3Qua2V5cyhjdHgucmVmcyksCiAgICBzbG90czogT2JqZWN0LmtleXMoY3R4LnNsb3RzKSwKICAgIHN1Z2dlc3Rpb246IGdlbmVyYXRlU3VnZ2VzdGlvbihjdHgpLAogICAgdGltZXN0YW1wOiBjdHgudGltZXN0YW1wCiAgfSk7Cn0KZnVuY3Rpb24gbGxtTG9nKHR5cGUsIGRhdGEpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGNvbnN0IGNvbmZpZyA9IGdldERlYnVnQ29uZmlnKCk7CiAgaWYgKGNvbmZpZy5vdXRwdXRGb3JtYXQgPT09ICJsbG0iKSB7CiAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeSh7IHR5cGUsIC4uLmRhdGEgfSkpOwogIH0KfQpmdW5jdGlvbiBpc0xMTU91dHB1dEZvcm1hdCgpIHsKICBjb25zdCBjb25maWcgPSBnZXREZWJ1Z0NvbmZpZygpOwogIHJldHVybiBjb25maWcub3V0cHV0Rm9ybWF0ID09PSAibGxtIjsKfQp2YXIgYXR0ZW1wdHMsIFNFTlNJVElWRV9LRVlTLCBDSVJDVUxBUl9DSEVDSywgbGxtQVBJOwp2YXIgaW5pdF9sbG0gPSBfX2VzbSh7CiAgInNyYy9sbG0udHMiKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgaW5pdF9kZWJ1ZygpOwogICAgaW5pdF9jb25zb2xlX2FwaSgpOwogICAgaW5pdF9pbnNpZGVfb3V0KCk7CiAgICBpbml0X3ZlcnNpb24oKTsKICAgIGF0dGVtcHRzID0gW107CiAgICBTRU5TSVRJVkVfS0VZUyA9IFsKICAgICAgInBhc3N3b3JkIiwKICAgICAgInRva2VuIiwKICAgICAgInNlY3JldCIsCiAgICAgICJhcGlLZXkiLAogICAgICAiYXBpX2tleSIsCiAgICAgICJhdXRoIiwKICAgICAgImNyZWRlbnRpYWwiLAogICAgICAicHJpdmF0ZSIsCiAgICAgICJrZXkiLAogICAgICAicGFzcyIKICAgIF07CiAgICBDSVJDVUxBUl9DSEVDSyA9IFN5bWJvbCgiX19sbG1fY2lyY3VsYXJfY2hlY2tfXyIpOwogICAgbGxtQVBJID0gewogICAgICAvKiogR2V0IGNvbXBsZXRlIHNlc3Npb24gY29udGV4dCAqLwogICAgICBjb250ZXh0LAogICAgICAvKiogR2V0IGZvY3VzZWQgY29udGV4dCBmb3IgY3VycmVudCBpc3N1ZSAqLwogICAgICBmb2N1cywKICAgICAgLyoqIENvcHkgY29udGV4dCB0byBjbGlwYm9hcmQgKi8KICAgICAgY29weSwKICAgICAgLyoqIEdldCBhbGwgcmVjb3JkZWQgYXR0ZW1wdHMgKi8KICAgICAgZ2V0IGF0dGVtcHRzKCkgewogICAgICAgIHJldHVybiBnZXRBdHRlbXB0cygpOwogICAgICB9LAogICAgICAvKiogQ2xlYXIgcmVjb3JkZWQgYXR0ZW1wdHMgKi8KICAgICAgY2xlYXJBdHRlbXB0cywKICAgICAgLyoqIEBpbnRlcm5hbCBSZWNvcmQgYW4gYXR0ZW1wdCAqLwogICAgICBfcmVjb3JkQXR0ZW1wdDogcmVjb3JkQXR0ZW1wdAogICAgfTsKICB9Cn0pOwoKLy8gc3JjL2RlYnVnLnRzCmZ1bmN0aW9uIGlzRGVidWdFbmFibGVkKGZlYXR1cmUpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgewogICAgaWYgKGZlYXR1cmUgPT09ICJlcnJvckJvdW5kYXJ5IikgewogICAgICByZXR1cm4gZGVidWdDb25maWcuZXJyb3JCb3VuZGFyeSA/PyB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICBjb25zdCB2YWx1ZSA9IGRlYnVnQ29uZmlnW2ZlYXR1cmVdOwogIGlmIChmZWF0dXJlID09PSAic3RyaWN0IikgewogICAgcmV0dXJuIHZhbHVlID8/IGZhbHNlOwogIH0KICByZXR1cm4gdmFsdWUgPz8gdHJ1ZTsKfQpmdW5jdGlvbiBzZXREZWJ1Z0NvbmZpZyhjb25maWcpIHsKICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gImJvb2xlYW4iKSB7CiAgICBjb25zdCBlbmFibGVkID0gY29uZmlnOwogICAgZGVidWdDb25maWcgPSB7CiAgICAgIGNvbnNvbGU6IGVuYWJsZWQsCiAgICAgIGdsb2JhbHM6IGVuYWJsZWQsCiAgICAgIGVycm9yQm91bmRhcnk6IHRydWUsCiAgICAgIC8vIEFsd2F5cyBrZWVwIGVycm9yIGJvdW5kYXJ5IGZvciBzYWZldHkKICAgICAgdmlzdWFsSW5kaWNhdG9yczogZW5hYmxlZCwKICAgICAgZXJyb3JIaXN0b3J5OiBlbmFibGVkLAogICAgICB2ZXJzaW9uTG9nOiBlbmFibGVkLAogICAgICBhcGk6IGVuYWJsZWQsCiAgICAgIG1ldGhvZE1pc3Npbmc6IGVuYWJsZWQsCiAgICAgIHRlbXBsYXRlSW5mZXJlbmNlOiBlbmFibGVkLAogICAgICBzdHJpY3Q6IGZhbHNlLAogICAgICAvLyBTdHJpY3QgbW9kZSBvbmx5IGVuYWJsZWQgZXhwbGljaXRseQogICAgICBvdXRwdXRGb3JtYXQ6ICJodW1hbiIsCiAgICAgIC8vIEFsd2F5cyBodW1hbiBmb3JtYXQgYnkgZGVmYXVsdAogICAgICBsbG06IGVuYWJsZWQKICAgICAgLy8gTExNIEFQSSBmb2xsb3dzIGRlYnVnIG1vZGUKICAgIH07CiAgfSBlbHNlIHsKICAgIGRlYnVnQ29uZmlnID0geyAuLi5kZWJ1Z0NvbmZpZywgLi4uY29uZmlnIH07CiAgfQp9CmZ1bmN0aW9uIGdldERlYnVnQ29uZmlnKCkgewogIHJldHVybiB7IC4uLmRlYnVnQ29uZmlnIH07Cn0KZnVuY3Rpb24gZXhwb3NlR2xvYmFscyhjdHgpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImdsb2JhbHMiKSkgcmV0dXJuOwogIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgcmV0dXJuOwogIGNvbnN0IHcgPSB3aW5kb3c7CiAgdy4kc3RhdGUgPSBjdHguc3RhdGU7CiAgdy4kcmVmcyA9IGN0eC5yZWZzOwogIHcuJHNsb3RzID0gY3R4LnNsb3RzOwogIHcuJHNlbGYgPSBjdHguZWxlbWVudDsKICB3LiRlcnJvciA9IGN0eC5lcnJvcjsKICB3LiRjb21wb25lbnQgPSBjdHguY29tcG9uZW50OwogIHcuJHJlcmVuZGVyID0gY3R4LnJlcmVuZGVyOwp9CmZ1bmN0aW9uIGNsZWFyR2xvYmFscygpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImdsb2JhbHMiKSkgcmV0dXJuOwogIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgcmV0dXJuOwogIGNvbnN0IHcgPSB3aW5kb3c7CiAgZGVsZXRlIHcuJHN0YXRlOwogIGRlbGV0ZSB3LiRyZWZzOwogIGRlbGV0ZSB3LiRzbG90czsKICBkZWxldGUgdy4kc2VsZjsKICBkZWxldGUgdy4kZXJyb3I7CiAgZGVsZXRlIHcuJGNvbXBvbmVudDsKICBkZWxldGUgdy4kcmVyZW5kZXI7Cn0KZnVuY3Rpb24gbG9nRXJyb3IoY3R4KSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHJldHVybjsKICBpZiAoZGVidWdDb25maWcub3V0cHV0Rm9ybWF0ID09PSAibGxtIikgewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9sbG0oKSwgbGxtX2V4cG9ydHMpKS50aGVuKCh7IGZvcm1hdEVycm9yRm9yTExNOiBmb3JtYXRFcnJvckZvckxMTTIgfSkgPT4gewogICAgICBjb25zb2xlLmxvZyhmb3JtYXRFcnJvckZvckxMTTIoY3R4KSk7CiAgICB9KTsKICAgIHJldHVybjsKICB9CiAgY29uc29sZS5sb2coCiAgICAiJWNcdXsxRjUzNH0gYm9yZURPTTogRXJyb3IgaW4gJWM8JXM+JWMgcmVuZGVyIiwKICAgICJjb2xvcjogI2ZmNmI2YjsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgImNvbG9yOiAjNGVjZGM0OyBmb250LXdlaWdodDogYm9sZCIsCiAgICBjdHguY29tcG9uZW50LAogICAgImNvbG9yOiAjZmY2YjZiIgogICk7CiAgY29uc29sZS5lcnJvcihjdHguZXJyb3IpOwogIGlmIChpc0RlYnVnRW5hYmxlZCgiZ2xvYmFscyIpKSB7CiAgICBjb25zb2xlLmxvZygiJWNcdXsxRjRDQn0gRGVidWcgY29udGV4dCBsb2FkZWQ6IiwgImNvbG9yOiAjOTVhNWE2OyBmb250LXdlaWdodDogYm9sZCIpOwogICAgY29uc29sZS5sb2coIiAgICRzdGF0ZSAgICAgXHUyMTkyIiwgY3R4LnN0YXRlKTsKICAgIGNvbnNvbGUubG9nKCIgICAkcmVmcyAgICAgIFx1MjE5MiIsIGN0eC5yZWZzKTsKICAgIGNvbnNvbGUubG9nKCIgICAkc2xvdHMgICAgIFx1MjE5MiIsIGN0eC5zbG90cyk7CiAgICBjb25zb2xlLmxvZygiICAgJHNlbGYgICAgICBcdTIxOTIiLCBjdHguZWxlbWVudCk7CiAgICBjb25zb2xlLmxvZygiJWNcdXsxRjRBMX0gUXVpY2sgZml4ZXM6IiwgImNvbG9yOiAjZjM5YzEyOyBmb250LXdlaWdodDogYm9sZCIpOwogICAgY29uc29sZS5sb2coIiAgICRzdGF0ZS5wcm9wZXJ0eU5hbWUgPSB2YWx1ZSIpOwogICAgY29uc29sZS5sb2coIiAgICRyZXJlbmRlcigpIik7CiAgICBjb25zb2xlLmxvZygiJWNcdXsxRjRFNH0gV2hlbiBmaXhlZDoiLCAiY29sb3I6ICMyN2FlNjA7IGZvbnQtd2VpZ2h0OiBib2xkIik7CiAgICBjb25zb2xlLmxvZyhgICAgYm9yZURPTS5leHBvcnQoJyR7Y3R4LmNvbXBvbmVudH0nKWApOwogIH0KfQpmdW5jdGlvbiBsb2dFcnJvck1pbmltYWwoY29tcG9uZW50MiwgZXJyb3IpIHsKICBjb25zb2xlLmVycm9yKGBbYm9yZURPTV0gUmVuZGVyIGVycm9yIGluIDwke2NvbXBvbmVudDJ9PjogJHtlcnJvci5tZXNzYWdlfWApOwp9CmZ1bmN0aW9uIGxvZ0luaXRFcnJvcihjb21wb25lbnQyLCBlcnJvcikgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSByZXR1cm47CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSByZXR1cm47CiAgY29uc29sZS5sb2coCiAgICAiJWNcdXsxRjUzNH0gYm9yZURPTTogRXJyb3IgaW4gJWM8JXM+JWMgaW5pdCIsCiAgICAiY29sb3I6ICNmZjZiNmI7IGZvbnQtd2VpZ2h0OiBib2xkIiwKICAgICJjb2xvcjogIzRlY2RjNDsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgY29tcG9uZW50MiwKICAgICJjb2xvcjogI2ZmNmI2YiIKICApOwogIGNvbnNvbGUuZXJyb3IoZXJyb3IpOwp9CmZ1bmN0aW9uIHN0b3JlRXJyb3IoY3R4KSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJlcnJvckhpc3RvcnkiKSkgcmV0dXJuOwogIGVycm9ycy5zZXQoY3R4LmNvbXBvbmVudCwgY3R4KTsKICBsYXN0RXJyb3IgPSBjdHg7Cn0KZnVuY3Rpb24gY2xlYXJFcnJvcihjb21wb25lbnQyKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJlcnJvckhpc3RvcnkiKSkgcmV0dXJuOwogIGlmIChjb21wb25lbnQyKSB7CiAgICBlcnJvcnMuZGVsZXRlKGNvbXBvbmVudDIpOwogICAgaWYgKGxhc3RFcnJvcj8uY29tcG9uZW50ID09PSBjb21wb25lbnQyKSB7CiAgICAgIGxhc3RFcnJvciA9IG51bGw7CiAgICB9CiAgfSBlbHNlIGlmIChsYXN0RXJyb3IpIHsKICAgIGVycm9ycy5kZWxldGUobGFzdEVycm9yLmNvbXBvbmVudCk7CiAgICBsYXN0RXJyb3IgPSBudWxsOwogIH0KfQpmdW5jdGlvbiBtYXJrQ29tcG9uZW50RXJyb3IoZWxlbWVudCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSByZXR1cm47CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgidmlzdWFsSW5kaWNhdG9ycyIpKSByZXR1cm47CiAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoImRhdGEtYm9yZWRvbS1lcnJvciIsICJ0cnVlIik7Cn0KZnVuY3Rpb24gY2xlYXJDb21wb25lbnRFcnJvck1hcmsoZWxlbWVudCkgewogIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCJkYXRhLWJvcmVkb20tZXJyb3IiKTsKfQpmdW5jdGlvbiBleHBvcnRTdGF0ZSh0YWdOYW1lKSB7CiAgY29uc3QgY3R4ID0gdGFnTmFtZSA/IGVycm9ycy5nZXQodGFnTmFtZSkgOiBsYXN0RXJyb3I7CiAgaWYgKCFjdHgpIHJldHVybiBudWxsOwogIHRyeSB7CiAgICByZXR1cm4gewogICAgICBjb21wb25lbnQ6IGN0eC5jb21wb25lbnQsCiAgICAgIHN0YXRlOiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGN0eC5zdGF0ZSkpLAogICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKGN0eC50aW1lc3RhbXApLnRvSVNPU3RyaW5nKCksCiAgICAgIGVycm9yOiBjdHguZXJyb3IubWVzc2FnZQogICAgfTsKICB9IGNhdGNoIChlKSB7CiAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICBjb25zb2xlLndhcm4oCiAgICAgICAgYFtib3JlRE9NXSBleHBvcnRTdGF0ZTogVW5hYmxlIHRvIHNlcmlhbGl6ZSBzdGF0ZSBmb3IgPCR7Y3R4LmNvbXBvbmVudH0+OmAsCiAgICAgICAgZSBpbnN0YW5jZW9mIEVycm9yID8gZS5tZXNzYWdlIDogZQogICAgICApOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgY29tcG9uZW50OiBjdHguY29tcG9uZW50LAogICAgICBzdGF0ZTogIltVbmFibGUgdG8gc2VyaWFsaXplIC0gY29udGFpbnMgY2lyY3VsYXIgcmVmZXJlbmNlcyBvciBmdW5jdGlvbnNdIiwKICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZShjdHgudGltZXN0YW1wKS50b0lTT1N0cmluZygpLAogICAgICBlcnJvcjogY3R4LmVycm9yLm1lc3NhZ2UKICAgIH07CiAgfQp9CnZhciBkZWJ1Z0NvbmZpZywgZXJyb3JzLCBsYXN0RXJyb3IsIGRlYnVnQVBJOwp2YXIgaW5pdF9kZWJ1ZyA9IF9fZXNtKHsKICAic3JjL2RlYnVnLnRzIigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGRlYnVnQ29uZmlnID0gewogICAgICBjb25zb2xlOiB0cnVlLAogICAgICBnbG9iYWxzOiB0cnVlLAogICAgICBlcnJvckJvdW5kYXJ5OiB0cnVlLAogICAgICB2aXN1YWxJbmRpY2F0b3JzOiB0cnVlLAogICAgICBlcnJvckhpc3Rvcnk6IHRydWUsCiAgICAgIHZlcnNpb25Mb2c6IHRydWUsCiAgICAgIGFwaTogdHJ1ZSwKICAgICAgbWV0aG9kTWlzc2luZzogdHJ1ZSwKICAgICAgdGVtcGxhdGVJbmZlcmVuY2U6IHRydWUsCiAgICAgIHN0cmljdDogZmFsc2UsCiAgICAgIG91dHB1dEZvcm1hdDogImh1bWFuIiwKICAgICAgbGxtOiB0cnVlCiAgICB9OwogICAgZXJyb3JzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGxhc3RFcnJvciA9IG51bGw7CiAgICBkZWJ1Z0FQSSA9IHsKICAgICAgLyoqIE1hcCBvZiBhbGwgY3VycmVudCBlcnJvcnMgYnkgY29tcG9uZW50IG5hbWUgKi8KICAgICAgZ2V0IGVycm9ycygpIHsKICAgICAgICByZXR1cm4gZXJyb3JzOwogICAgICB9LAogICAgICAvKiogTW9zdCByZWNlbnQgZXJyb3IgY29udGV4dCAqLwogICAgICBnZXQgbGFzdEVycm9yKCkgewogICAgICAgIHJldHVybiBsYXN0RXJyb3I7CiAgICAgIH0sCiAgICAgIC8qKiBSZS1yZW5kZXIgYSBzcGVjaWZpYyBjb21wb25lbnQgb3IgdGhlIGxhc3QgZXJyb3JlZCBvbmUgKi8KICAgICAgcmVyZW5kZXIodGFnTmFtZSkgewogICAgICAgIGNvbnN0IGN0eCA9IHRhZ05hbWUgPyBlcnJvcnMuZ2V0KHRhZ05hbWUpIDogbGFzdEVycm9yOwogICAgICAgIGlmIChjdHgpIHsKICAgICAgICAgIGN0eC5yZXJlbmRlcigpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oIltib3JlRE9NXSBObyBlcnJvciBjb250ZXh0IGZvdW5kIHRvIHJlcmVuZGVyIik7CiAgICAgICAgfQogICAgICB9LAogICAgICAvKiogQ2xlYXIgZXJyb3Igc3RhdGUgZm9yIGEgY29tcG9uZW50ICovCiAgICAgIGNsZWFyRXJyb3IodGFnTmFtZSkgewogICAgICAgIGNvbnN0IGN0eCA9IHRhZ05hbWUgPyBlcnJvcnMuZ2V0KHRhZ05hbWUpIDogbGFzdEVycm9yOwogICAgICAgIGlmIChjdHgpIHsKICAgICAgICAgIGNsZWFyQ29tcG9uZW50RXJyb3JNYXJrKGN0eC5lbGVtZW50KTsKICAgICAgICAgIGNsZWFyRXJyb3IodGFnTmFtZSk7CiAgICAgICAgICBjbGVhckdsb2JhbHMoKTsKICAgICAgICB9IGVsc2UgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgICAgICAgIGNvbnNvbGUud2FybigKICAgICAgICAgICAgdGFnTmFtZSA/IGBbYm9yZURPTV0gY2xlYXJFcnJvcjogTm8gZXJyb3IgZm91bmQgZm9yIDwke3RhZ05hbWV9PmAgOiAiW2JvcmVET01dIGNsZWFyRXJyb3I6IE5vIGVycm9yIHRvIGNsZWFyIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIC8qKiBFeHBvcnQgc3RhdGUgc25hcHNob3QgKi8KICAgICAgZXhwb3J0OiBleHBvcnRTdGF0ZSwKICAgICAgLyoqIEN1cnJlbnQgZGVidWcgY29uZmlndXJhdGlvbiAocmVhZC1vbmx5KSAqLwogICAgICBnZXQgY29uZmlnKCkgewogICAgICAgIHJldHVybiBnZXREZWJ1Z0NvbmZpZygpOwogICAgICB9CiAgICB9OwogIH0KfSk7CgovLyBzcmMvZG9tLnRzCnZhciBkeW5hbWljSW1wb3J0U2NyaXB0cyA9IGFzeW5jIChuYW1lcykgPT4gewogIGNvbnN0IHJlc3VsdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBuYW1lcy5sZW5ndGg7ICsraSkgewogICAgY29uc3Qgc2NyaXB0cyA9IEFycmF5LmZyb20ocXVlcnlBbGwoInNjcmlwdFtzcmNdIikpOwogICAgY29uc3QgbWF0Y2hpbmdTY3JpcHQgPSBzY3JpcHRzLmZpbmQoKHNjcmlwdCkgPT4gewogICAgICBjb25zdCBzcmMgPSBzY3JpcHQuZ2V0QXR0cmlidXRlKCJzcmMiKSA/PyAiIjsKICAgICAgY29uc3QgZmlsZW5hbWUgPSBzcmMuc3BsaXQoIi8iKS5wb3AoKSA/PyAiIjsKICAgICAgcmV0dXJuIGZpbGVuYW1lID09PSBgJHtuYW1lc1tpXX0uanNgOwogICAgfSk7CiAgICBjb25zdCBzY3JpcHRMb2NhdGlvbiA9IG1hdGNoaW5nU2NyaXB0Py5nZXRBdHRyaWJ1dGUoInNyYyIpOwogICAgbGV0IGYgPSBudWxsOwogICAgaWYgKHNjcmlwdExvY2F0aW9uKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgbW9kdWxlVXJsID0gbmV3IFVSTChzY3JpcHRMb2NhdGlvbiwgZG9jdW1lbnQuYmFzZVVSSSkuaHJlZjsKICAgICAgICBjb25zdCBleHBvcnRzID0gYXdhaXQgaW1wb3J0KG1vZHVsZVVybCk7CiAgICAgICAgZm9yIChjb25zdCBleHBvcnRlZCBvZiBPYmplY3Qua2V5cyhleHBvcnRzKSkgewogICAgICAgICAgZiA9IGV4cG9ydHNbZXhwb3J0ZWRdOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5zZXQobmFtZXNbaV0sIGYpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgVW5hYmxlIHRvIGltcG9ydCAiJHtzY3JpcHRMb2NhdGlvbn0iYCwgZSk7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfTsKdmFyIHNlYXJjaEZvckNvbXBvbmVudHMgPSAoKSA9PiB7CiAgcmV0dXJuIEFycmF5LmZyb20ocXVlcnlBbGwoInRlbXBsYXRlW2RhdGEtY29tcG9uZW50XSIpKS5maWx0ZXIoKGVsZW0pID0+IGVsZW0gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkubWFwKCh0KSA9PiB7CiAgICBjb25zdCByZXN1bHQgPSB7CiAgICAgIG5hbWU6ICIiLAogICAgICBhdHRyaWJ1dGVzOiBbXQogICAgfTsKICAgIGZvciAoY29uc3QgYXR0cmlidXRlIGluIHQuZGF0YXNldCkgewogICAgICBpZiAoYXR0cmlidXRlID09PSAiY29tcG9uZW50IikgewogICAgICAgIHJlc3VsdC5uYW1lID0gdC5kYXRhc2V0W2F0dHJpYnV0ZV0gPz8gIiI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0LmF0dHJpYnV0ZXMucHVzaChbCiAgICAgICAgICBkZWNhbWVsaXplKGF0dHJpYnV0ZSksCiAgICAgICAgICB0LmRhdGFzZXRbYXR0cmlidXRlXSA/PyAiIgogICAgICAgIF0pOwogICAgICB9CiAgICB9CiAgICBpZiAocmVzdWx0Lm5hbWUgPT09ICIiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICBgQSA8dGVtcGxhdGU+IHdhcyBmb3VuZCB3aXRoIGFuIGludmFsaWQgZGF0YS1jb21wb25lbnQ6ICIke3QuZGF0YXNldC5jb21wb25lbnR9ImAKICAgICAgKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfSkubWFwKCh7IG5hbWUsIGF0dHJpYnV0ZXMgfSkgPT4gewogICAgY29tcG9uZW50KG5hbWUsIHsgYXR0cmlidXRlcyB9KTsKICAgIHJldHVybiBuYW1lOwogIH0pOwp9Owp2YXIgY3JlYXRlQ29tcG9uZW50ID0gKG5hbWUsIHVwZGF0ZSkgPT4gewogIGNvbnN0IGVsZW1lbnQgPSBjcmVhdGUobmFtZSk7CiAgaWYgKCFpc0JvcmVkKGVsZW1lbnQpKSB7CiAgICBjb25zdCBlcnJvciA9IGBUaGUgdGFnIG5hbWUgIiR7bmFtZX0iIGlzIG5vdCBhIEJvcmVET00gIGNvbXBvbmVudC4KICAgICAgCiJjcmVhdGVDb21wb25lbnQiIG9ubHkgYWNjZXB0cyB0YWctbmFtZXMgd2l0aCBtYXRjaGluZyA8dGVtcGxhdGU+IHRhZ3MgdGhhdCBoYXZlIGEgZGF0YS1jb21wb25lbnQgYXR0cmlidXRlIGluIHRoZW0uYDsKICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpOwogICAgdGhyb3cgbmV3IEVycm9yKGVycm9yKTsKICB9CiAgaWYgKHVwZGF0ZSkgewogICAgZWxlbWVudC5yZW5kZXJDYWxsYmFjayA9IHVwZGF0ZTsKICB9CiAgcmV0dXJuIGVsZW1lbnQ7Cn07CnZhciBxdWVyeUNvbXBvbmVudCA9IChxKSA9PiB7CiAgY29uc3QgZWxlbSA9IHF1ZXJ5KHEpOwogIGlmIChlbGVtID09PSBudWxsIHx8ICFpc0JvcmVkKGVsZW0pKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZWxlbTsKfTsKdmFyIHF1ZXJ5ID0gKHF1ZXJ5MikgPT4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihxdWVyeTIpOwp2YXIgcXVlcnlBbGwgPSAocXVlcnkyKSA9PiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHF1ZXJ5Mik7CnZhciBjcmVhdGUgPSAodGFnTmFtZSwgY2hpbGRyZW4pID0+IHsKICBjb25zdCBlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKTsKICBpZiAoY2hpbGRyZW4gJiYgQXJyYXkuaXNBcnJheShjaGlsZHJlbikgJiYgY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgY2hpbGRyZW4ubWFwKChjKSA9PiBlLmFwcGVuZENoaWxkKGMpKTsKICB9CiAgcmV0dXJuIGU7Cn07CnZhciBkaXNwYXRjaCA9IChuYW1lLCBkZXRhaWwpID0+IHsKICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImxvYWRpbmciKSB7CiAgICBhZGRFdmVudExpc3RlbmVyKAogICAgICAiRE9NQ29udGVudExvYWRlZCIsCiAgICAgICgpID0+IGRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KG5hbWUsIHsgZGV0YWlsIH0pKQogICAgKTsKICB9IGVsc2UgewogICAgZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQobmFtZSwgeyBkZXRhaWwgfSkpOwogIH0KfTsKdmFyIGlzT2JqZWN0ID0gKHQpID0+IHR5cGVvZiB0ID09PSAib2JqZWN0IjsKdmFyIGlzRnVuY3Rpb24gPSAodCkgPT4gdHlwZW9mIHQgPT09ICJmdW5jdGlvbiI7CnZhciBpc0JvcmVkID0gKHQpID0+IGlzT2JqZWN0KHQpICYmICJpc0JvcmVkIiBpbiB0ICYmIEJvb2xlYW4odC5pc0JvcmVkKTsKdmFyIGRlY2FtZWxpemUgPSAoc3RyKSA9PiB7CiAgaWYgKHN0ciA9PT0gIiIgfHwgIXN0ci5zcGxpdCgiIikuc29tZSgoY2hhcikgPT4gY2hhciAhPT0gY2hhci50b0xvd2VyQ2FzZSgpKSkgewogICAgcmV0dXJuIHN0cjsKICB9CiAgbGV0IHJlc3VsdCA9ICIiOwogIGZvciAobGV0IGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBjaGFyID0gc3RyW2ldOwogICAgaWYgKGNoYXIgPT09IGNoYXIudG9VcHBlckNhc2UoKSAmJiBpICE9PSAwKSB7CiAgICAgIHJlc3VsdCArPSAiLSI7CiAgICB9CiAgICByZXN1bHQgKz0gY2hhci50b0xvd2VyQ2FzZSgpOwogIH0KICByZXR1cm4gcmVzdWx0Owp9Owp2YXIgaXNTdGFydHNXaXRoT24gPSAocykgPT4gcy5zdGFydHNXaXRoKCJvbiIpOwp2YXIgaXNTdGFydHNXaXRoUXVlcmllZE9uID0gKHMpID0+IHMuc3RhcnRzV2l0aCgicXVlcmllZE9uIik7CnZhciBnZXRFdmVudE5hbWUgPSAocykgPT4gewogIGlmIChpc1N0YXJ0c1dpdGhPbihzKSkgewogICAgcmV0dXJuIHMuc2xpY2UoMikudG9Mb3dlckNhc2UoKTsKICB9CiAgcmV0dXJuIHMuc2xpY2UoOSkudG9Mb3dlckNhc2UoKTsKfTsKdmFyIEJvcmVkID0gY2xhc3MgZXh0ZW5kcyBIVE1MRWxlbWVudCB7Cn07CnZhciBjb21wb25lbnQgPSAodGFnLCBwcm9wcyA9IHt9KSA9PiB7CiAgaWYgKGN1c3RvbUVsZW1lbnRzLmdldCh0YWcpKSByZXR1cm47CiAgY3VzdG9tRWxlbWVudHMuZGVmaW5lKAogICAgdGFnLAogICAgY2xhc3MgZXh0ZW5kcyBCb3JlZCB7CiAgICAgIC8vIFNwZWNpZnkgb2JzZXJ2ZWQgYXR0cmlidXRlcyBzbyB0aGF0CiAgICAgIC8vIGF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayB3aWxsIHdvcmsKICAgICAgc3RhdGljIGdldCBvYnNlcnZlZEF0dHJpYnV0ZXMoKSB7CiAgICAgICAgaWYgKHR5cGVvZiBwcm9wcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMocHJvcHMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHN1cGVyKCk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIFVzZWZ1bCB0byBrbm93IGlmIGEgZ2l2ZW4gSFRNTEVsZW1lbnQgaXMgYSBCb3JlZCBjb21wb25lbnQuCiAgICAgICAqIEBzZWUgYGlzQm9yZWQoKWAgdHlwZWd1YXJkCiAgICAgICAqLwogICAgICBpc0JvcmVkID0gdHJ1ZTsKICAgICAgdHJhdmVyc2UoZiwgeyB0cmF2ZXJzZVNoYWRvd1Jvb3QsIHF1ZXJ5OiBxdWVyeTIgfSA9IHt9KSB7CiAgICAgICAgQXJyYXkuZnJvbSgKICAgICAgICAgIHRyYXZlcnNlU2hhZG93Um9vdCA/IHRoaXMuc2hhZG93Um9vdD8ucXVlcnlTZWxlY3RvckFsbChxdWVyeTIgPz8gIioiKSA/PyBbXSA6IFtdCiAgICAgICAgKS5jb25jYXQoQXJyYXkuZnJvbSh0aGlzLnF1ZXJ5U2VsZWN0b3JBbGwocXVlcnkyID8/ICIqIikpKS5maWx0ZXIoKG4pID0+IG4gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkuZm9yRWFjaChmKTsKICAgICAgfQogICAgICAvKioKICAgICAgICogUmV0dXJucyB0aGUgbGlzdCBvZiBjdXN0b20gZXZlbnQgbmFtZXMgZnJvbSBhIHN0cmluZyB0aGF0IGlzIHNoYXBlZCBsaWtlOgogICAgICAgKiBgImRpc3BhdGNoKCdldmVudDEnLCAnZXZlbnQyJywgLi4uKSJgCiAgICAgICAqCiAgICAgICAqIFRoaXMgaXMgdXNlZnVsIHdoZW4gdHJhdmVyc2luZyBmb3IgZXZlbnQgaGFuZGxlcnMgdG8gYmUgcmVwbGFjZWQKICAgICAgICogd2l0aCBjdXN0b20gZGlzcGF0Y2hlcnMuCiAgICAgICAqIEByZXR1cm5zIGFuIGFycmF5IG9mIHN0cmluZ3MKICAgICAgICovCiAgICAgIC8qKiBFeHRyYWN0cyBldmVudCBuYW1lcyBmcm9tIHN0cmluZ3MgbGlrZSAiZGlzcGF0Y2goJ2EnLCdiJykiICovCiAgICAgICNwYXJzZUN1c3RvbUV2ZW50TmFtZXMoc3RyKSB7CiAgICAgICAgcmV0dXJuIHN0ci5zcGxpdCgiJyIpLmZpbHRlcigKICAgICAgICAgIChzKSA9PiBzLmxlbmd0aCA+IDIgJiYgIShzLmluY2x1ZGVzKCIoIikgfHwgcy5pbmNsdWRlcygiLCIpIHx8IHMuaW5jbHVkZXMoIikiKSkKICAgICAgICApOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBSZXBsYWNlcyBpbmxpbmUgb24qIGF0dHJpYnV0ZXMgd2l0aGluIHRoZSBjb21wb25lbnQgRE9NIHdpdGggcmVhbAogICAgICAgKiBsaXN0ZW5lcnMgdGhhdCBkaXNwYXRjaCBjdXN0b20gZXZlbnRzIHVzaW5nIGRpc3BhdGNoKCkuCiAgICAgICAqLwogICAgICAjY3JlYXRlRGlzcGF0Y2hlcnMoKSB7CiAgICAgICAgbGV0IGhvc3Q7CiAgICAgICAgdGhpcy50cmF2ZXJzZSgobm9kZSkgPT4gewogICAgICAgICAgaWYgKG5vZGUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgewogICAgICAgICAgICBjb25zdCBpc1dlYkNvbXBvbmVudCA9IGN1c3RvbUVsZW1lbnRzLmdldCgKICAgICAgICAgICAgICBub2RlLnRhZ05hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoaXNXZWJDb21wb25lbnQpIGhvc3QgPSBub2RlOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuYXR0cmlidXRlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IG5vZGUuYXR0cmlidXRlc1tpXTsKICAgICAgICAgICAgICBpZiAoaXNTdGFydHNXaXRoT24oYXR0cmlidXRlLm5hbWUpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBldmVudE5hbWVzID0gdGhpcy4jcGFyc2VDdXN0b21FdmVudE5hbWVzKGF0dHJpYnV0ZS52YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoZXZlbnROYW1lcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgIGV2ZW50TmFtZXMuZm9yRWFjaCgoY3VzdG9tRXZlbnROYW1lKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKAogICAgICAgICAgICAgICAgICAgICAgZ2V0RXZlbnROYW1lKGF0dHJpYnV0ZS5uYW1lKSwKICAgICAgICAgICAgICAgICAgICAgIChlKSA9PiBkaXNwYXRjaChjdXN0b21FdmVudE5hbWUsIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6IGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BhdGNoZXI6IG5vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6IHRoaXMucGFyZW50RWxlbWVudCA/IEFycmF5LmZyb20odGhpcy5wYXJlbnRFbGVtZW50LmNoaWxkcmVuKS5pbmRleE9mKAogICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMKICAgICAgICAgICAgICAgICAgICAgICAgKSA6IC0xCiAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgICAgIGBkYXRhLSR7YXR0cmlidXRlLm5hbWV9LWRpc3BhdGNoZXNgLAogICAgICAgICAgICAgICAgICBldmVudE5hbWVzLmpvaW4oKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZS5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCB7IHRyYXZlcnNlU2hhZG93Um9vdDogdHJ1ZSB9KTsKICAgICAgfQogICAgICBpc0luaXRpYWxpemVkID0gZmFsc2U7CiAgICAgICNpbml0KCkgewogICAgICAgIGxldCB0ZW1wbGF0ZSA9IHF1ZXJ5KGBbZGF0YS1jb21wb25lbnQ9IiR7dGFnfSJdYCkgPz8gY3JlYXRlKCJ0ZW1wbGF0ZSIpOwogICAgICAgIGNvbnN0IGlzVGVtcGxhdGVTaGFkb3dSb290ID0gdGVtcGxhdGUuZ2V0QXR0cmlidXRlKCJzaGFkb3dyb290bW9kZSIpOwogICAgICAgIGNvbnN0IGlzU2hhZG93Um9vdE5lZWRlZCA9IHByb3BzLnN0eWxlIHx8IHByb3BzLnNoYWRvdyB8fCBpc1RlbXBsYXRlU2hhZG93Um9vdDsKICAgICAgICBpZiAoaXNTaGFkb3dSb290TmVlZGVkKSB7CiAgICAgICAgICBjb25zdCBzaGFkb3dSb290TW9kZSA9IHByb3BzLnNoYWRvd3Jvb3Rtb2RlID8/IGlzVGVtcGxhdGVTaGFkb3dSb290ID8/ICJvcGVuIjsKICAgICAgICAgIGNvbnN0IHNoYWRvd1Jvb3QgPSB0aGlzLmF0dGFjaFNoYWRvdyh7IG1vZGU6IHNoYWRvd1Jvb3RNb2RlIH0pOwogICAgICAgICAgaWYgKHByb3BzLnN0eWxlKSB7CiAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gY3JlYXRlKCJzdHlsZSIpOwogICAgICAgICAgICBzdHlsZS50ZXh0Q29udGVudCA9IHByb3BzLnN0eWxlOwogICAgICAgICAgICBzaGFkb3dSb290LmFwcGVuZENoaWxkKHN0eWxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wcy5zaGFkb3cpIHsKICAgICAgICAgICAgY29uc3QgdG1wID0gY3JlYXRlKCJ0ZW1wbGF0ZSIpOwogICAgICAgICAgICB0bXAuaW5uZXJIVE1MID0gcHJvcHMuc2hhZG93OwogICAgICAgICAgICBzaGFkb3dSb290LmFwcGVuZENoaWxkKHRtcC5jb250ZW50LmNsb25lTm9kZSh0cnVlKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGVtcGxhdGVTaGFkb3dSb290KSB7CiAgICAgICAgICAgIHNoYWRvd1Jvb3QuYXBwZW5kQ2hpbGQodGVtcGxhdGUuY29udGVudC5jbG9uZU5vZGUodHJ1ZSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodGVtcGxhdGUgJiYgIWlzVGVtcGxhdGVTaGFkb3dSb290KSB7CiAgICAgICAgICB0aGlzLmFwcGVuZENoaWxkKHRlbXBsYXRlLmNvbnRlbnQuY2xvbmVOb2RlKHRydWUpKTsKICAgICAgICB9CiAgICAgICAgaWYgKHByb3BzLm9uU2xvdENoYW5nZSkgewogICAgICAgICAgdGhpcy50cmF2ZXJzZSgoZWxlbSkgPT4gewogICAgICAgICAgICBpZiAoIShlbGVtIGluc3RhbmNlb2YgSFRNTFNsb3RFbGVtZW50KSkgcmV0dXJuOwogICAgICAgICAgICBlbGVtLmFkZEV2ZW50TGlzdGVuZXIoInNsb3RjaGFuZ2UiLCAoZSkgPT4gcHJvcHMub25TbG90Q2hhbmdlPy4oZSkpOwogICAgICAgICAgfSwgeyB0cmF2ZXJzZVNoYWRvd1Jvb3Q6IHRydWUgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChpc0Z1bmN0aW9uKHByb3BzLm9uQ2xpY2spKSB7CiAgICAgICAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgcHJvcHMub25DbGljayk7CiAgICAgICAgfQogICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHByb3BzKSkgewogICAgICAgICAgaWYgKGlzU3RhcnRzV2l0aE9uKGtleSkpIHsKICAgICAgICAgICAgaWYgKCFpc0Z1bmN0aW9uKHZhbHVlKSkgY29udGludWU7CiAgICAgICAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcihnZXRFdmVudE5hbWUoa2V5KSwgdmFsdWUpOwogICAgICAgICAgfSBlbHNlIGlmIChpc1N0YXJ0c1dpdGhRdWVyaWVkT24oa2V5KSkgewogICAgICAgICAgICBjb25zdCBxdWVyaWVzID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghaXNPYmplY3QocXVlcmllcykpIGNvbnRpbnVlOwogICAgICAgICAgICBjb25zdCBldmVudE5hbWUgPSBnZXRFdmVudE5hbWUoa2V5KTsKICAgICAgICAgICAgZm9yIChjb25zdCBbcXVlcnkyLCBoYW5kbGVyXSBvZiBPYmplY3QuZW50cmllcyhxdWVyaWVzKSkgewogICAgICAgICAgICAgIHRoaXMudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGhhbmRsZXIpOwogICAgICAgICAgICAgIH0sIHsgdHJhdmVyc2VTaGFkb3dSb290OiB0cnVlLCBxdWVyeTogcXVlcnkyIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwcm9wcy5hdHRyaWJ1dGVzICYmIEFycmF5LmlzQXJyYXkocHJvcHMuYXR0cmlidXRlcykpIHsKICAgICAgICAgIHByb3BzLmF0dHJpYnV0ZXMubWFwKAogICAgICAgICAgICAoW2F0dHIsIHZhbHVlXSkgPT4gdGhpcy5zZXRBdHRyaWJ1dGUoYXR0ciwgdmFsdWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICB0aGlzLiNjcmVhdGVEaXNwYXRjaGVycygpOwogICAgICAgIHRoaXMuaXNJbml0aWFsaXplZCA9IHRydWU7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIFVzZXItcHJvdmlkZWQgcmVuZGVyZXIgaXMgYXNzaWduZWQgaGVyZSBieSBjcmVhdGVDb21wb25lbnQuCiAgICAgICAqIENhbGxlZCBvbiBjb25uZWN0IGFuZCB3aGVuZXZlciBzdGF0ZSB0cmlnZ2VycyBzdWJzY3JpcHRpb25zLgogICAgICAgKi8KICAgICAgcmVuZGVyQ2FsbGJhY2sgPSAoXykgPT4gewogICAgICB9OwogICAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICBpZiAoIXRoaXMuaXNJbml0aWFsaXplZCkgdGhpcy4jaW5pdCgpOwogICAgICAgIHRoaXMucmVuZGVyQ2FsbGJhY2sodGhpcyk7CiAgICAgICAgcHJvcHMuY29ubmVjdGVkQ2FsbGJhY2s/Lih0aGlzKTsKICAgICAgfQogICAgICBzbG90cyA9IGNyZWF0ZVNsb3RzQWNjZXNzb3IodGhpcyk7CiAgICAgIC8qCiAgICAgICAgICAgICNjcmVhdGVTbG90cygpIHsKICAgICAgICAgICAgICBjb25zdCBzbG90cyA9IEFycmF5LmZyb20odGhpcy5xdWVyeVNlbGVjdG9yQWxsKCJzbG90IikpOwogICAgICAgICAgICAgIGNvbnN0IHdlYkNvbXBvbmVudCA9IHRoaXM7CiAgICAgIAogICAgICAgICAgICAgIHNsb3RzLmZvckVhY2goKHNsb3QpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHNsb3ROYW1lID0gc2xvdC5nZXRBdHRyaWJ1dGUoIm5hbWUiKTsKICAgICAgICAgICAgICAgIGlmICghc2xvdE5hbWUpIHJldHVybjsKICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBjYW1lbGl6ZWRTbG90TmFtZSA9IGNhbWVsaXplKHNsb3ROYW1lKTsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3ZWJDb21wb25lbnQuc2xvdHMsIGNhbWVsaXplZFNsb3ROYW1lLCB7CiAgICAgICAgICAgICAgICAgIGdldCgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2ViQ29tcG9uZW50LnF1ZXJ5U2VsZWN0b3IoYFtkYXRhLXNsb3Q9IiR7c2xvdE5hbWV9Il1gKTsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgc2V0KHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGVsZW0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgdmFsdWUuc2V0QXR0cmlidXRlKCJkYXRhLXNsb3QiLCBzbG90TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgICBlbGVtID0gY3JlYXRlKCJzcGFuIik7CiAgICAgICAgICAgICAgICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZSgiZGF0YS1zbG90Iiwgc2xvdE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgZWxlbS5pbm5lclRleHQgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nU2xvdCA9IHRoaXNbY2FtZWxpemVkU2xvdE5hbWVdOwogICAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ1Nsb3QpIHsKICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nU2xvdC5wYXJlbnRFbGVtZW50LnJlcGxhY2VDaGlsZChlbGVtLCBleGlzdGluZ1Nsb3QpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBzbG90LnBhcmVudEVsZW1lbnQ/LnJlcGxhY2VDaGlsZChlbGVtLCBzbG90KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAqLwogICAgICB1cGRhdGVTbG90KHNsb3ROYW1lLCBjb250ZW50LCB3aXRoaW5UYWcpIHsKICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHdpdGhpblRhZyk7CiAgICAgICAgY29udGFpbmVyLnNldEF0dHJpYnV0ZSgic2xvdCIsIHNsb3ROYW1lKTsKICAgICAgfQogICAgICAvKgogICAgICAgICAgICAjY3JlYXRlUHJvcGVydGllcygpIHsKICAgICAgICAgICAgICBjb25zdCBlbGVtZW50c0ZvdW5kID0gZG9jdW1lbnQuZXZhbHVhdGUoCiAgICAgICAgICAgICAgICAiLy8qW2NvbnRhaW5zKHRleHQoKSwndGhpcy4nKV0iLAogICAgICAgICAgICAgICAgZG9jdW1lbnQsCiAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgWFBhdGhSZXN1bHQuT1JERVJFRF9OT0RFX0lURVJBVE9SX1RZUEUsCiAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICk7CiAgICAgIAogICAgICAgICAgICAgIGxldCBlbGVtZW50ID0gbnVsbDsKICAgICAgICAgICAgICB3aGlsZSAoZWxlbWVudCA9IGVsZW1lbnRzRm91bmQuaXRlcmF0ZU5leHQoKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkZvdW5kICIsIGVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAqLwogICAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICBwcm9wcy5kaXNjb25uZWN0ZWRDYWxsYmFjaz8uKHRoaXMpOwogICAgICB9CiAgICAgIGFkb3B0ZWRDYWxsYmFjaygpIHsKICAgICAgICBwcm9wcy5hZG9wdGVkQ2FsbGJhY2s/Lih0aGlzKTsKICAgICAgfQogICAgICBhdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7CiAgICAgICAgaWYgKCFwcm9wcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2spIHJldHVybjsKICAgICAgICBwcm9wcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2tbbmFtZV0oewogICAgICAgICAgZWxlbWVudDogdGhpcywKICAgICAgICAgIG5hbWUsCiAgICAgICAgICBvbGRWYWx1ZSwKICAgICAgICAgIG5ld1ZhbHVlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICApOwp9Owp2YXIgcmVnaXN0ZXJDb21wb25lbnQgPSAodGFnTmFtZSkgPT4gewogIGNvbXBvbmVudCh0YWdOYW1lLCB7fSk7Cn07CgovLyBzcmMvdXRpbHMvYWNjZXNzLnRzCmZ1bmN0aW9uIGFjY2VzcyhwYXRoLCBvYmopIHsKICBsZXQgcmVzdWx0ID0gb2JqOwogIGlmIChvYmogPT09IG51bGwpIHJldHVybiByZXN1bHQ7CiAgcGF0aC5mb3JFYWNoKChhdHRyaWJ1dGUpID0+IHsKICAgIHJlc3VsdCA9IHJlc3VsdFthdHRyaWJ1dGVdOwogIH0pOwogIHJldHVybiByZXN1bHQ7Cn0KCi8vIHNyYy91dGlscy9mbGF0dGVuLnRzCmZ1bmN0aW9uIGZsYXR0ZW4ob2JqLCBpZ25vcmUgPSBbXSkgewogIGNvbnN0IHN0YWNrID0gW3sKICAgIHBhdGg6IFtdLAogICAgb2JqCiAgfV07CiAgY29uc3QgcmVzdWx0ID0gW107CiAgY29uc3QgdmlzaXRlZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpOwogIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICBjb25zdCB7IHBhdGgsIG9iajogb2JqMiB9ID0gc3RhY2sucG9wKCk7CiAgICBpZiAodmlzaXRlZC5oYXMob2JqMikpIGNvbnRpbnVlOwogICAgdmlzaXRlZC5hZGQob2JqMik7CiAgICBmb3IgKGNvbnN0IGtleSBpbiBvYmoyKSB7CiAgICAgIGlmIChpZ25vcmUuaW5jbHVkZXMoa2V5KSkgY29udGludWU7CiAgICAgIGNvbnN0IHZhbHVlID0gb2JqMltrZXldOwogICAgICBjb25zdCBuZXdQYXRoID0gcGF0aC5jb25jYXQoa2V5KTsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwgJiYgIXZpc2l0ZWQuaGFzKHZhbHVlKSkgewogICAgICAgIHN0YWNrLnB1c2goewogICAgICAgICAgcGF0aDogbmV3UGF0aCwKICAgICAgICAgIG9iajogdmFsdWUKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXN1bHQucHVzaCh7IHBhdGg6IG5ld1BhdGgsIHZhbHVlIH0pOwogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CgovLyBzcmMvdXRpbHMvaXNQb2pvLnRzCmZ1bmN0aW9uIGlzUE9KTyhhcmcpIHsKICBpZiAoYXJnID09IG51bGwgfHwgdHlwZW9mIGFyZyAhPT0gIm9iamVjdCIpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgY29uc3QgcHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoYXJnKTsKICBpZiAocHJvdG8gPT0gbnVsbCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBwcm90byA9PT0gT2JqZWN0LnByb3RvdHlwZTsKfQoKLy8gc3JjL2JvcmUudHMKZnVuY3Rpb24gY3JlYXRlRXZlbnRzSGFuZGxlcihjLCBhcHAsIGRldGFpbCkgewogIHJldHVybiAoZXZlbnROYW1lLCBoYW5kbGVyKSA9PiB7CiAgICBhZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgKGV2ZW50KSA9PiB7CiAgICAgIGxldCB0YXJnZXQgPSBldmVudD8uZGV0YWlsPy5ldmVudC5jdXJyZW50VGFyZ2V0OwogICAgICBsZXQgZW1pdGVyRWxlbSA9IHZvaWQgMDsKICAgICAgd2hpbGUgKHRhcmdldCkgewogICAgICAgIGlmICh0YXJnZXQgPT09IGMpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IG1heWJlUHJvbWlzZSA9IGhhbmRsZXIoewogICAgICAgICAgICAgIHN0YXRlOiBhcHAsCiAgICAgICAgICAgICAgZTogZXZlbnQuZGV0YWlsLAogICAgICAgICAgICAgIGRldGFpbAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgUHJvbWlzZS5yZXNvbHZlKG1heWJlUHJvbWlzZSkuY2F0Y2goKGVycm9yKSA9PiB7CiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigKICAgICAgICAgICAgICAgIGBFcnJvciBpbiBhc3luYyBoYW5kbGVyIGZvciAiJHtldmVudE5hbWV9IiBldmVudGAsCiAgICAgICAgICAgICAgICBlcnJvcgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgaW4gaGFuZGxlciBmb3IgIiR7ZXZlbnROYW1lfSIgZXZlbnRgLCBlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh0YXJnZXQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgewogICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudEVsZW1lbnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRhcmdldCA9IHZvaWQgMDsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH07Cn0KZnVuY3Rpb24gY3JlYXRlUmVmc0FjY2Vzc29yKGMpIHsKICByZXR1cm4gbmV3IFByb3h5KHt9LCB7CiAgICBnZXQodGFyZ2V0LCBwcm9wLCByZWNlaXZlcikgewogICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigKICAgICAgICBgUmVmICIke1N0cmluZyhwcm9wKX0iIG5vdCBmb3VuZCBpbiA8JHtjLnRhZ05hbWV9PmAKICAgICAgKTsKICAgICAgaWYgKHR5cGVvZiBwcm9wID09PSAic3RyaW5nIikgewogICAgICAgIGNvbnN0IG5vZGVMaXN0ID0gYy5xdWVyeVNlbGVjdG9yQWxsKGBbZGF0YS1yZWY9IiR7cHJvcH0iXWApOwogICAgICAgIGlmICghbm9kZUxpc3QpIHRocm93IGVycm9yOwogICAgICAgIGNvbnN0IHJlZnMgPSBBcnJheS5mcm9tKG5vZGVMaXN0KS5maWx0ZXIoCiAgICAgICAgICAocmVmKSA9PiByZWYgaW5zdGFuY2VvZiBIVE1MRWxlbWVudAogICAgICAgICk7CiAgICAgICAgaWYgKHJlZnMubGVuZ3RoID09PSAwKSB0aHJvdyBlcnJvcjsKICAgICAgICBpZiAocmVmcy5sZW5ndGggPT09IDEpIHJldHVybiByZWZzWzBdOwogICAgICAgIHJldHVybiByZWZzOwogICAgICB9CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gY3JlYXRlU2xvdHNBY2Nlc3NvcihjKSB7CiAgcmV0dXJuIG5ldyBQcm94eSh7fSwgewogICAgZ2V0KHRhcmdldCwgcHJvcCwgcmVjaWV2ZXIpIHsKICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoCiAgICAgICAgYFNsb3QgIiR7U3RyaW5nKHByb3ApfSIgbm90IGZvdW5kIGluIDwke2MudGFnTmFtZX0+YAogICAgICApOwogICAgICBpZiAodHlwZW9mIHByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgY29uc3Qgbm9kZUxpc3QgPSBjLnF1ZXJ5U2VsZWN0b3JBbGwoYHNsb3RbbmFtZT0iJHtwcm9wfSJdYCk7CiAgICAgICAgaWYgKCFub2RlTGlzdCkgdGhyb3cgZXJyb3I7CiAgICAgICAgY29uc3QgcmVmcyA9IEFycmF5LmZyb20obm9kZUxpc3QpLmZpbHRlcigKICAgICAgICAgIChyZWYpID0+IHJlZiBpbnN0YW5jZW9mIEhUTUxTbG90RWxlbWVudAogICAgICAgICk7CiAgICAgICAgaWYgKHJlZnMubGVuZ3RoID09PSAwKSB0aHJvdyBlcnJvcjsKICAgICAgICBpZiAocmVmcy5sZW5ndGggPT09IDEpIHJldHVybiByZWZzWzBdOwogICAgICAgIHJldHVybiByZWZzOwogICAgICB9CiAgICB9LAogICAgc2V0KHRhcmdldCwgcHJvcCwgdmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiBwcm9wICE9PSAic3RyaW5nIikgcmV0dXJuIGZhbHNlOwogICAgICBsZXQgZWxlbSA9IHZhbHVlOwogICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgewogICAgICAgIHZhbHVlLnNldEF0dHJpYnV0ZSgiZGF0YS1zbG90IiwgcHJvcCk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgICAgIGVsZW0gPSBjcmVhdGUoInNwYW4iKTsKICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZSgiZGF0YS1zbG90IiwgcHJvcCk7CiAgICAgICAgZWxlbS5pbm5lclRleHQgPSB2YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgdmFsdWUgZm9yIHNsb3QgJHtwcm9wfSBpbiA8JHtjLnRhZ05hbWV9PmApOwogICAgICB9CiAgICAgIGNvbnN0IGV4aXN0aW5nU2xvdHMgPSBBcnJheS5mcm9tKAogICAgICAgIGMucXVlcnlTZWxlY3RvckFsbChgW2RhdGEtc2xvdD0iJHtwcm9wfSJdYCkKICAgICAgKTsKICAgICAgaWYgKGV4aXN0aW5nU2xvdHMubGVuZ3RoID4gMCkgewogICAgICAgIGV4aXN0aW5nU2xvdHMuZm9yRWFjaCgocykgPT4gcy5wYXJlbnRFbGVtZW50Py5yZXBsYWNlQ2hpbGQoZWxlbSwgcykpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHNsb3RzID0gQXJyYXkuZnJvbShjLnF1ZXJ5U2VsZWN0b3JBbGwoYHNsb3RbbmFtZT0iJHtwcm9wfSJdYCkpOwogICAgICAgIHNsb3RzLmZvckVhY2goKHMpID0+IHMucGFyZW50RWxlbWVudD8ucmVwbGFjZUNoaWxkKGVsZW0sIHMpKTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9KTsKfQpmdW5jdGlvbiBjcmVhdGVTdGF0ZUFjY2Vzc29yKHN0YXRlLCBsb2csIGFjY3VtKSB7CiAgY29uc3QgY3VycmVudCA9IGFjY3VtIHx8IHsgdGFyZ2V0czogLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCksIHBhdGg6IFtdIH07CiAgaWYgKHN0YXRlID09PSB2b2lkIDApIHJldHVybiB2b2lkIDA7CiAgcmV0dXJuIG5ldyBQcm94eShzdGF0ZSwgewogICAgLy8gU3RhdGUgYWNjZXNzb3JzIGFyZSByZWFkLW9ubHk6CiAgICBzZXQodGFyZ2V0LCBwcm9wLCBuZXdWYWx1ZSkgewogICAgICBpZiAodHlwZW9mIHByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigKICAgICAgICAgIGBTdGF0ZSBpcyByZWFkLW9ubHkgZm9yIHdlYiBjb21wb25lbnRzLiBVbmFibGUgdG8gc2V0ICcke3Byb3B9Jy5gCiAgICAgICAgKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogICAgLy8gUmVjdXJzaXZlbHkgYnVpbGQgYSBwcm94eSBmb3IgZWFjaCBzdGF0ZSBwcm9wIGJlaW5nIHJlYWQ6CiAgICBnZXQodGFyZ2V0LCBwcm9wLCByZWNlaXZlcikgewogICAgICBjb25zdCB2YWx1ZSA9IFJlZmxlY3QuZ2V0KHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpOwogICAgICBjb25zdCBpc1Byb3RvID0gcHJvcCA9PT0gIl9fcHJvdG9fXyI7CiAgICAgIGlmICh0eXBlb2YgcHJvcCA9PT0gInN0cmluZyIgJiYgIWlzUHJvdG8pIHsKICAgICAgICBpZiAoIWN1cnJlbnQudGFyZ2V0cy5oYXModGFyZ2V0KSkgewogICAgICAgICAgY3VycmVudC50YXJnZXRzLnNldCh0YXJnZXQsIGN1cnJlbnQucGF0aC5qb2luKCIuIikpOwogICAgICAgICAgY3VycmVudC5wYXRoLnB1c2gocHJvcCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpc1Byb3RvIHx8IEFycmF5LmlzQXJyYXkodmFsdWUpIHx8IGlzUE9KTyh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gY3JlYXRlU3RhdGVBY2Nlc3Nvcih2YWx1ZSwgbG9nLCBjdXJyZW50KTsKICAgICAgfQogICAgICBsZXQgcGF0aCA9IGN1cnJlbnQudGFyZ2V0cy5nZXQodGFyZ2V0KSA/PyAiIjsKICAgICAgaWYgKHR5cGVvZiBwYXRoID09PSAic3RyaW5nIiAmJiB0eXBlb2YgcHJvcCA9PT0gInN0cmluZyIpIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0YXJnZXQpKSB7CiAgICAgICAgICBwYXRoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwYXRoICs9IHBhdGggIT09ICIiID8gYC4ke3Byb3B9YCA6IHByb3A7CiAgICAgICAgfQogICAgICAgIGlmIChsb2cuaW5kZXhPZihwYXRoKSA9PT0gLTEpIHsKICAgICAgICAgIGxvZy5wdXNoKHBhdGgpOwogICAgICAgIH0KICAgICAgfQogICAgICBjdXJyZW50LnBhdGgubGVuZ3RoID0gMDsKICAgICAgY3VycmVudC5wYXRoLnB1c2gocGF0aCk7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICB9KTsKfQpmdW5jdGlvbiBjcmVhdGVTdWJzY3JpYmVyc0Rpc3BhdGNoZXIoc3RhdGUpIHsKICByZXR1cm4gKCkgPT4gewogICAgY29uc3QgdXBkYXRlcyA9IHN0YXRlLmludGVybmFsLnVwZGF0ZXM7CiAgICBjb25zdCBub3RpZmllZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICBjb25zdCBub3RpZnkgPSAoZm5zKSA9PiB7CiAgICAgIGlmICghZm5zKSByZXR1cm47CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgZm5zLmxlbmd0aDsgaisrKSB7CiAgICAgICAgY29uc3QgZm4gPSBmbnNbal07CiAgICAgICAgaWYgKG5vdGlmaWVkLmhhcyhmbikpIGNvbnRpbnVlOwogICAgICAgIG5vdGlmaWVkLmFkZChmbik7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZuKHN0YXRlLmFwcCk7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHVwZGF0ZXMucGF0aC5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwYXRoID0gdXBkYXRlcy5wYXRoW2ldOwogICAgICBjb25zdCByZWxhdGl2ZVBhdGggPSBwYXRoLnNsaWNlKHBhdGguaW5kZXhPZigiLiIpICsgMSk7CiAgICAgIG5vdGlmeSh1cGRhdGVzLnN1YnNjcmliZXJzLmdldChyZWxhdGl2ZVBhdGgpKTsKICAgICAgZm9yIChjb25zdCBbc3Vic2NyaWJlclBhdGgsIGZuc10gb2YgdXBkYXRlcy5zdWJzY3JpYmVycy5lbnRyaWVzKCkpIHsKICAgICAgICBpZiAoc3Vic2NyaWJlclBhdGggPT09IHJlbGF0aXZlUGF0aCkgY29udGludWU7CiAgICAgICAgY29uc3Qgc3Vic2NyaWJlcldpdGhEb3QgPSBgJHtzdWJzY3JpYmVyUGF0aH0uYDsKICAgICAgICBjb25zdCByZWxhdGl2ZVdpdGhEb3QgPSBgJHtyZWxhdGl2ZVBhdGh9LmA7CiAgICAgICAgaWYgKHJlbGF0aXZlUGF0aC5zdGFydHNXaXRoKHN1YnNjcmliZXJXaXRoRG90KSB8fCBzdWJzY3JpYmVyUGF0aC5zdGFydHNXaXRoKHJlbGF0aXZlV2l0aERvdCkpIHsKICAgICAgICAgIG5vdGlmeShmbnMpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgdXBkYXRlcy5wYXRoID0gW107CiAgICB1cGRhdGVzLnZhbHVlID0gW107CiAgICB1cGRhdGVzLnJhZiA9IHZvaWQgMDsKICB9Owp9CmZ1bmN0aW9uIHByb3hpZnkoYm9yZWRvbSkgewogIGNvbnN0IHJ1bnRpbWUgPSBib3JlZG9tLmludGVybmFsOwogIGNvbnN0IHN0YXRlID0gYm9yZWRvbTsKICBpZiAoc3RhdGUgPT09IHZvaWQgMCkgcmV0dXJuIGJvcmVkb207CiAgY29uc3Qgb2JqZWN0c1dpdGhQcm94aWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCk7CiAgY29uc3QgUFJPWFlfTUFSS0VSID0gU3ltYm9sKCJib3JlZG9tLXByb3h5Iik7CiAgZnVuY3Rpb24gY3JlYXRlUmVhY3RpdmVQcm94eSh2YWx1ZSwgZG90dGVkUGF0aCkgewogICAgaWYgKG9iamVjdHNXaXRoUHJveGllcy5oYXModmFsdWUpKSByZXR1cm4gdmFsdWU7CiAgICBjb25zdCBwcm94eSA9IG5ldyBQcm94eSh2YWx1ZSwgewogICAgICBnZXQodGFyZ2V0LCBwcm9wLCByZWNlaXZlcikgewogICAgICAgIGlmIChwcm9wID09PSBQUk9YWV9NQVJLRVIpIHJldHVybiB0cnVlOwogICAgICAgIHJldHVybiBSZWZsZWN0LmdldCh0YXJnZXQsIHByb3AsIHJlY2VpdmVyKTsKICAgICAgfSwKICAgICAgc2V0KHRhcmdldCwgcHJvcCwgbmV3VmFsdWUpIHsKICAgICAgICBjb25zdCBpc0NoYW5nZWQgPSB0YXJnZXRbcHJvcF0gIT09IG5ld1ZhbHVlOwogICAgICAgIGlmICghaXNDaGFuZ2VkKSByZXR1cm4gdHJ1ZTsKICAgICAgICBpZiAodHlwZW9mIHByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICBjb25zdCBuZXdQYXRoID0gQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyBkb3R0ZWRQYXRoIDogYCR7ZG90dGVkUGF0aH0uJHtwcm9wfWA7CiAgICAgICAgICBjb25zdCBpc0FscmVhZHlQcm94eSA9IG5ld1ZhbHVlICYmIG5ld1ZhbHVlW1BST1hZX01BUktFUl0gPT09IHRydWU7CiAgICAgICAgICBpZiAoIWlzQWxyZWFkeVByb3h5ICYmIChBcnJheS5pc0FycmF5KG5ld1ZhbHVlKSB8fCBpc1BPSk8obmV3VmFsdWUpKSkgewogICAgICAgICAgICBuZXdWYWx1ZSA9IHByb3hpZnlWYWx1ZShuZXdWYWx1ZSwgbmV3UGF0aCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFJlZmxlY3Quc2V0KHRhcmdldCwgcHJvcCwgbmV3VmFsdWUpOwogICAgICAgIGlmICh0eXBlb2YgcHJvcCAhPT0gInN0cmluZyIpIHJldHVybiB0cnVlOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgcnVudGltZS51cGRhdGVzLnBhdGgucHVzaChgJHtkb3R0ZWRQYXRofWApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBydW50aW1lLnVwZGF0ZXMucGF0aC5wdXNoKGAke2RvdHRlZFBhdGh9LiR7cHJvcH1gKTsKICAgICAgICB9CiAgICAgICAgcnVudGltZS51cGRhdGVzLnZhbHVlLnB1c2godGFyZ2V0KTsKICAgICAgICBpZiAoIXJ1bnRpbWUudXBkYXRlcy5yYWYpIHsKICAgICAgICAgIHJ1bnRpbWUudXBkYXRlcy5yYWYgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoCiAgICAgICAgICAgIGNyZWF0ZVN1YnNjcmliZXJzRGlzcGF0Y2hlcihib3JlZG9tKQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgb2JqZWN0c1dpdGhQcm94aWVzLmFkZCh2YWx1ZSk7CiAgICBvYmplY3RzV2l0aFByb3hpZXMuYWRkKHByb3h5KTsKICAgIHJldHVybiBwcm94eTsKICB9CiAgZnVuY3Rpb24gcHJveGlmeVZhbHVlKHZhbHVlLCBiYXNlUGF0aCkgewogICAgaWYgKCFBcnJheS5pc0FycmF5KHZhbHVlKSAmJiAhaXNQT0pPKHZhbHVlKSkgcmV0dXJuIHZhbHVlOwogICAgaWYgKG9iamVjdHNXaXRoUHJveGllcy5oYXModmFsdWUpKSByZXR1cm4gdmFsdWU7CiAgICBpZiAodmFsdWUgJiYgdmFsdWVbUFJPWFlfTUFSS0VSXSA9PT0gdHJ1ZSkgcmV0dXJuIHZhbHVlOwogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBpdGVtID0gdmFsdWVbaV07CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkgfHwgaXNQT0pPKGl0ZW0pKSB7CiAgICAgICAgICB2YWx1ZVtpXSA9IHByb3hpZnlWYWx1ZShpdGVtLCBiYXNlUGF0aCk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyh2YWx1ZSkpIHsKICAgICAgICBjb25zdCBpdGVtID0gdmFsdWVba2V5XTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShpdGVtKSB8fCBpc1BPSk8oaXRlbSkpIHsKICAgICAgICAgIHZhbHVlW2tleV0gPSBwcm94aWZ5VmFsdWUoaXRlbSwgYCR7YmFzZVBhdGh9LiR7a2V5fWApOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGNyZWF0ZVJlYWN0aXZlUHJveHkodmFsdWUsIGJhc2VQYXRoKTsKICB9CiAgZmxhdHRlbihib3JlZG9tLCBbImludGVybmFsIl0pLmZvckVhY2goKHsgcGF0aCwgdmFsdWUgfSkgPT4gewogICAgY29uc3QgbmVlZHNQcm94eSA9IEFycmF5LmlzQXJyYXkodmFsdWUpIHx8IGlzUE9KTyh2YWx1ZSkgJiYgIW9iamVjdHNXaXRoUHJveGllcy5oYXModmFsdWUpOwogICAgaWYgKG5lZWRzUHJveHkpIHsKICAgICAgY29uc3QgZG90dGVkUGF0aCA9IHBhdGguam9pbigiLiIpOwogICAgICBjb25zdCBwYXJlbnQgPSBhY2Nlc3MocGF0aC5zbGljZSgwLCAtMSksIHN0YXRlKTsKICAgICAgY29uc3QgaXNSb290ID0gcGFyZW50ID09PSB2YWx1ZTsKICAgICAgaWYgKGlzUm9vdCkgcmV0dXJuOwogICAgICBwYXJlbnRbcGF0aC5hdCgtMSldID0gY3JlYXRlUmVhY3RpdmVQcm94eSh2YWx1ZSwgZG90dGVkUGF0aCk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIGJvcmVkb207Cn0KZnVuY3Rpb24gcnVuQ29tcG9uZW50c0luaXRpYWxpemVyKHN0YXRlKSB7CiAgY29uc3QgdGFnc0luRG9tID0gc3RhdGUuaW50ZXJuYWwuY3VzdG9tVGFncy5maWx0ZXIoCiAgICAodGFnKSA9PiAoCiAgICAgIC8vIEEgdGFnIGlzIGNvbnNpZGVyZWQgcHJlc2VudCBpZiBhdCBsZWFzdCBvbmUgaW5zdGFuY2UgZXhpc3RzIGluIHRoZSBET00KICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0YWcpICE9PSBudWxsCiAgICApCiAgKTsKICBjb25zdCBjb21wb25lbnRzID0gc3RhdGUuaW50ZXJuYWwuY29tcG9uZW50czsKICBmb3IgKGNvbnN0IFt0YWdOYW1lLCBjb2RlXSBvZiBjb21wb25lbnRzLmVudHJpZXMoKSkgewogICAgaWYgKGNvZGUgPT09IG51bGwgfHwgIXRhZ3NJbkRvbS5pbmNsdWRlcyh0YWdOYW1lKSkgY29udGludWU7CiAgICBjb25zdCBlbGVtZW50cyA9IEFycmF5LmZyb20oCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwodGFnTmFtZSkKICAgICkuZmlsdGVyKChlbCkgPT4gaXNCb3JlZChlbCkpOwogICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICBjb250aW51ZTsKICAgIH0KICAgIGVsZW1lbnRzLmZvckVhY2goKGNvbXBvbmVudENsYXNzLCBpbmRleCkgPT4gewogICAgICBjb2RlKHN0YXRlLCB7IGluZGV4LCBuYW1lOiB0YWdOYW1lLCBkYXRhOiB2b2lkIDAgfSkoCiAgICAgICAgY29tcG9uZW50Q2xhc3MKICAgICAgKTsKICAgIH0pOwogIH0KICByZXR1cm47Cn0KZnVuY3Rpb24gY3JlYXRlQW5kUnVuQ29kZShuYW1lLCBzdGF0ZSwgZGV0YWlsKSB7CiAgY29uc3QgY29kZSA9IHN0YXRlLmludGVybmFsLmNvbXBvbmVudHMuZ2V0KG5hbWUpOwogIGlmIChjb2RlKSB7CiAgICBjb25zdCBpbmZvID0geyAuLi5kZXRhaWwsIHRhZ05hbWU6IG5hbWUgfTsKICAgIHJldHVybiBjcmVhdGVDb21wb25lbnQobmFtZSwgY29kZShzdGF0ZSwgaW5mbykpOwogIH0KICByZXR1cm4gY3JlYXRlQ29tcG9uZW50KG5hbWUpOwp9CgovLyBzcmMvaW5kZXgudHMKaW5pdF9kZWJ1ZygpOwppbml0X2NvbnNvbGVfYXBpKCk7CmluaXRfaW5zaWRlX291dCgpOwppbml0X2xsbSgpOwppbml0X2RlYnVnKCk7CmluaXRfdmVyc2lvbigpOwppbml0X3ZlcnNpb24oKTsKdmFyIGhhc0xvZ2dlZFZlcnNpb24gPSBmYWxzZTsKdmFyIGJvcmVET00gPSB7CiAgLyoqIE1hcCBvZiBhbGwgY3VycmVudCBlcnJvcnMgYnkgY29tcG9uZW50IG5hbWUgKi8KICBnZXQgZXJyb3JzKCkgewogICAgcmV0dXJuIGRlYnVnQVBJLmVycm9yczsKICB9LAogIC8qKiBNb3N0IHJlY2VudCBlcnJvciBjb250ZXh0ICovCiAgZ2V0IGxhc3RFcnJvcigpIHsKICAgIHJldHVybiBkZWJ1Z0FQSS5sYXN0RXJyb3I7CiAgfSwKICAvKiogUmUtcmVuZGVyIGEgc3BlY2lmaWMgY29tcG9uZW50IG9yIHRoZSBsYXN0IGVycm9yZWQgb25lICovCiAgcmVyZW5kZXI6IGRlYnVnQVBJLnJlcmVuZGVyLAogIC8qKiBDbGVhciBlcnJvciBzdGF0ZSBmb3IgYSBjb21wb25lbnQgKi8KICBjbGVhckVycm9yOiBkZWJ1Z0FQSS5jbGVhckVycm9yLAogIC8qKiBFeHBvcnQgc3RhdGUgc25hcHNob3QgKi8KICBleHBvcnQ6IGRlYnVnQVBJLmV4cG9ydCwKICAvKiogQ3VycmVudCBkZWJ1ZyBjb25maWd1cmF0aW9uIChyZWFkLW9ubHkpICovCiAgZ2V0IGNvbmZpZygpIHsKICAgIHJldHVybiBkZWJ1Z0FQSS5jb25maWc7CiAgfSwKICAvKiogRnJhbWV3b3JrIHZlcnNpb24gKi8KICB2ZXJzaW9uOiBWRVJTSU9OLAogIC8vIENvbnNvbGUgQVBJIChQaGFzZSAyKQogIC8qKiBEZWZpbmUgYSBuZXcgY29tcG9uZW50IGF0IHJ1bnRpbWUgKi8KICBkZWZpbmU6IGNvbnNvbGVBUEkuZGVmaW5lLAogIC8qKiBHZXQgbGl2ZSBhY2Nlc3MgdG8gYSBjb21wb25lbnQncyBpbnRlcm5hbHMgKi8KICBvcGVyYXRlOiBjb25zb2xlQVBJLm9wZXJhdGUsCiAgLyoqIEV4cG9ydCBjb21wb25lbnQgc3RhdGUgYW5kIHRlbXBsYXRlICovCiAgZXhwb3J0Q29tcG9uZW50OiBjb25zb2xlQVBJLmV4cG9ydENvbXBvbmVudCwKICAvLyBJbnNpZGUtT3V0IEFQSSAoUGhhc2UgMykKICAvKiogTWFwIG9mIG1pc3NpbmcgZnVuY3Rpb24gY2FsbHMgYnkgZnVuY3Rpb24gbmFtZSAqLwogIGdldCBtaXNzaW5nRnVuY3Rpb25zKCkgewogICAgcmV0dXJuIGluc2lkZU91dEFQSS5taXNzaW5nRnVuY3Rpb25zOwogIH0sCiAgLyoqIE1vc3QgcmVjZW50IG1pc3NpbmcgZnVuY3Rpb24gY29udGV4dCAqLwogIGdldCBsYXN0TWlzc2luZygpIHsKICAgIHJldHVybiBpbnNpZGVPdXRBUEkubGFzdE1pc3Npbmc7CiAgfSwKICAvKiogRGVmaW5lIGEgaGVscGVyIGZ1bmN0aW9uIGF2YWlsYWJsZSB0byBhbGwgcmVuZGVyIGZ1bmN0aW9ucyAqLwogIGRlZmluZUhlbHBlcjogaW5zaWRlT3V0QVBJLmRlZmluZUhlbHBlciwKICAvKiogR2V0IGFsbCBkZWZpbmVkIGhlbHBlcnMgKi8KICBnZXQgaGVscGVycygpIHsKICAgIHJldHVybiBpbnNpZGVPdXRBUEkuaGVscGVyczsKICB9LAogIC8qKiBDbGVhciBhIGhlbHBlciBkZWZpbml0aW9uICovCiAgY2xlYXJIZWxwZXI6IGluc2lkZU91dEFQSS5jbGVhckhlbHBlciwKICAvKiogQ2xlYXIgYWxsIG1pc3NpbmcgZnVuY3Rpb24gcmVjb3JkcyAqLwogIGNsZWFyTWlzc2luZ0Z1bmN0aW9uczogaW5zaWRlT3V0QVBJLmNsZWFyTWlzc2luZ0Z1bmN0aW9ucywKICAvKiogTWFwIG9mIGluZmVycmVkIHRlbXBsYXRlcyBieSB0YWcgbmFtZSAqLwogIGdldCBpbmZlcnJlZFRlbXBsYXRlcygpIHsKICAgIHJldHVybiBpbnNpZGVPdXRBUEkuaW5mZXJyZWRUZW1wbGF0ZXM7CiAgfSwKICAvKiogTWFudWFsbHkgaW5mZXIgdGVtcGxhdGUgZm9yIGEgdGFnICovCiAgaW5mZXJUZW1wbGF0ZTogaW5zaWRlT3V0QVBJLmluZmVyVGVtcGxhdGUsCiAgLy8gTExNIEludGVncmF0aW9uIEFQSSAoUGhhc2UgNCkKICAvKiogTExNIGNvbnRleHQgYW5kIG91dHB1dCB1dGlsaXRpZXMgKi8KICBsbG06IGxsbUFQSQp9OwppZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIpIHsKICB3aW5kb3cuYm9yZURPTSA9IGJvcmVET007Cn0KYXN5bmMgZnVuY3Rpb24gaW5mbGljdEJvcmVET00oc3RhdGUsIGNvbXBvbmVudHNMb2dpYywgY29uZmlnKSB7CiAgaWYgKGNvbmZpZz8uZGVidWcgIT09IHZvaWQgMCkgewogICAgc2V0RGVidWdDb25maWcoY29uZmlnLmRlYnVnKTsKICB9CiAgaWYgKCFoYXNMb2dnZWRWZXJzaW9uICYmIGlzRGVidWdFbmFibGVkKCJ2ZXJzaW9uTG9nIikpIHsKICAgIGhhc0xvZ2dlZFZlcnNpb24gPSB0cnVlOwogICAgaWYgKHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgY29uc29sZS5pbmZvID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGNvbnNvbGUuaW5mbyhgW2JvcmVET01dIHYke1ZFUlNJT059YCk7CiAgICB9CiAgfQogIGNvbnN0IHJlZ2lzdGVyZWROYW1lcyA9IHNlYXJjaEZvckNvbXBvbmVudHMoKTsKICBjb25zdCBjb21wb25lbnRzQ29kZSA9IGF3YWl0IGR5bmFtaWNJbXBvcnRTY3JpcHRzKHJlZ2lzdGVyZWROYW1lcyk7CiAgaWYgKGNvbXBvbmVudHNMb2dpYykgewogICAgZm9yIChjb25zdCB0YWdOYW1lIG9mIE9iamVjdC5rZXlzKGNvbXBvbmVudHNMb2dpYykpIHsKICAgICAgY29tcG9uZW50c0NvZGUuc2V0KHRhZ05hbWUsIGNvbXBvbmVudHNMb2dpY1t0YWdOYW1lXSk7CiAgICB9CiAgfQogIGNvbnN0IGluaXRpYWxTdGF0ZSA9IHsKICAgIGFwcDogc3RhdGUsCiAgICBpbnRlcm5hbDogewogICAgICBjdXN0b21UYWdzOiByZWdpc3RlcmVkTmFtZXMsCiAgICAgIGNvbXBvbmVudHM6IGNvbXBvbmVudHNDb2RlLAogICAgICB1cGRhdGVzOiB7CiAgICAgICAgcGF0aDogW10sCiAgICAgICAgdmFsdWU6IFtdLAogICAgICAgIHJhZjogdm9pZCAwLAogICAgICAgIHN1YnNjcmliZXJzOiAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpCiAgICAgIH0KICAgIH0KICB9OwogIGNvbnN0IHByb3hpZmllZFN0YXRlID0gcHJveGlmeShpbml0aWFsU3RhdGUpOwogIHByb3hpZmllZFN0YXRlLmludGVybmFsLnVwZGF0ZXMucGF0aCA9IFtdOwogIHByb3hpZmllZFN0YXRlLmludGVybmFsLnVwZGF0ZXMudmFsdWUgPSBbXTsKICBpZiAocHJveGlmaWVkU3RhdGUuaW50ZXJuYWwudXBkYXRlcy5yYWYpIHsKICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHByb3hpZmllZFN0YXRlLmludGVybmFsLnVwZGF0ZXMucmFmKTsKICAgIHByb3hpZmllZFN0YXRlLmludGVybmFsLnVwZGF0ZXMucmFmID0gdm9pZCAwOwogIH0KICBzZXRDdXJyZW50QXBwU3RhdGUocHJveGlmaWVkU3RhdGUsIHdlYkNvbXBvbmVudCwgcmVnaXN0ZXJDb21wb25lbnQpOwogIHJ1bkNvbXBvbmVudHNJbml0aWFsaXplcihwcm94aWZpZWRTdGF0ZSk7CiAgb2JzZXJ2ZVVuZGVmaW5lZEVsZW1lbnRzKCk7CiAgcmV0dXJuIHByb3hpZmllZFN0YXRlLmFwcDsKfQpmdW5jdGlvbiB3ZWJDb21wb25lbnQoaW5pdEZ1bmN0aW9uKSB7CiAgbGV0IGlzSW5pdGlhbGl6ZWQgPSBudWxsOwogIGxldCByZW5kZXJGdW5jdGlvbjsKICBjb25zdCByZXN1bHQgPSAoYXBwU3RhdGUsIGRldGFpbCkgPT4gKGMpID0+IHsKICAgIGNvbnN0IHsgaW50ZXJuYWwsIGFwcCB9ID0gYXBwU3RhdGU7CiAgICBsZXQgbG9nID0gW107CiAgICBjb25zdCBzdGF0ZSA9IGNyZWF0ZVN0YXRlQWNjZXNzb3IoYXBwLCBsb2cpOwogICAgY29uc3QgcmVmcyA9IGNyZWF0ZVJlZnNBY2Nlc3NvcihjKTsKICAgIGNvbnN0IHNsb3RzID0gY3JlYXRlU2xvdHNBY2Nlc3NvcihjKTsKICAgIGNvbnN0IG9uID0gY3JlYXRlRXZlbnRzSGFuZGxlcihjLCBhcHAsIGRldGFpbCk7CiAgICBpZiAoaXNJbml0aWFsaXplZCAhPT0gYykgewogICAgICBjb25zdCB1cGRhdGVTdWJzY3JpYmVycyA9IGFzeW5jICgpID0+IHsKICAgICAgICBjb25zdCBzdWJzY3JpYmVycyA9IGludGVybmFsLnVwZGF0ZXMuc3Vic2NyaWJlcnM7CiAgICAgICAgZm9yIChsZXQgcGF0aCBvZiBsb2cpIHsKICAgICAgICAgIGNvbnN0IGZ1bmN0aW9ucyA9IHN1YnNjcmliZXJzLmdldChwYXRoKTsKICAgICAgICAgIGlmIChmdW5jdGlvbnMpIHsKICAgICAgICAgICAgaWYgKCFmdW5jdGlvbnMuaW5jbHVkZXMocmVuZGVyRnVuY3Rpb24pKSB7CiAgICAgICAgICAgICAgZnVuY3Rpb25zLnB1c2gocmVuZGVyRnVuY3Rpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdWJzY3JpYmVycy5zZXQocGF0aCwgW3JlbmRlckZ1bmN0aW9uXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICBsZXQgdXNlckRlZmluZWRSZW5kZXJlcjsKICAgICAgdHJ5IHsKICAgICAgICB1c2VyRGVmaW5lZFJlbmRlcmVyID0gaW5pdEZ1bmN0aW9uKHsKICAgICAgICAgIGRldGFpbCwKICAgICAgICAgIHN0YXRlLAogICAgICAgICAgcmVmcywKICAgICAgICAgIG9uLAogICAgICAgICAgc2VsZjogYwogICAgICAgIH0pOwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGNvbnN0IGVyciA9IGVycm9yOwogICAgICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgICAgICBsb2dJbml0RXJyb3IoZGV0YWlsPy5uYW1lID8/IGMudGFnTmFtZS50b0xvd2VyQ2FzZSgpLCBlcnIpOwogICAgICAgIH0KICAgICAgICB1c2VyRGVmaW5lZFJlbmRlcmVyID0gKCkgPT4gewogICAgICAgIH07CiAgICAgIH0KICAgICAgcmVuZGVyRnVuY3Rpb24gPSAocmVuZGVyU3RhdGUpID0+IHsKICAgICAgICBjb25zdCBjb21wb25lbnROYW1lID0gZGV0YWlsPy5uYW1lID8/IGMudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIGNvbnN0IGhlbHBlcnMgPSBjcmVhdGVSZW5kZXJIZWxwZXJzKAogICAgICAgICAgY29tcG9uZW50TmFtZSwKICAgICAgICAgIGMsCiAgICAgICAgICAoKSA9PiByZW5kZXJGdW5jdGlvbihyZW5kZXJTdGF0ZSkKICAgICAgICApOwogICAgICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiZXJyb3JCb3VuZGFyeSIpKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB1c2VyRGVmaW5lZFJlbmRlcmVyKHsKICAgICAgICAgICAgICBzdGF0ZTogcmVuZGVyU3RhdGUsCiAgICAgICAgICAgICAgcmVmcywKICAgICAgICAgICAgICBzbG90cywKICAgICAgICAgICAgICBzZWxmOiBjLAogICAgICAgICAgICAgIGRldGFpbCwKICAgICAgICAgICAgICBtYWtlQ29tcG9uZW50OiAodGFnLCBvcHRzKSA9PiB7CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlQW5kUnVuQ29kZSh0YWcsIGFwcFN0YXRlLCBvcHRzPy5kZXRhaWwpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgaGVscGVycwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdXBkYXRlU3Vic2NyaWJlcnMoKTsKICAgICAgICAgICAgY2xlYXJDb21wb25lbnRFcnJvck1hcmsoYyk7CiAgICAgICAgICAgIGNsZWFyRXJyb3IoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBjb25zdCBlcnIgPSBlcnJvcjsKICAgICAgICAgICAgY29uc3QgY3R4ID0gewogICAgICAgICAgICAgIGNvbXBvbmVudDogY29tcG9uZW50TmFtZSwKICAgICAgICAgICAgICBlbGVtZW50OiBjLAogICAgICAgICAgICAgIGVycm9yOiBlcnIsCiAgICAgICAgICAgICAgc3RhdGU6IGFwcCwKICAgICAgICAgICAgICAvLyBXcml0ZSBwcm94eSAtIE1VVEFCTEUKICAgICAgICAgICAgICByZWZzLAogICAgICAgICAgICAgIHNsb3RzLAogICAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgICAgICByZXJlbmRlcjogKCkgPT4gcmVuZGVyRnVuY3Rpb24ocmVuZGVyU3RhdGUpLAogICAgICAgICAgICAgIHN0YWNrOiBlcnIuc3RhY2sgPz8gIiIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgICAgICAgICAgICBsb2dFcnJvcihjdHgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxvZ0Vycm9yTWluaW1hbChjb21wb25lbnROYW1lLCBlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV4cG9zZUdsb2JhbHMoY3R4KTsKICAgICAgICAgICAgc3RvcmVFcnJvcihjdHgpOwogICAgICAgICAgICBtYXJrQ29tcG9uZW50RXJyb3IoYyk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHVzZXJEZWZpbmVkUmVuZGVyZXIoewogICAgICAgICAgICBzdGF0ZTogcmVuZGVyU3RhdGUsCiAgICAgICAgICAgIHJlZnMsCiAgICAgICAgICAgIHNsb3RzLAogICAgICAgICAgICBzZWxmOiBjLAogICAgICAgICAgICBkZXRhaWwsCiAgICAgICAgICAgIG1ha2VDb21wb25lbnQ6ICh0YWcsIG9wdHMpID0+IHsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlQW5kUnVuQ29kZSh0YWcsIGFwcFN0YXRlLCBvcHRzPy5kZXRhaWwpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBoZWxwZXJzCiAgICAgICAgICB9KTsKICAgICAgICAgIHVwZGF0ZVN1YnNjcmliZXJzKCk7CiAgICAgICAgfQogICAgICB9OwogICAgICBzdG9yZUNvbXBvbmVudENvbnRleHQoYywgewogICAgICAgIHN0YXRlOiBhcHAsCiAgICAgICAgcmVmcywKICAgICAgICBzbG90cywKICAgICAgICBzZWxmOiBjLAogICAgICAgIGRldGFpbCwKICAgICAgICByZXJlbmRlcjogKCkgPT4gcmVuZGVyRnVuY3Rpb24oYXBwKQogICAgICB9KTsKICAgIH0KICAgIHJlbmRlckZ1bmN0aW9uKHN0YXRlKTsKICAgIGlzSW5pdGlhbGl6ZWQgPSBjOwogIH07CiAgcmVzdWx0W1dFQl9DT01QT05FTlRfTUFSS0VSXSA9IHRydWU7CiAgcmV0dXJuIHJlc3VsdDsKfQpleHBvcnQgewogIFZFUlNJT04sCiAgYm9yZURPTSwKICBjbGVhckdsb2JhbHMsCiAgaW5mbGljdEJvcmVET00sCiAgaXNEZWJ1Z0VuYWJsZWQsCiAgcXVlcnlDb21wb25lbnQsCiAgcmVnaXN0ZXJDb21wb25lbnQsCiAgc2V0RGVidWdDb25maWcsCiAgd2ViQ29tcG9uZW50Cn07Cg==
`;
var beautify = import_js_beautify.default.html;
var DEFAULT_COMPONENTS_DIR = "components";
var DEFAULT_STATIC_DIR = "src";
var DEFAULT_STATIC_SERVE = "";
var BUILD_DIR = "build";
var serverStarted = false;
var numberOfRefreshes = 0;
function collectMultiValue(value, previous) {
  const next = Array.isArray(previous) ? [...previous] : [];
  next.push(value);
  return next;
}
console.log("## boreDOM CLI options");
console.log(
  "## ",
  "--index <path to default html>",
  "The base HTML file to serve",
  "defaults to ./index.html"
);
console.log(
  "## ",
  "--html <folder>",
  "Folder containing HTML component files",
  'defaults to "./components"'
);
console.log(
  "## ",
  "--static <folder>",
  "Static files folder, all files in here are copied as is",
  'defaults to "./src"'
);
console.log(
  "## ",
  "--static-serve <folder>",
  "Build subfolder used to serve static assets",
  'defaults to "./"'
);
import_commander.program.option("--index <path to file>", "Index file to serve", "index.html").option(
  "--html <folder>",
  "Folder containing HTML component files",
  DEFAULT_COMPONENTS_DIR
).option(
  "--static <folder>",
  "Folder containing static files to be copied as is",
  collectMultiValue,
  [DEFAULT_STATIC_DIR]
).option(
  "--components-serve <folder>",
  "Build subfolder used to serve processed components",
  DEFAULT_COMPONENTS_DIR
).option(
  "--static-serve <folder>",
  "Build subfolder used to serve static assets",
  DEFAULT_STATIC_SERVE
);
var isTestMode = Boolean(process.env.BOREDOM_CLI_TEST_MODE);
if (isTestMode) {
  import_commander.program.parse([], { from: "user" });
} else {
  import_commander.program.parse(process.argv);
}
var options = import_commander.program.opts();
function sanitizeServeInput(value) {
  const normalizedSlashes = value.replace(/\\+/g, "/").trim();
  if (!normalizedSlashes) {
    return { fsPath: "", urlPath: "" };
  }
  if (["/", "./"].includes(normalizedSlashes)) {
    return { fsPath: "", urlPath: "/" };
  }
  let working = normalizedSlashes;
  while (working.startsWith("./")) {
    working = working.slice(2);
  }
  const isAbsolute = working.startsWith("/");
  if (isAbsolute) {
    working = working.replace(/^\/+/, "");
  }
  working = working.replace(/\/+$/, "");
  const fsPath = working;
  if (!fsPath) {
    return { fsPath: "", urlPath: isAbsolute ? "/" : "" };
  }
  const urlPath = isAbsolute ? `/${fsPath}` : fsPath;
  return { fsPath, urlPath };
}
function normalizeServePath(input, fallback) {
  if (typeof input === "undefined" || input === null) {
    return sanitizeServeInput(fallback);
  }
  const trimmed = String(input).trim();
  if (!trimmed) {
    return sanitizeServeInput(fallback);
  }
  return sanitizeServeInput(trimmed);
}
function buildRelativeServePath(base, ...segments) {
  const cleanSegments = segments.filter(Boolean).map((segment) => {
    return segment.replace(/^\/+/, "").replace(/\/+$/, "");
  });
  const ensureModuleRelative = (candidate) => {
    if (!candidate) {
      return candidate;
    }
    if (candidate.startsWith("/") || candidate.startsWith("./") || candidate.startsWith("../")) {
      return candidate;
    }
    return `./${candidate}`;
  };
  if (!base || base === ".") {
    return ensureModuleRelative(cleanSegments.join("/"));
  }
  if (base === "/") {
    const joined = cleanSegments.join("/");
    return joined ? `/${joined}` : "/";
  }
  const cleanBase = base.replace(/\/+$/, "");
  return ensureModuleRelative([cleanBase, ...cleanSegments].join("/"));
}
var componentsServePath;
var staticServePath;
var componentsServeUrlPath;
var staticServeUrlPath;
function setServePaths(currentOptions = options) {
  const componentsPaths = normalizeServePath(
    currentOptions.componentsServe,
    "components"
  );
  const staticPaths = normalizeServePath(
    currentOptions.staticServe,
    DEFAULT_STATIC_SERVE
  );
  componentsServePath = componentsPaths.fsPath;
  componentsServeUrlPath = componentsPaths.urlPath;
  staticServePath = staticPaths.fsPath;
  staticServeUrlPath = staticPaths.urlPath;
  return {
    componentsServePath,
    componentsServeUrlPath,
    staticServePath,
    staticServeUrlPath
  };
}
function getServePaths() {
  return {
    componentsServePath,
    componentsServeUrlPath,
    staticServePath,
    staticServeUrlPath
  };
}
setServePaths();
async function copyStatic() {
  const staticFolders = Array.isArray(options.static) ? options.static : [options.static].filter(Boolean);
  if (staticFolders.length === 0) {
    return;
  }
  for (const folder of staticFolders) {
    const staticDir = import_path.default.resolve(folder);
    if (await import_fs_extra.default.pathExists(staticDir)) {
      await import_fs_extra.default.copy(staticDir, import_path.default.join(BUILD_DIR, staticServePath), {
        overwrite: true,
        errorOnExist: false
      });
      console.log(`Static folder copied from ${folder}.`);
    }
  }
}
async function copyBoreDOM() {
  return import_fs_extra.default.writeFile(import_path.default.join(BUILD_DIR, "boreDOM.js"), atob(boredom));
}
async function processComponents() {
  let components = {};
  if (options.html) {
    const htmlFolder = import_path.default.resolve(options.html);
    const htmlFiles = glob.sync("**/*.html", { cwd: htmlFolder });
    for (const file of htmlFiles) {
      const filePath = import_path.default.join(htmlFolder, file);
      const content = await import_fs_extra.default.readFile(filePath, "utf-8");
      const $ = cheerio.load(content, { decodeEntities: false });
      const template = $("template[data-component]");
      if (template.length) {
        const componentName = template.attr("data-component");
        const fullTemplate = $.html(template);
        const componentBuildDir = import_path.default.join(
          BUILD_DIR,
          componentsServePath,
          componentName
        );
        await import_fs_extra.default.ensureDir(componentBuildDir);
        const destHtmlPath = import_path.default.join(
          componentBuildDir,
          `${componentName}.html`
        );
        await import_fs_extra.default.copy(filePath, destHtmlPath);
        const componentDir = import_path.default.dirname(filePath);
        const jsMatch = glob.sync(`**/${componentName}.js`, {
          cwd: componentDir
        });
        const cssMatch = glob.sync(`**/${componentName}.css`, {
          cwd: componentDir
        });
        const hasJS = jsMatch.length > 0;
        if (jsMatch.length > 0) {
          const jsSrc = import_path.default.join(componentDir, jsMatch[0]);
          const destJsPath = import_path.default.join(
            componentBuildDir,
            `${componentName}.js`
          );
          await import_fs_extra.default.copy(jsSrc, destJsPath);
          console.log(`Copied ${componentName}.js to ${componentBuildDir}`);
        }
        const hasCSS = cssMatch.length > 0;
        if (cssMatch.length > 0) {
          const cssSrc = import_path.default.join(componentDir, cssMatch[0]);
          const destCssPath = import_path.default.join(
            componentBuildDir,
            `${componentName}.css`
          );
          await import_fs_extra.default.copy(cssSrc, destCssPath);
          console.log(`Copied ${componentName}.css to ${componentBuildDir}`);
        }
        components[componentName] = {
          templateTag: fullTemplate,
          hasJS,
          hasCSS
        };
      }
    }
  }
  return components;
}
async function updateIndex(components) {
  console.log(
    "Updated index.html with components:\n\n",
    JSON.stringify(components, null, 2)
  );
  const indexPath = import_path.default.resolve(options.index);
  let indexContent = await import_fs_extra.default.readFile(indexPath, "utf-8");
  const $ = cheerio.load(indexContent, { decodeEntities: false });
  $("head").prepend(
    `
  <script type="importmap">{ "imports": {      "@mr_hugo/boredom/dist/boreDOM.full.js": "./boreDOM.js",
       "boredom": "./boreDOM.js"
     } }</script>`
  );
  $("body").append(`
  <script src="boreDOM.js" type="module"></script>`);
  Object.keys(components).forEach((component) => {
    const componentScriptPath = buildRelativeServePath(
      componentsServeUrlPath,
      component,
      `${component}.js`
    );
    const existingComponentScript = $(`script[src*="${component}.js"]`).first();
    const componentCssPath = buildRelativeServePath(
      componentsServeUrlPath,
      component,
      `${component}.css`
    );
    if (components[component].hasJS) {
      if (existingComponentScript.length > 0) {
        existingComponentScript.attr("src", componentScriptPath);
        existingComponentScript.attr("type", "module");
      } else if ($(`script[src="${componentScriptPath}"]`).length === 0) {
        $("body").append(
          `
  <script src="${componentScriptPath}" type="module"></script>`
        );
      }
    }
    if (components[component].hasCSS) {
      const existingComponentStylesheet = $(`link[href*="${component}.css"]`).first();
      if (existingComponentStylesheet.length > 0) {
        existingComponentStylesheet.attr("href", componentCssPath);
      } else if ($(`link[href="${componentCssPath}"]`).length === 0) {
        $("head").append(
          `
  <link rel="stylesheet" href="${componentCssPath}">`
        );
      }
    }
    if ($(`template[data-component="${component}"]`).length === 0) {
      const templateMarkup = `
  ${components[component].templateTag}`;
      const firstScript = $("body > script").first();
      if (firstScript.length > 0) {
        firstScript.before(templateMarkup);
      } else {
        $("body").prepend(templateMarkup);
      }
      console.log(`Injected template for ${component}`);
    }
  });
  $("template[data-component]").each((i, el) => {
    const comp = $(el).attr("data-component");
    if (!components[comp]) {
      $(el).remove();
      console.log(`Removed unused template for ${comp}`);
    }
  });
  const prettyHtml = beautify($.html(), {
    indent_size: 2,
    space_in_empty_paren: true
  });
  const buildIndex = import_path.default.join(BUILD_DIR, "index.html");
  await import_fs_extra.default.outputFile(buildIndex, prettyHtml);
  console.log("Index updated with pretty printed HTML.");
}
async function startServer() {
  if (serverStarted) return;
  function serveFile(req, res, opts) {
    let urlPath = decodeURIComponent(req.url.split(/[?#]/)[0]);
    if (urlPath === "/" || urlPath.endsWith("/")) {
      urlPath = import_path.default.posix.join(urlPath, "index.html");
    }
    const filePath = import_path.default.join(BUILD_DIR, urlPath);
    import_fs_extra.default.pathExists(filePath).then((exists) => {
      if (!exists) {
        res.writeHead(404, { "Content-Type": "text/plain" });
        return res.end("Not Found");
      }
      const contentType = import_mime_types.default.lookup(filePath) || "application/octet-stream";
      res.writeHead(200, { "Content-Type": contentType });
      import_fs_extra.default.createReadStream(filePath).pipe(res);
    }).catch((err) => {
      res.writeHead(500, { "Content-Type": "text/plain" });
      res.end("Internal Server Error");
    });
  }
  const server = import_http.default.createServer((req, res) => {
    return serveFile(req, res, {
      cleanUrls: true,
      public: import_path.default.resolve(BUILD_DIR)
    });
  });
  let port = process.env.PORT || 8080;
  const serverHandler = () => {
    const { port: actualPort } = server.address();
    console.log(`Server running at http://localhost:${actualPort}`);
  };
  server.listen(port, serverHandler);
  server.on("error", (e) => {
    if (e.code === "EADDRINUSE") {
      console.log(
        "\x1B[33m%s\x1B[0m",
        `\u26A0\uFE0F Warning: Port ${port} in use, starting with a OS assigned port.`
      );
      setTimeout(() => {
        server.close();
        server.listen(0);
      }, 1e3);
    }
  });
  serverStarted = true;
}
async function build() {
  await import_fs_extra.default.remove(BUILD_DIR);
  await import_fs_extra.default.ensureDir(BUILD_DIR);
  await copyStatic();
  await copyBoreDOM();
  const components = await processComponents();
  await updateIndex(components);
}
async function watchFiles() {
  const pathsToWatch = [];
  if (options.index) {
    pathsToWatch.push(import_path.default.resolve(options.index));
  }
  if (options.html) {
    pathsToWatch.push(import_path.default.resolve(options.html));
  }
  const staticFolders = Array.isArray(options.static) ? options.static : [options.static].filter(Boolean);
  for (const folder of staticFolders) {
    const staticDir = import_path.default.resolve(folder);
    if (await import_fs_extra.default.pathExists(staticDir)) {
      pathsToWatch.push(staticDir);
    }
  }
  console.log("Watching for file changes in:", pathsToWatch);
  const watcher = import_chokidar.default.watch(pathsToWatch, { ignoreInitial: true });
  let rebuildTimeout;
  watcher.on("all", (event, filePath) => {
    console.log(`Detected ${event} on ${filePath}. Scheduling rebuild...`);
    if (rebuildTimeout) clearTimeout(rebuildTimeout);
    rebuildTimeout = setTimeout(() => {
      build().then(() => {
        console.log(
          `#${++numberOfRefreshes} - ${(/* @__PURE__ */ new Date()).toISOString()} - Build refreshed.`
        );
      }).catch((err) => console.error("Error during rebuild:", err));
    }, 100);
  });
}
async function main() {
  console.log("The file used as the base for HTML is:", options.index);
  const indexPath = import_path.default.join(process.cwd(), options.index);
  import_fs_extra.default.ensureFile(indexPath, (err) => {
    if (err) {
      console.log(
        "\x1B[31m%s\x1B[0m",
        `\u274C Error: The file "${indexPath}" was not found.
Please specify a location for it with "--index"`
      );
      process.exit(1);
    }
  });
  await build();
  startServer();
  await watchFiles();
}
if (!isTestMode) {
  main().catch((err) => {
    console.error(err);
    process.exit(1);
  });
}
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  BUILD_DIR,
  build,
  buildRelativeServePath,
  copyBoreDOM,
  getServePaths,
  normalizeServePath,
  options,
  processComponents,
  setServePaths,
  updateIndex
});
