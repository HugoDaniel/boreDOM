#!/usr/bin/env node
"use strict";
var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
  // If the importer is in node compatibility mode or this is not an ESM
  // file that has been converted to a CommonJS file using a Babel-
  // compatible transform (i.e. "__esModule" has not been set), then set
  // "default" to the CommonJS "module.exports" for node compatibility.
  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
  mod
));
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// boreDOMCLI/generated_cli.js
var generated_cli_exports = {};
__export(generated_cli_exports, {
  BUILD_DIR: () => BUILD_DIR,
  build: () => build,
  buildRelativeServePath: () => buildRelativeServePath,
  copyBoreDOM: () => copyBoreDOM,
  getServePaths: () => getServePaths,
  normalizeServePath: () => normalizeServePath,
  options: () => options,
  processComponents: () => processComponents,
  setServePaths: () => setServePaths,
  updateIndex: () => updateIndex
});
module.exports = __toCommonJS(generated_cli_exports);
var import_fs_extra = __toESM(require("fs-extra"));
var import_mime_types = __toESM(require("mime-types"));
var import_path = __toESM(require("path"));
var glob = __toESM(require("glob"));
var cheerio = __toESM(require("cheerio"));
var import_commander = require("commander");
var import_http = __toESM(require("http"));
var import_finalhandler = __toESM(require("finalhandler"));
var import_js_beautify = __toESM(require("js-beautify"));
var import_chokidar = __toESM(require("chokidar"));
var import_serve_handler = __toESM(require("serve-handler"));
var boredom = `
dmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcE5hbWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM7CnZhciBfX2VzbSA9IChmbiwgcmVzKSA9PiBmdW5jdGlvbiBfX2luaXQoKSB7CiAgcmV0dXJuIGZuICYmIChyZXMgPSAoMCwgZm5bX19nZXRPd25Qcm9wTmFtZXMoZm4pWzBdXSkoZm4gPSAwKSksIHJlczsKfTsKdmFyIF9fZXhwb3J0ID0gKHRhcmdldCwgYWxsKSA9PiB7CiAgZm9yICh2YXIgbmFtZSBpbiBhbGwpCiAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwp9OwoKLy8gc3JjL2NvbnNvbGUtYXBpLnRzCmZ1bmN0aW9uIHNldEN1cnJlbnRBcHBTdGF0ZShzdGF0ZSwgd2ViQ29tcG9uZW50Rm4sIHJlZ2lzdGVyQ29tcG9uZW50Rm4pIHsKICBjdXJyZW50QXBwU3RhdGUgPSBzdGF0ZTsKICBpZiAod2ViQ29tcG9uZW50Rm4pIHN0b3JlZFdlYkNvbXBvbmVudCA9IHdlYkNvbXBvbmVudEZuOwogIGlmIChyZWdpc3RlckNvbXBvbmVudEZuKSBzdG9yZWRSZWdpc3RlckNvbXBvbmVudCA9IHJlZ2lzdGVyQ29tcG9uZW50Rm47Cn0KZnVuY3Rpb24gZ2V0Q3VycmVudEFwcFN0YXRlKCkgewogIHJldHVybiBjdXJyZW50QXBwU3RhdGU7Cn0KZnVuY3Rpb24gc3RvcmVDb21wb25lbnRDb250ZXh0KGVsZW1lbnQsIGNvbnRleHQyKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJhcGkiKSkgcmV0dXJuOwogIGNvbXBvbmVudENvbnRleHRzLnNldChlbGVtZW50LCBjb250ZXh0Mik7Cn0KZnVuY3Rpb24gaXNXZWJDb21wb25lbnRSZXN1bHQoZm4pIHsKICByZXR1cm4gdHlwZW9mIGZuID09PSAiZnVuY3Rpb24iICYmIGZuW1dFQl9DT01QT05FTlRfTUFSS0VSXSA9PT0gdHJ1ZTsKfQpmdW5jdGlvbiBkZWZpbmUodGFnTmFtZSwgdGVtcGxhdGUsIGxvZ2ljKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHsKICAgIGNvbnNvbGUud2FybigiW2JvcmVET01dIGRlZmluZSgpIGlzIG5vdCBhdmFpbGFibGUgaW4gcHJvZHVjdGlvbiBidWlsZCIpOwogICAgcmV0dXJuIGZhbHNlOwogIH0KICBpZiAoIWlzRGVidWdFbmFibGVkKCJhcGkiKSkgewogICAgY29uc29sZS53YXJuKCJbYm9yZURPTV0gZGVmaW5lKCkgaXMgZGlzYWJsZWQgKGRlYnVnLmFwaSBpcyBmYWxzZSkiKTsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKCFjdXJyZW50QXBwU3RhdGUpIHsKICAgIHRocm93IG5ldyBFcnJvcigiW2JvcmVET01dIENhbm5vdCBkZWZpbmUgY29tcG9uZW50IGJlZm9yZSBpbmZsaWN0Qm9yZURPTSgpIik7CiAgfQogIGlmICghdGFnTmFtZS5pbmNsdWRlcygiLSIpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYFtib3JlRE9NXSBJbnZhbGlkIHRhZyBuYW1lICIke3RhZ05hbWV9IjogbXVzdCBjb250YWluIGEgaHlwaGVuYCk7CiAgfQogIGlmIChjdXN0b21FbGVtZW50cy5nZXQodGFnTmFtZSkpIHsKICAgIHRocm93IG5ldyBFcnJvcihgW2JvcmVET01dIENvbXBvbmVudCAiJHt0YWdOYW1lfSIgaXMgYWxyZWFkeSBkZWZpbmVkYCk7CiAgfQogIGlmICghc3RvcmVkV2ViQ29tcG9uZW50IHx8ICFzdG9yZWRSZWdpc3RlckNvbXBvbmVudCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJbYm9yZURPTV0gQ29uc29sZSBBUEkgbm90IGluaXRpYWxpemVkLiBDYWxsIGluZmxpY3RCb3JlRE9NKCkgZmlyc3QuIik7CiAgfQogIGNvbnN0IGFwcFN0YXRlID0gY3VycmVudEFwcFN0YXRlOwogIGNvbnN0IHdlYkNvbXBvbmVudEZuID0gc3RvcmVkV2ViQ29tcG9uZW50OwogIGNvbnN0IHJlZ2lzdGVyQ29tcG9uZW50Rm4gPSBzdG9yZWRSZWdpc3RlckNvbXBvbmVudDsKICBjb25zdCB0ZW1wbGF0ZUVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiKTsKICB0ZW1wbGF0ZUVsLmlubmVySFRNTCA9IHRlbXBsYXRlOwogIHRlbXBsYXRlRWwuc2V0QXR0cmlidXRlKCJkYXRhLWNvbXBvbmVudCIsIHRhZ05hbWUpOwogIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGVtcGxhdGVFbCk7CiAgY29uc3QgY29tcG9uZW50TG9naWMgPSBpc1dlYkNvbXBvbmVudFJlc3VsdChsb2dpYykgPyBsb2dpYyA6IHdlYkNvbXBvbmVudEZuKGxvZ2ljKTsKICBhcHBTdGF0ZS5pbnRlcm5hbC5jb21wb25lbnRzLnNldCh0YWdOYW1lLCBjb21wb25lbnRMb2dpYyk7CiAgYXBwU3RhdGUuaW50ZXJuYWwuY3VzdG9tVGFncy5wdXNoKHRhZ05hbWUpOwogIHJlZ2lzdGVyQ29tcG9uZW50Rm4odGFnTmFtZSk7CiAgaW5pdGlhbGl6ZUV4aXN0aW5nRWxlbWVudHModGFnTmFtZSwgY29tcG9uZW50TG9naWMpOwogIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICBjb25zb2xlLmxvZygKICAgICAgIiVjXHUyNzA1IGJvcmVET006IERlZmluZWQgJWM8JXM+IiwKICAgICAgImNvbG9yOiAjMjdhZTYwOyBmb250LXdlaWdodDogYm9sZCIsCiAgICAgICJjb2xvcjogIzRlY2RjNDsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgICB0YWdOYW1lCiAgICApOwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBpbml0aWFsaXplRXhpc3RpbmdFbGVtZW50cyh0YWdOYW1lLCBsb2dpYykgewogIGlmICghY3VycmVudEFwcFN0YXRlKSByZXR1cm47CiAgY29uc3QgZWxlbWVudHMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwodGFnTmFtZSkpOwogIGNvbnN0IGZhaWxlZENvdW50ID0geyBjb3VudDogMCB9OwogIGVsZW1lbnRzLmZvckVhY2goKGVsZW0sIGluZGV4KSA9PiB7CiAgICBpZiAoZWxlbSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ICYmICJyZW5kZXJDYWxsYmFjayIgaW4gZWxlbSkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IGRldGFpbCA9IHsgaW5kZXgsIG5hbWU6IHRhZ05hbWUsIGRhdGE6IHZvaWQgMCB9OwogICAgICAgIGNvbnN0IHJlbmRlckNhbGxiYWNrID0gbG9naWMoY3VycmVudEFwcFN0YXRlLCBkZXRhaWwpOwogICAgICAgIGVsZW0ucmVuZGVyQ2FsbGJhY2sgPSByZW5kZXJDYWxsYmFjazsKICAgICAgICByZW5kZXJDYWxsYmFjayhlbGVtKTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBmYWlsZWRDb3VudC5jb3VudCsrOwogICAgICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKAogICAgICAgICAgICBgW2JvcmVET01dIEZhaWxlZCB0byBpbml0aWFsaXplIDwke3RhZ05hbWV9PiBpbnN0YW5jZSAke2luZGV4fTpgLAogICAgICAgICAgICBlcnJvcgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKICBpZiAoZmFpbGVkQ291bnQuY291bnQgPiAwICYmIGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgIGNvbnNvbGUud2FybigKICAgICAgYFtib3JlRE9NXSAke2ZhaWxlZENvdW50LmNvdW50fSBvZiAke2VsZW1lbnRzLmxlbmd0aH0gPCR7dGFnTmFtZX0+IGluc3RhbmNlcyBmYWlsZWQgdG8gaW5pdGlhbGl6ZWAKICAgICk7CiAgfQp9CmZ1bmN0aW9uIG9wZXJhdGUoc2VsZWN0b3JPckVsZW1lbnQsIGluZGV4ID0gMCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICBjb25zb2xlLndhcm4oIltib3JlRE9NXSBvcGVyYXRlKCkgaXMgbm90IGF2YWlsYWJsZSBpbiBwcm9kdWN0aW9uIGJ1aWxkIik7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoIWlzRGVidWdFbmFibGVkKCJhcGkiKSkgewogICAgY29uc29sZS53YXJuKCJbYm9yZURPTV0gb3BlcmF0ZSgpIGlzIGRpc2FibGVkIChkZWJ1Zy5hcGkgaXMgZmFsc2UpIik7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBsZXQgZWxlbWVudCA9IG51bGw7CiAgaWYgKHR5cGVvZiBzZWxlY3Rvck9yRWxlbWVudCA9PT0gInN0cmluZyIpIHsKICAgIGNvbnN0IGVsZW1lbnRzID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yT3JFbGVtZW50KSkuZmlsdGVyKChlbCkgPT4gZWwgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCk7CiAgICBlbGVtZW50ID0gZWxlbWVudHNbaW5kZXhdID8/IG51bGw7CiAgfSBlbHNlIHsKICAgIGVsZW1lbnQgPSBzZWxlY3Rvck9yRWxlbWVudDsKICB9CiAgaWYgKCFlbGVtZW50KSB7CiAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICBjb25zb2xlLndhcm4oYFtib3JlRE9NXSBvcGVyYXRlKCk6IE5vIGVsZW1lbnQgZm91bmQgZm9yICIke3NlbGVjdG9yT3JFbGVtZW50fSJgKTsKICAgIH0KICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGNvbnN0IGNvbnRleHQyID0gY29tcG9uZW50Q29udGV4dHMuZ2V0KGVsZW1lbnQpOwogIGlmICghY29udGV4dDIpIHsKICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgIGNvbnNvbGUud2FybihgW2JvcmVET01dIG9wZXJhdGUoKTogRWxlbWVudCBpcyBub3QgYSBib3JlRE9NIGNvbXBvbmVudCBvciBub3QgaW5pdGlhbGl6ZWRgKTsKICAgIH0KICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBjb250ZXh0MjsKfQpmdW5jdGlvbiBleHBvcnRDb21wb25lbnQoc2VsZWN0b3IpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgewogICAgY29uc29sZS53YXJuKCJbYm9yZURPTV0gZXhwb3J0Q29tcG9uZW50KCkgaXMgbm90IGF2YWlsYWJsZSBpbiBwcm9kdWN0aW9uIGJ1aWxkIik7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgiYXBpIikpIHsKICAgIGNvbnNvbGUud2FybigiW2JvcmVET01dIGV4cG9ydENvbXBvbmVudCgpIGlzIGRpc2FibGVkIChkZWJ1Zy5hcGkgaXMgZmFsc2UpIik7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgY29uc3QgY3R4ID0gb3BlcmF0ZShzZWxlY3Rvcik7CiAgaWYgKCFjdHgpIHJldHVybiBudWxsOwogIGNvbnN0IHRlbXBsYXRlRWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGB0ZW1wbGF0ZVtkYXRhLWNvbXBvbmVudD0iJHtjdHguZGV0YWlsLm5hbWV9Il1gKTsKICBjb25zdCB0ZW1wbGF0ZUh0bWwgPSB0ZW1wbGF0ZUVsPy5pbm5lckhUTUwgPz8gdm9pZCAwOwogIHRyeSB7CiAgICByZXR1cm4gewogICAgICBjb21wb25lbnQ6IGN0eC5kZXRhaWwubmFtZSwKICAgICAgc3RhdGU6IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlKSksCiAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZUh0bWwsCiAgICAgIHRpbWVzdGFtcDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS50b0lTT1N0cmluZygpCiAgICB9OwogIH0gY2F0Y2ggKGUpIHsKICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgIGNvbnNvbGUud2FybigKICAgICAgICBgW2JvcmVET01dIGV4cG9ydENvbXBvbmVudDogVW5hYmxlIHRvIHNlcmlhbGl6ZSBzdGF0ZSBmb3IgPCR7Y3R4LmRldGFpbC5uYW1lfT46YCwKICAgICAgICBlIGluc3RhbmNlb2YgRXJyb3IgPyBlLm1lc3NhZ2UgOiBlCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gewogICAgICBjb21wb25lbnQ6IGN0eC5kZXRhaWwubmFtZSwKICAgICAgc3RhdGU6ICJbVW5hYmxlIHRvIHNlcmlhbGl6ZSAtIGNvbnRhaW5zIGNpcmN1bGFyIHJlZmVyZW5jZXMgb3IgZnVuY3Rpb25zXSIsCiAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZUh0bWwsCiAgICAgIHRpbWVzdGFtcDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS50b0lTT1N0cmluZygpCiAgICB9OwogIH0KfQp2YXIgV0VCX0NPTVBPTkVOVF9NQVJLRVIsIGN1cnJlbnRBcHBTdGF0ZSwgc3RvcmVkV2ViQ29tcG9uZW50LCBzdG9yZWRSZWdpc3RlckNvbXBvbmVudCwgY29tcG9uZW50Q29udGV4dHMsIGNvbnNvbGVBUEk7CnZhciBpbml0X2NvbnNvbGVfYXBpID0gX19lc20oewogICJzcmMvY29uc29sZS1hcGkudHMiKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgaW5pdF9kZWJ1ZygpOwogICAgV0VCX0NPTVBPTkVOVF9NQVJLRVIgPSBTeW1ib2woImJvcmVET00ud2ViQ29tcG9uZW50Iik7CiAgICBjdXJyZW50QXBwU3RhdGUgPSBudWxsOwogICAgc3RvcmVkV2ViQ29tcG9uZW50ID0gbnVsbDsKICAgIHN0b3JlZFJlZ2lzdGVyQ29tcG9uZW50ID0gbnVsbDsKICAgIGNvbXBvbmVudENvbnRleHRzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgICBjb25zb2xlQVBJID0gewogICAgICBkZWZpbmUsCiAgICAgIG9wZXJhdGUsCiAgICAgIGV4cG9ydENvbXBvbmVudAogICAgfTsKICB9Cn0pOwoKLy8gc3JjL2luc2lkZS1vdXQudHMKZnVuY3Rpb24gY3JlYXRlUmVuZGVySGVscGVycyhjb21wb25lbnROYW1lLCBlbGVtZW50LCByZXJlbmRlcikgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICByZXR1cm4ge307CiAgfQogIGlmICghaXNEZWJ1Z0VuYWJsZWQoIm1ldGhvZE1pc3NpbmciKSkgewogICAgcmV0dXJuIHt9OwogIH0KICByZXR1cm4gbmV3IFByb3h5KHt9LCB7CiAgICBnZXQoX3RhcmdldCwgcHJvcCkgewogICAgICBpZiAodHlwZW9mIHByb3AgPT09ICJzeW1ib2wiIHx8IHByb3AgPT09ICJ0aGVuIiB8fCBwcm9wID09PSAidG9KU09OIikgewogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH0KICAgICAgaWYgKHVzZXJEZWZpbmVkSGVscGVycy5oYXMocHJvcCkpIHsKICAgICAgICBjb25zdCBoZWxwZXIgPSB1c2VyRGVmaW5lZEhlbHBlcnMuZ2V0KHByb3ApOwogICAgICAgIHJldHVybiAoLi4uYXJncykgPT4gewogICAgICAgICAgY29uc3QgcmVzdWx0ID0gaGVscGVyKC4uLmFyZ3MpOwogICAgICAgICAgaWYgKHR5cGVvZiBfX0RFQlVHX18gPT09ICJ1bmRlZmluZWQiIHx8IF9fREVCVUdfXykgewogICAgICAgICAgICB0cmFja0Z1bmN0aW9uQ2FsbChwcm9wLCBhcmdzLCByZXN1bHQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiAoLi4uYXJncykgPT4gewogICAgICAgIGNvbnN0IGN0eCA9IHsKICAgICAgICAgIG5hbWU6IHByb3AsCiAgICAgICAgICBhcmdzLAogICAgICAgICAgY29tcG9uZW50OiBjb21wb25lbnROYW1lLAogICAgICAgICAgZWxlbWVudCwKICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgIGRlZmluZTogKGltcGwpID0+IHsKICAgICAgICAgICAgZGVmaW5lSGVscGVyKHByb3AsIGltcGwpOwogICAgICAgICAgICByZXJlbmRlcigpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgbG9nTWlzc2luZ0Z1bmN0aW9uKGN0eCk7CiAgICAgICAgc3RvcmVNaXNzaW5nRnVuY3Rpb24oY3R4KTsKICAgICAgICBleHBvc2VNaXNzaW5nR2xvYmFscyhjdHgpOwogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH07CiAgICB9LAogICAgaGFzKF90YXJnZXQsIHByb3ApIHsKICAgICAgcmV0dXJuIHR5cGVvZiBwcm9wID09PSAic3RyaW5nIiAmJiB1c2VyRGVmaW5lZEhlbHBlcnMuaGFzKHByb3ApOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIGRlZmluZUhlbHBlcihuYW1lLCBpbXBsZW1lbnRhdGlvbikgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSByZXR1cm47CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgibWV0aG9kTWlzc2luZyIpKSByZXR1cm47CiAgdXNlckRlZmluZWRIZWxwZXJzLnNldChuYW1lLCBpbXBsZW1lbnRhdGlvbik7CiAgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgIGNvbnNvbGUubG9nKAogICAgICAiJWNcdTI3MDUgYm9yZURPTTogRGVmaW5lZCBoZWxwZXIgJWMlcyIsCiAgICAgICJjb2xvcjogIzI3YWU2MDsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgICAiY29sb3I6ICM5YjU5YjY7IGZvbnQtd2VpZ2h0OiBib2xkIiwKICAgICAgbmFtZQogICAgKTsKICB9Cn0KZnVuY3Rpb24gY2xlYXJIZWxwZXIobmFtZSkgewogIHVzZXJEZWZpbmVkSGVscGVycy5kZWxldGUobmFtZSk7Cn0KZnVuY3Rpb24gY2xlYXJNaXNzaW5nRnVuY3Rpb25zKCkgewogIG1pc3NpbmdGdW5jdGlvbnMuY2xlYXIoKTsKICBsYXN0TWlzc2luZyA9IG51bGw7Cn0KZnVuY3Rpb24gbG9nTWlzc2luZ0Z1bmN0aW9uKGN0eCkgewogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgcmV0dXJuOwogIGNvbnNvbGUubG9nKAogICAgIiVjXHUyNkEwXHVGRTBGIGJvcmVET006IE1pc3NpbmcgZnVuY3Rpb24gJWMlcyVjIGluIDwlcz4iLAogICAgImNvbG9yOiAjZjM5YzEyOyBmb250LXdlaWdodDogYm9sZCIsCiAgICAiY29sb3I6ICM5YjU5YjY7IGZvbnQtd2VpZ2h0OiBib2xkIiwKICAgIGN0eC5uYW1lLAogICAgImNvbG9yOiAjZjM5YzEyIiwKICAgIGN0eC5jb21wb25lbnQKICApOwogIGlmIChjdHguYXJncy5sZW5ndGggPiAwKSB7CiAgICBjb25zb2xlLmxvZygiICAgQXJndW1lbnRzOiIsIGN0eC5hcmdzKTsKICB9CiAgY29uc29sZS5sb2coIiVjXHV7MUY0QTF9IERlZmluZSBpdDoiLCAiY29sb3I6ICMzNDk4ZGI7IGZvbnQtd2VpZ2h0OiBib2xkIik7CiAgY29uc29sZS5sb2coYCAgICRkZWZpbmVNaXNzaW5nKCgke2dlbmVyYXRlQXJnTmFtZXMoY3R4LmFyZ3MpfSkgPT4geyAuLi4gfSlgKTsKICBjb25zb2xlLmxvZygKICAgIGAgICBib3JlRE9NLmRlZmluZUhlbHBlcignJHtjdHgubmFtZX0nLCAoJHtnZW5lcmF0ZUFyZ05hbWVzKGN0eC5hcmdzKX0pID0+IHsgLi4uIH0pYAogICk7Cn0KZnVuY3Rpb24gZ2VuZXJhdGVBcmdOYW1lcyhhcmdzKSB7CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gIiI7CiAgcmV0dXJuIGFyZ3MubWFwKChhcmcsIGkpID0+IHsKICAgIGlmIChhcmcgPT09IG51bGwgfHwgYXJnID09PSB2b2lkIDApIHJldHVybiBgYXJnJHtpfWA7CiAgICBpZiAoQXJyYXkuaXNBcnJheShhcmcpKSByZXR1cm4gIml0ZW1zIjsKICAgIGlmICh0eXBlb2YgYXJnID09PSAib2JqZWN0IikgewogICAgICBpZiAoIm5hbWUiIGluIGFyZyAmJiAiZW1haWwiIGluIGFyZykgcmV0dXJuICJ1c2VyIjsKICAgICAgaWYgKCJpZCIgaW4gYXJnICYmICJ0aXRsZSIgaW4gYXJnKSByZXR1cm4gIml0ZW0iOwogICAgICBpZiAoImlkIiBpbiBhcmcpIHJldHVybiAicmVjb3JkIjsKICAgICAgcmV0dXJuICJkYXRhIjsKICAgIH0KICAgIGlmICh0eXBlb2YgYXJnID09PSAic3RyaW5nIikgcmV0dXJuICJ0ZXh0IjsKICAgIGlmICh0eXBlb2YgYXJnID09PSAibnVtYmVyIikgcmV0dXJuICJjb3VudCI7CiAgICBpZiAodHlwZW9mIGFyZyA9PT0gImJvb2xlYW4iKSByZXR1cm4gImZsYWciOwogICAgcmV0dXJuIGBhcmcke2l9YDsKICB9KS5qb2luKCIsICIpOwp9CmZ1bmN0aW9uIHN0b3JlTWlzc2luZ0Z1bmN0aW9uKGN0eCkgewogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImVycm9ySGlzdG9yeSIpKSByZXR1cm47CiAgY29uc3QgZXhpc3RpbmcgPSBtaXNzaW5nRnVuY3Rpb25zLmdldChjdHgubmFtZSkgfHwgW107CiAgaWYgKGV4aXN0aW5nLmxlbmd0aCA+PSAxMCkgewogICAgZXhpc3Rpbmcuc2hpZnQoKTsKICB9CiAgZXhpc3RpbmcucHVzaChjdHgpOwogIG1pc3NpbmdGdW5jdGlvbnMuc2V0KGN0eC5uYW1lLCBleGlzdGluZyk7CiAgbGFzdE1pc3NpbmcgPSBjdHg7Cn0KZnVuY3Rpb24gZXhwb3NlTWlzc2luZ0dsb2JhbHMoY3R4KSB7CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgiZ2xvYmFscyIpKSByZXR1cm47CiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiKSByZXR1cm47CiAgY29uc3QgdyA9IHdpbmRvdzsKICB3LiRtaXNzaW5nTmFtZSA9IGN0eC5uYW1lOwogIHcuJG1pc3NpbmdBcmdzID0gY3R4LmFyZ3M7CiAgdy4kbWlzc2luZ0NvbXBvbmVudCA9IGN0eC5jb21wb25lbnQ7CiAgdy4kZGVmaW5lTWlzc2luZyA9IGN0eC5kZWZpbmU7Cn0KZnVuY3Rpb24gaW5mZXJUZW1wbGF0ZSh0YWdOYW1lLCBlbGVtZW50KSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybiBudWxsOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoInRlbXBsYXRlSW5mZXJlbmNlIikpIHJldHVybiBudWxsOwogIGlmIChpc0RlYnVnRW5hYmxlZCgic3RyaWN0IikpIHJldHVybiBudWxsOwogIGNvbnN0IHByb3BzID0ge307CiAgY29uc3Qgc2xvdHMgPSBbXTsKICBpZiAoZWxlbWVudCkgewogICAgZm9yIChjb25zdCBhdHRyIG9mIEFycmF5LmZyb20oZWxlbWVudC5hdHRyaWJ1dGVzKSkgewogICAgICBpZiAoYXR0ci5uYW1lLnN0YXJ0c1dpdGgoImRhdGEtIikpIGNvbnRpbnVlOwogICAgICBpZiAoWyJjbGFzcyIsICJpZCIsICJzdHlsZSJdLmluY2x1ZGVzKGF0dHIubmFtZSkpIGNvbnRpbnVlOwogICAgICBjb25zdCBjYW1lbE5hbWUgPSBrZWJhYlRvQ2FtZWwoYXR0ci5uYW1lKTsKICAgICAgcHJvcHNbY2FtZWxOYW1lXSA9IHBhcnNlQXR0cmlidXRlVmFsdWUoYXR0ci52YWx1ZSk7CiAgICB9CiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIEFycmF5LmZyb20oZWxlbWVudC5jaGlsZHJlbikpIHsKICAgICAgY29uc3Qgc2xvdE5hbWUgPSBjaGlsZC5nZXRBdHRyaWJ1dGUoInNsb3QiKTsKICAgICAgaWYgKHNsb3ROYW1lICYmICFzbG90cy5pbmNsdWRlcyhzbG90TmFtZSkpIHsKICAgICAgICBzbG90cy5wdXNoKHNsb3ROYW1lKTsKICAgICAgfQogICAgfQogIH0KICBjb25zdCBwcm9wc1Nsb3RzID0gT2JqZWN0LmtleXMocHJvcHMpLm1hcCgocCkgPT4gYCAgICA8c2xvdCBuYW1lPSIke2NhbWVsVG9LZWJhYihwKX0iPiR7Zm9ybWF0VmFsdWUocHJvcHNbcF0pfTwvc2xvdD5gKS5qb2luKCJcbiIpOwogIGNvbnN0IGRlZmF1bHRTbG90ID0gc2xvdHMubGVuZ3RoID09PSAwICYmIE9iamVjdC5rZXlzKHByb3BzKS5sZW5ndGggPT09IDAgPyAnICAgIDxzbG90IG5hbWU9ImNvbnRlbnQiPkxvYWRpbmcuLi48L3Nsb3Q+JyA6ICIiOwogIGNvbnN0IHRlbXBsYXRlID0gYDxkaXYgY2xhc3M9IiR7dGFnTmFtZX0tc2tlbGV0b24iIGRhdGEtaW5mZXJyZWQ+CiR7cHJvcHNTbG90cyB8fCBkZWZhdWx0U2xvdH0KICA8L2Rpdj5gOwogIHJldHVybiB7IHRhZ05hbWUsIHRlbXBsYXRlLCBwcm9wcywgc2xvdHMgfTsKfQpmdW5jdGlvbiByZWdpc3RlckluZmVycmVkQ29tcG9uZW50KHRhZ05hbWUsIGVsZW1lbnQpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuIGZhbHNlOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoInRlbXBsYXRlSW5mZXJlbmNlIikpIHJldHVybiBmYWxzZTsKICBpZiAoY3VzdG9tRWxlbWVudHMuZ2V0KHRhZ05hbWUpKSByZXR1cm4gZmFsc2U7CiAgaWYgKCFnZXRDdXJyZW50QXBwU3RhdGUoKSkgcmV0dXJuIGZhbHNlOwogIGNvbnN0IGluZmVyZW5jZSA9IGluZmVyVGVtcGxhdGUodGFnTmFtZSwgZWxlbWVudCk7CiAgaWYgKCFpbmZlcmVuY2UpIHJldHVybiBmYWxzZTsKICBjb25zdCB7IHRlbXBsYXRlLCBwcm9wcyB9ID0gaW5mZXJlbmNlOwogIGluZmVycmVkVGVtcGxhdGVzLnNldCh0YWdOYW1lLCBpbmZlcmVuY2UpOwogIGxvZ0luZmVycmVkQ29tcG9uZW50KHRhZ05hbWUsIHByb3BzKTsKICB0cnkgewogICAgZGVmaW5lKAogICAgICB0YWdOYW1lLAogICAgICB0ZW1wbGF0ZSwKICAgICAgLy8gU3R1YiByZW5kZXIgdGhhdCBsb2dzIHdoYXQgaXQgcmVjZWl2ZXMKICAgICAgKHsgc3RhdGUgfSkgPT4gKHsgc2xvdHMgfSkgPT4gewogICAgICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgICAgIiVjXHV7MUY1MkV9IGJvcmVET006IEluZmVycmVkIDwlcz4gcmVuZGVyaW5nIiwKICAgICAgICAgICAgImNvbG9yOiAjOWI1OWI2OyBmb250LXdlaWdodDogYm9sZCIsCiAgICAgICAgICAgIHRhZ05hbWUKICAgICAgICAgICk7CiAgICAgICAgICBjb25zb2xlLmxvZygiICAgSW5mZXJyZWQgcHJvcHM6IiwgcHJvcHMpOwogICAgICAgICAgY29uc29sZS5sb2coIiAgIEFwcCBzdGF0ZToiLCBzdGF0ZSk7CiAgICAgICAgfQogICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHByb3BzKSkgewogICAgICAgICAgY29uc3Qgc2xvdEtleSA9IGNhbWVsVG9LZWJhYihrZXkpOwogICAgICAgICAgaWYgKHNsb3RzW3Nsb3RLZXldKSB7CiAgICAgICAgICAgIHNsb3RzW3Nsb3RLZXldID0gU3RyaW5nKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICk7CiAgICByZXR1cm4gdHJ1ZTsKICB9IGNhdGNoIChlKSB7CiAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICBjb25zb2xlLndhcm4oYFtib3JlRE9NXSBGYWlsZWQgdG8gcmVnaXN0ZXIgaW5mZXJyZWQgPCR7dGFnTmFtZX0+OmAsIGUpOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KfQpmdW5jdGlvbiBsb2dJbmZlcnJlZENvbXBvbmVudCh0YWdOYW1lLCBwcm9wcykgewogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgcmV0dXJuOwogIGNvbnNvbGUubG9nKAogICAgIiVjXHV7MUY1MkV9IGJvcmVET006IEluZmVycmluZyB0ZW1wbGF0ZSBmb3IgJWM8JXM+IiwKICAgICJjb2xvcjogIzliNTliNjsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgImNvbG9yOiAjNGVjZGM0OyBmb250LXdlaWdodDogYm9sZCIsCiAgICB0YWdOYW1lCiAgKTsKICBpZiAoT2JqZWN0LmtleXMocHJvcHMpLmxlbmd0aCA+IDApIHsKICAgIGNvbnNvbGUubG9nKCIlY1x1ezFGNENCfSBJbmZlcnJlZCBwcm9wcyBmcm9tIGF0dHJpYnV0ZXM6IiwgImNvbG9yOiAjOTVhNWE2Iik7CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhwcm9wcykpIHsKICAgICAgY29uc29sZS5sb2coYCAgICR7a2V5fTogJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9YCk7CiAgICB9CiAgfQogIGNvbnNvbGUubG9nKCIlY1x1ezFGNEExfSBEZWZpbmUgcHJvcGVybHkgd2l0aDoiLCAiY29sb3I6ICMzNDk4ZGI7IGZvbnQtd2VpZ2h0OiBib2xkIik7CiAgY29uc29sZS5sb2coCiAgICBgICAgYm9yZURPTS5kZWZpbmUoJyR7dGFnTmFtZX0nLCAnPHlvdXIgdGVtcGxhdGU+JywgKHsgc3RhdGUgfSkgPT4gKHsgc2xvdHMgfSkgPT4geyAuLi4gfSlgCiAgKTsKfQpmdW5jdGlvbiBvYnNlcnZlVW5kZWZpbmVkRWxlbWVudHMoKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJ0ZW1wbGF0ZUluZmVyZW5jZSIpKSByZXR1cm47CiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiKSByZXR1cm47CiAgaWYgKHRlbXBsYXRlT2JzZXJ2ZXIpIHJldHVybjsKICB0ZW1wbGF0ZU9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoKG11dGF0aW9ucykgPT4gewogICAgZm9yIChjb25zdCBtdXRhdGlvbiBvZiBtdXRhdGlvbnMpIHsKICAgICAgZm9yIChjb25zdCBub2RlIG9mIEFycmF5LmZyb20obXV0YXRpb24uYWRkZWROb2RlcykpIHsKICAgICAgICBpZiAobm9kZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ICYmIG5vZGUudGFnTmFtZS5pbmNsdWRlcygiLSIpKSB7CiAgICAgICAgICBjb25zdCB0YWdOYW1lID0gbm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBpZiAoIWN1c3RvbUVsZW1lbnRzLmdldCh0YWdOYW1lKSkgewogICAgICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoCiAgICAgICAgICAgICAgYHRlbXBsYXRlW2RhdGEtY29tcG9uZW50PSIke3RhZ05hbWV9Il1gCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgICAgICAgICBxdWV1ZU1pY3JvdGFzaygoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWN1c3RvbUVsZW1lbnRzLmdldCh0YWdOYW1lKSkgewogICAgICAgICAgICAgICAgICByZWdpc3RlckluZmVycmVkQ29tcG9uZW50KHRhZ05hbWUsIG5vZGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CiAgdGVtcGxhdGVPYnNlcnZlci5vYnNlcnZlKGRvY3VtZW50LmJvZHksIHsKICAgIGNoaWxkTGlzdDogdHJ1ZSwKICAgIHN1YnRyZWU6IHRydWUKICB9KTsKfQpmdW5jdGlvbiBrZWJhYlRvQ2FtZWwoc3RyKSB7CiAgcmV0dXJuIHN0ci5yZXBsYWNlKC8tKFthLXpdKS9nLCAoXywgbGV0dGVyKSA9PiBsZXR0ZXIudG9VcHBlckNhc2UoKSk7Cn0KZnVuY3Rpb24gY2FtZWxUb0tlYmFiKHN0cikgewogIHJldHVybiBzdHIucmVwbGFjZSgvKFtBLVpdKS9nLCAiLSQxIikudG9Mb3dlckNhc2UoKTsKfQpmdW5jdGlvbiBwYXJzZUF0dHJpYnV0ZVZhbHVlKHZhbHVlKSB7CiAgaWYgKHZhbHVlID09PSAidHJ1ZSIpIHJldHVybiB0cnVlOwogIGlmICh2YWx1ZSA9PT0gImZhbHNlIikgcmV0dXJuIGZhbHNlOwogIGNvbnN0IG51bSA9IE51bWJlcih2YWx1ZSk7CiAgaWYgKCFpc05hTihudW0pICYmIHZhbHVlICE9PSAiIikgcmV0dXJuIG51bTsKICBpZiAodmFsdWUuc3RhcnRzV2l0aCgieyIpIHx8IHZhbHVlLnN0YXJ0c1dpdGgoIlsiKSkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpOwogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICB9CiAgcmV0dXJuIHZhbHVlOwp9CmZ1bmN0aW9uIGZvcm1hdFZhbHVlKHZhbHVlKSB7CiAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB2b2lkIDApIHJldHVybiAiIjsKICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IikgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHZhbHVlKTsKICByZXR1cm4gU3RyaW5nKHZhbHVlKTsKfQp2YXIgdXNlckRlZmluZWRIZWxwZXJzLCBtaXNzaW5nRnVuY3Rpb25zLCBsYXN0TWlzc2luZywgaW5mZXJyZWRUZW1wbGF0ZXMsIHRlbXBsYXRlT2JzZXJ2ZXIsIGluc2lkZU91dEFQSTsKdmFyIGluaXRfaW5zaWRlX291dCA9IF9fZXNtKHsKICAic3JjL2luc2lkZS1vdXQudHMiKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgaW5pdF9kZWJ1ZygpOwogICAgaW5pdF9jb25zb2xlX2FwaSgpOwogICAgaW5pdF90eXBlX2luZmVyZW5jZSgpOwogICAgdXNlckRlZmluZWRIZWxwZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIG1pc3NpbmdGdW5jdGlvbnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgbGFzdE1pc3NpbmcgPSBudWxsOwogICAgaW5mZXJyZWRUZW1wbGF0ZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgdGVtcGxhdGVPYnNlcnZlciA9IG51bGw7CiAgICBpbnNpZGVPdXRBUEkgPSB7CiAgICAgIC8qKiBNYXAgb2YgbWlzc2luZyBmdW5jdGlvbiBjYWxscyBieSBmdW5jdGlvbiBuYW1lICovCiAgICAgIGdldCBtaXNzaW5nRnVuY3Rpb25zKCkgewogICAgICAgIHJldHVybiBtaXNzaW5nRnVuY3Rpb25zOwogICAgICB9LAogICAgICAvKiogTW9zdCByZWNlbnQgbWlzc2luZyBmdW5jdGlvbiBjb250ZXh0ICovCiAgICAgIGdldCBsYXN0TWlzc2luZygpIHsKICAgICAgICByZXR1cm4gbGFzdE1pc3Npbmc7CiAgICAgIH0sCiAgICAgIC8qKiBEZWZpbmUgYSBoZWxwZXIgZnVuY3Rpb24gYXZhaWxhYmxlIHRvIGFsbCByZW5kZXIgZnVuY3Rpb25zICovCiAgICAgIGRlZmluZUhlbHBlciwKICAgICAgLyoqIEdldCBhbGwgZGVmaW5lZCBoZWxwZXJzICovCiAgICAgIGdldCBoZWxwZXJzKCkgewogICAgICAgIHJldHVybiBuZXcgTWFwKHVzZXJEZWZpbmVkSGVscGVycyk7CiAgICAgIH0sCiAgICAgIC8qKiBDbGVhciBhIGhlbHBlciBkZWZpbml0aW9uICovCiAgICAgIGNsZWFySGVscGVyLAogICAgICAvKiogQ2xlYXIgYWxsIG1pc3NpbmcgZnVuY3Rpb24gcmVjb3JkcyAqLwogICAgICBjbGVhck1pc3NpbmdGdW5jdGlvbnMsCiAgICAgIC8qKiBNYXAgb2YgaW5mZXJyZWQgdGVtcGxhdGVzIGJ5IHRhZyBuYW1lICovCiAgICAgIGdldCBpbmZlcnJlZFRlbXBsYXRlcygpIHsKICAgICAgICByZXR1cm4gaW5mZXJyZWRUZW1wbGF0ZXM7CiAgICAgIH0sCiAgICAgIC8qKiBNYW51YWxseSBpbmZlciB0ZW1wbGF0ZSBmb3IgYSB0YWcgKHVzZWZ1bCBmb3IgdGVzdGluZykgKi8KICAgICAgaW5mZXJUZW1wbGF0ZQogICAgfTsKICB9Cn0pOwoKLy8gc3JjL3ZlcnNpb24udHMKdmFyIFZFUlNJT047CnZhciBpbml0X3ZlcnNpb24gPSBfX2VzbSh7CiAgInNyYy92ZXJzaW9uLnRzIigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIFZFUlNJT04gPSAiMC4yNS4yNSI7CiAgfQp9KTsKCi8vIHNyYy92YWxpZGF0aW9uLnRzCmZ1bmN0aW9uIHNldFZhbGlkYXRpb25BcHBTdGF0ZShzdGF0ZSkgewogIGN1cnJlbnRBcHBTdGF0ZTIgPSBzdGF0ZTsKfQpmdW5jdGlvbiBjcmVhdGVTdGF0ZVNuYXBzaG90KCkgewogIGlmICghY3VycmVudEFwcFN0YXRlMikgcmV0dXJuIG51bGw7CiAgcmV0dXJuIGRlZXBDbG9uZShjdXJyZW50QXBwU3RhdGUyLmFwcCk7Cn0KZnVuY3Rpb24gcmVzdG9yZVN0YXRlU25hcHNob3Qoc25hcHNob3QpIHsKICBpZiAoIWN1cnJlbnRBcHBTdGF0ZTIgfHwgIXNuYXBzaG90KSByZXR1cm47CiAgY29uc3QgY3VycmVudCA9IGN1cnJlbnRBcHBTdGF0ZTIuYXBwOwogIGlmICghY3VycmVudCkgcmV0dXJuOwogIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKGN1cnJlbnQpKSB7CiAgICBpZiAoIShrZXkgaW4gc25hcHNob3QpKSB7CiAgICAgIGRlbGV0ZSBjdXJyZW50W2tleV07CiAgICB9CiAgfQogIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHNuYXBzaG90KSkgewogICAgY3VycmVudFtrZXldID0gZGVlcENsb25lKHZhbHVlKTsKICB9Cn0KZnVuY3Rpb24gZGVlcENsb25lKG9iaiwgc2VlbiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpKSB7CiAgaWYgKG9iaiA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqICE9PSAib2JqZWN0IikgcmV0dXJuIG9iajsKICBpZiAoc2Vlbi5oYXMob2JqKSkgcmV0dXJuIHNlZW4uZ2V0KG9iaik7CiAgaWYgKG9iaiBpbnN0YW5jZW9mIERhdGUpIHJldHVybiBuZXcgRGF0ZShvYmopOwogIGlmIChvYmogaW5zdGFuY2VvZiBSZWdFeHApIHJldHVybiBuZXcgUmVnRXhwKG9iai5zb3VyY2UsIG9iai5mbGFncyk7CiAgaWYgKG9iaiBpbnN0YW5jZW9mIE1hcCkgewogICAgY29uc3QgY2xvbmVkTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIHNlZW4uc2V0KG9iaiwgY2xvbmVkTWFwKTsKICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIG9iai5lbnRyaWVzKCkpIHsKICAgICAgY2xvbmVkTWFwLnNldChkZWVwQ2xvbmUoa2V5LCBzZWVuKSwgZGVlcENsb25lKHZhbHVlLCBzZWVuKSk7CiAgICB9CiAgICByZXR1cm4gY2xvbmVkTWFwOwogIH0KICBpZiAob2JqIGluc3RhbmNlb2YgU2V0KSB7CiAgICBjb25zdCBjbG9uZWRTZXQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgc2Vlbi5zZXQob2JqLCBjbG9uZWRTZXQpOwogICAgZm9yIChjb25zdCB2YWx1ZSBvZiBvYmopIHsKICAgICAgY2xvbmVkU2V0LmFkZChkZWVwQ2xvbmUodmFsdWUsIHNlZW4pKTsKICAgIH0KICAgIHJldHVybiBjbG9uZWRTZXQ7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKICAgIGNvbnN0IGNsb25lZEFyciA9IFtdOwogICAgc2Vlbi5zZXQob2JqLCBjbG9uZWRBcnIpOwogICAgZm9yIChjb25zdCBpdGVtIG9mIG9iaikgewogICAgICBjbG9uZWRBcnIucHVzaChkZWVwQ2xvbmUoaXRlbSwgc2VlbikpOwogICAgfQogICAgcmV0dXJuIGNsb25lZEFycjsKICB9CiAgY29uc3QgY2xvbmVkID0ge307CiAgc2Vlbi5zZXQob2JqLCBjbG9uZWQpOwogIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG9iaikpIHsKICAgIGNsb25lZFtrZXldID0gZGVlcENsb25lKHZhbHVlLCBzZWVuKTsKICB9CiAgcmV0dXJuIGNsb25lZDsKfQpmdW5jdGlvbiB2YWxpZGF0ZVN5bnRheChjb2RlKSB7CiAgY29uc3QgaXNzdWVzID0gW107CiAgdHJ5IHsKICAgIG5ldyBGdW5jdGlvbigic3RhdGUiLCAiYm9yZURPTSIsIGNvZGUpOwogIH0gY2F0Y2ggKGUpIHsKICAgIGNvbnN0IGVycm9yID0gZTsKICAgIGlzc3Vlcy5wdXNoKHsKICAgICAgdHlwZTogInN5bnRheCIsCiAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsCiAgICAgIGxvY2F0aW9uOiBleHRyYWN0TG9jYXRpb24oZXJyb3IpLAogICAgICBzZXZlcml0eTogImVycm9yIgogICAgfSk7CiAgfQogIHJldHVybiBpc3N1ZXM7Cn0KZnVuY3Rpb24gZXh0cmFjdExvY2F0aW9uKGVycm9yKSB7CiAgY29uc3QgcG9zTWF0Y2ggPSBlcnJvci5tZXNzYWdlLm1hdGNoKC9hdCBwb3NpdGlvbiAoXGQrKS8pOwogIGlmIChwb3NNYXRjaCkgcmV0dXJuIGBwb3NpdGlvbiAke3Bvc01hdGNoWzFdfWA7CiAgY29uc3QgbGluZU1hdGNoID0gZXJyb3IubWVzc2FnZS5tYXRjaCgvbGluZSAoXGQrKS8pOwogIGlmIChsaW5lTWF0Y2gpIHJldHVybiBgbGluZSAke2xpbmVNYXRjaFsxXX1gOwogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gdmFsaWRhdGVSZWZlcmVuY2VzKGNvZGUpIHsKICBjb25zdCBpc3N1ZXMgPSBbXTsKICBpZiAoIWN1cnJlbnRBcHBTdGF0ZTIpIHJldHVybiBpc3N1ZXM7CiAgY29uc3Qgc3RhdGUgPSBjdXJyZW50QXBwU3RhdGUyLmFwcDsKICBjb25zdCBrbm93blBhdGhzID0gZ2V0S25vd25TdGF0ZVBhdGhzKHN0YXRlKTsKICBjb25zdCBrbm93bkhlbHBlcnMgPSBnZXRLbm93bkhlbHBlcnMoKTsKICBjb25zdCBzdGF0ZVJlZnMgPSBleHRyYWN0U3RhdGVSZWZlcmVuY2VzKGNvZGUpOwogIGZvciAoY29uc3QgcmVmIG9mIHN0YXRlUmVmcykgewogICAgaWYgKCFpc1ZhbGlkUGF0aChyZWYsIGtub3duUGF0aHMpKSB7CiAgICAgIGNvbnN0IHN1Z2dlc3Rpb24gPSBmaW5kU2ltaWxhclBhdGgocmVmLCBrbm93blBhdGhzKTsKICAgICAgaXNzdWVzLnB1c2goewogICAgICAgIHR5cGU6ICJyZWZlcmVuY2UiLAogICAgICAgIG1lc3NhZ2U6IGAke3JlZn0gaXMgdW5kZWZpbmVkYCwKICAgICAgICBzdWdnZXN0aW9uOiBzdWdnZXN0aW9uID8gYERpZCB5b3UgbWVhbiAke3N1Z2dlc3Rpb259P2AgOiB2b2lkIDAsCiAgICAgICAgc2V2ZXJpdHk6ICJlcnJvciIKICAgICAgfSk7CiAgICB9CiAgfQogIGNvbnN0IGhlbHBlclJlZnMgPSBleHRyYWN0SGVscGVyUmVmZXJlbmNlcyhjb2RlKTsKICBmb3IgKGNvbnN0IHJlZiBvZiBoZWxwZXJSZWZzKSB7CiAgICBpZiAoIWtub3duSGVscGVycy5pbmNsdWRlcyhyZWYpKSB7CiAgICAgIGNvbnN0IHN1Z2dlc3Rpb24gPSBmaW5kU2ltaWxhcihyZWYsIGtub3duSGVscGVycyk7CiAgICAgIGlzc3Vlcy5wdXNoKHsKICAgICAgICB0eXBlOiAicmVmZXJlbmNlIiwKICAgICAgICBtZXNzYWdlOiBgSGVscGVyICcke3JlZn0nIGlzIG5vdCBkZWZpbmVkYCwKICAgICAgICBzdWdnZXN0aW9uOiBzdWdnZXN0aW9uID8gYERpZCB5b3UgbWVhbiAnJHtzdWdnZXN0aW9ufSc/YCA6IHZvaWQgMCwKICAgICAgICBzZXZlcml0eTogImVycm9yIgogICAgICB9KTsKICAgIH0KICB9CiAgcmV0dXJuIGlzc3VlczsKfQpmdW5jdGlvbiBleHRyYWN0U3RhdGVSZWZlcmVuY2VzKGNvZGUpIHsKICBjb25zdCByZWZzID0gW107CiAgY29uc3QgcmVnZXggPSAvc3RhdGVcLihbXHcuW1xdXSspL2c7CiAgbGV0IG1hdGNoOwogIHdoaWxlICgobWF0Y2ggPSByZWdleC5leGVjKGNvZGUpKSAhPT0gbnVsbCkgewogICAgcmVmcy5wdXNoKGBzdGF0ZS4ke21hdGNoWzFdfWApOwogIH0KICByZXR1cm4gWy4uLm5ldyBTZXQocmVmcyldOwp9CmZ1bmN0aW9uIGV4dHJhY3RIZWxwZXJSZWZlcmVuY2VzKGNvZGUpIHsKICBjb25zdCByZWZzID0gW107CiAgY29uc3QgcmVnZXggPSAvaGVscGVyc1wuKFx3KylccypcKC9nOwogIGxldCBtYXRjaDsKICB3aGlsZSAoKG1hdGNoID0gcmVnZXguZXhlYyhjb2RlKSkgIT09IG51bGwpIHsKICAgIHJlZnMucHVzaChtYXRjaFsxXSk7CiAgfQogIHJldHVybiBbLi4ubmV3IFNldChyZWZzKV07Cn0KZnVuY3Rpb24gZ2V0S25vd25TdGF0ZVBhdGhzKHN0YXRlLCBwcmVmaXggPSAic3RhdGUiLCBzZWVuID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCkpIHsKICBjb25zdCBwYXRocyA9IFtwcmVmaXhdOwogIGlmIChzdGF0ZSA9PT0gbnVsbCB8fCBzdGF0ZSA9PT0gdm9pZCAwKSByZXR1cm4gcGF0aHM7CiAgaWYgKHR5cGVvZiBzdGF0ZSAhPT0gIm9iamVjdCIpIHJldHVybiBwYXRoczsKICBpZiAoc2Vlbi5oYXMoc3RhdGUpKSByZXR1cm4gcGF0aHM7CiAgc2Vlbi5hZGQoc3RhdGUpOwogIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKHN0YXRlKSkgewogICAgY29uc3QgcGF0aCA9IGAke3ByZWZpeH0uJHtrZXl9YDsKICAgIHBhdGhzLnB1c2gocGF0aCk7CiAgICBjb25zdCB2YWx1ZSA9IHN0YXRlW2tleV07CiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgcGF0aHMucHVzaChwYXRoKTsKICAgICAgaWYgKHZhbHVlLmxlbmd0aCA+IDAgJiYgdmFsdWVbMF0gJiYgdHlwZW9mIHZhbHVlWzBdID09PSAib2JqZWN0IikgewogICAgICAgIHBhdGhzLnB1c2goLi4uZ2V0S25vd25TdGF0ZVBhdGhzKHZhbHVlWzBdLCBgJHtwYXRofVswXWAsIHNlZW4pKTsKICAgICAgfQogICAgfSBlbHNlIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiKSB7CiAgICAgIHBhdGhzLnB1c2goLi4uZ2V0S25vd25TdGF0ZVBhdGhzKHZhbHVlLCBwYXRoLCBzZWVuKSk7CiAgICB9CiAgfQogIHJldHVybiBwYXRoczsKfQpmdW5jdGlvbiBpc1ZhbGlkUGF0aChyZWYsIGtub3duUGF0aHMpIHsKICBpZiAoa25vd25QYXRocy5pbmNsdWRlcyhyZWYpKSByZXR1cm4gdHJ1ZTsKICBjb25zdCBiYXNlUGF0aCA9IHJlZi5yZXBsYWNlKC9cW1xkK1xdL2csICIiKTsKICBpZiAoa25vd25QYXRocy5pbmNsdWRlcyhiYXNlUGF0aCkpIHJldHVybiB0cnVlOwogIGNvbnN0IGFycmF5QmFzZVBhdGggPSByZWYucmVwbGFjZSgvXFtcZCtcXVwuW1x3Ll0rJC8sICIiKTsKICBpZiAoa25vd25QYXRocy5pbmNsdWRlcyhhcnJheUJhc2VQYXRoKSB8fCBrbm93blBhdGhzLmluY2x1ZGVzKGAke2FycmF5QmFzZVBhdGh9WzBdYCkpIHJldHVybiB0cnVlOwogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBmaW5kU2ltaWxhclBhdGgocmVmLCBrbm93blBhdGhzKSB7CiAgbGV0IGJlc3Q7CiAgbGV0IGJlc3RTY29yZSA9IEluZmluaXR5OwogIGZvciAoY29uc3QgcGF0aCBvZiBrbm93blBhdGhzKSB7CiAgICBjb25zdCBzY29yZSA9IGxldmVuc2h0ZWluKHJlZiwgcGF0aCk7CiAgICBpZiAoc2NvcmUgPCBiZXN0U2NvcmUgJiYgc2NvcmUgPCByZWYubGVuZ3RoIC8gMikgewogICAgICBiZXN0U2NvcmUgPSBzY29yZTsKICAgICAgYmVzdCA9IHBhdGg7CiAgICB9CiAgfQogIHJldHVybiBiZXN0Owp9CmZ1bmN0aW9uIGZpbmRTaW1pbGFyKG5hbWUsIGtub3duKSB7CiAgZm9yIChjb25zdCBrIG9mIGtub3duKSB7CiAgICBpZiAobGV2ZW5zaHRlaW4obmFtZSwgaykgPD0gMikgcmV0dXJuIGs7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gbGV2ZW5zaHRlaW4oYSwgYikgewogIGNvbnN0IG1hdHJpeCA9IFtdOwogIGZvciAobGV0IGkgPSAwOyBpIDw9IGIubGVuZ3RoOyBpKyspIHsKICAgIG1hdHJpeFtpXSA9IFtpXTsKICB9CiAgZm9yIChsZXQgaiA9IDA7IGogPD0gYS5sZW5ndGg7IGorKykgewogICAgbWF0cml4WzBdW2pdID0gajsKICB9CiAgZm9yIChsZXQgaSA9IDE7IGkgPD0gYi5sZW5ndGg7IGkrKykgewogICAgZm9yIChsZXQgaiA9IDE7IGogPD0gYS5sZW5ndGg7IGorKykgewogICAgICBpZiAoYi5jaGFyQXQoaSAtIDEpID09PSBhLmNoYXJBdChqIC0gMSkpIHsKICAgICAgICBtYXRyaXhbaV1bal0gPSBtYXRyaXhbaSAtIDFdW2ogLSAxXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtYXRyaXhbaV1bal0gPSBNYXRoLm1pbigKICAgICAgICAgIG1hdHJpeFtpIC0gMV1baiAtIDFdICsgMSwKICAgICAgICAgIC8vIHN1YnN0aXR1dGlvbgogICAgICAgICAgbWF0cml4W2ldW2ogLSAxXSArIDEsCiAgICAgICAgICAvLyBpbnNlcnRpb24KICAgICAgICAgIG1hdHJpeFtpIC0gMV1bal0gKyAxCiAgICAgICAgICAvLyBkZWxldGlvbgogICAgICAgICk7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG1hdHJpeFtiLmxlbmd0aF1bYS5sZW5ndGhdOwp9CmZ1bmN0aW9uIGdldEtub3duSGVscGVycygpIHsKICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBbXTsKICBjb25zdCBib3JlZG9tID0gd2luZG93LmJvcmVET007CiAgaWYgKCFib3JlZG9tPy5oZWxwZXJzKSByZXR1cm4gW107CiAgcmV0dXJuIEFycmF5LmZyb20oYm9yZWRvbS5oZWxwZXJzLmtleXMoKSk7Cn0KZnVuY3Rpb24gdmFsaWRhdGVUeXBlcyhjb2RlKSB7CiAgY29uc3QgaXNzdWVzID0gW107CiAgY29uc3QgYXJyYXlNZXRob2RQYXR0ZXJucyA9IFsKICAgIHsgcGF0dGVybjogL1wubWFwXHMqXCgvLCBtZXRob2Q6ICJtYXAiIH0sCiAgICB7IHBhdHRlcm46IC9cLmZpbHRlclxzKlwoLywgbWV0aG9kOiAiZmlsdGVyIiB9LAogICAgeyBwYXR0ZXJuOiAvXC5mb3JFYWNoXHMqXCgvLCBtZXRob2Q6ICJmb3JFYWNoIiB9LAogICAgeyBwYXR0ZXJuOiAvXC5yZWR1Y2VccypcKC8sIG1ldGhvZDogInJlZHVjZSIgfSwKICAgIHsgcGF0dGVybjogL1wuZmluZFxzKlwoLywgbWV0aG9kOiAiZmluZCIgfSwKICAgIHsgcGF0dGVybjogL1wuc29tZVxzKlwoLywgbWV0aG9kOiAic29tZSIgfSwKICAgIHsgcGF0dGVybjogL1wuZXZlcnlccypcKC8sIG1ldGhvZDogImV2ZXJ5IiB9CiAgXTsKICBmb3IgKGNvbnN0IHsgcGF0dGVybiwgbWV0aG9kIH0gb2YgYXJyYXlNZXRob2RQYXR0ZXJucykgewogICAgaWYgKHBhdHRlcm4udGVzdChjb2RlKSkgewogICAgICBjb25zdCByZWdleCA9IG5ldyBSZWdFeHAoYChzdGF0ZVxcLltcXHcuXSspXFwuJHttZXRob2R9XFxzKlxcKGApOwogICAgICBjb25zdCBtYXRjaDIgPSBjb2RlLm1hdGNoKHJlZ2V4KTsKICAgICAgaWYgKG1hdGNoMikgewogICAgICAgIGNvbnN0IHBhdGggPSBtYXRjaDJbMV07CiAgICAgICAgY29uc3QgdmFsdWUgPSBnZXRTdGF0ZVZhbHVlKHBhdGgpOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBpc3N1ZXMucHVzaCh7CiAgICAgICAgICAgIHR5cGU6ICJ0eXBlIiwKICAgICAgICAgICAgbWVzc2FnZTogYCR7cGF0aH0gaXMgJHt2YWx1ZX0sIGNhbm5vdCBjYWxsIC4ke21ldGhvZH0oKWAsCiAgICAgICAgICAgIHN1Z2dlc3Rpb246IGBBZGQgbnVsbCBjaGVjazogJHtwYXRofT8uJHttZXRob2R9KC4uLikgb3IgaW5pdGlhbGl6ZSAke3BhdGh9IGZpcnN0YCwKICAgICAgICAgICAgc2V2ZXJpdHk6ICJlcnJvciIKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICBpc3N1ZXMucHVzaCh7CiAgICAgICAgICAgIHR5cGU6ICJ0eXBlIiwKICAgICAgICAgICAgbWVzc2FnZTogYCR7cGF0aH0gaXMgbm90IGFuIGFycmF5LCBjYW5ub3QgY2FsbCAuJHttZXRob2R9KClgLAogICAgICAgICAgICBzdWdnZXN0aW9uOiBgRW5zdXJlICR7cGF0aH0gaXMgYW4gYXJyYXkgYmVmb3JlIGNhbGxpbmcgLiR7bWV0aG9kfSgpYCwKICAgICAgICAgICAgc2V2ZXJpdHk6ICJlcnJvciIKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICBjb25zdCBwcm9wQWNjZXNzUmVnZXggPSAvc3RhdGVcLihbXHcuXSspXC4oW1x3XSspL2c7CiAgbGV0IG1hdGNoOwogIHdoaWxlICgobWF0Y2ggPSBwcm9wQWNjZXNzUmVnZXguZXhlYyhjb2RlKSkgIT09IG51bGwpIHsKICAgIGNvbnN0IGJhc2VQYXRoID0gYHN0YXRlLiR7bWF0Y2hbMV19YDsKICAgIGNvbnN0IHZhbHVlID0gZ2V0U3RhdGVWYWx1ZShiYXNlUGF0aCk7CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHZvaWQgMCkgewogICAgICBpc3N1ZXMucHVzaCh7CiAgICAgICAgdHlwZTogInR5cGUiLAogICAgICAgIG1lc3NhZ2U6IGAke2Jhc2VQYXRofSBpcyAke3ZhbHVlfSwgY2Fubm90IHJlYWQgcHJvcGVydHkgJyR7bWF0Y2hbMl19J2AsCiAgICAgICAgc3VnZ2VzdGlvbjogYEFkZCBudWxsIGNoZWNrOiAke2Jhc2VQYXRofT8uJHttYXRjaFsyXX0gb3IgaW5pdGlhbGl6ZSAke2Jhc2VQYXRofSBmaXJzdGAsCiAgICAgICAgc2V2ZXJpdHk6ICJ3YXJuaW5nIgogICAgICB9KTsKICAgIH0KICB9CiAgaWYgKGNvZGUuaW5jbHVkZXMoImF3YWl0ICIpIHx8IGNvZGUuaW5jbHVkZXMoImFzeW5jICIpKSB7CiAgICBpc3N1ZXMucHVzaCh7CiAgICAgIHR5cGU6ICJ3YXJuaW5nIiwKICAgICAgbWVzc2FnZTogIkFzeW5jIGNvZGUgZGV0ZWN0ZWQgLSBhcHBseSgpIGV4ZWN1dGVzIHN5bmNocm9ub3VzbHkiLAogICAgICBzdWdnZXN0aW9uOiAiVXNlIHJlZ3VsYXIgc3luY2hyb25vdXMgY29kZSBvciBoYW5kbGUgYXN5bmMgc2VwYXJhdGVseSIsCiAgICAgIHNldmVyaXR5OiAid2FybmluZyIKICAgIH0pOwogIH0KICByZXR1cm4gaXNzdWVzOwp9CmZ1bmN0aW9uIGdldFN0YXRlVmFsdWUocGF0aCkgewogIGlmICghY3VycmVudEFwcFN0YXRlMikgcmV0dXJuIHZvaWQgMDsKICBjb25zdCBwYXJ0cyA9IHBhdGgucmVwbGFjZSgic3RhdGUuIiwgIiIpLnNwbGl0KCIuIik7CiAgbGV0IGN1cnJlbnQgPSBjdXJyZW50QXBwU3RhdGUyLmFwcDsKICBmb3IgKGNvbnN0IHBhcnQgb2YgcGFydHMpIHsKICAgIGlmIChjdXJyZW50ID09PSBudWxsIHx8IGN1cnJlbnQgPT09IHZvaWQgMCkgcmV0dXJuIGN1cnJlbnQ7CiAgICBjb25zdCBhcnJheU1hdGNoID0gcGFydC5tYXRjaCgvXihcdyspXFsoXGQrKVxdJC8pOwogICAgaWYgKGFycmF5TWF0Y2gpIHsKICAgICAgY3VycmVudCA9IGN1cnJlbnRbYXJyYXlNYXRjaFsxXV07CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGN1cnJlbnQpKSB7CiAgICAgICAgY3VycmVudCA9IGN1cnJlbnRbcGFyc2VJbnQoYXJyYXlNYXRjaFsyXSwgMTApXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjdXJyZW50ID0gY3VycmVudFtwYXJ0XTsKICAgIH0KICB9CiAgcmV0dXJuIGN1cnJlbnQ7Cn0KZnVuY3Rpb24gY2FsY3VsYXRlU3RhdGVDaGFuZ2VzKGJlZm9yZSwgYWZ0ZXIsIHBhdGggPSAic3RhdGUiKSB7CiAgY29uc3QgY2hhbmdlcyA9IFtdOwogIGlmIChiZWZvcmUgPT09IGFmdGVyKSByZXR1cm4gY2hhbmdlczsKICBpZiAodHlwZW9mIGJlZm9yZSAhPT0gdHlwZW9mIGFmdGVyKSB7CiAgICBjaGFuZ2VzLnB1c2goeyBwYXRoLCBiZWZvcmUsIGFmdGVyIH0pOwogICAgcmV0dXJuIGNoYW5nZXM7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KGJlZm9yZSkgJiYgQXJyYXkuaXNBcnJheShhZnRlcikpIHsKICAgIGlmIChKU09OLnN0cmluZ2lmeShiZWZvcmUpICE9PSBKU09OLnN0cmluZ2lmeShhZnRlcikpIHsKICAgICAgY2hhbmdlcy5wdXNoKHsgcGF0aCwgYmVmb3JlLCBhZnRlciB9KTsKICAgIH0KICAgIHJldHVybiBjaGFuZ2VzOwogIH0KICBpZiAodHlwZW9mIGJlZm9yZSA9PT0gIm9iamVjdCIgJiYgYmVmb3JlICE9PSBudWxsICYmIGFmdGVyICE9PSBudWxsKSB7CiAgICBjb25zdCBhbGxLZXlzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWy4uLk9iamVjdC5rZXlzKGJlZm9yZSksIC4uLk9iamVjdC5rZXlzKGFmdGVyKV0pOwogICAgZm9yIChjb25zdCBrZXkgb2YgYWxsS2V5cykgewogICAgICBjaGFuZ2VzLnB1c2goLi4uY2FsY3VsYXRlU3RhdGVDaGFuZ2VzKGJlZm9yZVtrZXldLCBhZnRlcltrZXldLCBgJHtwYXRofS4ke2tleX1gKSk7CiAgICB9CiAgICByZXR1cm4gY2hhbmdlczsKICB9CiAgaWYgKGJlZm9yZSAhPT0gYWZ0ZXIpIHsKICAgIGNoYW5nZXMucHVzaCh7IHBhdGgsIGJlZm9yZSwgYWZ0ZXIgfSk7CiAgfQogIHJldHVybiBjaGFuZ2VzOwp9CmZ1bmN0aW9uIGdldEFmZmVjdGVkQ29tcG9uZW50cyhfY2hhbmdlcykgewogIHJldHVybiBbXTsKfQpmdW5jdGlvbiB2YWxpZGF0ZShjb2RlKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHsKICAgIHJldHVybiB7IHZhbGlkOiB0cnVlLCBpc3N1ZXM6IFtdIH07CiAgfQogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImxsbSIpKSB7CiAgICByZXR1cm4geyB2YWxpZDogdHJ1ZSwgaXNzdWVzOiBbXSB9OwogIH0KICBjb25zdCBpc3N1ZXMgPSBbCiAgICAuLi52YWxpZGF0ZVN5bnRheChjb2RlKSwKICAgIC4uLnZhbGlkYXRlUmVmZXJlbmNlcyhjb2RlKSwKICAgIC4uLnZhbGlkYXRlVHlwZXMoY29kZSkKICBdOwogIGNvbnN0IGVycm9yczIgPSBpc3N1ZXMuZmlsdGVyKChpKSA9PiBpLnNldmVyaXR5ID09PSAiZXJyb3IiKTsKICByZXR1cm4gewogICAgdmFsaWQ6IGVycm9yczIubGVuZ3RoID09PSAwLAogICAgaXNzdWVzCiAgfTsKfQpmdW5jdGlvbiBhcHBseShjb2RlKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHsKICAgIHJldHVybiB7CiAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICBlcnJvcjogImFwcGx5KCkgbm90IGF2YWlsYWJsZSBpbiBwcm9kdWN0aW9uIiwKICAgICAgcm9sbGJhY2s6ICgpID0+IHsKICAgICAgfSwKICAgICAgY29tcG9uZW50c0FmZmVjdGVkOiBbXSwKICAgICAgc3RhdGVDaGFuZ2VzOiBbXQogICAgfTsKICB9CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgibGxtIikpIHsKICAgIHJldHVybiB7CiAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICBlcnJvcjogIkxMTSBBUEkgaXMgZGlzYWJsZWQiLAogICAgICByb2xsYmFjazogKCkgPT4gewogICAgICB9LAogICAgICBjb21wb25lbnRzQWZmZWN0ZWQ6IFtdLAogICAgICBzdGF0ZUNoYW5nZXM6IFtdCiAgICB9OwogIH0KICBjb25zdCBzbmFwc2hvdCA9IGNyZWF0ZVN0YXRlU25hcHNob3QoKTsKICBjb25zdCBzdGF0ZUJlZm9yZSA9IGRlZXBDbG9uZShzbmFwc2hvdCk7CiAgY29uc3QgdmFsaWRhdGlvbiA9IHZhbGlkYXRlKGNvZGUpOwogIGlmICghdmFsaWRhdGlvbi52YWxpZCkgewogICAgY29uc3QgZXJyb3JNc2cgPSB2YWxpZGF0aW9uLmlzc3Vlcy5maWx0ZXIoKGkpID0+IGkuc2V2ZXJpdHkgPT09ICJlcnJvciIpLm1hcCgoaSkgPT4gaS5tZXNzYWdlKS5qb2luKCI7ICIpOwogICAgcmVjb3JkQXR0ZW1wdChjb2RlLCAiZXJyb3IiLCBlcnJvck1zZyk7CiAgICByZXR1cm4gewogICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgZXJyb3I6IGBWYWxpZGF0aW9uIGZhaWxlZDogJHtlcnJvck1zZ31gLAogICAgICByb2xsYmFjazogKCkgPT4gewogICAgICB9LAogICAgICBjb21wb25lbnRzQWZmZWN0ZWQ6IFtdLAogICAgICBzdGF0ZUNoYW5nZXM6IFtdCiAgICB9OwogIH0KICB0cnkgewogICAgY29uc3QgZXhlY0ZuID0gbmV3IEZ1bmN0aW9uKCJzdGF0ZSIsICJib3JlRE9NIiwgY29kZSk7CiAgICBleGVjRm4oY3VycmVudEFwcFN0YXRlMj8uYXBwLCB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdy5ib3JlRE9NIDogdm9pZCAwKTsKICAgIGNvbnN0IHN0YXRlQWZ0ZXIgPSBjcmVhdGVTdGF0ZVNuYXBzaG90KCk7CiAgICBjb25zdCBzdGF0ZUNoYW5nZXMgPSBjYWxjdWxhdGVTdGF0ZUNoYW5nZXMoc3RhdGVCZWZvcmUsIHN0YXRlQWZ0ZXIpOwogICAgcmVjb3JkQXR0ZW1wdChjb2RlLCAic3VjY2VzcyIpOwogICAgcmV0dXJuIHsKICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgcm9sbGJhY2s6ICgpID0+IHJlc3RvcmVTdGF0ZVNuYXBzaG90KHNuYXBzaG90KSwKICAgICAgY29tcG9uZW50c0FmZmVjdGVkOiBnZXRBZmZlY3RlZENvbXBvbmVudHMoc3RhdGVDaGFuZ2VzKSwKICAgICAgc3RhdGVDaGFuZ2VzCiAgICB9OwogIH0gY2F0Y2ggKGUpIHsKICAgIHJlc3RvcmVTdGF0ZVNuYXBzaG90KHNuYXBzaG90KTsKICAgIGNvbnN0IGVycm9yID0gZTsKICAgIHJlY29yZEF0dGVtcHQoY29kZSwgImVycm9yIiwgZXJyb3IubWVzc2FnZSk7CiAgICByZXR1cm4gewogICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsCiAgICAgIHJvbGxiYWNrOiAoKSA9PiB7CiAgICAgIH0sCiAgICAgIC8vIEFscmVhZHkgcm9sbGVkIGJhY2sKICAgICAgY29tcG9uZW50c0FmZmVjdGVkOiBbXSwKICAgICAgc3RhdGVDaGFuZ2VzOiBbXQogICAgfTsKICB9Cn0KZnVuY3Rpb24gYXBwbHlCYXRjaChjb2RlQmxvY2tzKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHsKICAgIHJldHVybiB7CiAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICByZXN1bHRzOiBbXSwKICAgICAgcm9sbGJhY2tBbGw6ICgpID0+IHsKICAgICAgfSwKICAgICAgZXJyb3I6ICJhcHBseUJhdGNoKCkgbm90IGF2YWlsYWJsZSBpbiBwcm9kdWN0aW9uIgogICAgfTsKICB9CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgibGxtIikpIHsKICAgIHJldHVybiB7CiAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICByZXN1bHRzOiBbXSwKICAgICAgcm9sbGJhY2tBbGw6ICgpID0+IHsKICAgICAgfSwKICAgICAgZXJyb3I6ICJMTE0gQVBJIGlzIGRpc2FibGVkIgogICAgfTsKICB9CiAgY29uc3QgaW5pdGlhbFNuYXBzaG90ID0gY3JlYXRlU3RhdGVTbmFwc2hvdCgpOwogIGNvbnN0IHJlc3VsdHMgPSBbXTsKICBmb3IgKGxldCBpID0gMDsgaSA8IGNvZGVCbG9ja3MubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHJlc3VsdCA9IGFwcGx5KGNvZGVCbG9ja3NbaV0pOwogICAgcmVzdWx0cy5wdXNoKHJlc3VsdCk7CiAgICBpZiAoIXJlc3VsdC5zdWNjZXNzKSB7CiAgICAgIHJlc3RvcmVTdGF0ZVNuYXBzaG90KGluaXRpYWxTbmFwc2hvdCk7CiAgICAgIHJldHVybiB7CiAgICAgICAgc3VjY2VzczogZmFsc2UsCiAgICAgICAgcmVzdWx0cywKICAgICAgICByb2xsYmFja0FsbDogKCkgPT4gewogICAgICAgIH0sCiAgICAgICAgLy8gQWxyZWFkeSByb2xsZWQgYmFjawogICAgICAgIGVycm9yOiByZXN1bHQuZXJyb3IsCiAgICAgICAgZmFpbGVkSW5kZXg6IGkKICAgICAgfTsKICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIHN1Y2Nlc3M6IHRydWUsCiAgICByZXN1bHRzLAogICAgcm9sbGJhY2tBbGw6ICgpID0+IHJlc3RvcmVTdGF0ZVNuYXBzaG90KGluaXRpYWxTbmFwc2hvdCkKICB9Owp9CnZhciBjdXJyZW50QXBwU3RhdGUyOwp2YXIgaW5pdF92YWxpZGF0aW9uID0gX19lc20oewogICJzcmMvdmFsaWRhdGlvbi50cyIoKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpbml0X2RlYnVnKCk7CiAgICBpbml0X2xsbSgpOwogICAgY3VycmVudEFwcFN0YXRlMiA9IG51bGw7CiAgfQp9KTsKCi8vIHNyYy9sbG0udHMKdmFyIGxsbV9leHBvcnRzID0ge307Cl9fZXhwb3J0KGxsbV9leHBvcnRzLCB7CiAgY2xlYXJBdHRlbXB0czogKCkgPT4gY2xlYXJBdHRlbXB0cywKICBjb250ZXh0OiAoKSA9PiBjb250ZXh0LAogIGNvcHk6ICgpID0+IGNvcHksCiAgZm9jdXM6ICgpID0+IGZvY3VzLAogIGZvcm1hdEVycm9yRm9yTExNOiAoKSA9PiBmb3JtYXRFcnJvckZvckxMTSwKICBnZXRBdHRlbXB0czogKCkgPT4gZ2V0QXR0ZW1wdHMsCiAgaXNMTE1PdXRwdXRGb3JtYXQ6ICgpID0+IGlzTExNT3V0cHV0Rm9ybWF0LAogIGxsbUFQSTogKCkgPT4gbGxtQVBJLAogIGxsbUxvZzogKCkgPT4gbGxtTG9nLAogIHJlY29yZEF0dGVtcHQ6ICgpID0+IHJlY29yZEF0dGVtcHQsCiAgc2V0VmFsaWRhdGlvbkFwcFN0YXRlOiAoKSA9PiBzZXRWYWxpZGF0aW9uQXBwU3RhdGUKfSk7CmZ1bmN0aW9uIGlzU2FtZU9iamVjdChhLCBiKSB7CiAgaWYgKGEgPT09IGIpIHJldHVybiB0cnVlOwogIGlmICghYSB8fCAhYikgcmV0dXJuIGZhbHNlOwogIGlmICh0eXBlb2YgYSAhPT0gIm9iamVjdCIgfHwgdHlwZW9mIGIgIT09ICJvYmplY3QiKSByZXR1cm4gZmFsc2U7CiAgdHJ5IHsKICAgIGNvbnN0IG1hcmtlciA9IERhdGUubm93KCkgKyBNYXRoLnJhbmRvbSgpOwogICAgYVtDSVJDVUxBUl9DSEVDS10gPSBtYXJrZXI7CiAgICBjb25zdCBzYW1lID0gYltDSVJDVUxBUl9DSEVDS10gPT09IG1hcmtlcjsKICAgIGRlbGV0ZSBhW0NJUkNVTEFSX0NIRUNLXTsKICAgIHJldHVybiBzYW1lOwogIH0gY2F0Y2ggewogICAgcmV0dXJuIGZhbHNlOwogIH0KfQpmdW5jdGlvbiBnZXRTdGF0ZVBhdGhzKG9iaiwgcHJlZml4ID0gIiIsIHNlZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKSkgewogIGNvbnN0IHBhdGhzID0gW107CiAgaWYgKG9iaiA9PT0gbnVsbCB8fCBvYmogPT09IHZvaWQgMCkgcmV0dXJuIHBhdGhzOwogIGlmICh0eXBlb2Ygb2JqICE9PSAib2JqZWN0IikgcmV0dXJuIHBhdGhzOwogIGlmIChzZWVuLmhhcyhvYmopKSByZXR1cm4gcGF0aHM7CiAgc2Vlbi5hZGQob2JqKTsKICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhvYmopKSB7CiAgICBjb25zdCBwYXRoID0gcHJlZml4ID8gYCR7cHJlZml4fS4ke2tleX1gIDoga2V5OwogICAgcGF0aHMucHVzaChwYXRoKTsKICAgIGNvbnN0IHZhbHVlID0gb2JqW2tleV07CiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgcGF0aHMucHVzaChgJHtwYXRofVtdYCk7CiAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiAwICYmIHR5cGVvZiB2YWx1ZVswXSA9PT0gIm9iamVjdCIgJiYgdmFsdWVbMF0gIT09IG51bGwpIHsKICAgICAgICBwYXRocy5wdXNoKC4uLmdldFN0YXRlUGF0aHModmFsdWVbMF0sIGAke3BhdGh9WzBdYCwgc2VlbikpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHsKICAgICAgcGF0aHMucHVzaCguLi5nZXRTdGF0ZVBhdGhzKHZhbHVlLCBwYXRoLCBzZWVuKSk7CiAgICB9CiAgfQogIHJldHVybiBwYXRoczsKfQpmdW5jdGlvbiBpbmZlclR5cGVTaGFwZShvYmosIHNlZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKSkgewogIGlmIChvYmogPT09IG51bGwpIHJldHVybiAibnVsbCI7CiAgaWYgKG9iaiA9PT0gdm9pZCAwKSByZXR1cm4gInVuZGVmaW5lZCI7CiAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSkgewogICAgaWYgKG9iai5sZW5ndGggPT09IDApIHJldHVybiAiYW55W10iOwogICAgY29uc3QgZWxlbVR5cGUgPSBpbmZlclR5cGVTaGFwZShvYmpbMF0sIHNlZW4pOwogICAgcmV0dXJuIGAke2VsZW1UeXBlfVtdYDsKICB9CiAgaWYgKHR5cGVvZiBvYmogPT09ICJvYmplY3QiKSB7CiAgICBpZiAoc2Vlbi5oYXMob2JqKSkgcmV0dXJuICIvKiBjaXJjdWxhciAqLyI7CiAgICBzZWVuLmFkZChvYmopOwogICAgY29uc3QgcHJvcHMgPSBPYmplY3QuZW50cmllcyhvYmopLm1hcCgoW2ssIHZdKSA9PiBgICAke2t9OiAke2luZmVyVHlwZVNoYXBlKHYsIHNlZW4pfWApLmpvaW4oIlxuIik7CiAgICByZXR1cm4gYHsKJHtwcm9wc30KfWA7CiAgfQogIHJldHVybiB0eXBlb2Ygb2JqOwp9CmZ1bmN0aW9uIHNhbml0aXplU3RhdGUoc3RhdGUsIHNlZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKSwgcm9vdCkgewogIGlmIChzdGF0ZSA9PT0gbnVsbCB8fCBzdGF0ZSA9PT0gdm9pZCAwKSByZXR1cm4gc3RhdGU7CiAgaWYgKHR5cGVvZiBzdGF0ZSAhPT0gIm9iamVjdCIpIHJldHVybiBzdGF0ZTsKICBpZiAodHlwZW9mIHN0YXRlID09PSAiZnVuY3Rpb24iKSByZXR1cm4gIltGdW5jdGlvbl0iOwogIGlmICh0eXBlb2Ygc3RhdGUgPT09ICJzeW1ib2wiKSByZXR1cm4gIltTeW1ib2xdIjsKICBpZiAoc3RhdGUgaW5zdGFuY2VvZiBEYXRlKSByZXR1cm4gc3RhdGUudG9JU09TdHJpbmcoKTsKICBpZiAoc3RhdGUgaW5zdGFuY2VvZiBSZWdFeHApIHJldHVybiBzdGF0ZS50b1N0cmluZygpOwogIGlmIChzdGF0ZSBpbnN0YW5jZW9mIE1hcCkgcmV0dXJuICJbTWFwXSI7CiAgaWYgKHN0YXRlIGluc3RhbmNlb2YgU2V0KSByZXR1cm4gIltTZXRdIjsKICBpZiAocm9vdCA9PT0gdm9pZCAwKSByb290ID0gc3RhdGU7CiAgaWYgKHNlZW4uaGFzKHN0YXRlKSkgcmV0dXJuICJbQ2lyY3VsYXJdIjsKICBzZWVuLmFkZChzdGF0ZSk7CiAgY29uc3Qgc2FuaXRpemVkID0gQXJyYXkuaXNBcnJheShzdGF0ZSkgPyBbXSA6IHt9OwogIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHN0YXRlKSkgewogICAgY29uc3QgaXNTZW5zaXRpdmUgPSBTRU5TSVRJVkVfS0VZUy5zb21lKAogICAgICAocykgPT4ga2V5LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMocy50b0xvd2VyQ2FzZSgpKQogICAgKTsKICAgIGlmIChpc1NlbnNpdGl2ZSkgewogICAgICBzYW5pdGl6ZWRba2V5XSA9ICJbUkVEQUNURURdIjsKICAgIH0gZWxzZSBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IikgewogICAgICBpZiAoaXNTYW1lT2JqZWN0KHZhbHVlLCByb290KSkgewogICAgICAgIHNhbml0aXplZFtrZXldID0gIltDaXJjdWxhcl0iOwogICAgICB9IGVsc2UgaWYgKHNlZW4uaGFzKHZhbHVlKSkgewogICAgICAgIHNhbml0aXplZFtrZXldID0gIltDaXJjdWxhcl0iOwogICAgICB9IGVsc2UgewogICAgICAgIHNhbml0aXplZFtrZXldID0gc2FuaXRpemVTdGF0ZSh2YWx1ZSwgc2Vlbiwgcm9vdCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHNhbml0aXplZFtrZXldID0gIltGdW5jdGlvbl0iOwogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzeW1ib2wiKSB7CiAgICAgIHNhbml0aXplZFtrZXldID0gIltTeW1ib2xdIjsKICAgIH0gZWxzZSB7CiAgICAgIHNhbml0aXplZFtrZXldID0gdmFsdWU7CiAgICB9CiAgfQogIHJldHVybiBzYW5pdGl6ZWQ7Cn0KZnVuY3Rpb24gZ2VuZXJhdGVTdWdnZXN0aW9uKGN0eCkgewogIGNvbnN0IG1zZyA9IGN0eC5lcnJvci5tZXNzYWdlLnRvTG93ZXJDYXNlKCk7CiAgaWYgKG1zZy5pbmNsdWRlcygidW5kZWZpbmVkIikgJiYgbXNnLmluY2x1ZGVzKCJyZWFkaW5nIikpIHsKICAgIGNvbnN0IG1hdGNoID0gbXNnLm1hdGNoKC9yZWFkaW5nICcoXHcrKScvKTsKICAgIGlmIChtYXRjaCkgewogICAgICByZXR1cm4gYFByb3BlcnR5IGFjY2VzcyBvbiBudWxsL3VuZGVmaW5lZC4gQWRkIG51bGwgY2hlY2sgYmVmb3JlIGFjY2Vzc2luZyAnJHttYXRjaFsxXX0nIG9yIGluaXRpYWxpemUgdGhlIHZhbHVlLmA7CiAgICB9CiAgfQogIGlmIChtc2cuaW5jbHVkZXMoImlzIG5vdCBhIGZ1bmN0aW9uIikpIHsKICAgIGNvbnN0IG1hdGNoID0gbXNnLm1hdGNoKC8oXHcrKSBpcyBub3QgYSBmdW5jdGlvbi8pOwogICAgaWYgKG1hdGNoKSB7CiAgICAgIHJldHVybiBgJyR7bWF0Y2hbMV19JyBpcyBub3QgYSBmdW5jdGlvbi4gQ2hlY2sgaWYgaXQncyBkZWZpbmVkLCBpbXBvcnRlZCwgb3IgaWYgdGhlIG9iamVjdCBleGlzdHMuYDsKICAgIH0KICB9CiAgaWYgKG1zZy5pbmNsdWRlcygibWFwIikgfHwgbXNnLmluY2x1ZGVzKCJmaWx0ZXIiKSB8fCBtc2cuaW5jbHVkZXMoImZvcmVhY2giKSkgewogICAgcmV0dXJuICJBcnJheSBtZXRob2QgY2FsbGVkIG9uIG5vbi1hcnJheS4gSW5pdGlhbGl6ZSBhcyBlbXB0eSBhcnJheSBvciBhZGQgdHlwZSBjaGVjay4iOwogIH0KICBpZiAobXNnLmluY2x1ZGVzKCJudWxsIikgfHwgbXNnLmluY2x1ZGVzKCJ1bmRlZmluZWQiKSkgewogICAgcmV0dXJuICJOdWxsL3VuZGVmaW5lZCB2YWx1ZSBlbmNvdW50ZXJlZC4gQWRkIGRlZmVuc2l2ZSBjaGVja3Mgb3IgaW5pdGlhbGl6ZSBkYXRhLiI7CiAgfQogIHJldHVybiAiQ2hlY2sgdGhlIGVycm9yIG1lc3NhZ2UgYW5kIGNvbXBvbmVudCBzdGF0ZSBmb3IgdGhlIHJvb3QgY2F1c2UuIjsKfQpmdW5jdGlvbiBnZXRFcnJvck1hcCgpIHsKICByZXR1cm4gZGVidWdBUEkuZXJyb3JzOwp9CmZ1bmN0aW9uIGdldE1pc3NpbmdGdW5jdGlvbnNNYXAoKSB7CiAgcmV0dXJuIGluc2lkZU91dEFQSS5taXNzaW5nRnVuY3Rpb25zOwp9CmZ1bmN0aW9uIGdldERlZmluZWRIZWxwZXJzTWFwKCkgewogIHJldHVybiBpbnNpZGVPdXRBUEkuaGVscGVyczsKfQpmdW5jdGlvbiBnZXRNaXNzaW5nQ29tcG9uZW50cygpIHsKICBpZiAodHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIikgcmV0dXJuIFtdOwogIGNvbnN0IG1pc3NpbmcgPSBbXTsKICBjb25zdCBhbGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCIqIik7CiAgZm9yIChjb25zdCBlbCBvZiBBcnJheS5mcm9tKGFsbCkpIHsKICAgIGNvbnN0IHRhZyA9IGVsLnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKICAgIGlmICh0YWcuaW5jbHVkZXMoIi0iKSAmJiAhY3VzdG9tRWxlbWVudHMuZ2V0KHRhZykpIHsKICAgICAgaWYgKCFtaXNzaW5nLmluY2x1ZGVzKHRhZykpIHsKICAgICAgICBtaXNzaW5nLnB1c2godGFnKTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gbWlzc2luZzsKfQpmdW5jdGlvbiBnZXRSZWdpc3RlcmVkQ29tcG9uZW50cygpIHsKICBjb25zdCBhcHBTdGF0ZSA9IGdldEN1cnJlbnRBcHBTdGF0ZSgpOwogIGlmICghYXBwU3RhdGUpIHJldHVybiBbXTsKICByZXR1cm4gYXBwU3RhdGUuaW50ZXJuYWwuY3VzdG9tVGFncyB8fCBbXTsKfQpmdW5jdGlvbiBnZXRDb21wb25lbnRUZW1wbGF0ZSh0YWdOYW1lKSB7CiAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwogIGNvbnN0IHRlbXBsYXRlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgdGVtcGxhdGVbZGF0YS1jb21wb25lbnQ9IiR7dGFnTmFtZX0iXWApOwogIHJldHVybiB0ZW1wbGF0ZT8uaW5uZXJIVE1MID8/IG51bGw7Cn0KZnVuY3Rpb24gY291bnRDb21wb25lbnRJbnN0YW5jZXModGFnTmFtZSkgewogIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gMDsKICByZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCh0YWdOYW1lKS5sZW5ndGg7Cn0KZnVuY3Rpb24gYnVpbGRDb21wb25lbnRJbmZvKHRhZ05hbWUpIHsKICBjb25zdCBhcHBTdGF0ZSA9IGdldEN1cnJlbnRBcHBTdGF0ZSgpOwogIGNvbnN0IGhhc0xvZ2ljID0gYXBwU3RhdGU/LmludGVybmFsLmNvbXBvbmVudHMuaGFzKHRhZ05hbWUpID8/IGZhbHNlOwogIGNvbnN0IHRlbXBsYXRlID0gZ2V0Q29tcG9uZW50VGVtcGxhdGUodGFnTmFtZSk7CiAgY29uc3QgaW5zdGFuY2VDb3VudCA9IGNvdW50Q29tcG9uZW50SW5zdGFuY2VzKHRhZ05hbWUpOwogIGNvbnN0IGVycm9yczIgPSBnZXRFcnJvck1hcCgpOwogIGNvbnN0IGhhc0Vycm9yID0gZXJyb3JzMi5oYXModGFnTmFtZSk7CiAgY29uc3QgcmVmcyA9IFtdOwogIGNvbnN0IHNsb3RzID0gW107CiAgaWYgKHRlbXBsYXRlKSB7CiAgICBjb25zdCB0ZW1wRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICB0ZW1wRGl2LmlubmVySFRNTCA9IHRlbXBsYXRlOwogICAgdGVtcERpdi5xdWVyeVNlbGVjdG9yQWxsKCJbZGF0YS1yZWZdIikuZm9yRWFjaCgoZWwpID0+IHsKICAgICAgY29uc3QgcmVmTmFtZSA9IGVsLmdldEF0dHJpYnV0ZSgiZGF0YS1yZWYiKTsKICAgICAgaWYgKHJlZk5hbWUpIHJlZnMucHVzaChyZWZOYW1lKTsKICAgIH0pOwogICAgdGVtcERpdi5xdWVyeVNlbGVjdG9yQWxsKCJbZGF0YS1zbG90XSwgc2xvdFtuYW1lXSIpLmZvckVhY2goKGVsKSA9PiB7CiAgICAgIGNvbnN0IHNsb3ROYW1lID0gZWwuZ2V0QXR0cmlidXRlKCJkYXRhLXNsb3QiKSB8fCBlbC5nZXRBdHRyaWJ1dGUoIm5hbWUiKTsKICAgICAgaWYgKHNsb3ROYW1lKSBzbG90cy5wdXNoKHNsb3ROYW1lKTsKICAgIH0pOwogIH0KICByZXR1cm4gewogICAgdGFnTmFtZSwKICAgIHRlbXBsYXRlLAogICAgaGFzTG9naWMsCiAgICByZWZzLAogICAgc2xvdHMsCiAgICBldmVudHM6IFtdLAogICAgLy8gV291bGQgbmVlZCB0byB0cmFjayBmcm9tIG9uKCkgY2FsbHMKICAgIHN0YXRlQWNjZXNzOiBbXSwKICAgIC8vIFdvdWxkIG5lZWQgdG8gdHJhY2sgZnJvbSBzdGF0ZSBhY2Nlc3MKICAgIGhhc0Vycm9yLAogICAgaW5zdGFuY2VDb3VudAogIH07Cn0KZnVuY3Rpb24gYnVpbGRDb21wb25lbnRNYXAoKSB7CiAgY29uc3QgdGFncyA9IGdldFJlZ2lzdGVyZWRDb21wb25lbnRzKCk7CiAgY29uc3QgbWFwID0ge307CiAgZm9yIChjb25zdCB0YWcgb2YgdGFncykgewogICAgbWFwW3RhZ10gPSBidWlsZENvbXBvbmVudEluZm8odGFnKTsKICB9CiAgcmV0dXJuIG1hcDsKfQpmdW5jdGlvbiBnZXRDYXBhYmlsaXRpZXMoKSB7CiAgY29uc3QgY2FwYWJpbGl0aWVzID0gWyJyZWFjdGl2ZS1zdGF0ZSIsICJ3ZWItY29tcG9uZW50cyIsICJldmVudC1oYW5kbGluZyJdOwogIGNvbnN0IGNvbmZpZyA9IGdldERlYnVnQ29uZmlnKCk7CiAgaWYgKGNvbmZpZy5lcnJvckJvdW5kYXJ5KSBjYXBhYmlsaXRpZXMucHVzaCgiZXJyb3ItYm91bmRhcnkiKTsKICBpZiAoY29uZmlnLmdsb2JhbHMpIGNhcGFiaWxpdGllcy5wdXNoKCJkZWJ1Zy1nbG9iYWxzIik7CiAgaWYgKGNvbmZpZy5hcGkpIGNhcGFiaWxpdGllcy5wdXNoKCJydW50aW1lLWRlZmluZSIpOwogIGlmIChjb25maWcubWV0aG9kTWlzc2luZykgY2FwYWJpbGl0aWVzLnB1c2goIm1ldGhvZC1taXNzaW5nIik7CiAgaWYgKGNvbmZpZy50ZW1wbGF0ZUluZmVyZW5jZSkgY2FwYWJpbGl0aWVzLnB1c2goInRlbXBsYXRlLWluZmVyZW5jZSIpOwogIHJldHVybiBjYXBhYmlsaXRpZXM7Cn0KZnVuY3Rpb24gZGV0ZWN0UGF0dGVybnMoKSB7CiAgY29uc3QgdGFncyA9IGdldFJlZ2lzdGVyZWRDb21wb25lbnRzKCk7CiAgY29uc3QgY29tcG9uZW50TmFtaW5nID0gdGFncy5sZW5ndGggPiAwID8gdGFncy5ldmVyeSgodCkgPT4gdC5tYXRjaCgvXlthLXpdKy1bYS16XSsoLVthLXpdKykqJC8pKSA/ICJrZWJhYi1jYXNlIChlLmcuLCB1c2VyLXByb2ZpbGUsIHRvZG8tbGlzdCkiIDogIm1peGVkIiA6ICJ1bmtub3duIjsKICByZXR1cm4gewogICAgZXZlbnROYW1pbmc6ICJ1bmtub3duIiwKICAgIC8vIFdvdWxkIG5lZWQgdG8gdHJhY2sgZXZlbnRzCiAgICBzdGF0ZVN0cnVjdHVyZTogInVua25vd24iLAogICAgLy8gV291bGQgbmVlZCB0byBhbmFseXplIHN0YXRlIHNoYXBlCiAgICBjb21wb25lbnROYW1pbmcKICB9Owp9CmZ1bmN0aW9uIGluZmVyU2lnbmF0dXJlKG5hbWUsIGFyZ3MpIHsKICBpZiAoYXJncy5sZW5ndGggPT09IDApIHJldHVybiBgJHtuYW1lfSgpOiBhbnlgOwogIGNvbnN0IGFyZ1R5cGVzID0gYXJncy5tYXAoKGFyZywgaSkgPT4gewogICAgaWYgKGFyZyA9PT0gbnVsbCkgcmV0dXJuIGBhcmcke2l9OiBudWxsYDsKICAgIGlmIChhcmcgPT09IHZvaWQgMCkgcmV0dXJuIGBhcmcke2l9OiB1bmRlZmluZWRgOwogICAgaWYgKEFycmF5LmlzQXJyYXkoYXJnKSkgcmV0dXJuIGBpdGVtczogYW55W11gOwogICAgaWYgKHR5cGVvZiBhcmcgPT09ICJvYmplY3QiKSByZXR1cm4gYGRhdGE6IG9iamVjdGA7CiAgICByZXR1cm4gYGFyZyR7aX06ICR7dHlwZW9mIGFyZ31gOwogIH0pOwogIHJldHVybiBgJHtuYW1lfSgke2FyZ1R5cGVzLmpvaW4oIiwgIil9KTogYW55YDsKfQpmdW5jdGlvbiBnZXRFbXB0eUNvbnRleHQoKSB7CiAgcmV0dXJuIHsKICAgIGZyYW1ld29yazogewogICAgICBuYW1lOiAiYm9yZURPTSIsCiAgICAgIHZlcnNpb246IFZFUlNJT04sCiAgICAgIGNhcGFiaWxpdGllczogW10KICAgIH0sCiAgICBzdGF0ZTogewogICAgICBzaGFwZTogInt9IiwKICAgICAgcGF0aHM6IFtdLAogICAgICBzYW1wbGU6IHt9CiAgICB9LAogICAgY29tcG9uZW50czoge30sCiAgICBpc3N1ZXM6IHsKICAgICAgZXJyb3JzOiBbXSwKICAgICAgbWlzc2luZ0Z1bmN0aW9uczogW10sCiAgICAgIG1pc3NpbmdDb21wb25lbnRzOiBbXQogICAgfSwKICAgIGhlbHBlcnM6IHsKICAgICAgZGVmaW5lZDoge30sCiAgICAgIG1pc3Npbmc6IHt9CiAgICB9LAogICAgcGF0dGVybnM6IHsKICAgICAgZXZlbnROYW1pbmc6ICJ1bmtub3duIiwKICAgICAgc3RhdGVTdHJ1Y3R1cmU6ICJ1bmtub3duIiwKICAgICAgY29tcG9uZW50TmFtaW5nOiAidW5rbm93biIKICAgIH0KICB9Owp9CmZ1bmN0aW9uIGdldEVtcHR5Rm9jdXNlZENvbnRleHQoKSB7CiAgcmV0dXJuIHsKICAgIGlzc3VlOiB7CiAgICAgIHR5cGU6ICJub25lIiwKICAgICAgZGVzY3JpcHRpb246ICJMTE0gZmVhdHVyZXMgZGlzYWJsZWQgb3IgdW5hdmFpbGFibGUiCiAgICB9LAogICAgcmVsZXZhbnRTdGF0ZToge30KICB9Owp9CmZ1bmN0aW9uIGNvbnRleHQoKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHsKICAgIHJldHVybiBnZXRFbXB0eUNvbnRleHQoKTsKICB9CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgibGxtIikpIHsKICAgIHJldHVybiBnZXRFbXB0eUNvbnRleHQoKTsKICB9CiAgY29uc3QgYXBwU3RhdGUgPSBnZXRDdXJyZW50QXBwU3RhdGUoKTsKICBjb25zdCBzdGF0ZSA9IGFwcFN0YXRlPy5hcHAgPz8ge307CiAgY29uc3QgZXJyb3JzMiA9IGdldEVycm9yTWFwKCk7CiAgY29uc3QgbWlzc2luZ0ZucyA9IGdldE1pc3NpbmdGdW5jdGlvbnNNYXAoKTsKICBjb25zdCBkZWZpbmVkSGVscGVycyA9IGdldERlZmluZWRIZWxwZXJzTWFwKCk7CiAgY29uc3QgZXJyb3JJbmZvcyA9IEFycmF5LmZyb20oZXJyb3JzMi52YWx1ZXMoKSkubWFwKChjdHgpID0+ICh7CiAgICBjb21wb25lbnQ6IGN0eC5jb21wb25lbnQsCiAgICBlcnJvcjogY3R4LmVycm9yLm1lc3NhZ2UsCiAgICBzdGFjazogY3R4LnN0YWNrLAogICAgc3RhdGU6IHNhbml0aXplU3RhdGUoY3R4LnN0YXRlKSwKICAgIHRpbWVzdGFtcDogY3R4LnRpbWVzdGFtcAogIH0pKTsKICBjb25zdCBtaXNzaW5nRm5JbmZvcyA9IFtdOwogIGNvbnN0IG1pc3NpbmdDYWxsSW5mb3MgPSB7fTsKICBmb3IgKGNvbnN0IFtuYW1lLCBjYWxsc10gb2YgbWlzc2luZ0Zucy5lbnRyaWVzKCkpIHsKICAgIGNvbnN0IGFsbEFyZ3MgPSBjYWxscy5tYXAoKGMpID0+IGMuYXJncyk7CiAgICBjb25zdCBjb21wb25lbnRzID0gWy4uLm5ldyBTZXQoY2FsbHMubWFwKChjKSA9PiBjLmNvbXBvbmVudCkpXTsKICAgIGNvbnN0IGxhc3RDYWxsID0gTWF0aC5tYXgoLi4uY2FsbHMubWFwKChjKSA9PiBjLnRpbWVzdGFtcCkpOwogICAgbWlzc2luZ0ZuSW5mb3MucHVzaCh7CiAgICAgIG5hbWUsCiAgICAgIGFyZ3M6IGNhbGxzWzBdPy5hcmdzID8/IFtdLAogICAgICBjb21wb25lbnQ6IGNhbGxzWzBdPy5jb21wb25lbnQgPz8gInVua25vd24iLAogICAgICBpbmZlcnJlZFNpZ25hdHVyZTogaW5mZXJTaWduYXR1cmUobmFtZSwgY2FsbHNbMF0/LmFyZ3MgPz8gW10pLAogICAgICBjYWxsQ291bnQ6IGNhbGxzLmxlbmd0aAogICAgfSk7CiAgICBtaXNzaW5nQ2FsbEluZm9zW25hbWVdID0gewogICAgICBhcmdzOiBhbGxBcmdzLAogICAgICBjb21wb25lbnRzLAogICAgICBsYXN0Q2FsbAogICAgfTsKICB9CiAgY29uc3QgZGVmaW5lZEhlbHBlclNpZ25hdHVyZXMgPSB7fTsKICBmb3IgKGNvbnN0IFtuYW1lLCBmbl0gb2YgZGVmaW5lZEhlbHBlcnMuZW50cmllcygpKSB7CiAgICBkZWZpbmVkSGVscGVyU2lnbmF0dXJlc1tuYW1lXSA9IGAke25hbWV9KCR7Zm4ubGVuZ3RoID4gMCA/ICIuLi4iIDogIiJ9KTogYW55YDsKICB9CiAgcmV0dXJuIHsKICAgIGZyYW1ld29yazogewogICAgICBuYW1lOiAiYm9yZURPTSIsCiAgICAgIHZlcnNpb246IFZFUlNJT04sCiAgICAgIGNhcGFiaWxpdGllczogZ2V0Q2FwYWJpbGl0aWVzKCkKICAgIH0sCiAgICBzdGF0ZTogewogICAgICBzaGFwZTogaW5mZXJUeXBlU2hhcGUoc3RhdGUpLAogICAgICBwYXRoczogZ2V0U3RhdGVQYXRocyhzdGF0ZSksCiAgICAgIHNhbXBsZTogc2FuaXRpemVTdGF0ZShzdGF0ZSkKICAgIH0sCiAgICBjb21wb25lbnRzOiBidWlsZENvbXBvbmVudE1hcCgpLAogICAgaXNzdWVzOiB7CiAgICAgIGVycm9yczogZXJyb3JJbmZvcywKICAgICAgbWlzc2luZ0Z1bmN0aW9uczogbWlzc2luZ0ZuSW5mb3MsCiAgICAgIG1pc3NpbmdDb21wb25lbnRzOiBnZXRNaXNzaW5nQ29tcG9uZW50cygpCiAgICB9LAogICAgaGVscGVyczogewogICAgICBkZWZpbmVkOiBkZWZpbmVkSGVscGVyU2lnbmF0dXJlcywKICAgICAgbWlzc2luZzogbWlzc2luZ0NhbGxJbmZvcwogICAgfSwKICAgIHBhdHRlcm5zOiBkZXRlY3RQYXR0ZXJucygpCiAgfTsKfQpmdW5jdGlvbiBmb2N1cygpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgewogICAgcmV0dXJuIGdldEVtcHR5Rm9jdXNlZENvbnRleHQoKTsKICB9CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgibGxtIikpIHsKICAgIHJldHVybiBnZXRFbXB0eUZvY3VzZWRDb250ZXh0KCk7CiAgfQogIGNvbnN0IGVycm9yczIgPSBnZXRFcnJvck1hcCgpOwogIGlmIChlcnJvcnMyLnNpemUgPiAwKSB7CiAgICBjb25zdCBlcnJvckxpc3QgPSBBcnJheS5mcm9tKGVycm9yczIudmFsdWVzKCkpOwogICAgY29uc3QgbGF0ZXN0ID0gZXJyb3JMaXN0W2Vycm9yTGlzdC5sZW5ndGggLSAxXTsKICAgIHJldHVybiB7CiAgICAgIGlzc3VlOiB7CiAgICAgICAgdHlwZTogImVycm9yIiwKICAgICAgICBkZXNjcmlwdGlvbjogbGF0ZXN0LmVycm9yLm1lc3NhZ2UsCiAgICAgICAgY29tcG9uZW50OiBsYXRlc3QuY29tcG9uZW50LAogICAgICAgIHN1Z2dlc3Rpb246IGdlbmVyYXRlU3VnZ2VzdGlvbihsYXRlc3QpCiAgICAgIH0sCiAgICAgIGNvbXBvbmVudDogewogICAgICAgIC4uLmJ1aWxkQ29tcG9uZW50SW5mbyhsYXRlc3QuY29tcG9uZW50KSwKICAgICAgICBjdXJyZW50U3RhdGU6IHNhbml0aXplU3RhdGUobGF0ZXN0LnN0YXRlKQogICAgICB9LAogICAgICByZWxldmFudFN0YXRlOiBzYW5pdGl6ZVN0YXRlKGxhdGVzdC5zdGF0ZSksCiAgICAgIHByZXZpb3VzQXR0ZW1wdHM6IGdldFJlY2VudEF0dGVtcHRzKCkKICAgIH07CiAgfQogIGNvbnN0IG1pc3NpbmdGbnMgPSBnZXRNaXNzaW5nRnVuY3Rpb25zTWFwKCk7CiAgaWYgKG1pc3NpbmdGbnMuc2l6ZSA+IDApIHsKICAgIGNvbnN0IGVudHJpZXMgPSBBcnJheS5mcm9tKG1pc3NpbmdGbnMuZW50cmllcygpKTsKICAgIGNvbnN0IFtuYW1lLCBjYWxsc10gPSBlbnRyaWVzW2VudHJpZXMubGVuZ3RoIC0gMV07CiAgICBjb25zdCBsYXN0Q2FsbCA9IGNhbGxzW2NhbGxzLmxlbmd0aCAtIDFdOwogICAgcmV0dXJuIHsKICAgICAgaXNzdWU6IHsKICAgICAgICB0eXBlOiAibWlzc2luZ19mdW5jdGlvbiIsCiAgICAgICAgZGVzY3JpcHRpb246IGBVbmRlZmluZWQgZnVuY3Rpb24gJyR7bmFtZX0nIGNhbGxlZGAsCiAgICAgICAgY29tcG9uZW50OiBsYXN0Q2FsbD8uY29tcG9uZW50LAogICAgICAgIHN1Z2dlc3Rpb246IGBEZWZpbmUgaGVscGVyOiBib3JlRE9NLmRlZmluZUhlbHBlcigiJHtuYW1lfSIsICgke2luZmVyU2lnbmF0dXJlKG5hbWUsIGxhc3RDYWxsPy5hcmdzID8/IFtdKS5zcGxpdCgiKCIpWzFdPy5zcGxpdCgiKSIpWzBdIHx8ICIifSkgPT4geyAvKiBpbXBsZW1lbnRhdGlvbiAqLyB9KWAKICAgICAgfSwKICAgICAgY29tcG9uZW50OiBsYXN0Q2FsbD8uY29tcG9uZW50ID8gewogICAgICAgIC4uLmJ1aWxkQ29tcG9uZW50SW5mbyhsYXN0Q2FsbC5jb21wb25lbnQpLAogICAgICAgIGN1cnJlbnRTdGF0ZTogc2FuaXRpemVTdGF0ZShnZXRDdXJyZW50QXBwU3RhdGUoKT8uYXBwKQogICAgICB9IDogdm9pZCAwLAogICAgICByZWxldmFudFN0YXRlOiBzYW5pdGl6ZVN0YXRlKGdldEN1cnJlbnRBcHBTdGF0ZSgpPy5hcHApLAogICAgICBwcmV2aW91c0F0dGVtcHRzOiBnZXRSZWNlbnRBdHRlbXB0cygpCiAgICB9OwogIH0KICBjb25zdCBtaXNzaW5nQ29tcG9uZW50cyA9IGdldE1pc3NpbmdDb21wb25lbnRzKCk7CiAgaWYgKG1pc3NpbmdDb21wb25lbnRzLmxlbmd0aCA+IDApIHsKICAgIGNvbnN0IHRhZ05hbWUgPSBtaXNzaW5nQ29tcG9uZW50c1swXTsKICAgIHJldHVybiB7CiAgICAgIGlzc3VlOiB7CiAgICAgICAgdHlwZTogIm1pc3NpbmdfY29tcG9uZW50IiwKICAgICAgICBkZXNjcmlwdGlvbjogYEN1c3RvbSBlbGVtZW50IDwke3RhZ05hbWV9PiB1c2VkIGJ1dCBub3QgZGVmaW5lZGAsCiAgICAgICAgc3VnZ2VzdGlvbjogYERlZmluZSBjb21wb25lbnQ6IGJvcmVET00uZGVmaW5lKCIke3RhZ05hbWV9IiwgIjx0ZW1wbGF0ZS1odG1sPiIsICh7IHN0YXRlIH0pID0+ICh7IHNsb3RzIH0pID0+IHsgLyogcmVuZGVyICovIH0pYAogICAgICB9LAogICAgICByZWxldmFudFN0YXRlOiBzYW5pdGl6ZVN0YXRlKGdldEN1cnJlbnRBcHBTdGF0ZSgpPy5hcHApLAogICAgICBwcmV2aW91c0F0dGVtcHRzOiBnZXRSZWNlbnRBdHRlbXB0cygpCiAgICB9OwogIH0KICByZXR1cm4gewogICAgaXNzdWU6IHsKICAgICAgdHlwZTogIm5vbmUiLAogICAgICBkZXNjcmlwdGlvbjogIk5vIGN1cnJlbnQgaXNzdWVzIGRldGVjdGVkIgogICAgfSwKICAgIHJlbGV2YW50U3RhdGU6IHNhbml0aXplU3RhdGUoZ2V0Q3VycmVudEFwcFN0YXRlKCk/LmFwcCkKICB9Owp9CmZ1bmN0aW9uIGNvcHkoKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHsKICAgIHJldHVybiAie30iOwogIH0KICBpZiAoIWlzRGVidWdFbmFibGVkKCJsbG0iKSkgewogICAgcmV0dXJuICJ7fSI7CiAgfQogIGNvbnN0IGN0eCA9IGZvY3VzKCk7CiAgY29uc3QganNvbiA9IEpTT04uc3RyaW5naWZ5KGN0eCwgbnVsbCwgMik7CiAgaWYgKHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiICYmIG5hdmlnYXRvci5jbGlwYm9hcmQpIHsKICAgIG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KGpzb24pLnRoZW4oKCkgPT4gewogICAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgIiVjXHV7MUY0Q0J9IGJvcmVET006IExMTSBjb250ZXh0IGNvcGllZCB0byBjbGlwYm9hcmQiLAogICAgICAgICAgImNvbG9yOiAjMjdhZTYwOyBmb250LXdlaWdodDogYm9sZCIKICAgICAgICApOwogICAgICB9CiAgICB9KS5jYXRjaCgoKSA9PiB7CiAgICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgICAgY29uc29sZS5sb2coCiAgICAgICAgICAiJWNcdXsxRjRDQn0gYm9yZURPTTogQ2xpcGJvYXJkIGFjY2VzcyBmYWlsZWQsIGNvbnRleHQgbG9nZ2VkIGJlbG93OiIsCiAgICAgICAgICAiY29sb3I6ICNmMzljMTI7IGZvbnQtd2VpZ2h0OiBib2xkIgogICAgICAgICk7CiAgICAgICAgY29uc29sZS5sb2coanNvbik7CiAgICAgIH0KICAgIH0pOwogIH0gZWxzZSBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgY29uc29sZS5sb2coCiAgICAgICIlY1x1ezFGNENCfSBib3JlRE9NOiBDbGlwYm9hcmQgdW5hdmFpbGFibGUsIGNvbnRleHQgbG9nZ2VkIGJlbG93OiIsCiAgICAgICJjb2xvcjogI2YzOWMxMjsgZm9udC13ZWlnaHQ6IGJvbGQiCiAgICApOwogICAgY29uc29sZS5sb2coanNvbik7CiAgfQogIHJldHVybiBqc29uOwp9CmZ1bmN0aW9uIHJlY29yZEF0dGVtcHQoY29kZSwgcmVzdWx0LCBlcnJvcikgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSByZXR1cm47CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgibGxtIikpIHJldHVybjsKICBhdHRlbXB0cy5wdXNoKHsKICAgIGNvZGUsCiAgICByZXN1bHQsCiAgICBlcnJvciwKICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKQogIH0pOwogIGlmIChhdHRlbXB0cy5sZW5ndGggPiAxMCkgewogICAgYXR0ZW1wdHMgPSBhdHRlbXB0cy5zbGljZSgtMTApOwogIH0KfQpmdW5jdGlvbiBnZXRSZWNlbnRBdHRlbXB0cygpIHsKICByZXR1cm4gWy4uLmF0dGVtcHRzXTsKfQpmdW5jdGlvbiBnZXRBdHRlbXB0cygpIHsKICByZXR1cm4gWy4uLmF0dGVtcHRzXTsKfQpmdW5jdGlvbiBjbGVhckF0dGVtcHRzKCkgewogIGF0dGVtcHRzID0gW107Cn0KZnVuY3Rpb24gZm9ybWF0RXJyb3JGb3JMTE0oY3R4KSB7CiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHsKICAgIHR5cGU6ICJlcnJvciIsCiAgICBjb21wb25lbnQ6IGN0eC5jb21wb25lbnQsCiAgICBlcnJvcjogY3R4LmVycm9yLm1lc3NhZ2UsCiAgICBzdGFjazogY3R4LnN0YWNrLAogICAgc3RhdGU6IHNhbml0aXplU3RhdGUoY3R4LnN0YXRlKSwKICAgIHJlZnM6IE9iamVjdC5rZXlzKGN0eC5yZWZzKSwKICAgIHNsb3RzOiBPYmplY3Qua2V5cyhjdHguc2xvdHMpLAogICAgc3VnZ2VzdGlvbjogZ2VuZXJhdGVTdWdnZXN0aW9uKGN0eCksCiAgICB0aW1lc3RhbXA6IGN0eC50aW1lc3RhbXAKICB9KTsKfQpmdW5jdGlvbiBsbG1Mb2codHlwZSwgZGF0YSkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSByZXR1cm47CiAgY29uc3QgY29uZmlnID0gZ2V0RGVidWdDb25maWcoKTsKICBpZiAoY29uZmlnLm91dHB1dEZvcm1hdCA9PT0gImxsbSIpIHsKICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHsgdHlwZSwgLi4uZGF0YSB9KSk7CiAgfQp9CmZ1bmN0aW9uIGlzTExNT3V0cHV0Rm9ybWF0KCkgewogIGNvbnN0IGNvbmZpZyA9IGdldERlYnVnQ29uZmlnKCk7CiAgcmV0dXJuIGNvbmZpZy5vdXRwdXRGb3JtYXQgPT09ICJsbG0iOwp9CnZhciBhdHRlbXB0cywgU0VOU0lUSVZFX0tFWVMsIENJUkNVTEFSX0NIRUNLLCBsbG1BUEk7CnZhciBpbml0X2xsbSA9IF9fZXNtKHsKICAic3JjL2xsbS50cyIoKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpbml0X2RlYnVnKCk7CiAgICBpbml0X2NvbnNvbGVfYXBpKCk7CiAgICBpbml0X2luc2lkZV9vdXQoKTsKICAgIGluaXRfdmVyc2lvbigpOwogICAgaW5pdF90eXBlX2luZmVyZW5jZSgpOwogICAgaW5pdF92YWxpZGF0aW9uKCk7CiAgICBhdHRlbXB0cyA9IFtdOwogICAgU0VOU0lUSVZFX0tFWVMgPSBbCiAgICAgICJwYXNzd29yZCIsCiAgICAgICJ0b2tlbiIsCiAgICAgICJzZWNyZXQiLAogICAgICAiYXBpS2V5IiwKICAgICAgImFwaV9rZXkiLAogICAgICAiYXV0aCIsCiAgICAgICJjcmVkZW50aWFsIiwKICAgICAgInByaXZhdGUiLAogICAgICAia2V5IiwKICAgICAgInBhc3MiCiAgICBdOwogICAgQ0lSQ1VMQVJfQ0hFQ0sgPSBTeW1ib2woIl9fbGxtX2NpcmN1bGFyX2NoZWNrX18iKTsKICAgIGxsbUFQSSA9IHsKICAgICAgLyoqIEdldCBjb21wbGV0ZSBzZXNzaW9uIGNvbnRleHQgKi8KICAgICAgY29udGV4dCwKICAgICAgLyoqIEdldCBmb2N1c2VkIGNvbnRleHQgZm9yIGN1cnJlbnQgaXNzdWUgKi8KICAgICAgZm9jdXMsCiAgICAgIC8qKiBDb3B5IGNvbnRleHQgdG8gY2xpcGJvYXJkICovCiAgICAgIGNvcHksCiAgICAgIC8qKiBHZXQgYWxsIHJlY29yZGVkIGF0dGVtcHRzICovCiAgICAgIGdldCBhdHRlbXB0cygpIHsKICAgICAgICByZXR1cm4gZ2V0QXR0ZW1wdHMoKTsKICAgICAgfSwKICAgICAgLyoqIENsZWFyIHJlY29yZGVkIGF0dGVtcHRzICovCiAgICAgIGNsZWFyQXR0ZW1wdHMsCiAgICAgIC8qKiBAaW50ZXJuYWwgUmVjb3JkIGFuIGF0dGVtcHQgKi8KICAgICAgX3JlY29yZEF0dGVtcHQ6IHJlY29yZEF0dGVtcHQsCiAgICAgIC8vIFR5cGUgaW5mZXJlbmNlIChQaGFzZSA1KQogICAgICAvKiogSW5mZXIgVHlwZVNjcmlwdCB0eXBlcyBmcm9tIHJ1bnRpbWUgdXNhZ2UgKi8KICAgICAgaW5mZXJUeXBlcywKICAgICAgLyoqIEdldCBpbmZlcnJlZCB0eXBlIGZvciBhIHNwZWNpZmljIHBhdGggKi8KICAgICAgdHlwZU9mLAogICAgICAvKiogQ2xlYXIgdHlwZSB0cmFja2luZyBkYXRhIChmb3IgdGVzdGluZykgKi8KICAgICAgX2NsZWFyVHlwZXM6IGNsZWFyVHlwZVRyYWNraW5nLAogICAgICAvLyBWYWxpZGF0aW9uICYgQXBwbHkgKFBoYXNlIDYpCiAgICAgIC8qKiBWYWxpZGF0ZSBjb2RlIHdpdGhvdXQgZXhlY3V0aW5nICovCiAgICAgIHZhbGlkYXRlLAogICAgICAvKiogRXhlY3V0ZSBjb2RlIHdpdGggYXV0b21hdGljIHJvbGxiYWNrIG9uIGVycm9yICovCiAgICAgIGFwcGx5LAogICAgICAvKiogQXBwbHkgbXVsdGlwbGUgY29kZSBibG9ja3MgYXRvbWljYWxseSAqLwogICAgICBhcHBseUJhdGNoCiAgICB9OwogIH0KfSk7CgovLyBzcmMvZGVidWcudHMKZnVuY3Rpb24gaXNEZWJ1Z0VuYWJsZWQoZmVhdHVyZSkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICBpZiAoZmVhdHVyZSA9PT0gImVycm9yQm91bmRhcnkiKSB7CiAgICAgIHJldHVybiBkZWJ1Z0NvbmZpZy5lcnJvckJvdW5kYXJ5ID8/IHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGNvbnN0IHZhbHVlID0gZGVidWdDb25maWdbZmVhdHVyZV07CiAgaWYgKGZlYXR1cmUgPT09ICJzdHJpY3QiKSB7CiAgICByZXR1cm4gdmFsdWUgPz8gZmFsc2U7CiAgfQogIHJldHVybiB2YWx1ZSA/PyB0cnVlOwp9CmZ1bmN0aW9uIHNldERlYnVnQ29uZmlnKGNvbmZpZykgewogIGlmICh0eXBlb2YgY29uZmlnID09PSAiYm9vbGVhbiIpIHsKICAgIGNvbnN0IGVuYWJsZWQgPSBjb25maWc7CiAgICBkZWJ1Z0NvbmZpZyA9IHsKICAgICAgY29uc29sZTogZW5hYmxlZCwKICAgICAgZ2xvYmFsczogZW5hYmxlZCwKICAgICAgZXJyb3JCb3VuZGFyeTogdHJ1ZSwKICAgICAgLy8gQWx3YXlzIGtlZXAgZXJyb3IgYm91bmRhcnkgZm9yIHNhZmV0eQogICAgICB2aXN1YWxJbmRpY2F0b3JzOiBlbmFibGVkLAogICAgICBlcnJvckhpc3Rvcnk6IGVuYWJsZWQsCiAgICAgIHZlcnNpb25Mb2c6IGVuYWJsZWQsCiAgICAgIGFwaTogZW5hYmxlZCwKICAgICAgbWV0aG9kTWlzc2luZzogZW5hYmxlZCwKICAgICAgdGVtcGxhdGVJbmZlcmVuY2U6IGVuYWJsZWQsCiAgICAgIHN0cmljdDogZmFsc2UsCiAgICAgIC8vIFN0cmljdCBtb2RlIG9ubHkgZW5hYmxlZCBleHBsaWNpdGx5CiAgICAgIG91dHB1dEZvcm1hdDogImh1bWFuIiwKICAgICAgLy8gQWx3YXlzIGh1bWFuIGZvcm1hdCBieSBkZWZhdWx0CiAgICAgIGxsbTogZW5hYmxlZAogICAgICAvLyBMTE0gQVBJIGZvbGxvd3MgZGVidWcgbW9kZQogICAgfTsKICB9IGVsc2UgewogICAgZGVidWdDb25maWcgPSB7IC4uLmRlYnVnQ29uZmlnLCAuLi5jb25maWcgfTsKICB9Cn0KZnVuY3Rpb24gZ2V0RGVidWdDb25maWcoKSB7CiAgcmV0dXJuIHsgLi4uZGVidWdDb25maWcgfTsKfQpmdW5jdGlvbiBleHBvc2VHbG9iYWxzKGN0eCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSByZXR1cm47CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgiZ2xvYmFscyIpKSByZXR1cm47CiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiKSByZXR1cm47CiAgY29uc3QgdyA9IHdpbmRvdzsKICB3LiRzdGF0ZSA9IGN0eC5zdGF0ZTsKICB3LiRyZWZzID0gY3R4LnJlZnM7CiAgdy4kc2xvdHMgPSBjdHguc2xvdHM7CiAgdy4kc2VsZiA9IGN0eC5lbGVtZW50OwogIHcuJGVycm9yID0gY3R4LmVycm9yOwogIHcuJGNvbXBvbmVudCA9IGN0eC5jb21wb25lbnQ7CiAgdy4kcmVyZW5kZXIgPSBjdHgucmVyZW5kZXI7Cn0KZnVuY3Rpb24gY2xlYXJHbG9iYWxzKCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSByZXR1cm47CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgiZ2xvYmFscyIpKSByZXR1cm47CiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiKSByZXR1cm47CiAgY29uc3QgdyA9IHdpbmRvdzsKICBkZWxldGUgdy4kc3RhdGU7CiAgZGVsZXRlIHcuJHJlZnM7CiAgZGVsZXRlIHcuJHNsb3RzOwogIGRlbGV0ZSB3LiRzZWxmOwogIGRlbGV0ZSB3LiRlcnJvcjsKICBkZWxldGUgdy4kY29tcG9uZW50OwogIGRlbGV0ZSB3LiRyZXJlbmRlcjsKfQpmdW5jdGlvbiBsb2dFcnJvcihjdHgpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgcmV0dXJuOwogIGlmIChkZWJ1Z0NvbmZpZy5vdXRwdXRGb3JtYXQgPT09ICJsbG0iKSB7CiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IChpbml0X2xsbSgpLCBsbG1fZXhwb3J0cykpLnRoZW4oKHsgZm9ybWF0RXJyb3JGb3JMTE06IGZvcm1hdEVycm9yRm9yTExNMiB9KSA9PiB7CiAgICAgIGNvbnNvbGUubG9nKGZvcm1hdEVycm9yRm9yTExNMihjdHgpKTsKICAgIH0pOwogICAgcmV0dXJuOwogIH0KICBjb25zb2xlLmxvZygKICAgICIlY1x1ezFGNTM0fSBib3JlRE9NOiBFcnJvciBpbiAlYzwlcz4lYyByZW5kZXIiLAogICAgImNvbG9yOiAjZmY2YjZiOyBmb250LXdlaWdodDogYm9sZCIsCiAgICAiY29sb3I6ICM0ZWNkYzQ7IGZvbnQtd2VpZ2h0OiBib2xkIiwKICAgIGN0eC5jb21wb25lbnQsCiAgICAiY29sb3I6ICNmZjZiNmIiCiAgKTsKICBjb25zb2xlLmVycm9yKGN0eC5lcnJvcik7CiAgaWYgKGlzRGVidWdFbmFibGVkKCJnbG9iYWxzIikpIHsKICAgIGNvbnNvbGUubG9nKCIlY1x1ezFGNENCfSBEZWJ1ZyBjb250ZXh0IGxvYWRlZDoiLCAiY29sb3I6ICM5NWE1YTY7IGZvbnQtd2VpZ2h0OiBib2xkIik7CiAgICBjb25zb2xlLmxvZygiICAgJHN0YXRlICAgICBcdTIxOTIiLCBjdHguc3RhdGUpOwogICAgY29uc29sZS5sb2coIiAgICRyZWZzICAgICAgXHUyMTkyIiwgY3R4LnJlZnMpOwogICAgY29uc29sZS5sb2coIiAgICRzbG90cyAgICAgXHUyMTkyIiwgY3R4LnNsb3RzKTsKICAgIGNvbnNvbGUubG9nKCIgICAkc2VsZiAgICAgIFx1MjE5MiIsIGN0eC5lbGVtZW50KTsKICAgIGNvbnNvbGUubG9nKCIlY1x1ezFGNEExfSBRdWljayBmaXhlczoiLCAiY29sb3I6ICNmMzljMTI7IGZvbnQtd2VpZ2h0OiBib2xkIik7CiAgICBjb25zb2xlLmxvZygiICAgJHN0YXRlLnByb3BlcnR5TmFtZSA9IHZhbHVlIik7CiAgICBjb25zb2xlLmxvZygiICAgJHJlcmVuZGVyKCkiKTsKICAgIGNvbnNvbGUubG9nKCIlY1x1ezFGNEU0fSBXaGVuIGZpeGVkOiIsICJjb2xvcjogIzI3YWU2MDsgZm9udC13ZWlnaHQ6IGJvbGQiKTsKICAgIGNvbnNvbGUubG9nKGAgICBib3JlRE9NLmV4cG9ydCgnJHtjdHguY29tcG9uZW50fScpYCk7CiAgfQp9CmZ1bmN0aW9uIGxvZ0Vycm9yTWluaW1hbChjb21wb25lbnQyLCBlcnJvcikgewogIGNvbnNvbGUuZXJyb3IoYFtib3JlRE9NXSBSZW5kZXIgZXJyb3IgaW4gPCR7Y29tcG9uZW50Mn0+OiAke2Vycm9yLm1lc3NhZ2V9YCk7Cn0KZnVuY3Rpb24gbG9nSW5pdEVycm9yKGNvbXBvbmVudDIsIGVycm9yKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHJldHVybjsKICBjb25zb2xlLmxvZygKICAgICIlY1x1ezFGNTM0fSBib3JlRE9NOiBFcnJvciBpbiAlYzwlcz4lYyBpbml0IiwKICAgICJjb2xvcjogI2ZmNmI2YjsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgImNvbG9yOiAjNGVjZGM0OyBmb250LXdlaWdodDogYm9sZCIsCiAgICBjb21wb25lbnQyLAogICAgImNvbG9yOiAjZmY2YjZiIgogICk7CiAgY29uc29sZS5lcnJvcihlcnJvcik7Cn0KZnVuY3Rpb24gc3RvcmVFcnJvcihjdHgpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImVycm9ySGlzdG9yeSIpKSByZXR1cm47CiAgZXJyb3JzLnNldChjdHguY29tcG9uZW50LCBjdHgpOwogIGxhc3RFcnJvciA9IGN0eDsKfQpmdW5jdGlvbiBjbGVhckVycm9yKGNvbXBvbmVudDIpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImVycm9ySGlzdG9yeSIpKSByZXR1cm47CiAgaWYgKGNvbXBvbmVudDIpIHsKICAgIGVycm9ycy5kZWxldGUoY29tcG9uZW50Mik7CiAgICBpZiAobGFzdEVycm9yPy5jb21wb25lbnQgPT09IGNvbXBvbmVudDIpIHsKICAgICAgbGFzdEVycm9yID0gbnVsbDsKICAgIH0KICB9IGVsc2UgaWYgKGxhc3RFcnJvcikgewogICAgZXJyb3JzLmRlbGV0ZShsYXN0RXJyb3IuY29tcG9uZW50KTsKICAgIGxhc3RFcnJvciA9IG51bGw7CiAgfQp9CmZ1bmN0aW9uIG1hcmtDb21wb25lbnRFcnJvcihlbGVtZW50KSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJ2aXN1YWxJbmRpY2F0b3JzIikpIHJldHVybjsKICBlbGVtZW50LnNldEF0dHJpYnV0ZSgiZGF0YS1ib3JlZG9tLWVycm9yIiwgInRydWUiKTsKfQpmdW5jdGlvbiBjbGVhckNvbXBvbmVudEVycm9yTWFyayhlbGVtZW50KSB7CiAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoImRhdGEtYm9yZWRvbS1lcnJvciIpOwp9CmZ1bmN0aW9uIGV4cG9ydFN0YXRlKHRhZ05hbWUpIHsKICBjb25zdCBjdHggPSB0YWdOYW1lID8gZXJyb3JzLmdldCh0YWdOYW1lKSA6IGxhc3RFcnJvcjsKICBpZiAoIWN0eCkgcmV0dXJuIG51bGw7CiAgdHJ5IHsKICAgIHJldHVybiB7CiAgICAgIGNvbXBvbmVudDogY3R4LmNvbXBvbmVudCwKICAgICAgc3RhdGU6IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlKSksCiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoY3R4LnRpbWVzdGFtcCkudG9JU09TdHJpbmcoKSwKICAgICAgZXJyb3I6IGN0eC5lcnJvci5tZXNzYWdlCiAgICB9OwogIH0gY2F0Y2ggKGUpIHsKICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgIGNvbnNvbGUud2FybigKICAgICAgICBgW2JvcmVET01dIGV4cG9ydFN0YXRlOiBVbmFibGUgdG8gc2VyaWFsaXplIHN0YXRlIGZvciA8JHtjdHguY29tcG9uZW50fT46YCwKICAgICAgICBlIGluc3RhbmNlb2YgRXJyb3IgPyBlLm1lc3NhZ2UgOiBlCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gewogICAgICBjb21wb25lbnQ6IGN0eC5jb21wb25lbnQsCiAgICAgIHN0YXRlOiAiW1VuYWJsZSB0byBzZXJpYWxpemUgLSBjb250YWlucyBjaXJjdWxhciByZWZlcmVuY2VzIG9yIGZ1bmN0aW9uc10iLAogICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKGN0eC50aW1lc3RhbXApLnRvSVNPU3RyaW5nKCksCiAgICAgIGVycm9yOiBjdHguZXJyb3IubWVzc2FnZQogICAgfTsKICB9Cn0KdmFyIGRlYnVnQ29uZmlnLCBlcnJvcnMsIGxhc3RFcnJvciwgZGVidWdBUEk7CnZhciBpbml0X2RlYnVnID0gX19lc20oewogICJzcmMvZGVidWcudHMiKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgZGVidWdDb25maWcgPSB7CiAgICAgIGNvbnNvbGU6IHRydWUsCiAgICAgIGdsb2JhbHM6IHRydWUsCiAgICAgIGVycm9yQm91bmRhcnk6IHRydWUsCiAgICAgIHZpc3VhbEluZGljYXRvcnM6IHRydWUsCiAgICAgIGVycm9ySGlzdG9yeTogdHJ1ZSwKICAgICAgdmVyc2lvbkxvZzogdHJ1ZSwKICAgICAgYXBpOiB0cnVlLAogICAgICBtZXRob2RNaXNzaW5nOiB0cnVlLAogICAgICB0ZW1wbGF0ZUluZmVyZW5jZTogdHJ1ZSwKICAgICAgc3RyaWN0OiBmYWxzZSwKICAgICAgb3V0cHV0Rm9ybWF0OiAiaHVtYW4iLAogICAgICBsbG06IHRydWUKICAgIH07CiAgICBlcnJvcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgbGFzdEVycm9yID0gbnVsbDsKICAgIGRlYnVnQVBJID0gewogICAgICAvKiogTWFwIG9mIGFsbCBjdXJyZW50IGVycm9ycyBieSBjb21wb25lbnQgbmFtZSAqLwogICAgICBnZXQgZXJyb3JzKCkgewogICAgICAgIHJldHVybiBlcnJvcnM7CiAgICAgIH0sCiAgICAgIC8qKiBNb3N0IHJlY2VudCBlcnJvciBjb250ZXh0ICovCiAgICAgIGdldCBsYXN0RXJyb3IoKSB7CiAgICAgICAgcmV0dXJuIGxhc3RFcnJvcjsKICAgICAgfSwKICAgICAgLyoqIFJlLXJlbmRlciBhIHNwZWNpZmljIGNvbXBvbmVudCBvciB0aGUgbGFzdCBlcnJvcmVkIG9uZSAqLwogICAgICByZXJlbmRlcih0YWdOYW1lKSB7CiAgICAgICAgY29uc3QgY3R4ID0gdGFnTmFtZSA/IGVycm9ycy5nZXQodGFnTmFtZSkgOiBsYXN0RXJyb3I7CiAgICAgICAgaWYgKGN0eCkgewogICAgICAgICAgY3R4LnJlcmVuZGVyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnNvbGUud2FybigiW2JvcmVET01dIE5vIGVycm9yIGNvbnRleHQgZm91bmQgdG8gcmVyZW5kZXIiKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIC8qKiBDbGVhciBlcnJvciBzdGF0ZSBmb3IgYSBjb21wb25lbnQgKi8KICAgICAgY2xlYXJFcnJvcih0YWdOYW1lKSB7CiAgICAgICAgY29uc3QgY3R4ID0gdGFnTmFtZSA/IGVycm9ycy5nZXQodGFnTmFtZSkgOiBsYXN0RXJyb3I7CiAgICAgICAgaWYgKGN0eCkgewogICAgICAgICAgY2xlYXJDb21wb25lbnRFcnJvck1hcmsoY3R4LmVsZW1lbnQpOwogICAgICAgICAgY2xlYXJFcnJvcih0YWdOYW1lKTsKICAgICAgICAgIGNsZWFyR2xvYmFscygpOwogICAgICAgIH0gZWxzZSBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICAgICAgY29uc29sZS53YXJuKAogICAgICAgICAgICB0YWdOYW1lID8gYFtib3JlRE9NXSBjbGVhckVycm9yOiBObyBlcnJvciBmb3VuZCBmb3IgPCR7dGFnTmFtZX0+YCA6ICJbYm9yZURPTV0gY2xlYXJFcnJvcjogTm8gZXJyb3IgdG8gY2xlYXIiCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfSwKICAgICAgLyoqIEV4cG9ydCBzdGF0ZSBzbmFwc2hvdCAqLwogICAgICBleHBvcnQ6IGV4cG9ydFN0YXRlLAogICAgICAvKiogQ3VycmVudCBkZWJ1ZyBjb25maWd1cmF0aW9uIChyZWFkLW9ubHkpICovCiAgICAgIGdldCBjb25maWcoKSB7CiAgICAgICAgcmV0dXJuIGdldERlYnVnQ29uZmlnKCk7CiAgICAgIH0KICAgIH07CiAgfQp9KTsKCi8vIHNyYy90eXBlLWluZmVyZW5jZS50cwpmdW5jdGlvbiBpbmZlclR5cGVGcm9tVmFsdWUodmFsdWUsIHNlZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKSkgewogIGlmICh2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIHsga2luZDogInByaW1pdGl2ZSIsIHZhbHVlOiAibnVsbCIgfTsKICBpZiAodmFsdWUgPT09IHZvaWQgMCkgcmV0dXJuIHsga2luZDogInByaW1pdGl2ZSIsIHZhbHVlOiAidW5kZWZpbmVkIiB9OwogIGNvbnN0IHR5cGUgPSB0eXBlb2YgdmFsdWU7CiAgaWYgKHR5cGUgPT09ICJzdHJpbmciKSByZXR1cm4geyBraW5kOiAicHJpbWl0aXZlIiwgdmFsdWU6ICJzdHJpbmciIH07CiAgaWYgKHR5cGUgPT09ICJudW1iZXIiKSByZXR1cm4geyBraW5kOiAicHJpbWl0aXZlIiwgdmFsdWU6ICJudW1iZXIiIH07CiAgaWYgKHR5cGUgPT09ICJib29sZWFuIikgcmV0dXJuIHsga2luZDogInByaW1pdGl2ZSIsIHZhbHVlOiAiYm9vbGVhbiIgfTsKICBpZiAodHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIHsga2luZDogImZ1bmN0aW9uIiwgcGFyYW1zOiBbXSwgcmV0dXJuVHlwZTogeyBraW5kOiAidW5rbm93biIgfSB9OwogIH0KICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlKSByZXR1cm4geyBraW5kOiAiZGF0ZSIgfTsKICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHsga2luZDogImFycmF5IiwgZWxlbWVudFR5cGU6IHsga2luZDogInVua25vd24iIH0gfTsKICAgIH0KICAgIGNvbnN0IHNhbXBsZVNpemUgPSBNYXRoLm1pbig1LCB2YWx1ZS5sZW5ndGgpOwogICAgY29uc3QgZWxlbWVudFR5cGVzID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNhbXBsZVNpemU7IGkrKykgewogICAgICBlbGVtZW50VHlwZXMucHVzaChpbmZlclR5cGVGcm9tVmFsdWUodmFsdWVbaV0sIHNlZW4pKTsKICAgIH0KICAgIHJldHVybiB7IGtpbmQ6ICJhcnJheSIsIGVsZW1lbnRUeXBlOiBtZXJnZVR5cGVzKGVsZW1lbnRUeXBlcykgfTsKICB9CiAgaWYgKHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICBpZiAoc2Vlbi5oYXModmFsdWUpKSB7CiAgICAgIHJldHVybiB7IGtpbmQ6ICJ1bmtub3duIiB9OwogICAgfQogICAgc2Vlbi5hZGQodmFsdWUpOwogICAgY29uc3QgcHJvcGVydGllcyA9IHt9OwogICAgZm9yIChjb25zdCBba2V5LCB2YWxdIG9mIE9iamVjdC5lbnRyaWVzKHZhbHVlKSkgewogICAgICBpZiAodHlwZW9mIGtleSA9PT0gInN5bWJvbCIpIGNvbnRpbnVlOwogICAgICBwcm9wZXJ0aWVzW2tleV0gPSBpbmZlclR5cGVGcm9tVmFsdWUodmFsLCBzZWVuKTsKICAgIH0KICAgIHJldHVybiB7IGtpbmQ6ICJvYmplY3QiLCBwcm9wZXJ0aWVzIH07CiAgfQogIHJldHVybiB7IGtpbmQ6ICJ1bmtub3duIiB9Owp9CmZ1bmN0aW9uIG1lcmdlVHlwZXModHlwZXMpIHsKICBjb25zdCBrbm93biA9IHR5cGVzLmZpbHRlcigodCkgPT4gdC5raW5kICE9PSAidW5rbm93biIpOwogIGlmIChrbm93bi5sZW5ndGggPT09IDApIHJldHVybiB7IGtpbmQ6ICJ1bmtub3duIiB9OwogIGlmIChrbm93bi5sZW5ndGggPT09IDEpIHJldHVybiBrbm93blswXTsKICBpZiAoa25vd24uZXZlcnkoKHQpID0+IHQua2luZCA9PT0gInByaW1pdGl2ZSIpKSB7CiAgICBjb25zdCBwcmltaXRpdmVzID0ga25vd247CiAgICBjb25zdCB1bmlxdWUgPSBbLi4ubmV3IFNldChwcmltaXRpdmVzLm1hcCgocCkgPT4gcC52YWx1ZSkpXTsKICAgIGlmICh1bmlxdWUubGVuZ3RoID09PSAxKSByZXR1cm4ga25vd25bMF07CiAgICByZXR1cm4gewogICAgICBraW5kOiAidW5pb24iLAogICAgICB0eXBlczogdW5pcXVlLm1hcCgodikgPT4gKHsga2luZDogInByaW1pdGl2ZSIsIHZhbHVlOiB2IH0pKQogICAgfTsKICB9CiAgaWYgKGtub3duLmV2ZXJ5KCh0KSA9PiB0LmtpbmQgPT09ICJvYmplY3QiKSkgewogICAgY29uc3Qgb2JqZWN0cyA9IGtub3duOwogICAgY29uc3QgbWVyZ2VkUHJvcHMgPSB7fTsKICAgIGZvciAoY29uc3Qgb2JqIG9mIG9iamVjdHMpIHsKICAgICAgZm9yIChjb25zdCBba2V5LCB0eXBlXSBvZiBPYmplY3QuZW50cmllcyhvYmoucHJvcGVydGllcykpIHsKICAgICAgICBpZiAobWVyZ2VkUHJvcHNba2V5XSkgewogICAgICAgICAgbWVyZ2VkUHJvcHNba2V5XSA9IG1lcmdlVHlwZXMoW21lcmdlZFByb3BzW2tleV0sIHR5cGVdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWVyZ2VkUHJvcHNba2V5XSA9IHR5cGU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4geyBraW5kOiAib2JqZWN0IiwgcHJvcGVydGllczogbWVyZ2VkUHJvcHMgfTsKICB9CiAgaWYgKGtub3duLmV2ZXJ5KCh0KSA9PiB0LmtpbmQgPT09ICJhcnJheSIpKSB7CiAgICBjb25zdCBhcnJheXMgPSBrbm93bjsKICAgIGNvbnN0IGVsZW1lbnRUeXBlcyA9IGFycmF5cy5tYXAoKGEpID0+IGEuZWxlbWVudFR5cGUpOwogICAgcmV0dXJuIHsga2luZDogImFycmF5IiwgZWxlbWVudFR5cGU6IG1lcmdlVHlwZXMoZWxlbWVudFR5cGVzKSB9OwogIH0KICBjb25zdCBkZWR1cGVkID0gZGVkdXBsaWNhdGVUeXBlcyhrbm93bik7CiAgaWYgKGRlZHVwZWQubGVuZ3RoID09PSAxKSByZXR1cm4gZGVkdXBlZFswXTsKICByZXR1cm4geyBraW5kOiAidW5pb24iLCB0eXBlczogZGVkdXBlZCB9Owp9CmZ1bmN0aW9uIGRlZHVwbGljYXRlVHlwZXModHlwZXMpIHsKICBjb25zdCBzZWVuID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICBjb25zdCByZXN1bHQgPSBbXTsKICBmb3IgKGNvbnN0IHR5cGUgb2YgdHlwZXMpIHsKICAgIGNvbnN0IGtleSA9IHR5cGVOb2RlVG9LZXkodHlwZSk7CiAgICBpZiAoIXNlZW4uaGFzKGtleSkpIHsKICAgICAgc2Vlbi5hZGQoa2V5KTsKICAgICAgcmVzdWx0LnB1c2godHlwZSk7CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gdHlwZU5vZGVUb0tleShub2RlKSB7CiAgc3dpdGNoIChub2RlLmtpbmQpIHsKICAgIGNhc2UgInByaW1pdGl2ZSI6CiAgICAgIHJldHVybiBgcDoke25vZGUudmFsdWV9YDsKICAgIGNhc2UgImxpdGVyYWwiOgogICAgICByZXR1cm4gYGw6JHt0eXBlb2Ygbm9kZS52YWx1ZX06JHtub2RlLnZhbHVlfWA7CiAgICBjYXNlICJhcnJheSI6CiAgICAgIHJldHVybiBgYToke3R5cGVOb2RlVG9LZXkobm9kZS5lbGVtZW50VHlwZSl9YDsKICAgIGNhc2UgIm9iamVjdCI6CiAgICAgIGNvbnN0IHByb3BzID0gT2JqZWN0LmVudHJpZXMobm9kZS5wcm9wZXJ0aWVzKS5zb3J0KChbYV0sIFtiXSkgPT4gYS5sb2NhbGVDb21wYXJlKGIpKS5tYXAoKFtrLCB2XSkgPT4gYCR7a306JHt0eXBlTm9kZVRvS2V5KHYpfWApLmpvaW4oIiwiKTsKICAgICAgcmV0dXJuIGBvOnske3Byb3BzfX1gOwogICAgY2FzZSAidW5pb24iOgogICAgICByZXR1cm4gYHU6WyR7bm9kZS50eXBlcy5tYXAodHlwZU5vZGVUb0tleSkuc29ydCgpLmpvaW4oInwiKX1dYDsKICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgY29uc3QgcGFyYW1zID0gbm9kZS5wYXJhbXMubWFwKChwKSA9PiBgJHtwLm5hbWV9OiR7dHlwZU5vZGVUb0tleShwLnR5cGUpfWApLmpvaW4oIiwiKTsKICAgICAgcmV0dXJuIGBmOigke3BhcmFtc30pPT4ke3R5cGVOb2RlVG9LZXkobm9kZS5yZXR1cm5UeXBlKX1gOwogICAgY2FzZSAiZGF0ZSI6CiAgICAgIHJldHVybiAiZGF0ZSI7CiAgICBjYXNlICJ1bmtub3duIjoKICAgICAgcmV0dXJuICJ1bmtub3duIjsKICB9Cn0KZnVuY3Rpb24gbWVyZ2VQYXJhbVR5cGVzKGEsIGIpIHsKICBjb25zdCBtYXhMZW4gPSBNYXRoLm1heChhLmxlbmd0aCwgYi5sZW5ndGgpOwogIGNvbnN0IHJlc3VsdCA9IFtdOwogIGZvciAobGV0IGkgPSAwOyBpIDwgbWF4TGVuOyBpKyspIHsKICAgIGNvbnN0IHBhcmFtQSA9IGFbaV07CiAgICBjb25zdCBwYXJhbUIgPSBiW2ldOwogICAgaWYgKHBhcmFtQSAmJiBwYXJhbUIpIHsKICAgICAgcmVzdWx0LnB1c2goewogICAgICAgIG5hbWU6IHBhcmFtQS5uYW1lLAogICAgICAgIHR5cGU6IG1lcmdlVHlwZXMoW3BhcmFtQS50eXBlLCBwYXJhbUIudHlwZV0pLAogICAgICAgIG9wdGlvbmFsOiBwYXJhbUEub3B0aW9uYWwgfHwgcGFyYW1CLm9wdGlvbmFsCiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChwYXJhbUEpIHsKICAgICAgcmVzdWx0LnB1c2goeyAuLi5wYXJhbUEsIG9wdGlvbmFsOiB0cnVlIH0pOwogICAgfSBlbHNlIGlmIChwYXJhbUIpIHsKICAgICAgcmVzdWx0LnB1c2goeyAuLi5wYXJhbUIsIG9wdGlvbmFsOiB0cnVlIH0pOwogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIHRyYWNrU3RhdGVBY2Nlc3MocGF0aCwgdmFsdWUpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImxsbSIpKSByZXR1cm47CiAgY29uc3QgZXhpc3RpbmcgPSBzdGF0ZUFjY2Vzc2VzLmdldChwYXRoKTsKICBjb25zdCBpbmZlcnJlZFR5cGUgPSBpbmZlclR5cGVGcm9tVmFsdWUodmFsdWUpOwogIGlmIChleGlzdGluZykgewogICAgY29uc3QgbWVyZ2VkID0gbWVyZ2VUeXBlcyhbZXhpc3RpbmcudHlwZSwgaW5mZXJyZWRUeXBlXSk7CiAgICBzdGF0ZUFjY2Vzc2VzLnNldChwYXRoLCB7CiAgICAgIHBhdGgsCiAgICAgIHR5cGU6IG1lcmdlZCwKICAgICAgYWNjZXNzQ291bnQ6IGV4aXN0aW5nLmFjY2Vzc0NvdW50ICsgMQogICAgfSk7CiAgfSBlbHNlIHsKICAgIHN0YXRlQWNjZXNzZXMuc2V0KHBhdGgsIHsKICAgICAgcGF0aCwKICAgICAgdHlwZTogaW5mZXJyZWRUeXBlLAogICAgICBhY2Nlc3NDb3VudDogMQogICAgfSk7CiAgfQp9CmZ1bmN0aW9uIHRyYWNrRnVuY3Rpb25DYWxsKG5hbWUsIGFyZ3MsIHJldHVyblZhbHVlKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJsbG0iKSkgcmV0dXJuOwogIGNvbnN0IGV4aXN0aW5nID0gZnVuY3Rpb25DYWxscy5nZXQobmFtZSk7CiAgY29uc3QgYXJnVHlwZXMgPSBhcmdzLm1hcCgoYXJnLCBpKSA9PiAoewogICAgbmFtZTogaW5mZXJBcmdOYW1lKGFyZywgaSksCiAgICB0eXBlOiBpbmZlclR5cGVGcm9tVmFsdWUoYXJnKSwKICAgIG9wdGlvbmFsOiBmYWxzZQogIH0pKTsKICBjb25zdCByZXR1cm5UeXBlID0gaW5mZXJUeXBlRnJvbVZhbHVlKHJldHVyblZhbHVlKTsKICBpZiAoZXhpc3RpbmcpIHsKICAgIGNvbnN0IG1lcmdlZFBhcmFtcyA9IG1lcmdlUGFyYW1UeXBlcyhleGlzdGluZy5wYXJhbXMsIGFyZ1R5cGVzKTsKICAgIGNvbnN0IG1lcmdlZFJldHVybiA9IG1lcmdlVHlwZXMoW2V4aXN0aW5nLnJldHVyblR5cGUsIHJldHVyblR5cGVdKTsKICAgIGZ1bmN0aW9uQ2FsbHMuc2V0KG5hbWUsIHsKICAgICAgcGFyYW1zOiBtZXJnZWRQYXJhbXMsCiAgICAgIHJldHVyblR5cGU6IG1lcmdlZFJldHVybiwKICAgICAgY2FsbENvdW50OiBleGlzdGluZy5jYWxsQ291bnQgKyAxCiAgICB9KTsKICB9IGVsc2UgewogICAgZnVuY3Rpb25DYWxscy5zZXQobmFtZSwgewogICAgICBwYXJhbXM6IGFyZ1R5cGVzLAogICAgICByZXR1cm5UeXBlLAogICAgICBjYWxsQ291bnQ6IDEKICAgIH0pOwogIH0KfQpmdW5jdGlvbiBpbmZlckFyZ05hbWUodmFsdWUsIGluZGV4KSB7CiAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB2b2lkIDApIHJldHVybiBgYXJnJHtpbmRleH1gOwogIGNvbnN0IHR5cGUgPSB0eXBlb2YgdmFsdWU7CiAgaWYgKHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICBpZiAodmFsdWUuaW5jbHVkZXMoIkAiKSkgcmV0dXJuICJlbWFpbCI7CiAgICBpZiAodmFsdWUubWF0Y2goL15cZHs0fS1cZHsyfS1cZHsyfS8pKSByZXR1cm4gImRhdGUiOwogICAgaWYgKHZhbHVlLmxlbmd0aCA+IDEwMCkgcmV0dXJuICJ0ZXh0IjsKICAgIHJldHVybiAic3RyIjsKICB9CiAgaWYgKHR5cGUgPT09ICJudW1iZXIiKSB7CiAgICBpZiAoTnVtYmVyLmlzSW50ZWdlcih2YWx1ZSkpIHsKICAgICAgaWYgKHZhbHVlID4gMWUxMikgcmV0dXJuICJ0aW1lc3RhbXAiOwogICAgICByZXR1cm4gImNvdW50IjsKICAgIH0KICAgIHJldHVybiAidmFsdWUiOwogIH0KICBpZiAodHlwZSA9PT0gImJvb2xlYW4iKSByZXR1cm4gImZsYWciOwogIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgcmV0dXJuICJpdGVtcyI7CiAgaWYgKHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlKSByZXR1cm4gImRhdGUiOwogICAgcmV0dXJuICJkYXRhIjsKICB9CiAgcmV0dXJuIGBhcmcke2luZGV4fWA7Cn0KZnVuY3Rpb24gdHlwZU5vZGVUb1N0cmluZyhub2RlLCBpbmRlbnQgPSAwKSB7CiAgY29uc3QgcGFkID0gIiAgIi5yZXBlYXQoaW5kZW50KTsKICBzd2l0Y2ggKG5vZGUua2luZCkgewogICAgY2FzZSAicHJpbWl0aXZlIjoKICAgICAgcmV0dXJuIG5vZGUudmFsdWU7CiAgICBjYXNlICJsaXRlcmFsIjoKICAgICAgcmV0dXJuIHR5cGVvZiBub2RlLnZhbHVlID09PSAic3RyaW5nIiA/IGAiJHtub2RlLnZhbHVlLnJlcGxhY2UoL1xcL2csICJcXFxcIikucmVwbGFjZSgvIi9nLCAnXFwiJyl9ImAgOiBTdHJpbmcobm9kZS52YWx1ZSk7CiAgICBjYXNlICJhcnJheSI6CiAgICAgIGNvbnN0IGVsZW1TdHIgPSB0eXBlTm9kZVRvU3RyaW5nKG5vZGUuZWxlbWVudFR5cGUsIGluZGVudCk7CiAgICAgIGlmIChub2RlLmVsZW1lbnRUeXBlLmtpbmQgPT09ICJwcmltaXRpdmUiIHx8IG5vZGUuZWxlbWVudFR5cGUua2luZCA9PT0gInVua25vd24iKSB7CiAgICAgICAgcmV0dXJuIGAke2VsZW1TdHJ9W11gOwogICAgICB9CiAgICAgIHJldHVybiBgQXJyYXk8JHtlbGVtU3RyfT5gOwogICAgY2FzZSAib2JqZWN0IjogewogICAgICBjb25zdCBlbnRyaWVzID0gT2JqZWN0LmVudHJpZXMobm9kZS5wcm9wZXJ0aWVzKTsKICAgICAgaWYgKGVudHJpZXMubGVuZ3RoID09PSAwKSByZXR1cm4gInt9IjsKICAgICAgY29uc3QgcHJvcHMgPSBlbnRyaWVzLm1hcCgoW2ssIHZdKSA9PiBgJHtwYWR9ICAke2t9OiAke3R5cGVOb2RlVG9TdHJpbmcodiwgaW5kZW50ICsgMSl9O2ApLmpvaW4oIlxuIik7CiAgICAgIHJldHVybiBgewoke3Byb3BzfQoke3BhZH19YDsKICAgIH0KICAgIGNhc2UgInVuaW9uIjoKICAgICAgY29uc3QgdHlwZXMgPSBub2RlLnR5cGVzLm1hcCgodCkgPT4gdHlwZU5vZGVUb1N0cmluZyh0LCBpbmRlbnQpKTsKICAgICAgcmV0dXJuIHR5cGVzLmpvaW4oIiB8ICIpOwogICAgY2FzZSAiZnVuY3Rpb24iOiB7CiAgICAgIGNvbnN0IHBhcmFtcyA9IG5vZGUucGFyYW1zLm1hcCgocCkgPT4gYCR7cC5uYW1lfSR7cC5vcHRpb25hbCA/ICI/IiA6ICIifTogJHt0eXBlTm9kZVRvU3RyaW5nKHAudHlwZSl9YCkuam9pbigiLCAiKTsKICAgICAgcmV0dXJuIGAoJHtwYXJhbXN9KSA9PiAke3R5cGVOb2RlVG9TdHJpbmcobm9kZS5yZXR1cm5UeXBlKX1gOwogICAgfQogICAgY2FzZSAiZGF0ZSI6CiAgICAgIHJldHVybiAiRGF0ZSI7CiAgICBjYXNlICJ1bmtub3duIjoKICAgICAgcmV0dXJuICJ1bmtub3duIjsKICB9Cn0KZnVuY3Rpb24gYnVpbGRTdGF0ZVR5cGVOb2RlKCkgewogIGNvbnN0IHJvb3QgPSB7fTsKICBmb3IgKGNvbnN0IFtwYXRoLCBhY2Nlc3MyXSBvZiBzdGF0ZUFjY2Vzc2VzKSB7CiAgICBzZXROZXN0ZWRUeXBlKHJvb3QsIHBhdGgsIGFjY2VzczIudHlwZSk7CiAgfQogIHJldHVybiBidWlsZFR5cGVGcm9tTmVzdGVkKHJvb3QpOwp9CmZ1bmN0aW9uIHNldE5lc3RlZFR5cGUob2JqLCBwYXRoLCB0eXBlKSB7CiAgY29uc3QgcGFydHMgPSBwYXRoLnNwbGl0KCIuIik7CiAgbGV0IGN1cnJlbnQgPSBvYmo7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGggLSAxOyBpKyspIHsKICAgIGNvbnN0IHBhcnQgPSBwYXJ0c1tpXTsKICAgIGNvbnN0IGFycmF5TWF0Y2gyID0gcGFydC5tYXRjaCgvXiguKylcWyhcZCspXF0kLyk7CiAgICBpZiAoYXJyYXlNYXRjaDIpIHsKICAgICAgY29uc3QgWywgbmFtZV0gPSBhcnJheU1hdGNoMjsKICAgICAgaWYgKCFjdXJyZW50W25hbWVdKSBjdXJyZW50W25hbWVdID0geyBfX2lzQXJyYXk6IHRydWUsIF9fZWxlbWVudFR5cGU6IHt9IH07CiAgICAgIGN1cnJlbnQgPSBjdXJyZW50W25hbWVdLl9fZWxlbWVudFR5cGU7CiAgICB9IGVsc2UgewogICAgICBpZiAoIWN1cnJlbnRbcGFydF0pIGN1cnJlbnRbcGFydF0gPSB7fTsKICAgICAgY3VycmVudCA9IGN1cnJlbnRbcGFydF07CiAgICB9CiAgfQogIGNvbnN0IGxhc3RQYXJ0ID0gcGFydHNbcGFydHMubGVuZ3RoIC0gMV07CiAgY29uc3QgYXJyYXlNYXRjaCA9IGxhc3RQYXJ0Lm1hdGNoKC9eKC4rKVxbKFxkKylcXSQvKTsKICBpZiAoYXJyYXlNYXRjaCkgewogICAgY29uc3QgWywgbmFtZV0gPSBhcnJheU1hdGNoOwogICAgaWYgKCFjdXJyZW50W25hbWVdKSBjdXJyZW50W25hbWVdID0geyBfX2lzQXJyYXk6IHRydWUsIF9fZWxlbWVudFR5cGU6IHt9IH07CiAgICBjb25zdCBleGlzdGluZyA9IGN1cnJlbnRbbmFtZV0uX19lbGVtZW50VHlwZS5fX3R5cGU7CiAgICBpZiAoZXhpc3RpbmcpIHsKICAgICAgY3VycmVudFtuYW1lXS5fX2VsZW1lbnRUeXBlLl9fdHlwZSA9IG1lcmdlVHlwZXMoW2V4aXN0aW5nLCB0eXBlXSk7CiAgICB9IGVsc2UgewogICAgICBjdXJyZW50W25hbWVdLl9fZWxlbWVudFR5cGUuX190eXBlID0gdHlwZTsKICAgIH0KICB9IGVsc2UgewogICAgY29uc3QgZXhpc3RpbmcgPSBjdXJyZW50W2xhc3RQYXJ0XT8uX190eXBlOwogICAgaWYgKGV4aXN0aW5nKSB7CiAgICAgIGN1cnJlbnRbbGFzdFBhcnRdID0geyBfX3R5cGU6IG1lcmdlVHlwZXMoW2V4aXN0aW5nLCB0eXBlXSkgfTsKICAgIH0gZWxzZSB7CiAgICAgIGN1cnJlbnRbbGFzdFBhcnRdID0geyBfX3R5cGU6IHR5cGUgfTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gYnVpbGRUeXBlRnJvbU5lc3RlZChvYmopIHsKICBpZiAob2JqLl9fdHlwZSkgcmV0dXJuIG9iai5fX3R5cGU7CiAgaWYgKG9iai5fX2lzQXJyYXkpIHsKICAgIHJldHVybiB7CiAgICAgIGtpbmQ6ICJhcnJheSIsCiAgICAgIGVsZW1lbnRUeXBlOiBidWlsZFR5cGVGcm9tTmVzdGVkKG9iai5fX2VsZW1lbnRUeXBlKQogICAgfTsKICB9CiAgY29uc3QgcHJvcGVydGllcyA9IHt9OwogIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG9iaikpIHsKICAgIGlmIChrZXkuc3RhcnRzV2l0aCgiX18iKSkgY29udGludWU7CiAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IikgewogICAgICBwcm9wZXJ0aWVzW2tleV0gPSBidWlsZFR5cGVGcm9tTmVzdGVkKHZhbHVlKTsKICAgIH0KICB9CiAgaWYgKE9iamVjdC5rZXlzKHByb3BlcnRpZXMpLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHsga2luZDogInVua25vd24iIH07CiAgfQogIHJldHVybiB7IGtpbmQ6ICJvYmplY3QiLCBwcm9wZXJ0aWVzIH07Cn0KZnVuY3Rpb24gYnVpbGRTdGF0ZUludGVyZmFjZSgpIHsKICBjb25zdCBzdGF0ZVR5cGUgPSBidWlsZFN0YXRlVHlwZU5vZGUoKTsKICBpZiAoc3RhdGVUeXBlLmtpbmQgPT09ICJ1bmtub3duIikgewogICAgcmV0dXJuICJpbnRlcmZhY2UgU3RhdGUge30iOwogIH0KICByZXR1cm4gYGludGVyZmFjZSBTdGF0ZSAke3R5cGVOb2RlVG9TdHJpbmcoc3RhdGVUeXBlKX1gOwp9CmZ1bmN0aW9uIGdldEVtcHR5VHlwZURlZmluaXRpb25zKCkgewogIHJldHVybiB7CiAgICBzdGF0ZTogImludGVyZmFjZSBTdGF0ZSB7fSIsCiAgICBoZWxwZXJzOiB7fSwKICAgIGNvbXBvbmVudHM6IHt9LAogICAgZXZlbnRzOiB7fSwKICAgIHJhdzogewogICAgICBzdGF0ZTogeyBraW5kOiAib2JqZWN0IiwgcHJvcGVydGllczoge30gfSwKICAgICAgaGVscGVyczoge30sCiAgICAgIGNvbXBvbmVudHM6IHt9LAogICAgICBldmVudHM6IHt9CiAgICB9CiAgfTsKfQpmdW5jdGlvbiBpbmZlclR5cGVzKCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICByZXR1cm4gZ2V0RW1wdHlUeXBlRGVmaW5pdGlvbnMoKTsKICB9CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgibGxtIikpIHsKICAgIHJldHVybiBnZXRFbXB0eVR5cGVEZWZpbml0aW9ucygpOwogIH0KICBjb25zdCBoZWxwZXJzID0ge307CiAgZm9yIChjb25zdCBbbmFtZSwgZm5dIG9mIGZ1bmN0aW9uQ2FsbHMpIHsKICAgIGhlbHBlcnNbbmFtZV0gPSB0eXBlTm9kZVRvU3RyaW5nKHsKICAgICAga2luZDogImZ1bmN0aW9uIiwKICAgICAgcGFyYW1zOiBmbi5wYXJhbXMsCiAgICAgIHJldHVyblR5cGU6IGZuLnJldHVyblR5cGUKICAgIH0pOwogIH0KICBjb25zdCBjb21wb25lbnRzID0ge307CiAgZm9yIChjb25zdCBbdGFnLCBwcm9wc10gb2YgY29tcG9uZW50UHJvcHMpIHsKICAgIGNvbXBvbmVudHNbdGFnXSA9IHR5cGVOb2RlVG9TdHJpbmcoeyBraW5kOiAib2JqZWN0IiwgcHJvcGVydGllczogcHJvcHMgfSk7CiAgfQogIGNvbnN0IGV2ZW50cyA9IHt9OwogIGZvciAoY29uc3QgW25hbWUsIHBheWxvYWRdIG9mIGV2ZW50UGF5bG9hZHMpIHsKICAgIGV2ZW50c1tuYW1lXSA9IHR5cGVOb2RlVG9TdHJpbmcocGF5bG9hZCk7CiAgfQogIGNvbnN0IHJhd0hlbHBlcnMgPSB7fTsKICBmb3IgKGNvbnN0IFtuYW1lLCBmbl0gb2YgZnVuY3Rpb25DYWxscykgewogICAgcmF3SGVscGVyc1tuYW1lXSA9IGZuOwogIH0KICBjb25zdCByYXdDb21wb25lbnRzID0ge307CiAgZm9yIChjb25zdCBbdGFnLCBwcm9wc10gb2YgY29tcG9uZW50UHJvcHMpIHsKICAgIHJhd0NvbXBvbmVudHNbdGFnXSA9IHsga2luZDogIm9iamVjdCIsIHByb3BlcnRpZXM6IHByb3BzIH07CiAgfQogIGNvbnN0IHJhd0V2ZW50cyA9IHt9OwogIGZvciAoY29uc3QgW25hbWUsIHBheWxvYWRdIG9mIGV2ZW50UGF5bG9hZHMpIHsKICAgIHJhd0V2ZW50c1tuYW1lXSA9IHBheWxvYWQ7CiAgfQogIHJldHVybiB7CiAgICBzdGF0ZTogYnVpbGRTdGF0ZUludGVyZmFjZSgpLAogICAgaGVscGVycywKICAgIGNvbXBvbmVudHMsCiAgICBldmVudHMsCiAgICByYXc6IHsKICAgICAgc3RhdGU6IGJ1aWxkU3RhdGVUeXBlTm9kZSgpLAogICAgICBoZWxwZXJzOiByYXdIZWxwZXJzLAogICAgICBjb21wb25lbnRzOiByYXdDb21wb25lbnRzLAogICAgICBldmVudHM6IHJhd0V2ZW50cwogICAgfQogIH07Cn0KZnVuY3Rpb24gdHlwZU9mKHBhdGgpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuICJ1bmtub3duIjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJsbG0iKSkgcmV0dXJuICJ1bmtub3duIjsKICBjb25zdCBhY2Nlc3MyID0gc3RhdGVBY2Nlc3Nlcy5nZXQocGF0aCk7CiAgaWYgKGFjY2VzczIpIHsKICAgIHJldHVybiB0eXBlTm9kZVRvU3RyaW5nKGFjY2VzczIudHlwZSk7CiAgfQogIGNvbnN0IHN0YXRlVHlwZSA9IGJ1aWxkU3RhdGVUeXBlTm9kZSgpOwogIGNvbnN0IHJlc3VsdCA9IG5hdmlnYXRlVG9QYXRoKHN0YXRlVHlwZSwgcGF0aCk7CiAgaWYgKHJlc3VsdCkgewogICAgcmV0dXJuIHR5cGVOb2RlVG9TdHJpbmcocmVzdWx0KTsKICB9CiAgcmV0dXJuICJ1bmtub3duIjsKfQpmdW5jdGlvbiBuYXZpZ2F0ZVRvUGF0aChub2RlLCBwYXRoKSB7CiAgY29uc3QgcGFydHMgPSBwYXRoLnNwbGl0KCIuIik7CiAgbGV0IGN1cnJlbnQgPSBub2RlOwogIGZvciAoY29uc3QgcGFydCBvZiBwYXJ0cykgewogICAgY29uc3QgYXJyYXlNYXRjaCA9IHBhcnQubWF0Y2goL14oLispXFsoXGQrKVxdJC8pOwogICAgaWYgKGFycmF5TWF0Y2gpIHsKICAgICAgY29uc3QgWywgbmFtZV0gPSBhcnJheU1hdGNoOwogICAgICBpZiAoY3VycmVudC5raW5kID09PSAib2JqZWN0IiAmJiBjdXJyZW50LnByb3BlcnRpZXNbbmFtZV0pIHsKICAgICAgICBjdXJyZW50ID0gY3VycmVudC5wcm9wZXJ0aWVzW25hbWVdOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGlmIChjdXJyZW50LmtpbmQgPT09ICJhcnJheSIpIHsKICAgICAgICBjdXJyZW50ID0gY3VycmVudC5lbGVtZW50VHlwZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfSBlbHNlIGlmIChwYXJ0LmVuZHNXaXRoKCJbXSIpKSB7CiAgICAgIGNvbnN0IG5hbWUgPSBwYXJ0LnNsaWNlKDAsIC0yKTsKICAgICAgaWYgKGN1cnJlbnQua2luZCA9PT0gIm9iamVjdCIgJiYgY3VycmVudC5wcm9wZXJ0aWVzW25hbWVdKSB7CiAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucHJvcGVydGllc1tuYW1lXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGN1cnJlbnQua2luZCA9PT0gIm9iamVjdCIgJiYgY3VycmVudC5wcm9wZXJ0aWVzW3BhcnRdKSB7CiAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucHJvcGVydGllc1twYXJ0XTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gY3VycmVudDsKfQpmdW5jdGlvbiBjbGVhclR5cGVUcmFja2luZygpIHsKICBzdGF0ZUFjY2Vzc2VzLmNsZWFyKCk7CiAgZnVuY3Rpb25DYWxscy5jbGVhcigpOwogIGNvbXBvbmVudFByb3BzLmNsZWFyKCk7CiAgZXZlbnRQYXlsb2Fkcy5jbGVhcigpOwp9CnZhciBzdGF0ZUFjY2Vzc2VzLCBmdW5jdGlvbkNhbGxzLCBjb21wb25lbnRQcm9wcywgZXZlbnRQYXlsb2FkczsKdmFyIGluaXRfdHlwZV9pbmZlcmVuY2UgPSBfX2VzbSh7CiAgInNyYy90eXBlLWluZmVyZW5jZS50cyIoKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpbml0X2RlYnVnKCk7CiAgICBzdGF0ZUFjY2Vzc2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGZ1bmN0aW9uQ2FsbHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgY29tcG9uZW50UHJvcHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgZXZlbnRQYXlsb2FkcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgfQp9KTsKCi8vIHNyYy9kb20udHMKdmFyIGR5bmFtaWNJbXBvcnRTY3JpcHRzID0gYXN5bmMgKG5hbWVzKSA9PiB7CiAgY29uc3QgcmVzdWx0ID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBmb3IgKGxldCBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgKytpKSB7CiAgICBjb25zdCBzY3JpcHRzID0gQXJyYXkuZnJvbShxdWVyeUFsbCgic2NyaXB0W3NyY10iKSk7CiAgICBjb25zdCBtYXRjaGluZ1NjcmlwdCA9IHNjcmlwdHMuZmluZCgoc2NyaXB0KSA9PiB7CiAgICAgIGNvbnN0IHNyYyA9IHNjcmlwdC5nZXRBdHRyaWJ1dGUoInNyYyIpID8/ICIiOwogICAgICBjb25zdCBmaWxlbmFtZSA9IHNyYy5zcGxpdCgiLyIpLnBvcCgpID8/ICIiOwogICAgICByZXR1cm4gZmlsZW5hbWUgPT09IGAke25hbWVzW2ldfS5qc2A7CiAgICB9KTsKICAgIGNvbnN0IHNjcmlwdExvY2F0aW9uID0gbWF0Y2hpbmdTY3JpcHQ/LmdldEF0dHJpYnV0ZSgic3JjIik7CiAgICBsZXQgZiA9IG51bGw7CiAgICBpZiAoc2NyaXB0TG9jYXRpb24pIHsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCBtb2R1bGVVcmwgPSBuZXcgVVJMKHNjcmlwdExvY2F0aW9uLCBkb2N1bWVudC5iYXNlVVJJKS5ocmVmOwogICAgICAgIGNvbnN0IGV4cG9ydHMgPSBhd2FpdCBpbXBvcnQobW9kdWxlVXJsKTsKICAgICAgICBmb3IgKGNvbnN0IGV4cG9ydGVkIG9mIE9iamVjdC5rZXlzKGV4cG9ydHMpKSB7CiAgICAgICAgICBmID0gZXhwb3J0c1tleHBvcnRlZF07CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnNldChuYW1lc1tpXSwgZik7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBVbmFibGUgdG8gaW1wb3J0ICIke3NjcmlwdExvY2F0aW9ufSJgLCBlKTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9Owp2YXIgc2VhcmNoRm9yQ29tcG9uZW50cyA9ICgpID0+IHsKICByZXR1cm4gQXJyYXkuZnJvbShxdWVyeUFsbCgidGVtcGxhdGVbZGF0YS1jb21wb25lbnRdIikpLmZpbHRlcigoZWxlbSkgPT4gZWxlbSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KS5tYXAoKHQpID0+IHsKICAgIGNvbnN0IHJlc3VsdCA9IHsKICAgICAgbmFtZTogIiIsCiAgICAgIGF0dHJpYnV0ZXM6IFtdCiAgICB9OwogICAgZm9yIChjb25zdCBhdHRyaWJ1dGUgaW4gdC5kYXRhc2V0KSB7CiAgICAgIGlmIChhdHRyaWJ1dGUgPT09ICJjb21wb25lbnQiKSB7CiAgICAgICAgcmVzdWx0Lm5hbWUgPSB0LmRhdGFzZXRbYXR0cmlidXRlXSA/PyAiIjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQuYXR0cmlidXRlcy5wdXNoKFsKICAgICAgICAgIGRlY2FtZWxpemUoYXR0cmlidXRlKSwKICAgICAgICAgIHQuZGF0YXNldFthdHRyaWJ1dGVdID8/ICIiCiAgICAgICAgXSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChyZXN1bHQubmFtZSA9PT0gIiIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgIGBBIDx0ZW1wbGF0ZT4gd2FzIGZvdW5kIHdpdGggYW4gaW52YWxpZCBkYXRhLWNvbXBvbmVudDogIiR7dC5kYXRhc2V0LmNvbXBvbmVudH0iYAogICAgICApOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9KS5tYXAoKHsgbmFtZSwgYXR0cmlidXRlcyB9KSA9PiB7CiAgICBjb21wb25lbnQobmFtZSwgeyBhdHRyaWJ1dGVzIH0pOwogICAgcmV0dXJuIG5hbWU7CiAgfSk7Cn07CnZhciBjcmVhdGVDb21wb25lbnQgPSAobmFtZSwgdXBkYXRlKSA9PiB7CiAgY29uc3QgZWxlbWVudCA9IGNyZWF0ZShuYW1lKTsKICBpZiAoIWlzQm9yZWQoZWxlbWVudCkpIHsKICAgIGNvbnN0IGVycm9yID0gYFRoZSB0YWcgbmFtZSAiJHtuYW1lfSIgaXMgbm90IGEgQm9yZURPTSAgY29tcG9uZW50LgogICAgICAKImNyZWF0ZUNvbXBvbmVudCIgb25seSBhY2NlcHRzIHRhZy1uYW1lcyB3aXRoIG1hdGNoaW5nIDx0ZW1wbGF0ZT4gdGFncyB0aGF0IGhhdmUgYSBkYXRhLWNvbXBvbmVudCBhdHRyaWJ1dGUgaW4gdGhlbS5gOwogICAgY29uc29sZS5lcnJvcihlcnJvcik7CiAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3IpOwogIH0KICBpZiAodXBkYXRlKSB7CiAgICBlbGVtZW50LnJlbmRlckNhbGxiYWNrID0gdXBkYXRlOwogIH0KICByZXR1cm4gZWxlbWVudDsKfTsKdmFyIHF1ZXJ5Q29tcG9uZW50ID0gKHEpID0+IHsKICBjb25zdCBlbGVtID0gcXVlcnkocSk7CiAgaWYgKGVsZW0gPT09IG51bGwgfHwgIWlzQm9yZWQoZWxlbSkpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBlbGVtOwp9Owp2YXIgcXVlcnkgPSAocXVlcnkyKSA9PiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHF1ZXJ5Mik7CnZhciBxdWVyeUFsbCA9IChxdWVyeTIpID0+IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwocXVlcnkyKTsKdmFyIGNyZWF0ZSA9ICh0YWdOYW1lLCBjaGlsZHJlbikgPT4gewogIGNvbnN0IGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpOwogIGlmIChjaGlsZHJlbiAmJiBBcnJheS5pc0FycmF5KGNoaWxkcmVuKSAmJiBjaGlsZHJlbi5sZW5ndGggPiAwKSB7CiAgICBjaGlsZHJlbi5tYXAoKGMpID0+IGUuYXBwZW5kQ2hpbGQoYykpOwogIH0KICByZXR1cm4gZTsKfTsKdmFyIGRpc3BhdGNoID0gKG5hbWUsIGRldGFpbCkgPT4gewogIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAibG9hZGluZyIpIHsKICAgIGFkZEV2ZW50TGlzdGVuZXIoCiAgICAgICJET01Db250ZW50TG9hZGVkIiwKICAgICAgKCkgPT4gZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQobmFtZSwgeyBkZXRhaWwgfSkpCiAgICApOwogIH0gZWxzZSB7CiAgICBkaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudChuYW1lLCB7IGRldGFpbCB9KSk7CiAgfQp9Owp2YXIgaXNPYmplY3QgPSAodCkgPT4gdHlwZW9mIHQgPT09ICJvYmplY3QiOwp2YXIgaXNGdW5jdGlvbiA9ICh0KSA9PiB0eXBlb2YgdCA9PT0gImZ1bmN0aW9uIjsKdmFyIGlzQm9yZWQgPSAodCkgPT4gaXNPYmplY3QodCkgJiYgImlzQm9yZWQiIGluIHQgJiYgQm9vbGVhbih0LmlzQm9yZWQpOwp2YXIgZGVjYW1lbGl6ZSA9IChzdHIpID0+IHsKICBpZiAoc3RyID09PSAiIiB8fCAhc3RyLnNwbGl0KCIiKS5zb21lKChjaGFyKSA9PiBjaGFyICE9PSBjaGFyLnRvTG93ZXJDYXNlKCkpKSB7CiAgICByZXR1cm4gc3RyOwogIH0KICBsZXQgcmVzdWx0ID0gIiI7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IGNoYXIgPSBzdHJbaV07CiAgICBpZiAoY2hhciA9PT0gY2hhci50b1VwcGVyQ2FzZSgpICYmIGkgIT09IDApIHsKICAgICAgcmVzdWx0ICs9ICItIjsKICAgIH0KICAgIHJlc3VsdCArPSBjaGFyLnRvTG93ZXJDYXNlKCk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn07CnZhciBpc1N0YXJ0c1dpdGhPbiA9IChzKSA9PiBzLnN0YXJ0c1dpdGgoIm9uIik7CnZhciBpc1N0YXJ0c1dpdGhRdWVyaWVkT24gPSAocykgPT4gcy5zdGFydHNXaXRoKCJxdWVyaWVkT24iKTsKdmFyIGdldEV2ZW50TmFtZSA9IChzKSA9PiB7CiAgaWYgKGlzU3RhcnRzV2l0aE9uKHMpKSB7CiAgICByZXR1cm4gcy5zbGljZSgyKS50b0xvd2VyQ2FzZSgpOwogIH0KICByZXR1cm4gcy5zbGljZSg5KS50b0xvd2VyQ2FzZSgpOwp9Owp2YXIgQm9yZWQgPSBjbGFzcyBleHRlbmRzIEhUTUxFbGVtZW50IHsKfTsKdmFyIGNvbXBvbmVudCA9ICh0YWcsIHByb3BzID0ge30pID0+IHsKICBpZiAoY3VzdG9tRWxlbWVudHMuZ2V0KHRhZykpIHJldHVybjsKICBjdXN0b21FbGVtZW50cy5kZWZpbmUoCiAgICB0YWcsCiAgICBjbGFzcyBleHRlbmRzIEJvcmVkIHsKICAgICAgLy8gU3BlY2lmeSBvYnNlcnZlZCBhdHRyaWJ1dGVzIHNvIHRoYXQKICAgICAgLy8gYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrIHdpbGwgd29yawogICAgICBzdGF0aWMgZ2V0IG9ic2VydmVkQXR0cmlidXRlcygpIHsKICAgICAgICBpZiAodHlwZW9mIHByb3BzLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhwcm9wcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgc3VwZXIoKTsKICAgICAgfQogICAgICAvKioKICAgICAgICogVXNlZnVsIHRvIGtub3cgaWYgYSBnaXZlbiBIVE1MRWxlbWVudCBpcyBhIEJvcmVkIGNvbXBvbmVudC4KICAgICAgICogQHNlZSBgaXNCb3JlZCgpYCB0eXBlZ3VhcmQKICAgICAgICovCiAgICAgIGlzQm9yZWQgPSB0cnVlOwogICAgICB0cmF2ZXJzZShmLCB7IHRyYXZlcnNlU2hhZG93Um9vdCwgcXVlcnk6IHF1ZXJ5MiB9ID0ge30pIHsKICAgICAgICBBcnJheS5mcm9tKAogICAgICAgICAgdHJhdmVyc2VTaGFkb3dSb290ID8gdGhpcy5zaGFkb3dSb290Py5xdWVyeVNlbGVjdG9yQWxsKHF1ZXJ5MiA/PyAiKiIpID8/IFtdIDogW10KICAgICAgICApLmNvbmNhdChBcnJheS5mcm9tKHRoaXMucXVlcnlTZWxlY3RvckFsbChxdWVyeTIgPz8gIioiKSkpLmZpbHRlcigobikgPT4gbiBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KS5mb3JFYWNoKGYpOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBSZXR1cm5zIHRoZSBsaXN0IG9mIGN1c3RvbSBldmVudCBuYW1lcyBmcm9tIGEgc3RyaW5nIHRoYXQgaXMgc2hhcGVkIGxpa2U6CiAgICAgICAqIGAiZGlzcGF0Y2goJ2V2ZW50MScsICdldmVudDInLCAuLi4pImAKICAgICAgICoKICAgICAgICogVGhpcyBpcyB1c2VmdWwgd2hlbiB0cmF2ZXJzaW5nIGZvciBldmVudCBoYW5kbGVycyB0byBiZSByZXBsYWNlZAogICAgICAgKiB3aXRoIGN1c3RvbSBkaXNwYXRjaGVycy4KICAgICAgICogQHJldHVybnMgYW4gYXJyYXkgb2Ygc3RyaW5ncwogICAgICAgKi8KICAgICAgLyoqIEV4dHJhY3RzIGV2ZW50IG5hbWVzIGZyb20gc3RyaW5ncyBsaWtlICJkaXNwYXRjaCgnYScsJ2InKSIgKi8KICAgICAgI3BhcnNlQ3VzdG9tRXZlbnROYW1lcyhzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLnNwbGl0KCInIikuZmlsdGVyKAogICAgICAgICAgKHMpID0+IHMubGVuZ3RoID4gMiAmJiAhKHMuaW5jbHVkZXMoIigiKSB8fCBzLmluY2x1ZGVzKCIsIikgfHwgcy5pbmNsdWRlcygiKSIpKQogICAgICAgICk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIFJlcGxhY2VzIGlubGluZSBvbiogYXR0cmlidXRlcyB3aXRoaW4gdGhlIGNvbXBvbmVudCBET00gd2l0aCByZWFsCiAgICAgICAqIGxpc3RlbmVycyB0aGF0IGRpc3BhdGNoIGN1c3RvbSBldmVudHMgdXNpbmcgZGlzcGF0Y2goKS4KICAgICAgICovCiAgICAgICNjcmVhdGVEaXNwYXRjaGVycygpIHsKICAgICAgICBsZXQgaG9zdDsKICAgICAgICB0aGlzLnRyYXZlcnNlKChub2RlKSA9PiB7CiAgICAgICAgICBpZiAobm9kZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7CiAgICAgICAgICAgIGNvbnN0IGlzV2ViQ29tcG9uZW50ID0gY3VzdG9tRWxlbWVudHMuZ2V0KAogICAgICAgICAgICAgIG5vZGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChpc1dlYkNvbXBvbmVudCkgaG9zdCA9IG5vZGU7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5hdHRyaWJ1dGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlID0gbm9kZS5hdHRyaWJ1dGVzW2ldOwogICAgICAgICAgICAgIGlmIChpc1N0YXJ0c1dpdGhPbihhdHRyaWJ1dGUubmFtZSkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGV2ZW50TmFtZXMgPSB0aGlzLiNwYXJzZUN1c3RvbUV2ZW50TmFtZXMoYXR0cmlidXRlLnZhbHVlKTsKICAgICAgICAgICAgICAgIGlmIChldmVudE5hbWVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgZXZlbnROYW1lcy5mb3JFYWNoKChjdXN0b21FdmVudE5hbWUpID0+IHsKICAgICAgICAgICAgICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoCiAgICAgICAgICAgICAgICAgICAgICBnZXRFdmVudE5hbWUoYXR0cmlidXRlLm5hbWUpLAogICAgICAgICAgICAgICAgICAgICAgKGUpID0+IGRpc3BhdGNoKGN1c3RvbUV2ZW50TmFtZSwgewogICAgICAgICAgICAgICAgICAgICAgICBldmVudDogZSwKICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGF0Y2hlcjogbm9kZSwKICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50OiB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogdGhpcy5wYXJlbnRFbGVtZW50ID8gQXJyYXkuZnJvbSh0aGlzLnBhcmVudEVsZW1lbnQuY2hpbGRyZW4pLmluZGV4T2YoCiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcwogICAgICAgICAgICAgICAgICAgICAgICApIDogLTEKICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZSgKICAgICAgICAgICAgICAgICAgYGRhdGEtJHthdHRyaWJ1dGUubmFtZX0tZGlzcGF0Y2hlc2AsCiAgICAgICAgICAgICAgICAgIGV2ZW50TmFtZXMuam9pbigpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoYXR0cmlidXRlLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIHsgdHJhdmVyc2VTaGFkb3dSb290OiB0cnVlIH0pOwogICAgICB9CiAgICAgIGlzSW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAgICAgI2luaXQoKSB7CiAgICAgICAgbGV0IHRlbXBsYXRlID0gcXVlcnkoYFtkYXRhLWNvbXBvbmVudD0iJHt0YWd9Il1gKSA/PyBjcmVhdGUoInRlbXBsYXRlIik7CiAgICAgICAgY29uc3QgaXNUZW1wbGF0ZVNoYWRvd1Jvb3QgPSB0ZW1wbGF0ZS5nZXRBdHRyaWJ1dGUoInNoYWRvd3Jvb3Rtb2RlIik7CiAgICAgICAgY29uc3QgaXNTaGFkb3dSb290TmVlZGVkID0gcHJvcHMuc3R5bGUgfHwgcHJvcHMuc2hhZG93IHx8IGlzVGVtcGxhdGVTaGFkb3dSb290OwogICAgICAgIGlmIChpc1NoYWRvd1Jvb3ROZWVkZWQpIHsKICAgICAgICAgIGNvbnN0IHNoYWRvd1Jvb3RNb2RlID0gcHJvcHMuc2hhZG93cm9vdG1vZGUgPz8gaXNUZW1wbGF0ZVNoYWRvd1Jvb3QgPz8gIm9wZW4iOwogICAgICAgICAgY29uc3Qgc2hhZG93Um9vdCA9IHRoaXMuYXR0YWNoU2hhZG93KHsgbW9kZTogc2hhZG93Um9vdE1vZGUgfSk7CiAgICAgICAgICBpZiAocHJvcHMuc3R5bGUpIHsKICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBjcmVhdGUoInN0eWxlIik7CiAgICAgICAgICAgIHN0eWxlLnRleHRDb250ZW50ID0gcHJvcHMuc3R5bGU7CiAgICAgICAgICAgIHNoYWRvd1Jvb3QuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3BzLnNoYWRvdykgewogICAgICAgICAgICBjb25zdCB0bXAgPSBjcmVhdGUoInRlbXBsYXRlIik7CiAgICAgICAgICAgIHRtcC5pbm5lckhUTUwgPSBwcm9wcy5zaGFkb3c7CiAgICAgICAgICAgIHNoYWRvd1Jvb3QuYXBwZW5kQ2hpbGQodG1wLmNvbnRlbnQuY2xvbmVOb2RlKHRydWUpKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZW1wbGF0ZVNoYWRvd1Jvb3QpIHsKICAgICAgICAgICAgc2hhZG93Um9vdC5hcHBlbmRDaGlsZCh0ZW1wbGF0ZS5jb250ZW50LmNsb25lTm9kZSh0cnVlKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh0ZW1wbGF0ZSAmJiAhaXNUZW1wbGF0ZVNoYWRvd1Jvb3QpIHsKICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQodGVtcGxhdGUuY29udGVudC5jbG9uZU5vZGUodHJ1ZSkpOwogICAgICAgIH0KICAgICAgICBpZiAocHJvcHMub25TbG90Q2hhbmdlKSB7CiAgICAgICAgICB0aGlzLnRyYXZlcnNlKChlbGVtKSA9PiB7CiAgICAgICAgICAgIGlmICghKGVsZW0gaW5zdGFuY2VvZiBIVE1MU2xvdEVsZW1lbnQpKSByZXR1cm47CiAgICAgICAgICAgIGVsZW0uYWRkRXZlbnRMaXN0ZW5lcigic2xvdGNoYW5nZSIsIChlKSA9PiBwcm9wcy5vblNsb3RDaGFuZ2U/LihlKSk7CiAgICAgICAgICB9LCB7IHRyYXZlcnNlU2hhZG93Um9vdDogdHJ1ZSB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzRnVuY3Rpb24ocHJvcHMub25DbGljaykpIHsKICAgICAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBwcm9wcy5vbkNsaWNrKTsKICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMocHJvcHMpKSB7CiAgICAgICAgICBpZiAoaXNTdGFydHNXaXRoT24oa2V5KSkgewogICAgICAgICAgICBpZiAoIWlzRnVuY3Rpb24odmFsdWUpKSBjb250aW51ZTsKICAgICAgICAgICAgdGhpcy5hZGRFdmVudExpc3RlbmVyKGdldEV2ZW50TmFtZShrZXkpLCB2YWx1ZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzU3RhcnRzV2l0aFF1ZXJpZWRPbihrZXkpKSB7CiAgICAgICAgICAgIGNvbnN0IHF1ZXJpZXMgPSB2YWx1ZTsKICAgICAgICAgICAgaWYgKCFpc09iamVjdChxdWVyaWVzKSkgY29udGludWU7CiAgICAgICAgICAgIGNvbnN0IGV2ZW50TmFtZSA9IGdldEV2ZW50TmFtZShrZXkpOwogICAgICAgICAgICBmb3IgKGNvbnN0IFtxdWVyeTIsIGhhbmRsZXJdIG9mIE9iamVjdC5lbnRyaWVzKHF1ZXJpZXMpKSB7CiAgICAgICAgICAgICAgdGhpcy50cmF2ZXJzZSgobm9kZSkgPT4gewogICAgICAgICAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgaGFuZGxlcik7CiAgICAgICAgICAgICAgfSwgeyB0cmF2ZXJzZVNoYWRvd1Jvb3Q6IHRydWUsIHF1ZXJ5OiBxdWVyeTIgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHByb3BzLmF0dHJpYnV0ZXMgJiYgQXJyYXkuaXNBcnJheShwcm9wcy5hdHRyaWJ1dGVzKSkgewogICAgICAgICAgcHJvcHMuYXR0cmlidXRlcy5tYXAoCiAgICAgICAgICAgIChbYXR0ciwgdmFsdWVdKSA9PiB0aGlzLnNldEF0dHJpYnV0ZShhdHRyLCB2YWx1ZSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHRoaXMuI2NyZWF0ZURpc3BhdGNoZXJzKCk7CiAgICAgICAgdGhpcy5pc0luaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgfQogICAgICAvKioKICAgICAgICogVXNlci1wcm92aWRlZCByZW5kZXJlciBpcyBhc3NpZ25lZCBoZXJlIGJ5IGNyZWF0ZUNvbXBvbmVudC4KICAgICAgICogQ2FsbGVkIG9uIGNvbm5lY3QgYW5kIHdoZW5ldmVyIHN0YXRlIHRyaWdnZXJzIHN1YnNjcmlwdGlvbnMuCiAgICAgICAqLwogICAgICByZW5kZXJDYWxsYmFjayA9IChfKSA9PiB7CiAgICAgIH07CiAgICAgIGNvbm5lY3RlZENhbGxiYWNrKCkgewogICAgICAgIGlmICghdGhpcy5pc0luaXRpYWxpemVkKSB0aGlzLiNpbml0KCk7CiAgICAgICAgdGhpcy5yZW5kZXJDYWxsYmFjayh0aGlzKTsKICAgICAgICBwcm9wcy5jb25uZWN0ZWRDYWxsYmFjaz8uKHRoaXMpOwogICAgICB9CiAgICAgIHNsb3RzID0gY3JlYXRlU2xvdHNBY2Nlc3Nvcih0aGlzKTsKICAgICAgLyoKICAgICAgICAgICAgI2NyZWF0ZVNsb3RzKCkgewogICAgICAgICAgICAgIGNvbnN0IHNsb3RzID0gQXJyYXkuZnJvbSh0aGlzLnF1ZXJ5U2VsZWN0b3JBbGwoInNsb3QiKSk7CiAgICAgICAgICAgICAgY29uc3Qgd2ViQ29tcG9uZW50ID0gdGhpczsKICAgICAgCiAgICAgICAgICAgICAgc2xvdHMuZm9yRWFjaCgoc2xvdCkgPT4gewogICAgICAgICAgICAgICAgY29uc3Qgc2xvdE5hbWUgPSBzbG90LmdldEF0dHJpYnV0ZSgibmFtZSIpOwogICAgICAgICAgICAgICAgaWYgKCFzbG90TmFtZSkgcmV0dXJuOwogICAgICAKICAgICAgICAgICAgICAgIGNvbnN0IGNhbWVsaXplZFNsb3ROYW1lID0gY2FtZWxpemUoc2xvdE5hbWUpOwogICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdlYkNvbXBvbmVudC5zbG90cywgY2FtZWxpemVkU2xvdE5hbWUsIHsKICAgICAgICAgICAgICAgICAgZ2V0KCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB3ZWJDb21wb25lbnQucXVlcnlTZWxlY3RvcihgW2RhdGEtc2xvdD0iJHtzbG90TmFtZX0iXWApOwogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBzZXQodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgZWxlbSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5zZXRBdHRyaWJ1dGUoImRhdGEtc2xvdCIsIHNsb3ROYW1lKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAgIGVsZW0gPSBjcmVhdGUoInNwYW4iKTsKICAgICAgICAgICAgICAgICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKCJkYXRhLXNsb3QiLCBzbG90TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICBlbGVtLmlubmVyVGV4dCA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhpc3RpbmdTbG90ID0gdGhpc1tjYW1lbGl6ZWRTbG90TmFtZV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nU2xvdCkgewogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdTbG90LnBhcmVudEVsZW1lbnQucmVwbGFjZUNoaWxkKGVsZW0sIGV4aXN0aW5nU2xvdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHNsb3QucGFyZW50RWxlbWVudD8ucmVwbGFjZUNoaWxkKGVsZW0sIHNsb3QpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgICovCiAgICAgIHVwZGF0ZVNsb3Qoc2xvdE5hbWUsIGNvbnRlbnQsIHdpdGhpblRhZykgewogICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQod2l0aGluVGFnKTsKICAgICAgICBjb250YWluZXIuc2V0QXR0cmlidXRlKCJzbG90Iiwgc2xvdE5hbWUpOwogICAgICB9CiAgICAgIC8qCiAgICAgICAgICAgICNjcmVhdGVQcm9wZXJ0aWVzKCkgewogICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnRzRm91bmQgPSBkb2N1bWVudC5ldmFsdWF0ZSgKICAgICAgICAgICAgICAgICIvLypbY29udGFpbnModGV4dCgpLCd0aGlzLicpXSIsCiAgICAgICAgICAgICAgICBkb2N1bWVudCwKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICBYUGF0aFJlc3VsdC5PUkRFUkVEX05PREVfSVRFUkFUT1JfVFlQRSwKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgKTsKICAgICAgCiAgICAgICAgICAgICAgbGV0IGVsZW1lbnQgPSBudWxsOwogICAgICAgICAgICAgIHdoaWxlIChlbGVtZW50ID0gZWxlbWVudHNGb3VuZC5pdGVyYXRlTmV4dCgpKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiRm91bmQgIiwgZWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgICovCiAgICAgIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkgewogICAgICAgIHByb3BzLmRpc2Nvbm5lY3RlZENhbGxiYWNrPy4odGhpcyk7CiAgICAgIH0KICAgICAgYWRvcHRlZENhbGxiYWNrKCkgewogICAgICAgIHByb3BzLmFkb3B0ZWRDYWxsYmFjaz8uKHRoaXMpOwogICAgICB9CiAgICAgIGF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayhuYW1lLCBvbGRWYWx1ZSwgbmV3VmFsdWUpIHsKICAgICAgICBpZiAoIXByb3BzLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjaykgcmV0dXJuOwogICAgICAgIHByb3BzLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFja1tuYW1lXSh7CiAgICAgICAgICBlbGVtZW50OiB0aGlzLAogICAgICAgICAgbmFtZSwKICAgICAgICAgIG9sZFZhbHVlLAogICAgICAgICAgbmV3VmFsdWUKICAgICAgICB9KTsKICAgICAgfQogICAgfQogICk7Cn07CnZhciByZWdpc3RlckNvbXBvbmVudCA9ICh0YWdOYW1lKSA9PiB7CiAgY29tcG9uZW50KHRhZ05hbWUsIHt9KTsKfTsKCi8vIHNyYy91dGlscy9hY2Nlc3MudHMKZnVuY3Rpb24gYWNjZXNzKHBhdGgsIG9iaikgewogIGxldCByZXN1bHQgPSBvYmo7CiAgaWYgKG9iaiA9PT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKICBwYXRoLmZvckVhY2goKGF0dHJpYnV0ZSkgPT4gewogICAgcmVzdWx0ID0gcmVzdWx0W2F0dHJpYnV0ZV07CiAgfSk7CiAgcmV0dXJuIHJlc3VsdDsKfQoKLy8gc3JjL3V0aWxzL2ZsYXR0ZW4udHMKZnVuY3Rpb24gZmxhdHRlbihvYmosIGlnbm9yZSA9IFtdKSB7CiAgY29uc3Qgc3RhY2sgPSBbewogICAgcGF0aDogW10sCiAgICBvYmoKICB9XTsKICBjb25zdCByZXN1bHQgPSBbXTsKICBjb25zdCB2aXNpdGVkID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCk7CiAgd2hpbGUgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgIGNvbnN0IHsgcGF0aCwgb2JqOiBvYmoyIH0gPSBzdGFjay5wb3AoKTsKICAgIGlmICh2aXNpdGVkLmhhcyhvYmoyKSkgY29udGludWU7CiAgICB2aXNpdGVkLmFkZChvYmoyKTsKICAgIGZvciAoY29uc3Qga2V5IGluIG9iajIpIHsKICAgICAgaWYgKGlnbm9yZS5pbmNsdWRlcyhrZXkpKSBjb250aW51ZTsKICAgICAgY29uc3QgdmFsdWUgPSBvYmoyW2tleV07CiAgICAgIGNvbnN0IG5ld1BhdGggPSBwYXRoLmNvbmNhdChrZXkpOwogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCAmJiAhdmlzaXRlZC5oYXModmFsdWUpKSB7CiAgICAgICAgc3RhY2sucHVzaCh7CiAgICAgICAgICBwYXRoOiBuZXdQYXRoLAogICAgICAgICAgb2JqOiB2YWx1ZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJlc3VsdC5wdXNoKHsgcGF0aDogbmV3UGF0aCwgdmFsdWUgfSk7CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCi8vIHNyYy91dGlscy9pc1Bvam8udHMKZnVuY3Rpb24gaXNQT0pPKGFyZykgewogIGlmIChhcmcgPT0gbnVsbCB8fCB0eXBlb2YgYXJnICE9PSAib2JqZWN0IikgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBjb25zdCBwcm90byA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihhcmcpOwogIGlmIChwcm90byA9PSBudWxsKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIHByb3RvID09PSBPYmplY3QucHJvdG90eXBlOwp9CgovLyBzcmMvYm9yZS50cwppbml0X3R5cGVfaW5mZXJlbmNlKCk7CmZ1bmN0aW9uIGNyZWF0ZUV2ZW50c0hhbmRsZXIoYywgYXBwLCBkZXRhaWwpIHsKICByZXR1cm4gKGV2ZW50TmFtZSwgaGFuZGxlcikgPT4gewogICAgYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIChldmVudCkgPT4gewogICAgICBsZXQgdGFyZ2V0ID0gZXZlbnQ/LmRldGFpbD8uZXZlbnQuY3VycmVudFRhcmdldDsKICAgICAgbGV0IGVtaXRlckVsZW0gPSB2b2lkIDA7CiAgICAgIHdoaWxlICh0YXJnZXQpIHsKICAgICAgICBpZiAodGFyZ2V0ID09PSBjKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBtYXliZVByb21pc2UgPSBoYW5kbGVyKHsKICAgICAgICAgICAgICBzdGF0ZTogYXBwLAogICAgICAgICAgICAgIGU6IGV2ZW50LmRldGFpbCwKICAgICAgICAgICAgICBkZXRhaWwKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIFByb21pc2UucmVzb2x2ZShtYXliZVByb21pc2UpLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAgICAgICBgRXJyb3IgaW4gYXN5bmMgaGFuZGxlciBmb3IgIiR7ZXZlbnROYW1lfSIgZXZlbnRgLAogICAgICAgICAgICAgICAgZXJyb3IKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIGluIGhhbmRsZXIgZm9yICIke2V2ZW50TmFtZX0iIGV2ZW50YCwgZXJyb3IpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGFyZ2V0IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHsKICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnRFbGVtZW50OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0YXJnZXQgPSB2b2lkIDA7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9Owp9CmZ1bmN0aW9uIGNyZWF0ZVJlZnNBY2Nlc3NvcihjKSB7CiAgcmV0dXJuIG5ldyBQcm94eSh7fSwgewogICAgZ2V0KHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpIHsKICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoCiAgICAgICAgYFJlZiAiJHtTdHJpbmcocHJvcCl9IiBub3QgZm91bmQgaW4gPCR7Yy50YWdOYW1lfT5gCiAgICAgICk7CiAgICAgIGlmICh0eXBlb2YgcHJvcCA9PT0gInN0cmluZyIpIHsKICAgICAgICBjb25zdCBub2RlTGlzdCA9IGMucXVlcnlTZWxlY3RvckFsbChgW2RhdGEtcmVmPSIke3Byb3B9Il1gKTsKICAgICAgICBpZiAoIW5vZGVMaXN0KSB0aHJvdyBlcnJvcjsKICAgICAgICBjb25zdCByZWZzID0gQXJyYXkuZnJvbShub2RlTGlzdCkuZmlsdGVyKAogICAgICAgICAgKHJlZikgPT4gcmVmIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQKICAgICAgICApOwogICAgICAgIGlmIChyZWZzLmxlbmd0aCA9PT0gMCkgdGhyb3cgZXJyb3I7CiAgICAgICAgaWYgKHJlZnMubGVuZ3RoID09PSAxKSByZXR1cm4gcmVmc1swXTsKICAgICAgICByZXR1cm4gcmVmczsKICAgICAgfQogICAgfQogIH0pOwp9CmZ1bmN0aW9uIGNyZWF0ZVNsb3RzQWNjZXNzb3IoYykgewogIHJldHVybiBuZXcgUHJveHkoe30sIHsKICAgIGdldCh0YXJnZXQsIHByb3AsIHJlY2lldmVyKSB7CiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKAogICAgICAgIGBTbG90ICIke1N0cmluZyhwcm9wKX0iIG5vdCBmb3VuZCBpbiA8JHtjLnRhZ05hbWV9PmAKICAgICAgKTsKICAgICAgaWYgKHR5cGVvZiBwcm9wID09PSAic3RyaW5nIikgewogICAgICAgIGNvbnN0IG5vZGVMaXN0ID0gYy5xdWVyeVNlbGVjdG9yQWxsKGBzbG90W25hbWU9IiR7cHJvcH0iXWApOwogICAgICAgIGlmICghbm9kZUxpc3QpIHRocm93IGVycm9yOwogICAgICAgIGNvbnN0IHJlZnMgPSBBcnJheS5mcm9tKG5vZGVMaXN0KS5maWx0ZXIoCiAgICAgICAgICAocmVmKSA9PiByZWYgaW5zdGFuY2VvZiBIVE1MU2xvdEVsZW1lbnQKICAgICAgICApOwogICAgICAgIGlmIChyZWZzLmxlbmd0aCA9PT0gMCkgdGhyb3cgZXJyb3I7CiAgICAgICAgaWYgKHJlZnMubGVuZ3RoID09PSAxKSByZXR1cm4gcmVmc1swXTsKICAgICAgICByZXR1cm4gcmVmczsKICAgICAgfQogICAgfSwKICAgIHNldCh0YXJnZXQsIHByb3AsIHZhbHVlKSB7CiAgICAgIGlmICh0eXBlb2YgcHJvcCAhPT0gInN0cmluZyIpIHJldHVybiBmYWxzZTsKICAgICAgbGV0IGVsZW0gPSB2YWx1ZTsKICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHsKICAgICAgICB2YWx1ZS5zZXRBdHRyaWJ1dGUoImRhdGEtc2xvdCIsIHByb3ApOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHsKICAgICAgICBlbGVtID0gY3JlYXRlKCJzcGFuIik7CiAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoImRhdGEtc2xvdCIsIHByb3ApOwogICAgICAgIGVsZW0uaW5uZXJUZXh0ID0gdmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHZhbHVlIGZvciBzbG90ICR7cHJvcH0gaW4gPCR7Yy50YWdOYW1lfT5gKTsKICAgICAgfQogICAgICBjb25zdCBleGlzdGluZ1Nsb3RzID0gQXJyYXkuZnJvbSgKICAgICAgICBjLnF1ZXJ5U2VsZWN0b3JBbGwoYFtkYXRhLXNsb3Q9IiR7cHJvcH0iXWApCiAgICAgICk7CiAgICAgIGlmIChleGlzdGluZ1Nsb3RzLmxlbmd0aCA+IDApIHsKICAgICAgICBleGlzdGluZ1Nsb3RzLmZvckVhY2goKHMpID0+IHMucGFyZW50RWxlbWVudD8ucmVwbGFjZUNoaWxkKGVsZW0sIHMpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBzbG90cyA9IEFycmF5LmZyb20oYy5xdWVyeVNlbGVjdG9yQWxsKGBzbG90W25hbWU9IiR7cHJvcH0iXWApKTsKICAgICAgICBzbG90cy5mb3JFYWNoKChzKSA9PiBzLnBhcmVudEVsZW1lbnQ/LnJlcGxhY2VDaGlsZChlbGVtLCBzKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gY3JlYXRlU3RhdGVBY2Nlc3NvcihzdGF0ZSwgbG9nLCBhY2N1bSkgewogIGNvbnN0IGN1cnJlbnQgPSBhY2N1bSB8fCB7IHRhcmdldHM6IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpLCBwYXRoOiBbXSB9OwogIGlmIChzdGF0ZSA9PT0gdm9pZCAwKSByZXR1cm4gdm9pZCAwOwogIHJldHVybiBuZXcgUHJveHkoc3RhdGUsIHsKICAgIC8vIFN0YXRlIGFjY2Vzc29ycyBhcmUgcmVhZC1vbmx5OgogICAgc2V0KHRhcmdldCwgcHJvcCwgbmV3VmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiBwcm9wID09PSAic3RyaW5nIikgewogICAgICAgIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICBgU3RhdGUgaXMgcmVhZC1vbmx5IGZvciB3ZWIgY29tcG9uZW50cy4gVW5hYmxlIHRvIHNldCAnJHtwcm9wfScuYAogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIC8vIFJlY3Vyc2l2ZWx5IGJ1aWxkIGEgcHJveHkgZm9yIGVhY2ggc3RhdGUgcHJvcCBiZWluZyByZWFkOgogICAgZ2V0KHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpIHsKICAgICAgY29uc3QgdmFsdWUgPSBSZWZsZWN0LmdldCh0YXJnZXQsIHByb3AsIHJlY2VpdmVyKTsKICAgICAgY29uc3QgaXNQcm90byA9IHByb3AgPT09ICJfX3Byb3RvX18iOwogICAgICBpZiAodHlwZW9mIHByb3AgPT09ICJzdHJpbmciICYmICFpc1Byb3RvKSB7CiAgICAgICAgaWYgKCFjdXJyZW50LnRhcmdldHMuaGFzKHRhcmdldCkpIHsKICAgICAgICAgIGN1cnJlbnQudGFyZ2V0cy5zZXQodGFyZ2V0LCBjdXJyZW50LnBhdGguam9pbigiLiIpKTsKICAgICAgICAgIGN1cnJlbnQucGF0aC5wdXNoKHByb3ApOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoaXNQcm90byB8fCBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCBpc1BPSk8odmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZVN0YXRlQWNjZXNzb3IodmFsdWUsIGxvZywgY3VycmVudCk7CiAgICAgIH0KICAgICAgbGV0IHBhdGggPSBjdXJyZW50LnRhcmdldHMuZ2V0KHRhcmdldCkgPz8gIiI7CiAgICAgIGlmICh0eXBlb2YgcGF0aCA9PT0gInN0cmluZyIgJiYgdHlwZW9mIHByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGFyZ2V0KSkgewogICAgICAgICAgcGF0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGF0aCArPSBwYXRoICE9PSAiIiA/IGAuJHtwcm9wfWAgOiBwcm9wOwogICAgICAgIH0KICAgICAgICBpZiAobG9nLmluZGV4T2YocGF0aCkgPT09IC0xKSB7CiAgICAgICAgICBsb2cucHVzaChwYXRoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY3VycmVudC5wYXRoLmxlbmd0aCA9IDA7CiAgICAgIGN1cnJlbnQucGF0aC5wdXNoKHBhdGgpOwogICAgICBpZiAodHlwZW9mIF9fREVCVUdfXyA9PT0gInVuZGVmaW5lZCIgfHwgX19ERUJVR19fKSB7CiAgICAgICAgaWYgKHR5cGVvZiBwYXRoID09PSAic3RyaW5nIiAmJiBwYXRoICE9PSAiIikgewogICAgICAgICAgdHJhY2tTdGF0ZUFjY2VzcyhwYXRoLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICB9KTsKfQpmdW5jdGlvbiBjcmVhdGVTdWJzY3JpYmVyc0Rpc3BhdGNoZXIoc3RhdGUpIHsKICByZXR1cm4gKCkgPT4gewogICAgY29uc3QgdXBkYXRlcyA9IHN0YXRlLmludGVybmFsLnVwZGF0ZXM7CiAgICBjb25zdCBub3RpZmllZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICBjb25zdCBub3RpZnkgPSAoZm5zKSA9PiB7CiAgICAgIGlmICghZm5zKSByZXR1cm47CiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgZm5zLmxlbmd0aDsgaisrKSB7CiAgICAgICAgY29uc3QgZm4gPSBmbnNbal07CiAgICAgICAgaWYgKG5vdGlmaWVkLmhhcyhmbikpIGNvbnRpbnVlOwogICAgICAgIG5vdGlmaWVkLmFkZChmbik7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGZuKHN0YXRlLmFwcCk7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHVwZGF0ZXMucGF0aC5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwYXRoID0gdXBkYXRlcy5wYXRoW2ldOwogICAgICBjb25zdCByZWxhdGl2ZVBhdGggPSBwYXRoLnNsaWNlKHBhdGguaW5kZXhPZigiLiIpICsgMSk7CiAgICAgIG5vdGlmeSh1cGRhdGVzLnN1YnNjcmliZXJzLmdldChyZWxhdGl2ZVBhdGgpKTsKICAgICAgZm9yIChjb25zdCBbc3Vic2NyaWJlclBhdGgsIGZuc10gb2YgdXBkYXRlcy5zdWJzY3JpYmVycy5lbnRyaWVzKCkpIHsKICAgICAgICBpZiAoc3Vic2NyaWJlclBhdGggPT09IHJlbGF0aXZlUGF0aCkgY29udGludWU7CiAgICAgICAgY29uc3Qgc3Vic2NyaWJlcldpdGhEb3QgPSBgJHtzdWJzY3JpYmVyUGF0aH0uYDsKICAgICAgICBjb25zdCByZWxhdGl2ZVdpdGhEb3QgPSBgJHtyZWxhdGl2ZVBhdGh9LmA7CiAgICAgICAgaWYgKHJlbGF0aXZlUGF0aC5zdGFydHNXaXRoKHN1YnNjcmliZXJXaXRoRG90KSB8fCBzdWJzY3JpYmVyUGF0aC5zdGFydHNXaXRoKHJlbGF0aXZlV2l0aERvdCkpIHsKICAgICAgICAgIG5vdGlmeShmbnMpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgdXBkYXRlcy5wYXRoID0gW107CiAgICB1cGRhdGVzLnZhbHVlID0gW107CiAgICB1cGRhdGVzLnJhZiA9IHZvaWQgMDsKICB9Owp9CmZ1bmN0aW9uIHByb3hpZnkoYm9yZWRvbSkgewogIGNvbnN0IHJ1bnRpbWUgPSBib3JlZG9tLmludGVybmFsOwogIGNvbnN0IHN0YXRlID0gYm9yZWRvbTsKICBpZiAoc3RhdGUgPT09IHZvaWQgMCkgcmV0dXJuIGJvcmVkb207CiAgY29uc3Qgb2JqZWN0c1dpdGhQcm94aWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCk7CiAgY29uc3QgUFJPWFlfTUFSS0VSID0gU3ltYm9sKCJib3JlZG9tLXByb3h5Iik7CiAgZnVuY3Rpb24gY3JlYXRlUmVhY3RpdmVQcm94eSh2YWx1ZSwgZG90dGVkUGF0aCkgewogICAgaWYgKG9iamVjdHNXaXRoUHJveGllcy5oYXModmFsdWUpKSByZXR1cm4gdmFsdWU7CiAgICBjb25zdCBwcm94eSA9IG5ldyBQcm94eSh2YWx1ZSwgewogICAgICBnZXQodGFyZ2V0LCBwcm9wLCByZWNlaXZlcikgewogICAgICAgIGlmIChwcm9wID09PSBQUk9YWV9NQVJLRVIpIHJldHVybiB0cnVlOwogICAgICAgIHJldHVybiBSZWZsZWN0LmdldCh0YXJnZXQsIHByb3AsIHJlY2VpdmVyKTsKICAgICAgfSwKICAgICAgc2V0KHRhcmdldCwgcHJvcCwgbmV3VmFsdWUpIHsKICAgICAgICBjb25zdCBpc0NoYW5nZWQgPSB0YXJnZXRbcHJvcF0gIT09IG5ld1ZhbHVlOwogICAgICAgIGlmICghaXNDaGFuZ2VkKSByZXR1cm4gdHJ1ZTsKICAgICAgICBpZiAodHlwZW9mIHByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICBjb25zdCBuZXdQYXRoID0gQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyBkb3R0ZWRQYXRoIDogYCR7ZG90dGVkUGF0aH0uJHtwcm9wfWA7CiAgICAgICAgICBjb25zdCBpc0FscmVhZHlQcm94eSA9IG5ld1ZhbHVlICYmIG5ld1ZhbHVlW1BST1hZX01BUktFUl0gPT09IHRydWU7CiAgICAgICAgICBpZiAoIWlzQWxyZWFkeVByb3h5ICYmIChBcnJheS5pc0FycmF5KG5ld1ZhbHVlKSB8fCBpc1BPSk8obmV3VmFsdWUpKSkgewogICAgICAgICAgICBuZXdWYWx1ZSA9IHByb3hpZnlWYWx1ZShuZXdWYWx1ZSwgbmV3UGF0aCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFJlZmxlY3Quc2V0KHRhcmdldCwgcHJvcCwgbmV3VmFsdWUpOwogICAgICAgIGlmICh0eXBlb2YgcHJvcCAhPT0gInN0cmluZyIpIHJldHVybiB0cnVlOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgcnVudGltZS51cGRhdGVzLnBhdGgucHVzaChgJHtkb3R0ZWRQYXRofWApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBydW50aW1lLnVwZGF0ZXMucGF0aC5wdXNoKGAke2RvdHRlZFBhdGh9LiR7cHJvcH1gKTsKICAgICAgICB9CiAgICAgICAgcnVudGltZS51cGRhdGVzLnZhbHVlLnB1c2godGFyZ2V0KTsKICAgICAgICBpZiAoIXJ1bnRpbWUudXBkYXRlcy5yYWYpIHsKICAgICAgICAgIHJ1bnRpbWUudXBkYXRlcy5yYWYgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoCiAgICAgICAgICAgIGNyZWF0ZVN1YnNjcmliZXJzRGlzcGF0Y2hlcihib3JlZG9tKQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgb2JqZWN0c1dpdGhQcm94aWVzLmFkZCh2YWx1ZSk7CiAgICBvYmplY3RzV2l0aFByb3hpZXMuYWRkKHByb3h5KTsKICAgIHJldHVybiBwcm94eTsKICB9CiAgZnVuY3Rpb24gcHJveGlmeVZhbHVlKHZhbHVlLCBiYXNlUGF0aCkgewogICAgaWYgKCFBcnJheS5pc0FycmF5KHZhbHVlKSAmJiAhaXNQT0pPKHZhbHVlKSkgcmV0dXJuIHZhbHVlOwogICAgaWYgKG9iamVjdHNXaXRoUHJveGllcy5oYXModmFsdWUpKSByZXR1cm4gdmFsdWU7CiAgICBpZiAodmFsdWUgJiYgdmFsdWVbUFJPWFlfTUFSS0VSXSA9PT0gdHJ1ZSkgcmV0dXJuIHZhbHVlOwogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBpdGVtID0gdmFsdWVbaV07CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkgfHwgaXNQT0pPKGl0ZW0pKSB7CiAgICAgICAgICB2YWx1ZVtpXSA9IHByb3hpZnlWYWx1ZShpdGVtLCBiYXNlUGF0aCk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyh2YWx1ZSkpIHsKICAgICAgICBjb25zdCBpdGVtID0gdmFsdWVba2V5XTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShpdGVtKSB8fCBpc1BPSk8oaXRlbSkpIHsKICAgICAgICAgIHZhbHVlW2tleV0gPSBwcm94aWZ5VmFsdWUoaXRlbSwgYCR7YmFzZVBhdGh9LiR7a2V5fWApOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGNyZWF0ZVJlYWN0aXZlUHJveHkodmFsdWUsIGJhc2VQYXRoKTsKICB9CiAgZmxhdHRlbihib3JlZG9tLCBbImludGVybmFsIl0pLmZvckVhY2goKHsgcGF0aCwgdmFsdWUgfSkgPT4gewogICAgY29uc3QgbmVlZHNQcm94eSA9IEFycmF5LmlzQXJyYXkodmFsdWUpIHx8IGlzUE9KTyh2YWx1ZSkgJiYgIW9iamVjdHNXaXRoUHJveGllcy5oYXModmFsdWUpOwogICAgaWYgKG5lZWRzUHJveHkpIHsKICAgICAgY29uc3QgZG90dGVkUGF0aCA9IHBhdGguam9pbigiLiIpOwogICAgICBjb25zdCBwYXJlbnQgPSBhY2Nlc3MocGF0aC5zbGljZSgwLCAtMSksIHN0YXRlKTsKICAgICAgY29uc3QgaXNSb290ID0gcGFyZW50ID09PSB2YWx1ZTsKICAgICAgaWYgKGlzUm9vdCkgcmV0dXJuOwogICAgICBwYXJlbnRbcGF0aC5hdCgtMSldID0gY3JlYXRlUmVhY3RpdmVQcm94eSh2YWx1ZSwgZG90dGVkUGF0aCk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIGJvcmVkb207Cn0KZnVuY3Rpb24gcnVuQ29tcG9uZW50c0luaXRpYWxpemVyKHN0YXRlKSB7CiAgY29uc3QgdGFnc0luRG9tID0gc3RhdGUuaW50ZXJuYWwuY3VzdG9tVGFncy5maWx0ZXIoCiAgICAodGFnKSA9PiAoCiAgICAgIC8vIEEgdGFnIGlzIGNvbnNpZGVyZWQgcHJlc2VudCBpZiBhdCBsZWFzdCBvbmUgaW5zdGFuY2UgZXhpc3RzIGluIHRoZSBET00KICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0YWcpICE9PSBudWxsCiAgICApCiAgKTsKICBjb25zdCBjb21wb25lbnRzID0gc3RhdGUuaW50ZXJuYWwuY29tcG9uZW50czsKICBmb3IgKGNvbnN0IFt0YWdOYW1lLCBjb2RlXSBvZiBjb21wb25lbnRzLmVudHJpZXMoKSkgewogICAgaWYgKGNvZGUgPT09IG51bGwgfHwgIXRhZ3NJbkRvbS5pbmNsdWRlcyh0YWdOYW1lKSkgY29udGludWU7CiAgICBjb25zdCBlbGVtZW50cyA9IEFycmF5LmZyb20oCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwodGFnTmFtZSkKICAgICkuZmlsdGVyKChlbCkgPT4gaXNCb3JlZChlbCkpOwogICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICBjb250aW51ZTsKICAgIH0KICAgIGVsZW1lbnRzLmZvckVhY2goKGNvbXBvbmVudENsYXNzLCBpbmRleCkgPT4gewogICAgICBjb2RlKHN0YXRlLCB7IGluZGV4LCBuYW1lOiB0YWdOYW1lLCBkYXRhOiB2b2lkIDAgfSkoCiAgICAgICAgY29tcG9uZW50Q2xhc3MKICAgICAgKTsKICAgIH0pOwogIH0KICByZXR1cm47Cn0KZnVuY3Rpb24gY3JlYXRlQW5kUnVuQ29kZShuYW1lLCBzdGF0ZSwgZGV0YWlsKSB7CiAgY29uc3QgY29kZSA9IHN0YXRlLmludGVybmFsLmNvbXBvbmVudHMuZ2V0KG5hbWUpOwogIGlmIChjb2RlKSB7CiAgICBjb25zdCBpbmZvID0geyAuLi5kZXRhaWwsIHRhZ05hbWU6IG5hbWUgfTsKICAgIHJldHVybiBjcmVhdGVDb21wb25lbnQobmFtZSwgY29kZShzdGF0ZSwgaW5mbykpOwogIH0KICByZXR1cm4gY3JlYXRlQ29tcG9uZW50KG5hbWUpOwp9CgovLyBzcmMvaW5kZXgudHMKaW5pdF9kZWJ1ZygpOwppbml0X2NvbnNvbGVfYXBpKCk7CmluaXRfaW5zaWRlX291dCgpOwppbml0X2xsbSgpOwppbml0X2RlYnVnKCk7CmluaXRfdmVyc2lvbigpOwppbml0X3ZlcnNpb24oKTsKdmFyIGhhc0xvZ2dlZFZlcnNpb24gPSBmYWxzZTsKdmFyIGJvcmVET00gPSB7CiAgLyoqIE1hcCBvZiBhbGwgY3VycmVudCBlcnJvcnMgYnkgY29tcG9uZW50IG5hbWUgKi8KICBnZXQgZXJyb3JzKCkgewogICAgcmV0dXJuIGRlYnVnQVBJLmVycm9yczsKICB9LAogIC8qKiBNb3N0IHJlY2VudCBlcnJvciBjb250ZXh0ICovCiAgZ2V0IGxhc3RFcnJvcigpIHsKICAgIHJldHVybiBkZWJ1Z0FQSS5sYXN0RXJyb3I7CiAgfSwKICAvKiogUmUtcmVuZGVyIGEgc3BlY2lmaWMgY29tcG9uZW50IG9yIHRoZSBsYXN0IGVycm9yZWQgb25lICovCiAgcmVyZW5kZXI6IGRlYnVnQVBJLnJlcmVuZGVyLAogIC8qKiBDbGVhciBlcnJvciBzdGF0ZSBmb3IgYSBjb21wb25lbnQgKi8KICBjbGVhckVycm9yOiBkZWJ1Z0FQSS5jbGVhckVycm9yLAogIC8qKiBFeHBvcnQgc3RhdGUgc25hcHNob3QgKi8KICBleHBvcnQ6IGRlYnVnQVBJLmV4cG9ydCwKICAvKiogQ3VycmVudCBkZWJ1ZyBjb25maWd1cmF0aW9uIChyZWFkLW9ubHkpICovCiAgZ2V0IGNvbmZpZygpIHsKICAgIHJldHVybiBkZWJ1Z0FQSS5jb25maWc7CiAgfSwKICAvKiogRnJhbWV3b3JrIHZlcnNpb24gKi8KICB2ZXJzaW9uOiBWRVJTSU9OLAogIC8vIENvbnNvbGUgQVBJIChQaGFzZSAyKQogIC8qKiBEZWZpbmUgYSBuZXcgY29tcG9uZW50IGF0IHJ1bnRpbWUgKi8KICBkZWZpbmU6IGNvbnNvbGVBUEkuZGVmaW5lLAogIC8qKiBHZXQgbGl2ZSBhY2Nlc3MgdG8gYSBjb21wb25lbnQncyBpbnRlcm5hbHMgKi8KICBvcGVyYXRlOiBjb25zb2xlQVBJLm9wZXJhdGUsCiAgLyoqIEV4cG9ydCBjb21wb25lbnQgc3RhdGUgYW5kIHRlbXBsYXRlICovCiAgZXhwb3J0Q29tcG9uZW50OiBjb25zb2xlQVBJLmV4cG9ydENvbXBvbmVudCwKICAvLyBJbnNpZGUtT3V0IEFQSSAoUGhhc2UgMykKICAvKiogTWFwIG9mIG1pc3NpbmcgZnVuY3Rpb24gY2FsbHMgYnkgZnVuY3Rpb24gbmFtZSAqLwogIGdldCBtaXNzaW5nRnVuY3Rpb25zKCkgewogICAgcmV0dXJuIGluc2lkZU91dEFQSS5taXNzaW5nRnVuY3Rpb25zOwogIH0sCiAgLyoqIE1vc3QgcmVjZW50IG1pc3NpbmcgZnVuY3Rpb24gY29udGV4dCAqLwogIGdldCBsYXN0TWlzc2luZygpIHsKICAgIHJldHVybiBpbnNpZGVPdXRBUEkubGFzdE1pc3Npbmc7CiAgfSwKICAvKiogRGVmaW5lIGEgaGVscGVyIGZ1bmN0aW9uIGF2YWlsYWJsZSB0byBhbGwgcmVuZGVyIGZ1bmN0aW9ucyAqLwogIGRlZmluZUhlbHBlcjogaW5zaWRlT3V0QVBJLmRlZmluZUhlbHBlciwKICAvKiogR2V0IGFsbCBkZWZpbmVkIGhlbHBlcnMgKi8KICBnZXQgaGVscGVycygpIHsKICAgIHJldHVybiBpbnNpZGVPdXRBUEkuaGVscGVyczsKICB9LAogIC8qKiBDbGVhciBhIGhlbHBlciBkZWZpbml0aW9uICovCiAgY2xlYXJIZWxwZXI6IGluc2lkZU91dEFQSS5jbGVhckhlbHBlciwKICAvKiogQ2xlYXIgYWxsIG1pc3NpbmcgZnVuY3Rpb24gcmVjb3JkcyAqLwogIGNsZWFyTWlzc2luZ0Z1bmN0aW9uczogaW5zaWRlT3V0QVBJLmNsZWFyTWlzc2luZ0Z1bmN0aW9ucywKICAvKiogTWFwIG9mIGluZmVycmVkIHRlbXBsYXRlcyBieSB0YWcgbmFtZSAqLwogIGdldCBpbmZlcnJlZFRlbXBsYXRlcygpIHsKICAgIHJldHVybiBpbnNpZGVPdXRBUEkuaW5mZXJyZWRUZW1wbGF0ZXM7CiAgfSwKICAvKiogTWFudWFsbHkgaW5mZXIgdGVtcGxhdGUgZm9yIGEgdGFnICovCiAgaW5mZXJUZW1wbGF0ZTogaW5zaWRlT3V0QVBJLmluZmVyVGVtcGxhdGUsCiAgLy8gTExNIEludGVncmF0aW9uIEFQSSAoUGhhc2UgNCkKICAvKiogTExNIGNvbnRleHQgYW5kIG91dHB1dCB1dGlsaXRpZXMgKi8KICBsbG06IGxsbUFQSQp9OwppZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIpIHsKICB3aW5kb3cuYm9yZURPTSA9IGJvcmVET007Cn0KYXN5bmMgZnVuY3Rpb24gaW5mbGljdEJvcmVET00oc3RhdGUsIGNvbXBvbmVudHNMb2dpYywgY29uZmlnKSB7CiAgaWYgKGNvbmZpZz8uZGVidWcgIT09IHZvaWQgMCkgewogICAgc2V0RGVidWdDb25maWcoY29uZmlnLmRlYnVnKTsKICB9CiAgaWYgKCFoYXNMb2dnZWRWZXJzaW9uICYmIGlzRGVidWdFbmFibGVkKCJ2ZXJzaW9uTG9nIikpIHsKICAgIGhhc0xvZ2dlZFZlcnNpb24gPSB0cnVlOwogICAgaWYgKHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgY29uc29sZS5pbmZvID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGNvbnNvbGUuaW5mbyhgW2JvcmVET01dIHYke1ZFUlNJT059YCk7CiAgICB9CiAgfQogIGNvbnN0IHJlZ2lzdGVyZWROYW1lcyA9IHNlYXJjaEZvckNvbXBvbmVudHMoKTsKICBjb25zdCBjb21wb25lbnRzQ29kZSA9IGF3YWl0IGR5bmFtaWNJbXBvcnRTY3JpcHRzKHJlZ2lzdGVyZWROYW1lcyk7CiAgaWYgKGNvbXBvbmVudHNMb2dpYykgewogICAgZm9yIChjb25zdCB0YWdOYW1lIG9mIE9iamVjdC5rZXlzKGNvbXBvbmVudHNMb2dpYykpIHsKICAgICAgY29tcG9uZW50c0NvZGUuc2V0KHRhZ05hbWUsIGNvbXBvbmVudHNMb2dpY1t0YWdOYW1lXSk7CiAgICB9CiAgfQogIGNvbnN0IGluaXRpYWxTdGF0ZSA9IHsKICAgIGFwcDogc3RhdGUsCiAgICBpbnRlcm5hbDogewogICAgICBjdXN0b21UYWdzOiByZWdpc3RlcmVkTmFtZXMsCiAgICAgIGNvbXBvbmVudHM6IGNvbXBvbmVudHNDb2RlLAogICAgICB1cGRhdGVzOiB7CiAgICAgICAgcGF0aDogW10sCiAgICAgICAgdmFsdWU6IFtdLAogICAgICAgIHJhZjogdm9pZCAwLAogICAgICAgIHN1YnNjcmliZXJzOiAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpCiAgICAgIH0KICAgIH0KICB9OwogIGNvbnN0IHByb3hpZmllZFN0YXRlID0gcHJveGlmeShpbml0aWFsU3RhdGUpOwogIHByb3hpZmllZFN0YXRlLmludGVybmFsLnVwZGF0ZXMucGF0aCA9IFtdOwogIHByb3hpZmllZFN0YXRlLmludGVybmFsLnVwZGF0ZXMudmFsdWUgPSBbXTsKICBpZiAocHJveGlmaWVkU3RhdGUuaW50ZXJuYWwudXBkYXRlcy5yYWYpIHsKICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHByb3hpZmllZFN0YXRlLmludGVybmFsLnVwZGF0ZXMucmFmKTsKICAgIHByb3hpZmllZFN0YXRlLmludGVybmFsLnVwZGF0ZXMucmFmID0gdm9pZCAwOwogIH0KICBzZXRDdXJyZW50QXBwU3RhdGUocHJveGlmaWVkU3RhdGUsIHdlYkNvbXBvbmVudCwgcmVnaXN0ZXJDb21wb25lbnQpOwogIHNldFZhbGlkYXRpb25BcHBTdGF0ZShwcm94aWZpZWRTdGF0ZSk7CiAgcnVuQ29tcG9uZW50c0luaXRpYWxpemVyKHByb3hpZmllZFN0YXRlKTsKICBvYnNlcnZlVW5kZWZpbmVkRWxlbWVudHMoKTsKICByZXR1cm4gcHJveGlmaWVkU3RhdGUuYXBwOwp9CmZ1bmN0aW9uIHdlYkNvbXBvbmVudChpbml0RnVuY3Rpb24pIHsKICBsZXQgaXNJbml0aWFsaXplZCA9IG51bGw7CiAgbGV0IHJlbmRlckZ1bmN0aW9uOwogIGNvbnN0IHJlc3VsdCA9IChhcHBTdGF0ZSwgZGV0YWlsKSA9PiAoYykgPT4gewogICAgY29uc3QgeyBpbnRlcm5hbCwgYXBwIH0gPSBhcHBTdGF0ZTsKICAgIGxldCBsb2cgPSBbXTsKICAgIGNvbnN0IHN0YXRlID0gY3JlYXRlU3RhdGVBY2Nlc3NvcihhcHAsIGxvZyk7CiAgICBjb25zdCByZWZzID0gY3JlYXRlUmVmc0FjY2Vzc29yKGMpOwogICAgY29uc3Qgc2xvdHMgPSBjcmVhdGVTbG90c0FjY2Vzc29yKGMpOwogICAgY29uc3Qgb24gPSBjcmVhdGVFdmVudHNIYW5kbGVyKGMsIGFwcCwgZGV0YWlsKTsKICAgIGlmIChpc0luaXRpYWxpemVkICE9PSBjKSB7CiAgICAgIGNvbnN0IHVwZGF0ZVN1YnNjcmliZXJzID0gYXN5bmMgKCkgPT4gewogICAgICAgIGNvbnN0IHN1YnNjcmliZXJzID0gaW50ZXJuYWwudXBkYXRlcy5zdWJzY3JpYmVyczsKICAgICAgICBmb3IgKGxldCBwYXRoIG9mIGxvZykgewogICAgICAgICAgY29uc3QgZnVuY3Rpb25zID0gc3Vic2NyaWJlcnMuZ2V0KHBhdGgpOwogICAgICAgICAgaWYgKGZ1bmN0aW9ucykgewogICAgICAgICAgICBpZiAoIWZ1bmN0aW9ucy5pbmNsdWRlcyhyZW5kZXJGdW5jdGlvbikpIHsKICAgICAgICAgICAgICBmdW5jdGlvbnMucHVzaChyZW5kZXJGdW5jdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN1YnNjcmliZXJzLnNldChwYXRoLCBbcmVuZGVyRnVuY3Rpb25dKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIGxldCB1c2VyRGVmaW5lZFJlbmRlcmVyOwogICAgICB0cnkgewogICAgICAgIHVzZXJEZWZpbmVkUmVuZGVyZXIgPSBpbml0RnVuY3Rpb24oewogICAgICAgICAgZGV0YWlsLAogICAgICAgICAgc3RhdGUsCiAgICAgICAgICByZWZzLAogICAgICAgICAgb24sCiAgICAgICAgICBzZWxmOiBjCiAgICAgICAgfSk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc3QgZXJyID0gZXJyb3I7CiAgICAgICAgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgICAgICAgIGxvZ0luaXRFcnJvcihkZXRhaWw/Lm5hbWUgPz8gYy50YWdOYW1lLnRvTG93ZXJDYXNlKCksIGVycik7CiAgICAgICAgfQogICAgICAgIHVzZXJEZWZpbmVkUmVuZGVyZXIgPSAoKSA9PiB7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZW5kZXJGdW5jdGlvbiA9IChyZW5kZXJTdGF0ZSkgPT4gewogICAgICAgIGNvbnN0IGNvbXBvbmVudE5hbWUgPSBkZXRhaWw/Lm5hbWUgPz8gYy50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgY29uc3QgaGVscGVycyA9IGNyZWF0ZVJlbmRlckhlbHBlcnMoCiAgICAgICAgICBjb21wb25lbnROYW1lLAogICAgICAgICAgYywKICAgICAgICAgICgpID0+IHJlbmRlckZ1bmN0aW9uKHJlbmRlclN0YXRlKQogICAgICAgICk7CiAgICAgICAgaWYgKGlzRGVidWdFbmFibGVkKCJlcnJvckJvdW5kYXJ5IikpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHVzZXJEZWZpbmVkUmVuZGVyZXIoewogICAgICAgICAgICAgIHN0YXRlOiByZW5kZXJTdGF0ZSwKICAgICAgICAgICAgICByZWZzLAogICAgICAgICAgICAgIHNsb3RzLAogICAgICAgICAgICAgIHNlbGY6IGMsCiAgICAgICAgICAgICAgZGV0YWlsLAogICAgICAgICAgICAgIG1ha2VDb21wb25lbnQ6ICh0YWcsIG9wdHMpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVBbmRSdW5Db2RlKHRhZywgYXBwU3RhdGUsIG9wdHM/LmRldGFpbCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBoZWxwZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB1cGRhdGVTdWJzY3JpYmVycygpOwogICAgICAgICAgICBjbGVhckNvbXBvbmVudEVycm9yTWFyayhjKTsKICAgICAgICAgICAgY2xlYXJFcnJvcihjb21wb25lbnROYW1lKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGNvbnN0IGVyciA9IGVycm9yOwogICAgICAgICAgICBjb25zdCBjdHggPSB7CiAgICAgICAgICAgICAgY29tcG9uZW50OiBjb21wb25lbnROYW1lLAogICAgICAgICAgICAgIGVsZW1lbnQ6IGMsCiAgICAgICAgICAgICAgZXJyb3I6IGVyciwKICAgICAgICAgICAgICBzdGF0ZTogYXBwLAogICAgICAgICAgICAgIC8vIFdyaXRlIHByb3h5IC0gTVVUQUJMRQogICAgICAgICAgICAgIHJlZnMsCiAgICAgICAgICAgICAgc2xvdHMsCiAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgIHJlcmVuZGVyOiAoKSA9PiByZW5kZXJGdW5jdGlvbihyZW5kZXJTdGF0ZSksCiAgICAgICAgICAgICAgc3RhY2s6IGVyci5zdGFjayA/PyAiIgogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICAgICAgICAgIGxvZ0Vycm9yKGN0eCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbG9nRXJyb3JNaW5pbWFsKGNvbXBvbmVudE5hbWUsIGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXhwb3NlR2xvYmFscyhjdHgpOwogICAgICAgICAgICBzdG9yZUVycm9yKGN0eCk7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRFcnJvcihjKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdXNlckRlZmluZWRSZW5kZXJlcih7CiAgICAgICAgICAgIHN0YXRlOiByZW5kZXJTdGF0ZSwKICAgICAgICAgICAgcmVmcywKICAgICAgICAgICAgc2xvdHMsCiAgICAgICAgICAgIHNlbGY6IGMsCiAgICAgICAgICAgIGRldGFpbCwKICAgICAgICAgICAgbWFrZUNvbXBvbmVudDogKHRhZywgb3B0cykgPT4gewogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVBbmRSdW5Db2RlKHRhZywgYXBwU3RhdGUsIG9wdHM/LmRldGFpbCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGhlbHBlcnMKICAgICAgICAgIH0pOwogICAgICAgICAgdXBkYXRlU3Vic2NyaWJlcnMoKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHN0b3JlQ29tcG9uZW50Q29udGV4dChjLCB7CiAgICAgICAgc3RhdGU6IGFwcCwKICAgICAgICByZWZzLAogICAgICAgIHNsb3RzLAogICAgICAgIHNlbGY6IGMsCiAgICAgICAgZGV0YWlsLAogICAgICAgIHJlcmVuZGVyOiAoKSA9PiByZW5kZXJGdW5jdGlvbihhcHApCiAgICAgIH0pOwogICAgfQogICAgcmVuZGVyRnVuY3Rpb24oc3RhdGUpOwogICAgaXNJbml0aWFsaXplZCA9IGM7CiAgfTsKICByZXN1bHRbV0VCX0NPTVBPTkVOVF9NQVJLRVJdID0gdHJ1ZTsKICByZXR1cm4gcmVzdWx0Owp9CmV4cG9ydCB7CiAgVkVSU0lPTiwKICBib3JlRE9NLAogIGNsZWFyR2xvYmFscywKICBpbmZsaWN0Qm9yZURPTSwKICBpc0RlYnVnRW5hYmxlZCwKICBxdWVyeUNvbXBvbmVudCwKICByZWdpc3RlckNvbXBvbmVudCwKICBzZXREZWJ1Z0NvbmZpZywKICB3ZWJDb21wb25lbnQKfTsK
`;
var beautify = import_js_beautify.default.html;
var DEFAULT_COMPONENTS_DIR = "components";
var DEFAULT_STATIC_DIR = "src";
var DEFAULT_STATIC_SERVE = "";
var BUILD_DIR = "build";
var serverStarted = false;
var numberOfRefreshes = 0;
function collectMultiValue(value, previous) {
  const next = Array.isArray(previous) ? [...previous] : [];
  next.push(value);
  return next;
}
console.log("## boreDOM CLI options");
console.log(
  "## ",
  "--index <path to default html>",
  "The base HTML file to serve",
  "defaults to ./index.html"
);
console.log(
  "## ",
  "--html <folder>",
  "Folder containing HTML component files",
  'defaults to "./components"'
);
console.log(
  "## ",
  "--static <folder>",
  "Static files folder, all files in here are copied as is",
  'defaults to "./src"'
);
console.log(
  "## ",
  "--static-serve <folder>",
  "Build subfolder used to serve static assets",
  'defaults to "./"'
);
import_commander.program.option("--index <path to file>", "Index file to serve", "index.html").option(
  "--html <folder>",
  "Folder containing HTML component files",
  DEFAULT_COMPONENTS_DIR
).option(
  "--static <folder>",
  "Folder containing static files to be copied as is",
  collectMultiValue,
  [DEFAULT_STATIC_DIR]
).option(
  "--components-serve <folder>",
  "Build subfolder used to serve processed components",
  DEFAULT_COMPONENTS_DIR
).option(
  "--static-serve <folder>",
  "Build subfolder used to serve static assets",
  DEFAULT_STATIC_SERVE
);
var isTestMode = Boolean(process.env.BOREDOM_CLI_TEST_MODE);
if (isTestMode) {
  import_commander.program.parse([], { from: "user" });
} else {
  import_commander.program.parse(process.argv);
}
var options = import_commander.program.opts();
function sanitizeServeInput(value) {
  const normalizedSlashes = value.replace(/\\+/g, "/").trim();
  if (!normalizedSlashes) {
    return { fsPath: "", urlPath: "" };
  }
  if (["/", "./"].includes(normalizedSlashes)) {
    return { fsPath: "", urlPath: "/" };
  }
  let working = normalizedSlashes;
  while (working.startsWith("./")) {
    working = working.slice(2);
  }
  const isAbsolute = working.startsWith("/");
  if (isAbsolute) {
    working = working.replace(/^\/+/, "");
  }
  working = working.replace(/\/+$/, "");
  const fsPath = working;
  if (!fsPath) {
    return { fsPath: "", urlPath: isAbsolute ? "/" : "" };
  }
  const urlPath = isAbsolute ? `/${fsPath}` : fsPath;
  return { fsPath, urlPath };
}
function normalizeServePath(input, fallback) {
  if (typeof input === "undefined" || input === null) {
    return sanitizeServeInput(fallback);
  }
  const trimmed = String(input).trim();
  if (!trimmed) {
    return sanitizeServeInput(fallback);
  }
  return sanitizeServeInput(trimmed);
}
function buildRelativeServePath(base, ...segments) {
  const cleanSegments = segments.filter(Boolean).map((segment) => {
    return segment.replace(/^\/+/, "").replace(/\/+$/, "");
  });
  const ensureModuleRelative = (candidate) => {
    if (!candidate) {
      return candidate;
    }
    if (candidate.startsWith("/") || candidate.startsWith("./") || candidate.startsWith("../")) {
      return candidate;
    }
    return `./${candidate}`;
  };
  if (!base || base === ".") {
    return ensureModuleRelative(cleanSegments.join("/"));
  }
  if (base === "/") {
    const joined = cleanSegments.join("/");
    return joined ? `/${joined}` : "/";
  }
  const cleanBase = base.replace(/\/+$/, "");
  return ensureModuleRelative([cleanBase, ...cleanSegments].join("/"));
}
var componentsServePath;
var staticServePath;
var componentsServeUrlPath;
var staticServeUrlPath;
function setServePaths(currentOptions = options) {
  const componentsPaths = normalizeServePath(
    currentOptions.componentsServe,
    "components"
  );
  const staticPaths = normalizeServePath(
    currentOptions.staticServe,
    DEFAULT_STATIC_SERVE
  );
  componentsServePath = componentsPaths.fsPath;
  componentsServeUrlPath = componentsPaths.urlPath;
  staticServePath = staticPaths.fsPath;
  staticServeUrlPath = staticPaths.urlPath;
  return {
    componentsServePath,
    componentsServeUrlPath,
    staticServePath,
    staticServeUrlPath
  };
}
function getServePaths() {
  return {
    componentsServePath,
    componentsServeUrlPath,
    staticServePath,
    staticServeUrlPath
  };
}
setServePaths();
async function copyStatic() {
  const staticFolders = Array.isArray(options.static) ? options.static : [options.static].filter(Boolean);
  if (staticFolders.length === 0) {
    return;
  }
  for (const folder of staticFolders) {
    const staticDir = import_path.default.resolve(folder);
    if (await import_fs_extra.default.pathExists(staticDir)) {
      await import_fs_extra.default.copy(staticDir, import_path.default.join(BUILD_DIR, staticServePath), {
        overwrite: true,
        errorOnExist: false
      });
      console.log(`Static folder copied from ${folder}.`);
    }
  }
}
async function copyBoreDOM() {
  return import_fs_extra.default.writeFile(import_path.default.join(BUILD_DIR, "boreDOM.js"), atob(boredom));
}
async function processComponents() {
  let components = {};
  if (options.html) {
    const htmlFolder = import_path.default.resolve(options.html);
    const htmlFiles = glob.sync("**/*.html", { cwd: htmlFolder });
    for (const file of htmlFiles) {
      const filePath = import_path.default.join(htmlFolder, file);
      const content = await import_fs_extra.default.readFile(filePath, "utf-8");
      const $ = cheerio.load(content, { decodeEntities: false });
      const template = $("template[data-component]");
      if (template.length) {
        const componentName = template.attr("data-component");
        const fullTemplate = $.html(template);
        const componentBuildDir = import_path.default.join(
          BUILD_DIR,
          componentsServePath,
          componentName
        );
        await import_fs_extra.default.ensureDir(componentBuildDir);
        const destHtmlPath = import_path.default.join(
          componentBuildDir,
          `${componentName}.html`
        );
        await import_fs_extra.default.copy(filePath, destHtmlPath);
        const componentDir = import_path.default.dirname(filePath);
        const jsMatch = glob.sync(`**/${componentName}.js`, {
          cwd: componentDir
        });
        const cssMatch = glob.sync(`**/${componentName}.css`, {
          cwd: componentDir
        });
        const hasJS = jsMatch.length > 0;
        if (jsMatch.length > 0) {
          const jsSrc = import_path.default.join(componentDir, jsMatch[0]);
          const destJsPath = import_path.default.join(
            componentBuildDir,
            `${componentName}.js`
          );
          await import_fs_extra.default.copy(jsSrc, destJsPath);
          console.log(`Copied ${componentName}.js to ${componentBuildDir}`);
        }
        const hasCSS = cssMatch.length > 0;
        if (cssMatch.length > 0) {
          const cssSrc = import_path.default.join(componentDir, cssMatch[0]);
          const destCssPath = import_path.default.join(
            componentBuildDir,
            `${componentName}.css`
          );
          await import_fs_extra.default.copy(cssSrc, destCssPath);
          console.log(`Copied ${componentName}.css to ${componentBuildDir}`);
        }
        components[componentName] = {
          templateTag: fullTemplate,
          hasJS,
          hasCSS
        };
      }
    }
  }
  return components;
}
async function updateIndex(components) {
  console.log(
    "Updated index.html with components:\n\n",
    JSON.stringify(components, null, 2)
  );
  const indexPath = import_path.default.resolve(options.index);
  let indexContent = await import_fs_extra.default.readFile(indexPath, "utf-8");
  const $ = cheerio.load(indexContent, { decodeEntities: false });
  $("head").prepend(
    `
  <script type="importmap">{ "imports": {      "@mr_hugo/boredom/dist/boreDOM.full.js": "./boreDOM.js",
       "boredom": "./boreDOM.js"
     } }</script>`
  );
  $("body").append(`
  <script src="boreDOM.js" type="module"></script>`);
  Object.keys(components).forEach((component) => {
    const componentScriptPath = buildRelativeServePath(
      componentsServeUrlPath,
      component,
      `${component}.js`
    );
    const existingComponentScript = $(`script[src*="${component}.js"]`).first();
    const componentCssPath = buildRelativeServePath(
      componentsServeUrlPath,
      component,
      `${component}.css`
    );
    if (components[component].hasJS) {
      if (existingComponentScript.length > 0) {
        existingComponentScript.attr("src", componentScriptPath);
        existingComponentScript.attr("type", "module");
      } else if ($(`script[src="${componentScriptPath}"]`).length === 0) {
        $("body").append(
          `
  <script src="${componentScriptPath}" type="module"></script>`
        );
      }
    }
    if (components[component].hasCSS) {
      const existingComponentStylesheet = $(`link[href*="${component}.css"]`).first();
      if (existingComponentStylesheet.length > 0) {
        existingComponentStylesheet.attr("href", componentCssPath);
      } else if ($(`link[href="${componentCssPath}"]`).length === 0) {
        $("head").append(
          `
  <link rel="stylesheet" href="${componentCssPath}">`
        );
      }
    }
    if ($(`template[data-component="${component}"]`).length === 0) {
      const templateMarkup = `
  ${components[component].templateTag}`;
      const firstScript = $("body > script").first();
      if (firstScript.length > 0) {
        firstScript.before(templateMarkup);
      } else {
        $("body").prepend(templateMarkup);
      }
      console.log(`Injected template for ${component}`);
    }
  });
  $("template[data-component]").each((i, el) => {
    const comp = $(el).attr("data-component");
    if (!components[comp]) {
      $(el).remove();
      console.log(`Removed unused template for ${comp}`);
    }
  });
  const prettyHtml = beautify($.html(), {
    indent_size: 2,
    space_in_empty_paren: true
  });
  const buildIndex = import_path.default.join(BUILD_DIR, "index.html");
  await import_fs_extra.default.outputFile(buildIndex, prettyHtml);
  console.log("Index updated with pretty printed HTML.");
}
async function startServer() {
  if (serverStarted) return;
  function serveFile(req, res, opts) {
    let urlPath = decodeURIComponent(req.url.split(/[?#]/)[0]);
    if (urlPath === "/" || urlPath.endsWith("/")) {
      urlPath = import_path.default.posix.join(urlPath, "index.html");
    }
    const filePath = import_path.default.join(BUILD_DIR, urlPath);
    import_fs_extra.default.pathExists(filePath).then((exists) => {
      if (!exists) {
        res.writeHead(404, { "Content-Type": "text/plain" });
        return res.end("Not Found");
      }
      const contentType = import_mime_types.default.lookup(filePath) || "application/octet-stream";
      res.writeHead(200, { "Content-Type": contentType });
      import_fs_extra.default.createReadStream(filePath).pipe(res);
    }).catch((err) => {
      res.writeHead(500, { "Content-Type": "text/plain" });
      res.end("Internal Server Error");
    });
  }
  const server = import_http.default.createServer((req, res) => {
    return serveFile(req, res, {
      cleanUrls: true,
      public: import_path.default.resolve(BUILD_DIR)
    });
  });
  let port = process.env.PORT || 8080;
  const serverHandler = () => {
    const { port: actualPort } = server.address();
    console.log(`Server running at http://localhost:${actualPort}`);
  };
  server.listen(port, serverHandler);
  server.on("error", (e) => {
    if (e.code === "EADDRINUSE") {
      console.log(
        "\x1B[33m%s\x1B[0m",
        `\u26A0\uFE0F Warning: Port ${port} in use, starting with a OS assigned port.`
      );
      setTimeout(() => {
        server.close();
        server.listen(0);
      }, 1e3);
    }
  });
  serverStarted = true;
}
async function build() {
  await import_fs_extra.default.remove(BUILD_DIR);
  await import_fs_extra.default.ensureDir(BUILD_DIR);
  await copyStatic();
  await copyBoreDOM();
  const components = await processComponents();
  await updateIndex(components);
}
async function watchFiles() {
  const pathsToWatch = [];
  if (options.index) {
    pathsToWatch.push(import_path.default.resolve(options.index));
  }
  if (options.html) {
    pathsToWatch.push(import_path.default.resolve(options.html));
  }
  const staticFolders = Array.isArray(options.static) ? options.static : [options.static].filter(Boolean);
  for (const folder of staticFolders) {
    const staticDir = import_path.default.resolve(folder);
    if (await import_fs_extra.default.pathExists(staticDir)) {
      pathsToWatch.push(staticDir);
    }
  }
  console.log("Watching for file changes in:", pathsToWatch);
  const watcher = import_chokidar.default.watch(pathsToWatch, { ignoreInitial: true });
  let rebuildTimeout;
  watcher.on("all", (event, filePath) => {
    console.log(`Detected ${event} on ${filePath}. Scheduling rebuild...`);
    if (rebuildTimeout) clearTimeout(rebuildTimeout);
    rebuildTimeout = setTimeout(() => {
      build().then(() => {
        console.log(
          `#${++numberOfRefreshes} - ${(/* @__PURE__ */ new Date()).toISOString()} - Build refreshed.`
        );
      }).catch((err) => console.error("Error during rebuild:", err));
    }, 100);
  });
}
async function main() {
  console.log("The file used as the base for HTML is:", options.index);
  const indexPath = import_path.default.join(process.cwd(), options.index);
  import_fs_extra.default.ensureFile(indexPath, (err) => {
    if (err) {
      console.log(
        "\x1B[31m%s\x1B[0m",
        `\u274C Error: The file "${indexPath}" was not found.
Please specify a location for it with "--index"`
      );
      process.exit(1);
    }
  });
  await build();
  startServer();
  await watchFiles();
}
if (!isTestMode) {
  main().catch((err) => {
    console.error(err);
    process.exit(1);
  });
}
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  BUILD_DIR,
  build,
  buildRelativeServePath,
  copyBoreDOM,
  getServePaths,
  normalizeServePath,
  options,
  processComponents,
  setServePaths,
  updateIndex
});
