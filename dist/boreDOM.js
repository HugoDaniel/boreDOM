#!/usr/bin/env node
"use strict";
var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
  // If the importer is in node compatibility mode or this is not an ESM
  // file that has been converted to a CommonJS file using a Babel-
  // compatible transform (i.e. "__esModule" has not been set), then set
  // "default" to the CommonJS "module.exports" for node compatibility.
  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
  mod
));
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// boreDOMCLI/generated_cli.js
var generated_cli_exports = {};
__export(generated_cli_exports, {
  BUILD_DIR: () => BUILD_DIR,
  build: () => build,
  buildRelativeServePath: () => buildRelativeServePath,
  copyBoreDOM: () => copyBoreDOM,
  getServePaths: () => getServePaths,
  normalizeServePath: () => normalizeServePath,
  options: () => options,
  processComponents: () => processComponents,
  setServePaths: () => setServePaths,
  updateIndex: () => updateIndex
});
module.exports = __toCommonJS(generated_cli_exports);
var import_fs_extra = __toESM(require("fs-extra"));
var import_mime_types = __toESM(require("mime-types"));
var import_path = __toESM(require("path"));
var glob = __toESM(require("glob"));
var cheerio = __toESM(require("cheerio"));
var import_commander = require("commander");
var import_http = __toESM(require("http"));
var import_finalhandler = __toESM(require("finalhandler"));
var import_js_beautify = __toESM(require("js-beautify"));
var import_chokidar = __toESM(require("chokidar"));
var import_serve_handler = __toESM(require("serve-handler"));
var boredom = `
dmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcE5hbWVzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXM7CnZhciBfX2VzbSA9IChmbiwgcmVzKSA9PiBmdW5jdGlvbiBfX2luaXQoKSB7CiAgcmV0dXJuIGZuICYmIChyZXMgPSAoMCwgZm5bX19nZXRPd25Qcm9wTmFtZXMoZm4pWzBdXSkoZm4gPSAwKSksIHJlczsKfTsKdmFyIF9fZXhwb3J0ID0gKHRhcmdldCwgYWxsKSA9PiB7CiAgZm9yICh2YXIgbmFtZSBpbiBhbGwpCiAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwp9OwoKLy8gc3JjL2NvbnNvbGUtYXBpLnRzCmZ1bmN0aW9uIHNldEN1cnJlbnRBcHBTdGF0ZShzdGF0ZSwgd2ViQ29tcG9uZW50Rm4sIHJlZ2lzdGVyQ29tcG9uZW50Rm4pIHsKICBjdXJyZW50QXBwU3RhdGUgPSBzdGF0ZTsKICBpZiAod2ViQ29tcG9uZW50Rm4pIHN0b3JlZFdlYkNvbXBvbmVudCA9IHdlYkNvbXBvbmVudEZuOwogIGlmIChyZWdpc3RlckNvbXBvbmVudEZuKSBzdG9yZWRSZWdpc3RlckNvbXBvbmVudCA9IHJlZ2lzdGVyQ29tcG9uZW50Rm47Cn0KZnVuY3Rpb24gZ2V0Q3VycmVudEFwcFN0YXRlKCkgewogIHJldHVybiBjdXJyZW50QXBwU3RhdGU7Cn0KZnVuY3Rpb24gc3RvcmVDb21wb25lbnRDb250ZXh0KGVsZW1lbnQsIGNvbnRleHQyKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJhcGkiKSkgcmV0dXJuOwogIGNvbXBvbmVudENvbnRleHRzLnNldChlbGVtZW50LCBjb250ZXh0Mik7Cn0KZnVuY3Rpb24gaXNXZWJDb21wb25lbnRSZXN1bHQoZm4pIHsKICByZXR1cm4gdHlwZW9mIGZuID09PSAiZnVuY3Rpb24iICYmIGZuW1dFQl9DT01QT05FTlRfTUFSS0VSXSA9PT0gdHJ1ZTsKfQpmdW5jdGlvbiBkZWZpbmUodGFnTmFtZSwgdGVtcGxhdGUsIGxvZ2ljKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHsKICAgIGNvbnNvbGUud2FybigiW2JvcmVET01dIGRlZmluZSgpIGlzIG5vdCBhdmFpbGFibGUgaW4gcHJvZHVjdGlvbiBidWlsZCIpOwogICAgcmV0dXJuIGZhbHNlOwogIH0KICBpZiAoIWlzRGVidWdFbmFibGVkKCJhcGkiKSkgewogICAgY29uc29sZS53YXJuKCJbYm9yZURPTV0gZGVmaW5lKCkgaXMgZGlzYWJsZWQgKGRlYnVnLmFwaSBpcyBmYWxzZSkiKTsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKCFjdXJyZW50QXBwU3RhdGUpIHsKICAgIHRocm93IG5ldyBFcnJvcigiW2JvcmVET01dIENhbm5vdCBkZWZpbmUgY29tcG9uZW50IGJlZm9yZSBpbmZsaWN0Qm9yZURPTSgpIik7CiAgfQogIGlmICghdGFnTmFtZS5pbmNsdWRlcygiLSIpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYFtib3JlRE9NXSBJbnZhbGlkIHRhZyBuYW1lICIke3RhZ05hbWV9IjogbXVzdCBjb250YWluIGEgaHlwaGVuYCk7CiAgfQogIGlmIChjdXN0b21FbGVtZW50cy5nZXQodGFnTmFtZSkpIHsKICAgIHRocm93IG5ldyBFcnJvcihgW2JvcmVET01dIENvbXBvbmVudCAiJHt0YWdOYW1lfSIgaXMgYWxyZWFkeSBkZWZpbmVkYCk7CiAgfQogIGlmICghc3RvcmVkV2ViQ29tcG9uZW50IHx8ICFzdG9yZWRSZWdpc3RlckNvbXBvbmVudCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJbYm9yZURPTV0gQ29uc29sZSBBUEkgbm90IGluaXRpYWxpemVkLiBDYWxsIGluZmxpY3RCb3JlRE9NKCkgZmlyc3QuIik7CiAgfQogIGNvbnN0IGFwcFN0YXRlID0gY3VycmVudEFwcFN0YXRlOwogIGNvbnN0IHdlYkNvbXBvbmVudEZuID0gc3RvcmVkV2ViQ29tcG9uZW50OwogIGNvbnN0IHJlZ2lzdGVyQ29tcG9uZW50Rm4gPSBzdG9yZWRSZWdpc3RlckNvbXBvbmVudDsKICBjb25zdCB0ZW1wbGF0ZUVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiKTsKICB0ZW1wbGF0ZUVsLmlubmVySFRNTCA9IHRlbXBsYXRlOwogIHRlbXBsYXRlRWwuc2V0QXR0cmlidXRlKCJkYXRhLWNvbXBvbmVudCIsIHRhZ05hbWUpOwogIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGVtcGxhdGVFbCk7CiAgY29uc3QgY29tcG9uZW50TG9naWMgPSBpc1dlYkNvbXBvbmVudFJlc3VsdChsb2dpYykgPyBsb2dpYyA6IHdlYkNvbXBvbmVudEZuKGxvZ2ljKTsKICBhcHBTdGF0ZS5pbnRlcm5hbC5jb21wb25lbnRzLnNldCh0YWdOYW1lLCBjb21wb25lbnRMb2dpYyk7CiAgYXBwU3RhdGUuaW50ZXJuYWwuY3VzdG9tVGFncy5wdXNoKHRhZ05hbWUpOwogIHJlZ2lzdGVyQ29tcG9uZW50Rm4odGFnTmFtZSk7CiAgaW5pdGlhbGl6ZUV4aXN0aW5nRWxlbWVudHModGFnTmFtZSwgY29tcG9uZW50TG9naWMpOwogIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICBjb25zb2xlLmxvZygKICAgICAgIiVjXHUyNzA1IGJvcmVET006IERlZmluZWQgJWM8JXM+IiwKICAgICAgImNvbG9yOiAjMjdhZTYwOyBmb250LXdlaWdodDogYm9sZCIsCiAgICAgICJjb2xvcjogIzRlY2RjNDsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgICB0YWdOYW1lCiAgICApOwogIH0KICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBpbml0aWFsaXplRXhpc3RpbmdFbGVtZW50cyh0YWdOYW1lLCBsb2dpYykgewogIGlmICghY3VycmVudEFwcFN0YXRlKSByZXR1cm47CiAgY29uc3QgZWxlbWVudHMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwodGFnTmFtZSkpOwogIGNvbnN0IGZhaWxlZENvdW50ID0geyBjb3VudDogMCB9OwogIGVsZW1lbnRzLmZvckVhY2goKGVsZW0sIGluZGV4KSA9PiB7CiAgICBpZiAoZWxlbSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ICYmICJyZW5kZXJDYWxsYmFjayIgaW4gZWxlbSkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IGRldGFpbCA9IHsgaW5kZXgsIG5hbWU6IHRhZ05hbWUsIGRhdGE6IHZvaWQgMCB9OwogICAgICAgIGNvbnN0IHJlbmRlckNhbGxiYWNrID0gbG9naWMoY3VycmVudEFwcFN0YXRlLCBkZXRhaWwpOwogICAgICAgIGVsZW0ucmVuZGVyQ2FsbGJhY2sgPSByZW5kZXJDYWxsYmFjazsKICAgICAgICByZW5kZXJDYWxsYmFjayhlbGVtKTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBmYWlsZWRDb3VudC5jb3VudCsrOwogICAgICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKAogICAgICAgICAgICBgW2JvcmVET01dIEZhaWxlZCB0byBpbml0aWFsaXplIDwke3RhZ05hbWV9PiBpbnN0YW5jZSAke2luZGV4fTpgLAogICAgICAgICAgICBlcnJvcgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKICBpZiAoZmFpbGVkQ291bnQuY291bnQgPiAwICYmIGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgIGNvbnNvbGUud2FybigKICAgICAgYFtib3JlRE9NXSAke2ZhaWxlZENvdW50LmNvdW50fSBvZiAke2VsZW1lbnRzLmxlbmd0aH0gPCR7dGFnTmFtZX0+IGluc3RhbmNlcyBmYWlsZWQgdG8gaW5pdGlhbGl6ZWAKICAgICk7CiAgfQp9CmZ1bmN0aW9uIG9wZXJhdGUoc2VsZWN0b3JPckVsZW1lbnQsIGluZGV4ID0gMCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICBjb25zb2xlLndhcm4oIltib3JlRE9NXSBvcGVyYXRlKCkgaXMgbm90IGF2YWlsYWJsZSBpbiBwcm9kdWN0aW9uIGJ1aWxkIik7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoIWlzRGVidWdFbmFibGVkKCJhcGkiKSkgewogICAgY29uc29sZS53YXJuKCJbYm9yZURPTV0gb3BlcmF0ZSgpIGlzIGRpc2FibGVkIChkZWJ1Zy5hcGkgaXMgZmFsc2UpIik7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBsZXQgZWxlbWVudCA9IG51bGw7CiAgaWYgKHR5cGVvZiBzZWxlY3Rvck9yRWxlbWVudCA9PT0gInN0cmluZyIpIHsKICAgIGNvbnN0IGVsZW1lbnRzID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yT3JFbGVtZW50KSkuZmlsdGVyKChlbCkgPT4gZWwgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCk7CiAgICBlbGVtZW50ID0gZWxlbWVudHNbaW5kZXhdID8/IG51bGw7CiAgfSBlbHNlIHsKICAgIGVsZW1lbnQgPSBzZWxlY3Rvck9yRWxlbWVudDsKICB9CiAgaWYgKCFlbGVtZW50KSB7CiAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICBjb25zb2xlLndhcm4oYFtib3JlRE9NXSBvcGVyYXRlKCk6IE5vIGVsZW1lbnQgZm91bmQgZm9yICIke3NlbGVjdG9yT3JFbGVtZW50fSJgKTsKICAgIH0KICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGNvbnN0IGNvbnRleHQyID0gY29tcG9uZW50Q29udGV4dHMuZ2V0KGVsZW1lbnQpOwogIGlmICghY29udGV4dDIpIHsKICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgIGNvbnNvbGUud2FybihgW2JvcmVET01dIG9wZXJhdGUoKTogRWxlbWVudCBpcyBub3QgYSBib3JlRE9NIGNvbXBvbmVudCBvciBub3QgaW5pdGlhbGl6ZWRgKTsKICAgIH0KICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBjb250ZXh0MjsKfQpmdW5jdGlvbiBleHBvcnRDb21wb25lbnQoc2VsZWN0b3IpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgewogICAgY29uc29sZS53YXJuKCJbYm9yZURPTV0gZXhwb3J0Q29tcG9uZW50KCkgaXMgbm90IGF2YWlsYWJsZSBpbiBwcm9kdWN0aW9uIGJ1aWxkIik7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgiYXBpIikpIHsKICAgIGNvbnNvbGUud2FybigiW2JvcmVET01dIGV4cG9ydENvbXBvbmVudCgpIGlzIGRpc2FibGVkIChkZWJ1Zy5hcGkgaXMgZmFsc2UpIik7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgY29uc3QgY3R4ID0gb3BlcmF0ZShzZWxlY3Rvcik7CiAgaWYgKCFjdHgpIHJldHVybiBudWxsOwogIGNvbnN0IHRlbXBsYXRlRWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGB0ZW1wbGF0ZVtkYXRhLWNvbXBvbmVudD0iJHtjdHguZGV0YWlsLm5hbWV9Il1gKTsKICBjb25zdCB0ZW1wbGF0ZUh0bWwgPSB0ZW1wbGF0ZUVsPy5pbm5lckhUTUwgPz8gdm9pZCAwOwogIHRyeSB7CiAgICByZXR1cm4gewogICAgICBjb21wb25lbnQ6IGN0eC5kZXRhaWwubmFtZSwKICAgICAgc3RhdGU6IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoY3R4LnN0YXRlKSksCiAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZUh0bWwsCiAgICAgIHRpbWVzdGFtcDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS50b0lTT1N0cmluZygpCiAgICB9OwogIH0gY2F0Y2ggKGUpIHsKICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgIGNvbnNvbGUud2FybigKICAgICAgICBgW2JvcmVET01dIGV4cG9ydENvbXBvbmVudDogVW5hYmxlIHRvIHNlcmlhbGl6ZSBzdGF0ZSBmb3IgPCR7Y3R4LmRldGFpbC5uYW1lfT46YCwKICAgICAgICBlIGluc3RhbmNlb2YgRXJyb3IgPyBlLm1lc3NhZ2UgOiBlCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gewogICAgICBjb21wb25lbnQ6IGN0eC5kZXRhaWwubmFtZSwKICAgICAgc3RhdGU6ICJbVW5hYmxlIHRvIHNlcmlhbGl6ZSAtIGNvbnRhaW5zIGNpcmN1bGFyIHJlZmVyZW5jZXMgb3IgZnVuY3Rpb25zXSIsCiAgICAgIHRlbXBsYXRlOiB0ZW1wbGF0ZUh0bWwsCiAgICAgIHRpbWVzdGFtcDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS50b0lTT1N0cmluZygpCiAgICB9OwogIH0KfQp2YXIgV0VCX0NPTVBPTkVOVF9NQVJLRVIsIGN1cnJlbnRBcHBTdGF0ZSwgc3RvcmVkV2ViQ29tcG9uZW50LCBzdG9yZWRSZWdpc3RlckNvbXBvbmVudCwgY29tcG9uZW50Q29udGV4dHMsIGNvbnNvbGVBUEk7CnZhciBpbml0X2NvbnNvbGVfYXBpID0gX19lc20oewogICJzcmMvY29uc29sZS1hcGkudHMiKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgaW5pdF9kZWJ1ZygpOwogICAgV0VCX0NPTVBPTkVOVF9NQVJLRVIgPSBTeW1ib2woImJvcmVET00ud2ViQ29tcG9uZW50Iik7CiAgICBjdXJyZW50QXBwU3RhdGUgPSBudWxsOwogICAgc3RvcmVkV2ViQ29tcG9uZW50ID0gbnVsbDsKICAgIHN0b3JlZFJlZ2lzdGVyQ29tcG9uZW50ID0gbnVsbDsKICAgIGNvbXBvbmVudENvbnRleHRzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgICBjb25zb2xlQVBJID0gewogICAgICBkZWZpbmUsCiAgICAgIG9wZXJhdGUsCiAgICAgIGV4cG9ydENvbXBvbmVudAogICAgfTsKICB9Cn0pOwoKLy8gc3JjL2luc2lkZS1vdXQudHMKZnVuY3Rpb24gY3JlYXRlUmVuZGVySGVscGVycyhjb21wb25lbnROYW1lLCBlbGVtZW50LCByZXJlbmRlcikgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICByZXR1cm4ge307CiAgfQogIGlmICghaXNEZWJ1Z0VuYWJsZWQoIm1ldGhvZE1pc3NpbmciKSkgewogICAgcmV0dXJuIHt9OwogIH0KICByZXR1cm4gbmV3IFByb3h5KHt9LCB7CiAgICBnZXQoX3RhcmdldCwgcHJvcCkgewogICAgICBpZiAodHlwZW9mIHByb3AgPT09ICJzeW1ib2wiIHx8IHByb3AgPT09ICJ0aGVuIiB8fCBwcm9wID09PSAidG9KU09OIikgewogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH0KICAgICAgaWYgKHVzZXJEZWZpbmVkSGVscGVycy5oYXMocHJvcCkpIHsKICAgICAgICBjb25zdCBoZWxwZXIgPSB1c2VyRGVmaW5lZEhlbHBlcnMuZ2V0KHByb3ApOwogICAgICAgIHJldHVybiAoLi4uYXJncykgPT4gewogICAgICAgICAgY29uc3QgcmVzdWx0ID0gaGVscGVyKC4uLmFyZ3MpOwogICAgICAgICAgaWYgKHR5cGVvZiBfX0RFQlVHX18gPT09ICJ1bmRlZmluZWQiIHx8IF9fREVCVUdfXykgewogICAgICAgICAgICB0cmFja0Z1bmN0aW9uQ2FsbChwcm9wLCBhcmdzLCByZXN1bHQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiAoLi4uYXJncykgPT4gewogICAgICAgIGNvbnN0IGN0eCA9IHsKICAgICAgICAgIG5hbWU6IHByb3AsCiAgICAgICAgICBhcmdzLAogICAgICAgICAgY29tcG9uZW50OiBjb21wb25lbnROYW1lLAogICAgICAgICAgZWxlbWVudCwKICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSwKICAgICAgICAgIGRlZmluZTogKGltcGwpID0+IHsKICAgICAgICAgICAgZGVmaW5lSGVscGVyKHByb3AsIGltcGwpOwogICAgICAgICAgICByZXJlbmRlcigpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgbG9nTWlzc2luZ0Z1bmN0aW9uKGN0eCk7CiAgICAgICAgc3RvcmVNaXNzaW5nRnVuY3Rpb24oY3R4KTsKICAgICAgICBleHBvc2VNaXNzaW5nR2xvYmFscyhjdHgpOwogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH07CiAgICB9LAogICAgaGFzKF90YXJnZXQsIHByb3ApIHsKICAgICAgcmV0dXJuIHR5cGVvZiBwcm9wID09PSAic3RyaW5nIiAmJiB1c2VyRGVmaW5lZEhlbHBlcnMuaGFzKHByb3ApOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIGRlZmluZUhlbHBlcihuYW1lLCBpbXBsZW1lbnRhdGlvbikgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSByZXR1cm47CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgibWV0aG9kTWlzc2luZyIpKSByZXR1cm47CiAgdXNlckRlZmluZWRIZWxwZXJzLnNldChuYW1lLCBpbXBsZW1lbnRhdGlvbik7CiAgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgIGNvbnNvbGUubG9nKAogICAgICAiJWNcdTI3MDUgYm9yZURPTTogRGVmaW5lZCBoZWxwZXIgJWMlcyIsCiAgICAgICJjb2xvcjogIzI3YWU2MDsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgICAiY29sb3I6ICM5YjU5YjY7IGZvbnQtd2VpZ2h0OiBib2xkIiwKICAgICAgbmFtZQogICAgKTsKICB9Cn0KZnVuY3Rpb24gY2xlYXJIZWxwZXIobmFtZSkgewogIHVzZXJEZWZpbmVkSGVscGVycy5kZWxldGUobmFtZSk7Cn0KZnVuY3Rpb24gY2xlYXJNaXNzaW5nRnVuY3Rpb25zKCkgewogIG1pc3NpbmdGdW5jdGlvbnMuY2xlYXIoKTsKICBsYXN0TWlzc2luZyA9IG51bGw7Cn0KZnVuY3Rpb24gbG9nTWlzc2luZ0Z1bmN0aW9uKGN0eCkgewogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgcmV0dXJuOwogIGNvbnNvbGUubG9nKAogICAgIiVjXHUyNkEwXHVGRTBGIGJvcmVET006IE1pc3NpbmcgZnVuY3Rpb24gJWMlcyVjIGluIDwlcz4iLAogICAgImNvbG9yOiAjZjM5YzEyOyBmb250LXdlaWdodDogYm9sZCIsCiAgICAiY29sb3I6ICM5YjU5YjY7IGZvbnQtd2VpZ2h0OiBib2xkIiwKICAgIGN0eC5uYW1lLAogICAgImNvbG9yOiAjZjM5YzEyIiwKICAgIGN0eC5jb21wb25lbnQKICApOwogIGlmIChjdHguYXJncy5sZW5ndGggPiAwKSB7CiAgICBjb25zb2xlLmxvZygiICAgQXJndW1lbnRzOiIsIGN0eC5hcmdzKTsKICB9CiAgY29uc29sZS5sb2coIiVjXHV7MUY0QTF9IERlZmluZSBpdDoiLCAiY29sb3I6ICMzNDk4ZGI7IGZvbnQtd2VpZ2h0OiBib2xkIik7CiAgY29uc29sZS5sb2coYCAgICRkZWZpbmVNaXNzaW5nKCgke2dlbmVyYXRlQXJnTmFtZXMoY3R4LmFyZ3MpfSkgPT4geyAuLi4gfSlgKTsKICBjb25zb2xlLmxvZygKICAgIGAgICBib3JlRE9NLmRlZmluZUhlbHBlcignJHtjdHgubmFtZX0nLCAoJHtnZW5lcmF0ZUFyZ05hbWVzKGN0eC5hcmdzKX0pID0+IHsgLi4uIH0pYAogICk7Cn0KZnVuY3Rpb24gZ2VuZXJhdGVBcmdOYW1lcyhhcmdzKSB7CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gIiI7CiAgcmV0dXJuIGFyZ3MubWFwKChhcmcsIGkpID0+IHsKICAgIGlmIChhcmcgPT09IG51bGwgfHwgYXJnID09PSB2b2lkIDApIHJldHVybiBgYXJnJHtpfWA7CiAgICBpZiAoQXJyYXkuaXNBcnJheShhcmcpKSByZXR1cm4gIml0ZW1zIjsKICAgIGlmICh0eXBlb2YgYXJnID09PSAib2JqZWN0IikgewogICAgICBpZiAoIm5hbWUiIGluIGFyZyAmJiAiZW1haWwiIGluIGFyZykgcmV0dXJuICJ1c2VyIjsKICAgICAgaWYgKCJpZCIgaW4gYXJnICYmICJ0aXRsZSIgaW4gYXJnKSByZXR1cm4gIml0ZW0iOwogICAgICBpZiAoImlkIiBpbiBhcmcpIHJldHVybiAicmVjb3JkIjsKICAgICAgcmV0dXJuICJkYXRhIjsKICAgIH0KICAgIGlmICh0eXBlb2YgYXJnID09PSAic3RyaW5nIikgcmV0dXJuICJ0ZXh0IjsKICAgIGlmICh0eXBlb2YgYXJnID09PSAibnVtYmVyIikgcmV0dXJuICJjb3VudCI7CiAgICBpZiAodHlwZW9mIGFyZyA9PT0gImJvb2xlYW4iKSByZXR1cm4gImZsYWciOwogICAgcmV0dXJuIGBhcmcke2l9YDsKICB9KS5qb2luKCIsICIpOwp9CmZ1bmN0aW9uIHN0b3JlTWlzc2luZ0Z1bmN0aW9uKGN0eCkgewogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImVycm9ySGlzdG9yeSIpKSByZXR1cm47CiAgY29uc3QgZXhpc3RpbmcgPSBtaXNzaW5nRnVuY3Rpb25zLmdldChjdHgubmFtZSkgfHwgW107CiAgaWYgKGV4aXN0aW5nLmxlbmd0aCA+PSAxMCkgewogICAgZXhpc3Rpbmcuc2hpZnQoKTsKICB9CiAgZXhpc3RpbmcucHVzaChjdHgpOwogIG1pc3NpbmdGdW5jdGlvbnMuc2V0KGN0eC5uYW1lLCBleGlzdGluZyk7CiAgbGFzdE1pc3NpbmcgPSBjdHg7Cn0KZnVuY3Rpb24gZXhwb3NlTWlzc2luZ0dsb2JhbHMoY3R4KSB7CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgiZ2xvYmFscyIpKSByZXR1cm47CiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiKSByZXR1cm47CiAgY29uc3QgdyA9IHdpbmRvdzsKICB3LiRtaXNzaW5nTmFtZSA9IGN0eC5uYW1lOwogIHcuJG1pc3NpbmdBcmdzID0gY3R4LmFyZ3M7CiAgdy4kbWlzc2luZ0NvbXBvbmVudCA9IGN0eC5jb21wb25lbnQ7CiAgdy4kZGVmaW5lTWlzc2luZyA9IGN0eC5kZWZpbmU7Cn0KZnVuY3Rpb24gaW5mZXJUZW1wbGF0ZSh0YWdOYW1lLCBlbGVtZW50KSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybiBudWxsOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoInRlbXBsYXRlSW5mZXJlbmNlIikpIHJldHVybiBudWxsOwogIGlmIChpc0RlYnVnRW5hYmxlZCgic3RyaWN0IikpIHJldHVybiBudWxsOwogIGNvbnN0IHByb3BzID0ge307CiAgY29uc3Qgc2xvdHMgPSBbXTsKICBpZiAoZWxlbWVudCkgewogICAgZm9yIChjb25zdCBhdHRyIG9mIEFycmF5LmZyb20oZWxlbWVudC5hdHRyaWJ1dGVzKSkgewogICAgICBpZiAoYXR0ci5uYW1lLnN0YXJ0c1dpdGgoImRhdGEtIikpIGNvbnRpbnVlOwogICAgICBpZiAoWyJjbGFzcyIsICJpZCIsICJzdHlsZSJdLmluY2x1ZGVzKGF0dHIubmFtZSkpIGNvbnRpbnVlOwogICAgICBjb25zdCBjYW1lbE5hbWUgPSBrZWJhYlRvQ2FtZWwoYXR0ci5uYW1lKTsKICAgICAgcHJvcHNbY2FtZWxOYW1lXSA9IHBhcnNlQXR0cmlidXRlVmFsdWUoYXR0ci52YWx1ZSk7CiAgICB9CiAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIEFycmF5LmZyb20oZWxlbWVudC5jaGlsZHJlbikpIHsKICAgICAgY29uc3Qgc2xvdE5hbWUgPSBjaGlsZC5nZXRBdHRyaWJ1dGUoInNsb3QiKTsKICAgICAgaWYgKHNsb3ROYW1lICYmICFzbG90cy5pbmNsdWRlcyhzbG90TmFtZSkpIHsKICAgICAgICBzbG90cy5wdXNoKHNsb3ROYW1lKTsKICAgICAgfQogICAgfQogIH0KICBjb25zdCBwcm9wc1Nsb3RzID0gT2JqZWN0LmtleXMocHJvcHMpLm1hcCgocCkgPT4gYCAgICA8c2xvdCBuYW1lPSIke2NhbWVsVG9LZWJhYihwKX0iPiR7Zm9ybWF0VmFsdWUocHJvcHNbcF0pfTwvc2xvdD5gKS5qb2luKCJcbiIpOwogIGNvbnN0IGRlZmF1bHRTbG90ID0gc2xvdHMubGVuZ3RoID09PSAwICYmIE9iamVjdC5rZXlzKHByb3BzKS5sZW5ndGggPT09IDAgPyAnICAgIDxzbG90IG5hbWU9ImNvbnRlbnQiPkxvYWRpbmcuLi48L3Nsb3Q+JyA6ICIiOwogIGNvbnN0IHRlbXBsYXRlID0gYDxkaXYgY2xhc3M9IiR7dGFnTmFtZX0tc2tlbGV0b24iIGRhdGEtaW5mZXJyZWQ+CiR7cHJvcHNTbG90cyB8fCBkZWZhdWx0U2xvdH0KICA8L2Rpdj5gOwogIHJldHVybiB7IHRhZ05hbWUsIHRlbXBsYXRlLCBwcm9wcywgc2xvdHMgfTsKfQpmdW5jdGlvbiByZWdpc3RlckluZmVycmVkQ29tcG9uZW50KHRhZ05hbWUsIGVsZW1lbnQpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuIGZhbHNlOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoInRlbXBsYXRlSW5mZXJlbmNlIikpIHJldHVybiBmYWxzZTsKICBpZiAoY3VzdG9tRWxlbWVudHMuZ2V0KHRhZ05hbWUpKSByZXR1cm4gZmFsc2U7CiAgaWYgKCFnZXRDdXJyZW50QXBwU3RhdGUoKSkgcmV0dXJuIGZhbHNlOwogIGNvbnN0IGluZmVyZW5jZSA9IGluZmVyVGVtcGxhdGUodGFnTmFtZSwgZWxlbWVudCk7CiAgaWYgKCFpbmZlcmVuY2UpIHJldHVybiBmYWxzZTsKICBjb25zdCB7IHRlbXBsYXRlLCBwcm9wcyB9ID0gaW5mZXJlbmNlOwogIGluZmVycmVkVGVtcGxhdGVzLnNldCh0YWdOYW1lLCBpbmZlcmVuY2UpOwogIGxvZ0luZmVycmVkQ29tcG9uZW50KHRhZ05hbWUsIHByb3BzKTsKICB0cnkgewogICAgZGVmaW5lKAogICAgICB0YWdOYW1lLAogICAgICB0ZW1wbGF0ZSwKICAgICAgLy8gU3R1YiByZW5kZXIgdGhhdCBsb2dzIHdoYXQgaXQgcmVjZWl2ZXMKICAgICAgKHsgc3RhdGUgfSkgPT4gKHsgc2xvdHMgfSkgPT4gewogICAgICAgIGlmIChpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgICAgIiVjXHV7MUY1MkV9IGJvcmVET006IEluZmVycmVkIDwlcz4gcmVuZGVyaW5nIiwKICAgICAgICAgICAgImNvbG9yOiAjOWI1OWI2OyBmb250LXdlaWdodDogYm9sZCIsCiAgICAgICAgICAgIHRhZ05hbWUKICAgICAgICAgICk7CiAgICAgICAgICBjb25zb2xlLmxvZygiICAgSW5mZXJyZWQgcHJvcHM6IiwgcHJvcHMpOwogICAgICAgICAgY29uc29sZS5sb2coIiAgIEFwcCBzdGF0ZToiLCBzdGF0ZSk7CiAgICAgICAgfQogICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHByb3BzKSkgewogICAgICAgICAgY29uc3Qgc2xvdEtleSA9IGNhbWVsVG9LZWJhYihrZXkpOwogICAgICAgICAgaWYgKHNsb3RzW3Nsb3RLZXldKSB7CiAgICAgICAgICAgIHNsb3RzW3Nsb3RLZXldID0gU3RyaW5nKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICk7CiAgICByZXR1cm4gdHJ1ZTsKICB9IGNhdGNoIChlKSB7CiAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICBjb25zb2xlLndhcm4oYFtib3JlRE9NXSBGYWlsZWQgdG8gcmVnaXN0ZXIgaW5mZXJyZWQgPCR7dGFnTmFtZX0+OmAsIGUpOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KfQpmdW5jdGlvbiBsb2dJbmZlcnJlZENvbXBvbmVudCh0YWdOYW1lLCBwcm9wcykgewogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgcmV0dXJuOwogIGNvbnNvbGUubG9nKAogICAgIiVjXHV7MUY1MkV9IGJvcmVET006IEluZmVycmluZyB0ZW1wbGF0ZSBmb3IgJWM8JXM+IiwKICAgICJjb2xvcjogIzliNTliNjsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgImNvbG9yOiAjNGVjZGM0OyBmb250LXdlaWdodDogYm9sZCIsCiAgICB0YWdOYW1lCiAgKTsKICBpZiAoT2JqZWN0LmtleXMocHJvcHMpLmxlbmd0aCA+IDApIHsKICAgIGNvbnNvbGUubG9nKCIlY1x1ezFGNENCfSBJbmZlcnJlZCBwcm9wcyBmcm9tIGF0dHJpYnV0ZXM6IiwgImNvbG9yOiAjOTVhNWE2Iik7CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhwcm9wcykpIHsKICAgICAgY29uc29sZS5sb2coYCAgICR7a2V5fTogJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9YCk7CiAgICB9CiAgfQogIGNvbnNvbGUubG9nKCIlY1x1ezFGNEExfSBEZWZpbmUgcHJvcGVybHkgd2l0aDoiLCAiY29sb3I6ICMzNDk4ZGI7IGZvbnQtd2VpZ2h0OiBib2xkIik7CiAgY29uc29sZS5sb2coCiAgICBgICAgYm9yZURPTS5kZWZpbmUoJyR7dGFnTmFtZX0nLCAnPHlvdXIgdGVtcGxhdGU+JywgKHsgc3RhdGUgfSkgPT4gKHsgc2xvdHMgfSkgPT4geyAuLi4gfSlgCiAgKTsKfQpmdW5jdGlvbiBvYnNlcnZlVW5kZWZpbmVkRWxlbWVudHMoKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJ0ZW1wbGF0ZUluZmVyZW5jZSIpKSByZXR1cm47CiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiKSByZXR1cm47CiAgaWYgKHRlbXBsYXRlT2JzZXJ2ZXIpIHJldHVybjsKICB0ZW1wbGF0ZU9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoKG11dGF0aW9ucykgPT4gewogICAgZm9yIChjb25zdCBtdXRhdGlvbiBvZiBtdXRhdGlvbnMpIHsKICAgICAgZm9yIChjb25zdCBub2RlIG9mIEFycmF5LmZyb20obXV0YXRpb24uYWRkZWROb2RlcykpIHsKICAgICAgICBpZiAobm9kZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ICYmIG5vZGUudGFnTmFtZS5pbmNsdWRlcygiLSIpKSB7CiAgICAgICAgICBjb25zdCB0YWdOYW1lID0gbm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBpZiAoIWN1c3RvbUVsZW1lbnRzLmdldCh0YWdOYW1lKSkgewogICAgICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoCiAgICAgICAgICAgICAgYHRlbXBsYXRlW2RhdGEtY29tcG9uZW50PSIke3RhZ05hbWV9Il1gCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgICAgICAgICBxdWV1ZU1pY3JvdGFzaygoKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWN1c3RvbUVsZW1lbnRzLmdldCh0YWdOYW1lKSkgewogICAgICAgICAgICAgICAgICByZWdpc3RlckluZmVycmVkQ29tcG9uZW50KHRhZ05hbWUsIG5vZGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CiAgdGVtcGxhdGVPYnNlcnZlci5vYnNlcnZlKGRvY3VtZW50LmJvZHksIHsKICAgIGNoaWxkTGlzdDogdHJ1ZSwKICAgIHN1YnRyZWU6IHRydWUKICB9KTsKfQpmdW5jdGlvbiBrZWJhYlRvQ2FtZWwoc3RyKSB7CiAgcmV0dXJuIHN0ci5yZXBsYWNlKC8tKFthLXpdKS9nLCAoXywgbGV0dGVyKSA9PiBsZXR0ZXIudG9VcHBlckNhc2UoKSk7Cn0KZnVuY3Rpb24gY2FtZWxUb0tlYmFiKHN0cikgewogIHJldHVybiBzdHIucmVwbGFjZSgvKFtBLVpdKS9nLCAiLSQxIikudG9Mb3dlckNhc2UoKTsKfQpmdW5jdGlvbiBwYXJzZUF0dHJpYnV0ZVZhbHVlKHZhbHVlKSB7CiAgaWYgKHZhbHVlID09PSAidHJ1ZSIpIHJldHVybiB0cnVlOwogIGlmICh2YWx1ZSA9PT0gImZhbHNlIikgcmV0dXJuIGZhbHNlOwogIGNvbnN0IG51bSA9IE51bWJlcih2YWx1ZSk7CiAgaWYgKCFpc05hTihudW0pICYmIHZhbHVlICE9PSAiIikgcmV0dXJuIG51bTsKICBpZiAodmFsdWUuc3RhcnRzV2l0aCgieyIpIHx8IHZhbHVlLnN0YXJ0c1dpdGgoIlsiKSkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpOwogICAgfSBjYXRjaCB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICB9CiAgcmV0dXJuIHZhbHVlOwp9CmZ1bmN0aW9uIGZvcm1hdFZhbHVlKHZhbHVlKSB7CiAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB2b2lkIDApIHJldHVybiAiIjsKICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IikgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHZhbHVlKTsKICByZXR1cm4gU3RyaW5nKHZhbHVlKTsKfQp2YXIgdXNlckRlZmluZWRIZWxwZXJzLCBtaXNzaW5nRnVuY3Rpb25zLCBsYXN0TWlzc2luZywgaW5mZXJyZWRUZW1wbGF0ZXMsIHRlbXBsYXRlT2JzZXJ2ZXIsIGluc2lkZU91dEFQSTsKdmFyIGluaXRfaW5zaWRlX291dCA9IF9fZXNtKHsKICAic3JjL2luc2lkZS1vdXQudHMiKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgaW5pdF9kZWJ1ZygpOwogICAgaW5pdF9jb25zb2xlX2FwaSgpOwogICAgaW5pdF90eXBlX2luZmVyZW5jZSgpOwogICAgdXNlckRlZmluZWRIZWxwZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIG1pc3NpbmdGdW5jdGlvbnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgbGFzdE1pc3NpbmcgPSBudWxsOwogICAgaW5mZXJyZWRUZW1wbGF0ZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgdGVtcGxhdGVPYnNlcnZlciA9IG51bGw7CiAgICBpbnNpZGVPdXRBUEkgPSB7CiAgICAgIC8qKiBNYXAgb2YgbWlzc2luZyBmdW5jdGlvbiBjYWxscyBieSBmdW5jdGlvbiBuYW1lICovCiAgICAgIGdldCBtaXNzaW5nRnVuY3Rpb25zKCkgewogICAgICAgIHJldHVybiBtaXNzaW5nRnVuY3Rpb25zOwogICAgICB9LAogICAgICAvKiogTW9zdCByZWNlbnQgbWlzc2luZyBmdW5jdGlvbiBjb250ZXh0ICovCiAgICAgIGdldCBsYXN0TWlzc2luZygpIHsKICAgICAgICByZXR1cm4gbGFzdE1pc3Npbmc7CiAgICAgIH0sCiAgICAgIC8qKiBEZWZpbmUgYSBoZWxwZXIgZnVuY3Rpb24gYXZhaWxhYmxlIHRvIGFsbCByZW5kZXIgZnVuY3Rpb25zICovCiAgICAgIGRlZmluZUhlbHBlciwKICAgICAgLyoqIEdldCBhbGwgZGVmaW5lZCBoZWxwZXJzICovCiAgICAgIGdldCBoZWxwZXJzKCkgewogICAgICAgIHJldHVybiBuZXcgTWFwKHVzZXJEZWZpbmVkSGVscGVycyk7CiAgICAgIH0sCiAgICAgIC8qKiBDbGVhciBhIGhlbHBlciBkZWZpbml0aW9uICovCiAgICAgIGNsZWFySGVscGVyLAogICAgICAvKiogQ2xlYXIgYWxsIG1pc3NpbmcgZnVuY3Rpb24gcmVjb3JkcyAqLwogICAgICBjbGVhck1pc3NpbmdGdW5jdGlvbnMsCiAgICAgIC8qKiBNYXAgb2YgaW5mZXJyZWQgdGVtcGxhdGVzIGJ5IHRhZyBuYW1lICovCiAgICAgIGdldCBpbmZlcnJlZFRlbXBsYXRlcygpIHsKICAgICAgICByZXR1cm4gaW5mZXJyZWRUZW1wbGF0ZXM7CiAgICAgIH0sCiAgICAgIC8qKiBNYW51YWxseSBpbmZlciB0ZW1wbGF0ZSBmb3IgYSB0YWcgKHVzZWZ1bCBmb3IgdGVzdGluZykgKi8KICAgICAgaW5mZXJUZW1wbGF0ZQogICAgfTsKICB9Cn0pOwoKLy8gc3JjL3ZlcnNpb24udHMKdmFyIFZFUlNJT047CnZhciBpbml0X3ZlcnNpb24gPSBfX2VzbSh7CiAgInNyYy92ZXJzaW9uLnRzIigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIFZFUlNJT04gPSAiMC4yNS4yNSI7CiAgfQp9KTsKCi8vIHNyYy92YWxpZGF0aW9uLnRzCmZ1bmN0aW9uIHNldFZhbGlkYXRpb25BcHBTdGF0ZShzdGF0ZSkgewogIGN1cnJlbnRBcHBTdGF0ZTIgPSBzdGF0ZTsKfQpmdW5jdGlvbiBjcmVhdGVTdGF0ZVNuYXBzaG90KCkgewogIGlmICghY3VycmVudEFwcFN0YXRlMikgcmV0dXJuIG51bGw7CiAgcmV0dXJuIGRlZXBDbG9uZShjdXJyZW50QXBwU3RhdGUyLmFwcCk7Cn0KZnVuY3Rpb24gcmVzdG9yZVN0YXRlU25hcHNob3Qoc25hcHNob3QpIHsKICBpZiAoIWN1cnJlbnRBcHBTdGF0ZTIgfHwgIXNuYXBzaG90KSByZXR1cm47CiAgY29uc3QgY3VycmVudCA9IGN1cnJlbnRBcHBTdGF0ZTIuYXBwOwogIGlmICghY3VycmVudCkgcmV0dXJuOwogIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKGN1cnJlbnQpKSB7CiAgICBpZiAoIShrZXkgaW4gc25hcHNob3QpKSB7CiAgICAgIGRlbGV0ZSBjdXJyZW50W2tleV07CiAgICB9CiAgfQogIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHNuYXBzaG90KSkgewogICAgY3VycmVudFtrZXldID0gZGVlcENsb25lKHZhbHVlKTsKICB9Cn0KZnVuY3Rpb24gZGVlcENsb25lKG9iaiwgc2VlbiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpKSB7CiAgaWYgKG9iaiA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqICE9PSAib2JqZWN0IikgcmV0dXJuIG9iajsKICBpZiAoc2Vlbi5oYXMob2JqKSkgcmV0dXJuIHNlZW4uZ2V0KG9iaik7CiAgaWYgKG9iaiBpbnN0YW5jZW9mIERhdGUpIHJldHVybiBuZXcgRGF0ZShvYmopOwogIGlmIChvYmogaW5zdGFuY2VvZiBSZWdFeHApIHJldHVybiBuZXcgUmVnRXhwKG9iai5zb3VyY2UsIG9iai5mbGFncyk7CiAgaWYgKG9iaiBpbnN0YW5jZW9mIE1hcCkgewogICAgY29uc3QgY2xvbmVkTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIHNlZW4uc2V0KG9iaiwgY2xvbmVkTWFwKTsKICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIG9iai5lbnRyaWVzKCkpIHsKICAgICAgY2xvbmVkTWFwLnNldChkZWVwQ2xvbmUoa2V5LCBzZWVuKSwgZGVlcENsb25lKHZhbHVlLCBzZWVuKSk7CiAgICB9CiAgICByZXR1cm4gY2xvbmVkTWFwOwogIH0KICBpZiAob2JqIGluc3RhbmNlb2YgU2V0KSB7CiAgICBjb25zdCBjbG9uZWRTZXQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgc2Vlbi5zZXQob2JqLCBjbG9uZWRTZXQpOwogICAgZm9yIChjb25zdCB2YWx1ZSBvZiBvYmopIHsKICAgICAgY2xvbmVkU2V0LmFkZChkZWVwQ2xvbmUodmFsdWUsIHNlZW4pKTsKICAgIH0KICAgIHJldHVybiBjbG9uZWRTZXQ7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKICAgIGNvbnN0IGNsb25lZEFyciA9IG5ldyBBcnJheShvYmoubGVuZ3RoKTsKICAgIHNlZW4uc2V0KG9iaiwgY2xvbmVkQXJyKTsKICAgIGZvciAoY29uc3Qga2V5IGluIG9iaikgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgewogICAgICAgIGNsb25lZEFycltrZXldID0gZGVlcENsb25lKG9ialtrZXldLCBzZWVuKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGNsb25lZEFycjsKICB9CiAgY29uc3QgY2xvbmVkID0ge307CiAgc2Vlbi5zZXQob2JqLCBjbG9uZWQpOwogIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG9iaikpIHsKICAgIGNsb25lZFtrZXldID0gZGVlcENsb25lKHZhbHVlLCBzZWVuKTsKICB9CiAgcmV0dXJuIGNsb25lZDsKfQpmdW5jdGlvbiB2YWxpZGF0ZVN5bnRheChjb2RlKSB7CiAgY29uc3QgaXNzdWVzID0gW107CiAgdHJ5IHsKICAgIG5ldyBGdW5jdGlvbigic3RhdGUiLCAiYm9yZURPTSIsIGNvZGUpOwogIH0gY2F0Y2ggKGUpIHsKICAgIGNvbnN0IGVycm9yID0gZTsKICAgIGlzc3Vlcy5wdXNoKHsKICAgICAgdHlwZTogInN5bnRheCIsCiAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsCiAgICAgIGxvY2F0aW9uOiBleHRyYWN0TG9jYXRpb24oZXJyb3IpLAogICAgICBzZXZlcml0eTogImVycm9yIgogICAgfSk7CiAgfQogIHJldHVybiBpc3N1ZXM7Cn0KZnVuY3Rpb24gZXh0cmFjdExvY2F0aW9uKGVycm9yKSB7CiAgY29uc3QgcG9zTWF0Y2ggPSBlcnJvci5tZXNzYWdlLm1hdGNoKC9hdCBwb3NpdGlvbiAoXGQrKS8pOwogIGlmIChwb3NNYXRjaCkgcmV0dXJuIGBwb3NpdGlvbiAke3Bvc01hdGNoWzFdfWA7CiAgY29uc3QgbGluZU1hdGNoID0gZXJyb3IubWVzc2FnZS5tYXRjaCgvbGluZSAoXGQrKS8pOwogIGlmIChsaW5lTWF0Y2gpIHJldHVybiBgbGluZSAke2xpbmVNYXRjaFsxXX1gOwogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gdmFsaWRhdGVSZWZlcmVuY2VzKGNvZGUpIHsKICBjb25zdCBpc3N1ZXMgPSBbXTsKICBpZiAoIWN1cnJlbnRBcHBTdGF0ZTIpIHJldHVybiBpc3N1ZXM7CiAgY29uc3Qgc3RhdGUgPSBjdXJyZW50QXBwU3RhdGUyLmFwcDsKICBjb25zdCBrbm93blBhdGhzID0gZ2V0S25vd25TdGF0ZVBhdGhzKHN0YXRlKTsKICBjb25zdCBrbm93bkhlbHBlcnMgPSBnZXRLbm93bkhlbHBlcnMoKTsKICBjb25zdCBzdGF0ZVJlZnMgPSBleHRyYWN0U3RhdGVSZWZlcmVuY2VzKGNvZGUpOwogIGZvciAoY29uc3QgcmVmIG9mIHN0YXRlUmVmcykgewogICAgaWYgKCFpc1ZhbGlkUGF0aChyZWYsIGtub3duUGF0aHMpKSB7CiAgICAgIGNvbnN0IHN1Z2dlc3Rpb24gPSBmaW5kU2ltaWxhclBhdGgocmVmLCBrbm93blBhdGhzKTsKICAgICAgaXNzdWVzLnB1c2goewogICAgICAgIHR5cGU6ICJyZWZlcmVuY2UiLAogICAgICAgIG1lc3NhZ2U6IGAke3JlZn0gaXMgdW5kZWZpbmVkYCwKICAgICAgICBzdWdnZXN0aW9uOiBzdWdnZXN0aW9uID8gYERpZCB5b3UgbWVhbiAke3N1Z2dlc3Rpb259P2AgOiB2b2lkIDAsCiAgICAgICAgc2V2ZXJpdHk6ICJlcnJvciIKICAgICAgfSk7CiAgICB9CiAgfQogIGNvbnN0IGhlbHBlclJlZnMgPSBleHRyYWN0SGVscGVyUmVmZXJlbmNlcyhjb2RlKTsKICBmb3IgKGNvbnN0IHJlZiBvZiBoZWxwZXJSZWZzKSB7CiAgICBpZiAoIWtub3duSGVscGVycy5pbmNsdWRlcyhyZWYpKSB7CiAgICAgIGNvbnN0IHN1Z2dlc3Rpb24gPSBmaW5kU2ltaWxhcihyZWYsIGtub3duSGVscGVycyk7CiAgICAgIGlzc3Vlcy5wdXNoKHsKICAgICAgICB0eXBlOiAicmVmZXJlbmNlIiwKICAgICAgICBtZXNzYWdlOiBgSGVscGVyICcke3JlZn0nIGlzIG5vdCBkZWZpbmVkYCwKICAgICAgICBzdWdnZXN0aW9uOiBzdWdnZXN0aW9uID8gYERpZCB5b3UgbWVhbiAnJHtzdWdnZXN0aW9ufSc/YCA6IHZvaWQgMCwKICAgICAgICBzZXZlcml0eTogImVycm9yIgogICAgICB9KTsKICAgIH0KICB9CiAgcmV0dXJuIGlzc3VlczsKfQpmdW5jdGlvbiBleHRyYWN0U3RhdGVSZWZlcmVuY2VzKGNvZGUpIHsKICBjb25zdCByZWZzID0gW107CiAgY29uc3QgcmVnZXggPSAvc3RhdGVcLihbXHcuW1xdXSspL2c7CiAgbGV0IG1hdGNoOwogIHdoaWxlICgobWF0Y2ggPSByZWdleC5leGVjKGNvZGUpKSAhPT0gbnVsbCkgewogICAgbGV0IHBhdGggPSBtYXRjaFsxXTsKICAgIGNvbnN0IG1ldGhvZFBhdHRlcm4gPSAvXC4ocHVzaHxwb3B8c2hpZnR8dW5zaGlmdHxtYXB8ZmlsdGVyfHJlZHVjZXxmb3JFYWNofGZpbmR8ZmluZEluZGV4fHNvbWV8ZXZlcnl8aW5kZXhPZnxpbmNsdWRlc3xzcGxpY2V8c2xpY2V8Y29uY2F0fGpvaW58cmV2ZXJzZXxzb3J0fGZsYXR8ZmxhdE1hcHxhdHxmaWxsfGNvcHlXaXRoaW58ZW50cmllc3xrZXlzfHZhbHVlc3xsZW5ndGh8c2l6ZXxnZXR8c2V0fGhhc3xkZWxldGV8YWRkfGNsZWFyfHRvU3RyaW5nfHZhbHVlT2Z8dG9KU09OKSQvOwogICAgcGF0aCA9IHBhdGgucmVwbGFjZShtZXRob2RQYXR0ZXJuLCAiIik7CiAgICBpZiAocGF0aCkgewogICAgICByZWZzLnB1c2goYHN0YXRlLiR7cGF0aH1gKTsKICAgIH0KICB9CiAgcmV0dXJuIFsuLi5uZXcgU2V0KHJlZnMpXTsKfQpmdW5jdGlvbiBleHRyYWN0SGVscGVyUmVmZXJlbmNlcyhjb2RlKSB7CiAgY29uc3QgcmVmcyA9IFtdOwogIGNvbnN0IHJlZ2V4ID0gL2hlbHBlcnNcLihcdyspXHMqXCgvZzsKICBsZXQgbWF0Y2g7CiAgd2hpbGUgKChtYXRjaCA9IHJlZ2V4LmV4ZWMoY29kZSkpICE9PSBudWxsKSB7CiAgICByZWZzLnB1c2gobWF0Y2hbMV0pOwogIH0KICByZXR1cm4gWy4uLm5ldyBTZXQocmVmcyldOwp9CmZ1bmN0aW9uIGdldEtub3duU3RhdGVQYXRocyhzdGF0ZSwgcHJlZml4ID0gInN0YXRlIiwgc2VlbiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpKSB7CiAgY29uc3QgcGF0aHMgPSBbcHJlZml4XTsKICBpZiAoc3RhdGUgPT09IG51bGwgfHwgc3RhdGUgPT09IHZvaWQgMCkgcmV0dXJuIHBhdGhzOwogIGlmICh0eXBlb2Ygc3RhdGUgIT09ICJvYmplY3QiKSByZXR1cm4gcGF0aHM7CiAgaWYgKHNlZW4uaGFzKHN0YXRlKSkgcmV0dXJuIHBhdGhzOwogIHNlZW4uYWRkKHN0YXRlKTsKICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhzdGF0ZSkpIHsKICAgIGNvbnN0IHBhdGggPSBgJHtwcmVmaXh9LiR7a2V5fWA7CiAgICBwYXRocy5wdXNoKHBhdGgpOwogICAgY29uc3QgdmFsdWUgPSBzdGF0ZVtrZXldOwogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgIHBhdGhzLnB1c2gocGF0aCk7CiAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiAwICYmIHZhbHVlWzBdICYmIHR5cGVvZiB2YWx1ZVswXSA9PT0gIm9iamVjdCIpIHsKICAgICAgICBwYXRocy5wdXNoKC4uLmdldEtub3duU3RhdGVQYXRocyh2YWx1ZVswXSwgYCR7cGF0aH1bMF1gLCBzZWVuKSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IikgewogICAgICBwYXRocy5wdXNoKC4uLmdldEtub3duU3RhdGVQYXRocyh2YWx1ZSwgcGF0aCwgc2VlbikpOwogICAgfQogIH0KICByZXR1cm4gcGF0aHM7Cn0KZnVuY3Rpb24gaXNWYWxpZFBhdGgocmVmLCBrbm93blBhdGhzKSB7CiAgaWYgKGtub3duUGF0aHMuaW5jbHVkZXMocmVmKSkgcmV0dXJuIHRydWU7CiAgY29uc3QgYmFzZVBhdGggPSByZWYucmVwbGFjZSgvXFtcZCtcXS9nLCAiIik7CiAgaWYgKGtub3duUGF0aHMuaW5jbHVkZXMoYmFzZVBhdGgpKSByZXR1cm4gdHJ1ZTsKICBjb25zdCBhcnJheUJhc2VQYXRoID0gcmVmLnJlcGxhY2UoL1xbXGQrXF1cLltcdy5dKyQvLCAiIik7CiAgaWYgKGtub3duUGF0aHMuaW5jbHVkZXMoYXJyYXlCYXNlUGF0aCkgfHwga25vd25QYXRocy5pbmNsdWRlcyhgJHthcnJheUJhc2VQYXRofVswXWApKSByZXR1cm4gdHJ1ZTsKICByZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gZmluZFNpbWlsYXJQYXRoKHJlZiwga25vd25QYXRocykgewogIGxldCBiZXN0OwogIGxldCBiZXN0U2NvcmUgPSBJbmZpbml0eTsKICBmb3IgKGNvbnN0IHBhdGggb2Yga25vd25QYXRocykgewogICAgY29uc3Qgc2NvcmUgPSBsZXZlbnNodGVpbihyZWYsIHBhdGgpOwogICAgaWYgKHNjb3JlIDwgYmVzdFNjb3JlICYmIHNjb3JlIDwgcmVmLmxlbmd0aCAvIDIpIHsKICAgICAgYmVzdFNjb3JlID0gc2NvcmU7CiAgICAgIGJlc3QgPSBwYXRoOwogICAgfQogIH0KICByZXR1cm4gYmVzdDsKfQpmdW5jdGlvbiBmaW5kU2ltaWxhcihuYW1lLCBrbm93bikgewogIGZvciAoY29uc3QgayBvZiBrbm93bikgewogICAgaWYgKGxldmVuc2h0ZWluKG5hbWUsIGspIDw9IDIpIHJldHVybiBrOwogIH0KICByZXR1cm4gdm9pZCAwOwp9CmZ1bmN0aW9uIGxldmVuc2h0ZWluKGEsIGIpIHsKICBjb25zdCBtYXRyaXggPSBbXTsKICBmb3IgKGxldCBpID0gMDsgaSA8PSBiLmxlbmd0aDsgaSsrKSB7CiAgICBtYXRyaXhbaV0gPSBbaV07CiAgfQogIGZvciAobGV0IGogPSAwOyBqIDw9IGEubGVuZ3RoOyBqKyspIHsKICAgIG1hdHJpeFswXVtqXSA9IGo7CiAgfQogIGZvciAobGV0IGkgPSAxOyBpIDw9IGIubGVuZ3RoOyBpKyspIHsKICAgIGZvciAobGV0IGogPSAxOyBqIDw9IGEubGVuZ3RoOyBqKyspIHsKICAgICAgaWYgKGIuY2hhckF0KGkgLSAxKSA9PT0gYS5jaGFyQXQoaiAtIDEpKSB7CiAgICAgICAgbWF0cml4W2ldW2pdID0gbWF0cml4W2kgLSAxXVtqIC0gMV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWF0cml4W2ldW2pdID0gTWF0aC5taW4oCiAgICAgICAgICBtYXRyaXhbaSAtIDFdW2ogLSAxXSArIDEsCiAgICAgICAgICAvLyBzdWJzdGl0dXRpb24KICAgICAgICAgIG1hdHJpeFtpXVtqIC0gMV0gKyAxLAogICAgICAgICAgLy8gaW5zZXJ0aW9uCiAgICAgICAgICBtYXRyaXhbaSAtIDFdW2pdICsgMQogICAgICAgICAgLy8gZGVsZXRpb24KICAgICAgICApOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBtYXRyaXhbYi5sZW5ndGhdW2EubGVuZ3RoXTsKfQpmdW5jdGlvbiBnZXRLbm93bkhlbHBlcnMoKSB7CiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gW107CiAgY29uc3QgYm9yZWRvbSA9IHdpbmRvdy5ib3JlRE9NOwogIGlmICghYm9yZWRvbT8uaGVscGVycykgcmV0dXJuIFtdOwogIHJldHVybiBBcnJheS5mcm9tKGJvcmVkb20uaGVscGVycy5rZXlzKCkpOwp9CmZ1bmN0aW9uIHZhbGlkYXRlVHlwZXMoY29kZSkgewogIGNvbnN0IGlzc3VlcyA9IFtdOwogIGNvbnN0IGFycmF5TWV0aG9kUGF0dGVybnMgPSBbCiAgICB7IHBhdHRlcm46IC9cLm1hcFxzKlwoLywgbWV0aG9kOiAibWFwIiB9LAogICAgeyBwYXR0ZXJuOiAvXC5maWx0ZXJccypcKC8sIG1ldGhvZDogImZpbHRlciIgfSwKICAgIHsgcGF0dGVybjogL1wuZm9yRWFjaFxzKlwoLywgbWV0aG9kOiAiZm9yRWFjaCIgfSwKICAgIHsgcGF0dGVybjogL1wucmVkdWNlXHMqXCgvLCBtZXRob2Q6ICJyZWR1Y2UiIH0sCiAgICB7IHBhdHRlcm46IC9cLmZpbmRccypcKC8sIG1ldGhvZDogImZpbmQiIH0sCiAgICB7IHBhdHRlcm46IC9cLnNvbWVccypcKC8sIG1ldGhvZDogInNvbWUiIH0sCiAgICB7IHBhdHRlcm46IC9cLmV2ZXJ5XHMqXCgvLCBtZXRob2Q6ICJldmVyeSIgfQogIF07CiAgZm9yIChjb25zdCB7IHBhdHRlcm4sIG1ldGhvZCB9IG9mIGFycmF5TWV0aG9kUGF0dGVybnMpIHsKICAgIGlmIChwYXR0ZXJuLnRlc3QoY29kZSkpIHsKICAgICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKGAoc3RhdGVcXC5bXFx3Ll0rKVxcLiR7bWV0aG9kfVxccypcXChgKTsKICAgICAgY29uc3QgbWF0Y2gyID0gY29kZS5tYXRjaChyZWdleCk7CiAgICAgIGlmIChtYXRjaDIpIHsKICAgICAgICBjb25zdCBwYXRoID0gbWF0Y2gyWzFdOwogICAgICAgIGNvbnN0IHZhbHVlID0gZ2V0U3RhdGVWYWx1ZShwYXRoKTsKICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHZvaWQgMCkgewogICAgICAgICAgaXNzdWVzLnB1c2goewogICAgICAgICAgICB0eXBlOiAidHlwZSIsCiAgICAgICAgICAgIG1lc3NhZ2U6IGAke3BhdGh9IGlzICR7dmFsdWV9LCBjYW5ub3QgY2FsbCAuJHttZXRob2R9KClgLAogICAgICAgICAgICBzdWdnZXN0aW9uOiBgQWRkIG51bGwgY2hlY2s6ICR7cGF0aH0/LiR7bWV0aG9kfSguLi4pIG9yIGluaXRpYWxpemUgJHtwYXRofSBmaXJzdGAsCiAgICAgICAgICAgIHNldmVyaXR5OiAiZXJyb3IiCiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKCFBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgaXNzdWVzLnB1c2goewogICAgICAgICAgICB0eXBlOiAidHlwZSIsCiAgICAgICAgICAgIG1lc3NhZ2U6IGAke3BhdGh9IGlzIG5vdCBhbiBhcnJheSwgY2Fubm90IGNhbGwgLiR7bWV0aG9kfSgpYCwKICAgICAgICAgICAgc3VnZ2VzdGlvbjogYEVuc3VyZSAke3BhdGh9IGlzIGFuIGFycmF5IGJlZm9yZSBjYWxsaW5nIC4ke21ldGhvZH0oKWAsCiAgICAgICAgICAgIHNldmVyaXR5OiAiZXJyb3IiCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgY29uc3QgcHJvcEFjY2Vzc1JlZ2V4ID0gL3N0YXRlXC4oW1x3Ll0rKVwuKFtcd10rKS9nOwogIGxldCBtYXRjaDsKICB3aGlsZSAoKG1hdGNoID0gcHJvcEFjY2Vzc1JlZ2V4LmV4ZWMoY29kZSkpICE9PSBudWxsKSB7CiAgICBjb25zdCBiYXNlUGF0aCA9IGBzdGF0ZS4ke21hdGNoWzFdfWA7CiAgICBjb25zdCB2YWx1ZSA9IGdldFN0YXRlVmFsdWUoYmFzZVBhdGgpOwogICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB2b2lkIDApIHsKICAgICAgaXNzdWVzLnB1c2goewogICAgICAgIHR5cGU6ICJ0eXBlIiwKICAgICAgICBtZXNzYWdlOiBgJHtiYXNlUGF0aH0gaXMgJHt2YWx1ZX0sIGNhbm5vdCByZWFkIHByb3BlcnR5ICcke21hdGNoWzJdfSdgLAogICAgICAgIHN1Z2dlc3Rpb246IGBBZGQgbnVsbCBjaGVjazogJHtiYXNlUGF0aH0/LiR7bWF0Y2hbMl19IG9yIGluaXRpYWxpemUgJHtiYXNlUGF0aH0gZmlyc3RgLAogICAgICAgIHNldmVyaXR5OiAid2FybmluZyIKICAgICAgfSk7CiAgICB9CiAgfQogIGlmIChjb2RlLmluY2x1ZGVzKCJhd2FpdCAiKSB8fCBjb2RlLmluY2x1ZGVzKCJhc3luYyAiKSkgewogICAgaXNzdWVzLnB1c2goewogICAgICB0eXBlOiAid2FybmluZyIsCiAgICAgIG1lc3NhZ2U6ICJBc3luYyBjb2RlIGRldGVjdGVkIC0gYXBwbHkoKSBleGVjdXRlcyBzeW5jaHJvbm91c2x5IiwKICAgICAgc3VnZ2VzdGlvbjogIlVzZSByZWd1bGFyIHN5bmNocm9ub3VzIGNvZGUgb3IgaGFuZGxlIGFzeW5jIHNlcGFyYXRlbHkiLAogICAgICBzZXZlcml0eTogIndhcm5pbmciCiAgICB9KTsKICB9CiAgcmV0dXJuIGlzc3VlczsKfQpmdW5jdGlvbiBnZXRTdGF0ZVZhbHVlKHBhdGgpIHsKICBpZiAoIWN1cnJlbnRBcHBTdGF0ZTIpIHJldHVybiB2b2lkIDA7CiAgY29uc3QgcGFydHMgPSBwYXRoLnJlcGxhY2UoInN0YXRlLiIsICIiKS5zcGxpdCgiLiIpOwogIGxldCBjdXJyZW50ID0gY3VycmVudEFwcFN0YXRlMi5hcHA7CiAgZm9yIChjb25zdCBwYXJ0IG9mIHBhcnRzKSB7CiAgICBpZiAoY3VycmVudCA9PT0gbnVsbCB8fCBjdXJyZW50ID09PSB2b2lkIDApIHJldHVybiBjdXJyZW50OwogICAgY29uc3QgYXJyYXlNYXRjaCA9IHBhcnQubWF0Y2goL14oXHcrKVxbKFxkKylcXSQvKTsKICAgIGlmIChhcnJheU1hdGNoKSB7CiAgICAgIGN1cnJlbnQgPSBjdXJyZW50W2FycmF5TWF0Y2hbMV1dOwogICAgICBpZiAoQXJyYXkuaXNBcnJheShjdXJyZW50KSkgewogICAgICAgIGN1cnJlbnQgPSBjdXJyZW50W3BhcnNlSW50KGFycmF5TWF0Y2hbMl0sIDEwKV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY3VycmVudCA9IGN1cnJlbnRbcGFydF07CiAgICB9CiAgfQogIHJldHVybiBjdXJyZW50Owp9CmZ1bmN0aW9uIGNhbGN1bGF0ZVN0YXRlQ2hhbmdlcyhiZWZvcmUsIGFmdGVyLCBwYXRoID0gInN0YXRlIikgewogIGNvbnN0IGNoYW5nZXMgPSBbXTsKICBpZiAoYmVmb3JlID09PSBhZnRlcikgcmV0dXJuIGNoYW5nZXM7CiAgaWYgKHR5cGVvZiBiZWZvcmUgIT09IHR5cGVvZiBhZnRlcikgewogICAgY2hhbmdlcy5wdXNoKHsgcGF0aCwgYmVmb3JlLCBhZnRlciB9KTsKICAgIHJldHVybiBjaGFuZ2VzOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheShiZWZvcmUpICYmIEFycmF5LmlzQXJyYXkoYWZ0ZXIpKSB7CiAgICBpZiAoSlNPTi5zdHJpbmdpZnkoYmVmb3JlKSAhPT0gSlNPTi5zdHJpbmdpZnkoYWZ0ZXIpKSB7CiAgICAgIGNoYW5nZXMucHVzaCh7IHBhdGgsIGJlZm9yZSwgYWZ0ZXIgfSk7CiAgICB9CiAgICByZXR1cm4gY2hhbmdlczsKICB9CiAgaWYgKHR5cGVvZiBiZWZvcmUgPT09ICJvYmplY3QiICYmIGJlZm9yZSAhPT0gbnVsbCAmJiBhZnRlciAhPT0gbnVsbCkgewogICAgY29uc3QgYWxsS2V5cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsuLi5PYmplY3Qua2V5cyhiZWZvcmUpLCAuLi5PYmplY3Qua2V5cyhhZnRlcildKTsKICAgIGZvciAoY29uc3Qga2V5IG9mIGFsbEtleXMpIHsKICAgICAgY2hhbmdlcy5wdXNoKC4uLmNhbGN1bGF0ZVN0YXRlQ2hhbmdlcyhiZWZvcmVba2V5XSwgYWZ0ZXJba2V5XSwgYCR7cGF0aH0uJHtrZXl9YCkpOwogICAgfQogICAgcmV0dXJuIGNoYW5nZXM7CiAgfQogIGlmIChiZWZvcmUgIT09IGFmdGVyKSB7CiAgICBjaGFuZ2VzLnB1c2goeyBwYXRoLCBiZWZvcmUsIGFmdGVyIH0pOwogIH0KICByZXR1cm4gY2hhbmdlczsKfQpmdW5jdGlvbiBnZXRBZmZlY3RlZENvbXBvbmVudHMoX2NoYW5nZXMpIHsKICByZXR1cm4gW107Cn0KZnVuY3Rpb24gdmFsaWRhdGUoY29kZSkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICByZXR1cm4geyB2YWxpZDogdHJ1ZSwgaXNzdWVzOiBbXSB9OwogIH0KICBpZiAoIWlzRGVidWdFbmFibGVkKCJsbG0iKSkgewogICAgcmV0dXJuIHsgdmFsaWQ6IHRydWUsIGlzc3VlczogW10gfTsKICB9CiAgY29uc3QgaXNzdWVzID0gWwogICAgLi4udmFsaWRhdGVTeW50YXgoY29kZSksCiAgICAuLi52YWxpZGF0ZVJlZmVyZW5jZXMoY29kZSksCiAgICAuLi52YWxpZGF0ZVR5cGVzKGNvZGUpCiAgXTsKICBjb25zdCBlcnJvcnMyID0gaXNzdWVzLmZpbHRlcigoaSkgPT4gaS5zZXZlcml0eSA9PT0gImVycm9yIik7CiAgcmV0dXJuIHsKICAgIHZhbGlkOiBlcnJvcnMyLmxlbmd0aCA9PT0gMCwKICAgIGlzc3VlcwogIH07Cn0KZnVuY3Rpb24gYXBwbHkoY29kZSkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICByZXR1cm4gewogICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgZXJyb3I6ICJhcHBseSgpIG5vdCBhdmFpbGFibGUgaW4gcHJvZHVjdGlvbiIsCiAgICAgIHJvbGxiYWNrOiAoKSA9PiB7CiAgICAgIH0sCiAgICAgIGNvbXBvbmVudHNBZmZlY3RlZDogW10sCiAgICAgIHN0YXRlQ2hhbmdlczogW10KICAgIH07CiAgfQogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImxsbSIpKSB7CiAgICByZXR1cm4gewogICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgZXJyb3I6ICJMTE0gQVBJIGlzIGRpc2FibGVkIiwKICAgICAgcm9sbGJhY2s6ICgpID0+IHsKICAgICAgfSwKICAgICAgY29tcG9uZW50c0FmZmVjdGVkOiBbXSwKICAgICAgc3RhdGVDaGFuZ2VzOiBbXQogICAgfTsKICB9CiAgY29uc3Qgc25hcHNob3QgPSBjcmVhdGVTdGF0ZVNuYXBzaG90KCk7CiAgY29uc3Qgc3RhdGVCZWZvcmUgPSBkZWVwQ2xvbmUoc25hcHNob3QpOwogIGNvbnN0IHZhbGlkYXRpb24gPSB2YWxpZGF0ZShjb2RlKTsKICBpZiAoIXZhbGlkYXRpb24udmFsaWQpIHsKICAgIGNvbnN0IGVycm9yTXNnID0gdmFsaWRhdGlvbi5pc3N1ZXMuZmlsdGVyKChpKSA9PiBpLnNldmVyaXR5ID09PSAiZXJyb3IiKS5tYXAoKGkpID0+IGkubWVzc2FnZSkuam9pbigiOyAiKTsKICAgIHJlY29yZEF0dGVtcHQoY29kZSwgImVycm9yIiwgZXJyb3JNc2cpOwogICAgcmV0dXJuIHsKICAgICAgc3VjY2VzczogZmFsc2UsCiAgICAgIGVycm9yOiBgVmFsaWRhdGlvbiBmYWlsZWQ6ICR7ZXJyb3JNc2d9YCwKICAgICAgcm9sbGJhY2s6ICgpID0+IHsKICAgICAgfSwKICAgICAgY29tcG9uZW50c0FmZmVjdGVkOiBbXSwKICAgICAgc3RhdGVDaGFuZ2VzOiBbXQogICAgfTsKICB9CiAgdHJ5IHsKICAgIGNvbnN0IGV4ZWNGbiA9IG5ldyBGdW5jdGlvbigic3RhdGUiLCAiYm9yZURPTSIsIGNvZGUpOwogICAgZXhlY0ZuKGN1cnJlbnRBcHBTdGF0ZTI/LmFwcCwgdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cuYm9yZURPTSA6IHZvaWQgMCk7CiAgICBjb25zdCBzdGF0ZUFmdGVyID0gY3JlYXRlU3RhdGVTbmFwc2hvdCgpOwogICAgY29uc3Qgc3RhdGVDaGFuZ2VzID0gY2FsY3VsYXRlU3RhdGVDaGFuZ2VzKHN0YXRlQmVmb3JlLCBzdGF0ZUFmdGVyKTsKICAgIHJlY29yZEF0dGVtcHQoY29kZSwgInN1Y2Nlc3MiKTsKICAgIHJldHVybiB7CiAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgIHJvbGxiYWNrOiAoKSA9PiByZXN0b3JlU3RhdGVTbmFwc2hvdChzbmFwc2hvdCksCiAgICAgIGNvbXBvbmVudHNBZmZlY3RlZDogZ2V0QWZmZWN0ZWRDb21wb25lbnRzKHN0YXRlQ2hhbmdlcyksCiAgICAgIHN0YXRlQ2hhbmdlcwogICAgfTsKICB9IGNhdGNoIChlKSB7CiAgICByZXN0b3JlU3RhdGVTbmFwc2hvdChzbmFwc2hvdCk7CiAgICBjb25zdCBlcnJvciA9IGU7CiAgICByZWNvcmRBdHRlbXB0KGNvZGUsICJlcnJvciIsIGVycm9yLm1lc3NhZ2UpOwogICAgcmV0dXJuIHsKICAgICAgc3VjY2VzczogZmFsc2UsCiAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlLAogICAgICByb2xsYmFjazogKCkgPT4gewogICAgICB9LAogICAgICAvLyBBbHJlYWR5IHJvbGxlZCBiYWNrCiAgICAgIGNvbXBvbmVudHNBZmZlY3RlZDogW10sCiAgICAgIHN0YXRlQ2hhbmdlczogW10KICAgIH07CiAgfQp9CmZ1bmN0aW9uIGFwcGx5QmF0Y2goY29kZUJsb2NrcykgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICByZXR1cm4gewogICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgcmVzdWx0czogW10sCiAgICAgIHJvbGxiYWNrQWxsOiAoKSA9PiB7CiAgICAgIH0sCiAgICAgIGVycm9yOiAiYXBwbHlCYXRjaCgpIG5vdCBhdmFpbGFibGUgaW4gcHJvZHVjdGlvbiIKICAgIH07CiAgfQogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImxsbSIpKSB7CiAgICByZXR1cm4gewogICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgcmVzdWx0czogW10sCiAgICAgIHJvbGxiYWNrQWxsOiAoKSA9PiB7CiAgICAgIH0sCiAgICAgIGVycm9yOiAiTExNIEFQSSBpcyBkaXNhYmxlZCIKICAgIH07CiAgfQogIGNvbnN0IGluaXRpYWxTbmFwc2hvdCA9IGNyZWF0ZVN0YXRlU25hcHNob3QoKTsKICBjb25zdCByZXN1bHRzID0gW107CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb2RlQmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCByZXN1bHQgPSBhcHBseShjb2RlQmxvY2tzW2ldKTsKICAgIHJlc3VsdHMucHVzaChyZXN1bHQpOwogICAgaWYgKCFyZXN1bHQuc3VjY2VzcykgewogICAgICByZXN0b3JlU3RhdGVTbmFwc2hvdChpbml0aWFsU25hcHNob3QpOwogICAgICByZXR1cm4gewogICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgIHJlc3VsdHMsCiAgICAgICAgcm9sbGJhY2tBbGw6ICgpID0+IHsKICAgICAgICB9LAogICAgICAgIC8vIEFscmVhZHkgcm9sbGVkIGJhY2sKICAgICAgICBlcnJvcjogcmVzdWx0LmVycm9yLAogICAgICAgIGZhaWxlZEluZGV4OiBpCiAgICAgIH07CiAgICB9CiAgfQogIHJldHVybiB7CiAgICBzdWNjZXNzOiB0cnVlLAogICAgcmVzdWx0cywKICAgIHJvbGxiYWNrQWxsOiAoKSA9PiByZXN0b3JlU3RhdGVTbmFwc2hvdChpbml0aWFsU25hcHNob3QpCiAgfTsKfQp2YXIgY3VycmVudEFwcFN0YXRlMjsKdmFyIGluaXRfdmFsaWRhdGlvbiA9IF9fZXNtKHsKICAic3JjL3ZhbGlkYXRpb24udHMiKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgaW5pdF9kZWJ1ZygpOwogICAgaW5pdF9sbG0oKTsKICAgIGN1cnJlbnRBcHBTdGF0ZTIgPSBudWxsOwogIH0KfSk7CgovLyBzcmMvbGxtLnRzCnZhciBsbG1fZXhwb3J0cyA9IHt9OwpfX2V4cG9ydChsbG1fZXhwb3J0cywgewogIGNsZWFyQXR0ZW1wdHM6ICgpID0+IGNsZWFyQXR0ZW1wdHMsCiAgY29udGV4dDogKCkgPT4gY29udGV4dCwKICBjb3B5OiAoKSA9PiBjb3B5LAogIGZvY3VzOiAoKSA9PiBmb2N1cywKICBmb3JtYXRFcnJvckZvckxMTTogKCkgPT4gZm9ybWF0RXJyb3JGb3JMTE0sCiAgZ2V0QXR0ZW1wdHM6ICgpID0+IGdldEF0dGVtcHRzLAogIGlzTExNT3V0cHV0Rm9ybWF0OiAoKSA9PiBpc0xMTU91dHB1dEZvcm1hdCwKICBsbG1BUEk6ICgpID0+IGxsbUFQSSwKICBsbG1Mb2c6ICgpID0+IGxsbUxvZywKICByZWNvcmRBdHRlbXB0OiAoKSA9PiByZWNvcmRBdHRlbXB0LAogIHNldFZhbGlkYXRpb25BcHBTdGF0ZTogKCkgPT4gc2V0VmFsaWRhdGlvbkFwcFN0YXRlCn0pOwpmdW5jdGlvbiBpc1NhbWVPYmplY3QoYSwgYikgewogIGlmIChhID09PSBiKSByZXR1cm4gdHJ1ZTsKICBpZiAoIWEgfHwgIWIpIHJldHVybiBmYWxzZTsKICBpZiAodHlwZW9mIGEgIT09ICJvYmplY3QiIHx8IHR5cGVvZiBiICE9PSAib2JqZWN0IikgcmV0dXJuIGZhbHNlOwogIHRyeSB7CiAgICBjb25zdCBtYXJrZXIgPSBEYXRlLm5vdygpICsgTWF0aC5yYW5kb20oKTsKICAgIGFbQ0lSQ1VMQVJfQ0hFQ0tdID0gbWFya2VyOwogICAgY29uc3Qgc2FtZSA9IGJbQ0lSQ1VMQVJfQ0hFQ0tdID09PSBtYXJrZXI7CiAgICBkZWxldGUgYVtDSVJDVUxBUl9DSEVDS107CiAgICByZXR1cm4gc2FtZTsKICB9IGNhdGNoIHsKICAgIHJldHVybiBmYWxzZTsKICB9Cn0KZnVuY3Rpb24gZ2V0U3RhdGVQYXRocyhvYmosIHByZWZpeCA9ICIiLCBzZWVuID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCkpIHsKICBjb25zdCBwYXRocyA9IFtdOwogIGlmIChvYmogPT09IG51bGwgfHwgb2JqID09PSB2b2lkIDApIHJldHVybiBwYXRoczsKICBpZiAodHlwZW9mIG9iaiAhPT0gIm9iamVjdCIpIHJldHVybiBwYXRoczsKICBpZiAoc2Vlbi5oYXMob2JqKSkgcmV0dXJuIHBhdGhzOwogIHNlZW4uYWRkKG9iaik7CiAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMob2JqKSkgewogICAgY29uc3QgcGF0aCA9IHByZWZpeCA/IGAke3ByZWZpeH0uJHtrZXl9YCA6IGtleTsKICAgIHBhdGhzLnB1c2gocGF0aCk7CiAgICBjb25zdCB2YWx1ZSA9IG9ialtrZXldOwogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgIHBhdGhzLnB1c2goYCR7cGF0aH1bXWApOwogICAgICBpZiAodmFsdWUubGVuZ3RoID4gMCAmJiB0eXBlb2YgdmFsdWVbMF0gPT09ICJvYmplY3QiICYmIHZhbHVlWzBdICE9PSBudWxsKSB7CiAgICAgICAgcGF0aHMucHVzaCguLi5nZXRTdGF0ZVBhdGhzKHZhbHVlWzBdLCBgJHtwYXRofVswXWAsIHNlZW4pKTsKICAgICAgfQogICAgfSBlbHNlIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiKSB7CiAgICAgIHBhdGhzLnB1c2goLi4uZ2V0U3RhdGVQYXRocyh2YWx1ZSwgcGF0aCwgc2VlbikpOwogICAgfQogIH0KICByZXR1cm4gcGF0aHM7Cn0KZnVuY3Rpb24gaW5mZXJUeXBlU2hhcGUob2JqLCBzZWVuID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCkpIHsKICBpZiAob2JqID09PSBudWxsKSByZXR1cm4gIm51bGwiOwogIGlmIChvYmogPT09IHZvaWQgMCkgcmV0dXJuICJ1bmRlZmluZWQiOwogIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHsKICAgIGlmIChvYmoubGVuZ3RoID09PSAwKSByZXR1cm4gImFueVtdIjsKICAgIGNvbnN0IGVsZW1UeXBlID0gaW5mZXJUeXBlU2hhcGUob2JqWzBdLCBzZWVuKTsKICAgIHJldHVybiBgJHtlbGVtVHlwZX1bXWA7CiAgfQogIGlmICh0eXBlb2Ygb2JqID09PSAib2JqZWN0IikgewogICAgaWYgKHNlZW4uaGFzKG9iaikpIHJldHVybiAiLyogY2lyY3VsYXIgKi8iOwogICAgc2Vlbi5hZGQob2JqKTsKICAgIGNvbnN0IHByb3BzID0gT2JqZWN0LmVudHJpZXMob2JqKS5tYXAoKFtrLCB2XSkgPT4gYCAgJHtrfTogJHtpbmZlclR5cGVTaGFwZSh2LCBzZWVuKX1gKS5qb2luKCJcbiIpOwogICAgcmV0dXJuIGB7CiR7cHJvcHN9Cn1gOwogIH0KICByZXR1cm4gdHlwZW9mIG9iajsKfQpmdW5jdGlvbiBzYW5pdGl6ZVN0YXRlKHN0YXRlLCBzZWVuID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCksIHJvb3QpIHsKICBpZiAoc3RhdGUgPT09IG51bGwgfHwgc3RhdGUgPT09IHZvaWQgMCkgcmV0dXJuIHN0YXRlOwogIGlmICh0eXBlb2Ygc3RhdGUgIT09ICJvYmplY3QiKSByZXR1cm4gc3RhdGU7CiAgaWYgKHR5cGVvZiBzdGF0ZSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuICJbRnVuY3Rpb25dIjsKICBpZiAodHlwZW9mIHN0YXRlID09PSAic3ltYm9sIikgcmV0dXJuICJbU3ltYm9sXSI7CiAgaWYgKHN0YXRlIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuIHN0YXRlLnRvSVNPU3RyaW5nKCk7CiAgaWYgKHN0YXRlIGluc3RhbmNlb2YgUmVnRXhwKSByZXR1cm4gc3RhdGUudG9TdHJpbmcoKTsKICBpZiAoc3RhdGUgaW5zdGFuY2VvZiBNYXApIHJldHVybiAiW01hcF0iOwogIGlmIChzdGF0ZSBpbnN0YW5jZW9mIFNldCkgcmV0dXJuICJbU2V0XSI7CiAgaWYgKHJvb3QgPT09IHZvaWQgMCkgcm9vdCA9IHN0YXRlOwogIGlmIChzZWVuLmhhcyhzdGF0ZSkpIHJldHVybiAiW0NpcmN1bGFyXSI7CiAgc2Vlbi5hZGQoc3RhdGUpOwogIGNvbnN0IHNhbml0aXplZCA9IEFycmF5LmlzQXJyYXkoc3RhdGUpID8gW10gOiB7fTsKICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhzdGF0ZSkpIHsKICAgIGNvbnN0IGlzU2Vuc2l0aXZlID0gU0VOU0lUSVZFX0tFWVMuc29tZSgKICAgICAgKHMpID0+IGtleS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHMudG9Mb3dlckNhc2UoKSkKICAgICk7CiAgICBpZiAoaXNTZW5zaXRpdmUpIHsKICAgICAgc2FuaXRpemVkW2tleV0gPSAiW1JFREFDVEVEXSI7CiAgICB9IGVsc2UgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHsKICAgICAgaWYgKGlzU2FtZU9iamVjdCh2YWx1ZSwgcm9vdCkpIHsKICAgICAgICBzYW5pdGl6ZWRba2V5XSA9ICJbQ2lyY3VsYXJdIjsKICAgICAgfSBlbHNlIGlmIChzZWVuLmhhcyh2YWx1ZSkpIHsKICAgICAgICBzYW5pdGl6ZWRba2V5XSA9ICJbQ2lyY3VsYXJdIjsKICAgICAgfSBlbHNlIHsKICAgICAgICBzYW5pdGl6ZWRba2V5XSA9IHNhbml0aXplU3RhdGUodmFsdWUsIHNlZW4sIHJvb3QpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICBzYW5pdGl6ZWRba2V5XSA9ICJbRnVuY3Rpb25dIjsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAic3ltYm9sIikgewogICAgICBzYW5pdGl6ZWRba2V5XSA9ICJbU3ltYm9sXSI7CiAgICB9IGVsc2UgewogICAgICBzYW5pdGl6ZWRba2V5XSA9IHZhbHVlOwogICAgfQogIH0KICByZXR1cm4gc2FuaXRpemVkOwp9CmZ1bmN0aW9uIGdlbmVyYXRlU3VnZ2VzdGlvbihjdHgpIHsKICBjb25zdCBtc2cgPSBjdHguZXJyb3IubWVzc2FnZS50b0xvd2VyQ2FzZSgpOwogIGlmIChtc2cuaW5jbHVkZXMoInVuZGVmaW5lZCIpICYmIG1zZy5pbmNsdWRlcygicmVhZGluZyIpKSB7CiAgICBjb25zdCBtYXRjaCA9IG1zZy5tYXRjaCgvcmVhZGluZyAnKFx3KyknLyk7CiAgICBpZiAobWF0Y2gpIHsKICAgICAgcmV0dXJuIGBQcm9wZXJ0eSBhY2Nlc3Mgb24gbnVsbC91bmRlZmluZWQuIEFkZCBudWxsIGNoZWNrIGJlZm9yZSBhY2Nlc3NpbmcgJyR7bWF0Y2hbMV19JyBvciBpbml0aWFsaXplIHRoZSB2YWx1ZS5gOwogICAgfQogIH0KICBpZiAobXNnLmluY2x1ZGVzKCJpcyBub3QgYSBmdW5jdGlvbiIpKSB7CiAgICBjb25zdCBtYXRjaCA9IG1zZy5tYXRjaCgvKFx3KykgaXMgbm90IGEgZnVuY3Rpb24vKTsKICAgIGlmIChtYXRjaCkgewogICAgICByZXR1cm4gYCcke21hdGNoWzFdfScgaXMgbm90IGEgZnVuY3Rpb24uIENoZWNrIGlmIGl0J3MgZGVmaW5lZCwgaW1wb3J0ZWQsIG9yIGlmIHRoZSBvYmplY3QgZXhpc3RzLmA7CiAgICB9CiAgfQogIGlmIChtc2cuaW5jbHVkZXMoIm1hcCIpIHx8IG1zZy5pbmNsdWRlcygiZmlsdGVyIikgfHwgbXNnLmluY2x1ZGVzKCJmb3JlYWNoIikpIHsKICAgIHJldHVybiAiQXJyYXkgbWV0aG9kIGNhbGxlZCBvbiBub24tYXJyYXkuIEluaXRpYWxpemUgYXMgZW1wdHkgYXJyYXkgb3IgYWRkIHR5cGUgY2hlY2suIjsKICB9CiAgaWYgKG1zZy5pbmNsdWRlcygibnVsbCIpIHx8IG1zZy5pbmNsdWRlcygidW5kZWZpbmVkIikpIHsKICAgIHJldHVybiAiTnVsbC91bmRlZmluZWQgdmFsdWUgZW5jb3VudGVyZWQuIEFkZCBkZWZlbnNpdmUgY2hlY2tzIG9yIGluaXRpYWxpemUgZGF0YS4iOwogIH0KICByZXR1cm4gIkNoZWNrIHRoZSBlcnJvciBtZXNzYWdlIGFuZCBjb21wb25lbnQgc3RhdGUgZm9yIHRoZSByb290IGNhdXNlLiI7Cn0KZnVuY3Rpb24gZ2V0RXJyb3JNYXAoKSB7CiAgcmV0dXJuIGRlYnVnQVBJLmVycm9yczsKfQpmdW5jdGlvbiBnZXRNaXNzaW5nRnVuY3Rpb25zTWFwKCkgewogIHJldHVybiBpbnNpZGVPdXRBUEkubWlzc2luZ0Z1bmN0aW9uczsKfQpmdW5jdGlvbiBnZXREZWZpbmVkSGVscGVyc01hcCgpIHsKICByZXR1cm4gaW5zaWRlT3V0QVBJLmhlbHBlcnM7Cn0KZnVuY3Rpb24gZ2V0TWlzc2luZ0NvbXBvbmVudHMoKSB7CiAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBbXTsKICBjb25zdCBtaXNzaW5nID0gW107CiAgY29uc3QgYWxsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgiKiIpOwogIGZvciAoY29uc3QgZWwgb2YgQXJyYXkuZnJvbShhbGwpKSB7CiAgICBjb25zdCB0YWcgPSBlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICBpZiAodGFnLmluY2x1ZGVzKCItIikgJiYgIWN1c3RvbUVsZW1lbnRzLmdldCh0YWcpKSB7CiAgICAgIGlmICghbWlzc2luZy5pbmNsdWRlcyh0YWcpKSB7CiAgICAgICAgbWlzc2luZy5wdXNoKHRhZyk7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG1pc3Npbmc7Cn0KZnVuY3Rpb24gZ2V0UmVnaXN0ZXJlZENvbXBvbmVudHMoKSB7CiAgY29uc3QgYXBwU3RhdGUgPSBnZXRDdXJyZW50QXBwU3RhdGUoKTsKICBpZiAoIWFwcFN0YXRlKSByZXR1cm4gW107CiAgcmV0dXJuIGFwcFN0YXRlLmludGVybmFsLmN1c3RvbVRhZ3MgfHwgW107Cn0KZnVuY3Rpb24gZ2V0Q29tcG9uZW50VGVtcGxhdGUodGFnTmFtZSkgewogIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gbnVsbDsKICBjb25zdCB0ZW1wbGF0ZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoYHRlbXBsYXRlW2RhdGEtY29tcG9uZW50PSIke3RhZ05hbWV9Il1gKTsKICByZXR1cm4gdGVtcGxhdGU/LmlubmVySFRNTCA/PyBudWxsOwp9CmZ1bmN0aW9uIGNvdW50Q29tcG9uZW50SW5zdGFuY2VzKHRhZ05hbWUpIHsKICBpZiAodHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIikgcmV0dXJuIDA7CiAgcmV0dXJuIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwodGFnTmFtZSkubGVuZ3RoOwp9CmZ1bmN0aW9uIGJ1aWxkQ29tcG9uZW50SW5mbyh0YWdOYW1lKSB7CiAgY29uc3QgYXBwU3RhdGUgPSBnZXRDdXJyZW50QXBwU3RhdGUoKTsKICBjb25zdCBoYXNMb2dpYyA9IGFwcFN0YXRlPy5pbnRlcm5hbC5jb21wb25lbnRzLmhhcyh0YWdOYW1lKSA/PyBmYWxzZTsKICBjb25zdCB0ZW1wbGF0ZSA9IGdldENvbXBvbmVudFRlbXBsYXRlKHRhZ05hbWUpOwogIGNvbnN0IGluc3RhbmNlQ291bnQgPSBjb3VudENvbXBvbmVudEluc3RhbmNlcyh0YWdOYW1lKTsKICBjb25zdCBlcnJvcnMyID0gZ2V0RXJyb3JNYXAoKTsKICBjb25zdCBoYXNFcnJvciA9IGVycm9yczIuaGFzKHRhZ05hbWUpOwogIGNvbnN0IHJlZnMgPSBbXTsKICBjb25zdCBzbG90cyA9IFtdOwogIGlmICh0ZW1wbGF0ZSkgewogICAgY29uc3QgdGVtcERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgdGVtcERpdi5pbm5lckhUTUwgPSB0ZW1wbGF0ZTsKICAgIHRlbXBEaXYucXVlcnlTZWxlY3RvckFsbCgiW2RhdGEtcmVmXSIpLmZvckVhY2goKGVsKSA9PiB7CiAgICAgIGNvbnN0IHJlZk5hbWUgPSBlbC5nZXRBdHRyaWJ1dGUoImRhdGEtcmVmIik7CiAgICAgIGlmIChyZWZOYW1lKSByZWZzLnB1c2gocmVmTmFtZSk7CiAgICB9KTsKICAgIHRlbXBEaXYucXVlcnlTZWxlY3RvckFsbCgiW2RhdGEtc2xvdF0sIHNsb3RbbmFtZV0iKS5mb3JFYWNoKChlbCkgPT4gewogICAgICBjb25zdCBzbG90TmFtZSA9IGVsLmdldEF0dHJpYnV0ZSgiZGF0YS1zbG90IikgfHwgZWwuZ2V0QXR0cmlidXRlKCJuYW1lIik7CiAgICAgIGlmIChzbG90TmFtZSkgc2xvdHMucHVzaChzbG90TmFtZSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIHsKICAgIHRhZ05hbWUsCiAgICB0ZW1wbGF0ZSwKICAgIGhhc0xvZ2ljLAogICAgcmVmcywKICAgIHNsb3RzLAogICAgZXZlbnRzOiBbXSwKICAgIC8vIFdvdWxkIG5lZWQgdG8gdHJhY2sgZnJvbSBvbigpIGNhbGxzCiAgICBzdGF0ZUFjY2VzczogW10sCiAgICAvLyBXb3VsZCBuZWVkIHRvIHRyYWNrIGZyb20gc3RhdGUgYWNjZXNzCiAgICBoYXNFcnJvciwKICAgIGluc3RhbmNlQ291bnQKICB9Owp9CmZ1bmN0aW9uIGJ1aWxkQ29tcG9uZW50TWFwKCkgewogIGNvbnN0IHRhZ3MgPSBnZXRSZWdpc3RlcmVkQ29tcG9uZW50cygpOwogIGNvbnN0IG1hcCA9IHt9OwogIGZvciAoY29uc3QgdGFnIG9mIHRhZ3MpIHsKICAgIG1hcFt0YWddID0gYnVpbGRDb21wb25lbnRJbmZvKHRhZyk7CiAgfQogIHJldHVybiBtYXA7Cn0KZnVuY3Rpb24gZ2V0Q2FwYWJpbGl0aWVzKCkgewogIGNvbnN0IGNhcGFiaWxpdGllcyA9IFsicmVhY3RpdmUtc3RhdGUiLCAid2ViLWNvbXBvbmVudHMiLCAiZXZlbnQtaGFuZGxpbmciXTsKICBjb25zdCBjb25maWcgPSBnZXREZWJ1Z0NvbmZpZygpOwogIGlmIChjb25maWcuZXJyb3JCb3VuZGFyeSkgY2FwYWJpbGl0aWVzLnB1c2goImVycm9yLWJvdW5kYXJ5Iik7CiAgaWYgKGNvbmZpZy5nbG9iYWxzKSBjYXBhYmlsaXRpZXMucHVzaCgiZGVidWctZ2xvYmFscyIpOwogIGlmIChjb25maWcuYXBpKSBjYXBhYmlsaXRpZXMucHVzaCgicnVudGltZS1kZWZpbmUiKTsKICBpZiAoY29uZmlnLm1ldGhvZE1pc3NpbmcpIGNhcGFiaWxpdGllcy5wdXNoKCJtZXRob2QtbWlzc2luZyIpOwogIGlmIChjb25maWcudGVtcGxhdGVJbmZlcmVuY2UpIGNhcGFiaWxpdGllcy5wdXNoKCJ0ZW1wbGF0ZS1pbmZlcmVuY2UiKTsKICByZXR1cm4gY2FwYWJpbGl0aWVzOwp9CmZ1bmN0aW9uIGRldGVjdFBhdHRlcm5zKCkgewogIGNvbnN0IHRhZ3MgPSBnZXRSZWdpc3RlcmVkQ29tcG9uZW50cygpOwogIGNvbnN0IGNvbXBvbmVudE5hbWluZyA9IHRhZ3MubGVuZ3RoID4gMCA/IHRhZ3MuZXZlcnkoKHQpID0+IHQubWF0Y2goL15bYS16XSstW2Etel0rKC1bYS16XSspKiQvKSkgPyAia2ViYWItY2FzZSAoZS5nLiwgdXNlci1wcm9maWxlLCB0b2RvLWxpc3QpIiA6ICJtaXhlZCIgOiAidW5rbm93biI7CiAgcmV0dXJuIHsKICAgIGV2ZW50TmFtaW5nOiAidW5rbm93biIsCiAgICAvLyBXb3VsZCBuZWVkIHRvIHRyYWNrIGV2ZW50cwogICAgc3RhdGVTdHJ1Y3R1cmU6ICJ1bmtub3duIiwKICAgIC8vIFdvdWxkIG5lZWQgdG8gYW5hbHl6ZSBzdGF0ZSBzaGFwZQogICAgY29tcG9uZW50TmFtaW5nCiAgfTsKfQpmdW5jdGlvbiBpbmZlclNpZ25hdHVyZShuYW1lLCBhcmdzKSB7CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gYCR7bmFtZX0oKTogYW55YDsKICBjb25zdCBhcmdUeXBlcyA9IGFyZ3MubWFwKChhcmcsIGkpID0+IHsKICAgIGlmIChhcmcgPT09IG51bGwpIHJldHVybiBgYXJnJHtpfTogbnVsbGA7CiAgICBpZiAoYXJnID09PSB2b2lkIDApIHJldHVybiBgYXJnJHtpfTogdW5kZWZpbmVkYDsKICAgIGlmIChBcnJheS5pc0FycmF5KGFyZykpIHJldHVybiBgaXRlbXM6IGFueVtdYDsKICAgIGlmICh0eXBlb2YgYXJnID09PSAib2JqZWN0IikgcmV0dXJuIGBkYXRhOiBvYmplY3RgOwogICAgcmV0dXJuIGBhcmcke2l9OiAke3R5cGVvZiBhcmd9YDsKICB9KTsKICByZXR1cm4gYCR7bmFtZX0oJHthcmdUeXBlcy5qb2luKCIsICIpfSk6IGFueWA7Cn0KZnVuY3Rpb24gZ2V0RW1wdHlDb250ZXh0KCkgewogIHJldHVybiB7CiAgICBmcmFtZXdvcms6IHsKICAgICAgbmFtZTogImJvcmVET00iLAogICAgICB2ZXJzaW9uOiBWRVJTSU9OLAogICAgICBjYXBhYmlsaXRpZXM6IFtdCiAgICB9LAogICAgc3RhdGU6IHsKICAgICAgc2hhcGU6ICJ7fSIsCiAgICAgIHBhdGhzOiBbXSwKICAgICAgc2FtcGxlOiB7fQogICAgfSwKICAgIGNvbXBvbmVudHM6IHt9LAogICAgaXNzdWVzOiB7CiAgICAgIGVycm9yczogW10sCiAgICAgIG1pc3NpbmdGdW5jdGlvbnM6IFtdLAogICAgICBtaXNzaW5nQ29tcG9uZW50czogW10KICAgIH0sCiAgICBoZWxwZXJzOiB7CiAgICAgIGRlZmluZWQ6IHt9LAogICAgICBtaXNzaW5nOiB7fQogICAgfSwKICAgIHBhdHRlcm5zOiB7CiAgICAgIGV2ZW50TmFtaW5nOiAidW5rbm93biIsCiAgICAgIHN0YXRlU3RydWN0dXJlOiAidW5rbm93biIsCiAgICAgIGNvbXBvbmVudE5hbWluZzogInVua25vd24iCiAgICB9CiAgfTsKfQpmdW5jdGlvbiBnZXRFbXB0eUZvY3VzZWRDb250ZXh0KCkgewogIHJldHVybiB7CiAgICBpc3N1ZTogewogICAgICB0eXBlOiAibm9uZSIsCiAgICAgIGRlc2NyaXB0aW9uOiAiTExNIGZlYXR1cmVzIGRpc2FibGVkIG9yIHVuYXZhaWxhYmxlIgogICAgfSwKICAgIHJlbGV2YW50U3RhdGU6IHt9CiAgfTsKfQpmdW5jdGlvbiBjb250ZXh0KCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICByZXR1cm4gZ2V0RW1wdHlDb250ZXh0KCk7CiAgfQogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImxsbSIpKSB7CiAgICByZXR1cm4gZ2V0RW1wdHlDb250ZXh0KCk7CiAgfQogIGNvbnN0IGFwcFN0YXRlID0gZ2V0Q3VycmVudEFwcFN0YXRlKCk7CiAgY29uc3Qgc3RhdGUgPSBhcHBTdGF0ZT8uYXBwID8/IHt9OwogIGNvbnN0IGVycm9yczIgPSBnZXRFcnJvck1hcCgpOwogIGNvbnN0IG1pc3NpbmdGbnMgPSBnZXRNaXNzaW5nRnVuY3Rpb25zTWFwKCk7CiAgY29uc3QgZGVmaW5lZEhlbHBlcnMgPSBnZXREZWZpbmVkSGVscGVyc01hcCgpOwogIGNvbnN0IGVycm9ySW5mb3MgPSBBcnJheS5mcm9tKGVycm9yczIudmFsdWVzKCkpLm1hcCgoY3R4KSA9PiAoewogICAgY29tcG9uZW50OiBjdHguY29tcG9uZW50LAogICAgZXJyb3I6IGN0eC5lcnJvci5tZXNzYWdlLAogICAgc3RhY2s6IGN0eC5zdGFjaywKICAgIHN0YXRlOiBzYW5pdGl6ZVN0YXRlKGN0eC5zdGF0ZSksCiAgICB0aW1lc3RhbXA6IGN0eC50aW1lc3RhbXAKICB9KSk7CiAgY29uc3QgbWlzc2luZ0ZuSW5mb3MgPSBbXTsKICBjb25zdCBtaXNzaW5nQ2FsbEluZm9zID0ge307CiAgZm9yIChjb25zdCBbbmFtZSwgY2FsbHNdIG9mIG1pc3NpbmdGbnMuZW50cmllcygpKSB7CiAgICBjb25zdCBhbGxBcmdzID0gY2FsbHMubWFwKChjKSA9PiBjLmFyZ3MpOwogICAgY29uc3QgY29tcG9uZW50cyA9IFsuLi5uZXcgU2V0KGNhbGxzLm1hcCgoYykgPT4gYy5jb21wb25lbnQpKV07CiAgICBjb25zdCBsYXN0Q2FsbCA9IE1hdGgubWF4KC4uLmNhbGxzLm1hcCgoYykgPT4gYy50aW1lc3RhbXApKTsKICAgIG1pc3NpbmdGbkluZm9zLnB1c2goewogICAgICBuYW1lLAogICAgICBhcmdzOiBjYWxsc1swXT8uYXJncyA/PyBbXSwKICAgICAgY29tcG9uZW50OiBjYWxsc1swXT8uY29tcG9uZW50ID8/ICJ1bmtub3duIiwKICAgICAgaW5mZXJyZWRTaWduYXR1cmU6IGluZmVyU2lnbmF0dXJlKG5hbWUsIGNhbGxzWzBdPy5hcmdzID8/IFtdKSwKICAgICAgY2FsbENvdW50OiBjYWxscy5sZW5ndGgKICAgIH0pOwogICAgbWlzc2luZ0NhbGxJbmZvc1tuYW1lXSA9IHsKICAgICAgYXJnczogYWxsQXJncywKICAgICAgY29tcG9uZW50cywKICAgICAgbGFzdENhbGwKICAgIH07CiAgfQogIGNvbnN0IGRlZmluZWRIZWxwZXJTaWduYXR1cmVzID0ge307CiAgZm9yIChjb25zdCBbbmFtZSwgZm5dIG9mIGRlZmluZWRIZWxwZXJzLmVudHJpZXMoKSkgewogICAgZGVmaW5lZEhlbHBlclNpZ25hdHVyZXNbbmFtZV0gPSBgJHtuYW1lfSgke2ZuLmxlbmd0aCA+IDAgPyAiLi4uIiA6ICIifSk6IGFueWA7CiAgfQogIHJldHVybiB7CiAgICBmcmFtZXdvcms6IHsKICAgICAgbmFtZTogImJvcmVET00iLAogICAgICB2ZXJzaW9uOiBWRVJTSU9OLAogICAgICBjYXBhYmlsaXRpZXM6IGdldENhcGFiaWxpdGllcygpCiAgICB9LAogICAgc3RhdGU6IHsKICAgICAgc2hhcGU6IGluZmVyVHlwZVNoYXBlKHN0YXRlKSwKICAgICAgcGF0aHM6IGdldFN0YXRlUGF0aHMoc3RhdGUpLAogICAgICBzYW1wbGU6IHNhbml0aXplU3RhdGUoc3RhdGUpCiAgICB9LAogICAgY29tcG9uZW50czogYnVpbGRDb21wb25lbnRNYXAoKSwKICAgIGlzc3VlczogewogICAgICBlcnJvcnM6IGVycm9ySW5mb3MsCiAgICAgIG1pc3NpbmdGdW5jdGlvbnM6IG1pc3NpbmdGbkluZm9zLAogICAgICBtaXNzaW5nQ29tcG9uZW50czogZ2V0TWlzc2luZ0NvbXBvbmVudHMoKQogICAgfSwKICAgIGhlbHBlcnM6IHsKICAgICAgZGVmaW5lZDogZGVmaW5lZEhlbHBlclNpZ25hdHVyZXMsCiAgICAgIG1pc3Npbmc6IG1pc3NpbmdDYWxsSW5mb3MKICAgIH0sCiAgICBwYXR0ZXJuczogZGV0ZWN0UGF0dGVybnMoKQogIH07Cn0KZnVuY3Rpb24gZm9jdXMoKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHsKICAgIHJldHVybiBnZXRFbXB0eUZvY3VzZWRDb250ZXh0KCk7CiAgfQogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImxsbSIpKSB7CiAgICByZXR1cm4gZ2V0RW1wdHlGb2N1c2VkQ29udGV4dCgpOwogIH0KICBjb25zdCBlcnJvcnMyID0gZ2V0RXJyb3JNYXAoKTsKICBpZiAoZXJyb3JzMi5zaXplID4gMCkgewogICAgY29uc3QgZXJyb3JMaXN0ID0gQXJyYXkuZnJvbShlcnJvcnMyLnZhbHVlcygpKTsKICAgIGNvbnN0IGxhdGVzdCA9IGVycm9yTGlzdFtlcnJvckxpc3QubGVuZ3RoIC0gMV07CiAgICByZXR1cm4gewogICAgICBpc3N1ZTogewogICAgICAgIHR5cGU6ICJlcnJvciIsCiAgICAgICAgZGVzY3JpcHRpb246IGxhdGVzdC5lcnJvci5tZXNzYWdlLAogICAgICAgIGNvbXBvbmVudDogbGF0ZXN0LmNvbXBvbmVudCwKICAgICAgICBzdWdnZXN0aW9uOiBnZW5lcmF0ZVN1Z2dlc3Rpb24obGF0ZXN0KQogICAgICB9LAogICAgICBjb21wb25lbnQ6IHsKICAgICAgICAuLi5idWlsZENvbXBvbmVudEluZm8obGF0ZXN0LmNvbXBvbmVudCksCiAgICAgICAgY3VycmVudFN0YXRlOiBzYW5pdGl6ZVN0YXRlKGxhdGVzdC5zdGF0ZSkKICAgICAgfSwKICAgICAgcmVsZXZhbnRTdGF0ZTogc2FuaXRpemVTdGF0ZShsYXRlc3Quc3RhdGUpLAogICAgICBwcmV2aW91c0F0dGVtcHRzOiBnZXRSZWNlbnRBdHRlbXB0cygpCiAgICB9OwogIH0KICBjb25zdCBtaXNzaW5nRm5zID0gZ2V0TWlzc2luZ0Z1bmN0aW9uc01hcCgpOwogIGlmIChtaXNzaW5nRm5zLnNpemUgPiAwKSB7CiAgICBjb25zdCBlbnRyaWVzID0gQXJyYXkuZnJvbShtaXNzaW5nRm5zLmVudHJpZXMoKSk7CiAgICBjb25zdCBbbmFtZSwgY2FsbHNdID0gZW50cmllc1tlbnRyaWVzLmxlbmd0aCAtIDFdOwogICAgY29uc3QgbGFzdENhbGwgPSBjYWxsc1tjYWxscy5sZW5ndGggLSAxXTsKICAgIHJldHVybiB7CiAgICAgIGlzc3VlOiB7CiAgICAgICAgdHlwZTogIm1pc3NpbmdfZnVuY3Rpb24iLAogICAgICAgIGRlc2NyaXB0aW9uOiBgVW5kZWZpbmVkIGZ1bmN0aW9uICcke25hbWV9JyBjYWxsZWRgLAogICAgICAgIGNvbXBvbmVudDogbGFzdENhbGw/LmNvbXBvbmVudCwKICAgICAgICBzdWdnZXN0aW9uOiBgRGVmaW5lIGhlbHBlcjogYm9yZURPTS5kZWZpbmVIZWxwZXIoIiR7bmFtZX0iLCAoJHtpbmZlclNpZ25hdHVyZShuYW1lLCBsYXN0Q2FsbD8uYXJncyA/PyBbXSkuc3BsaXQoIigiKVsxXT8uc3BsaXQoIikiKVswXSB8fCAiIn0pID0+IHsgLyogaW1wbGVtZW50YXRpb24gKi8gfSlgCiAgICAgIH0sCiAgICAgIGNvbXBvbmVudDogbGFzdENhbGw/LmNvbXBvbmVudCA/IHsKICAgICAgICAuLi5idWlsZENvbXBvbmVudEluZm8obGFzdENhbGwuY29tcG9uZW50KSwKICAgICAgICBjdXJyZW50U3RhdGU6IHNhbml0aXplU3RhdGUoZ2V0Q3VycmVudEFwcFN0YXRlKCk/LmFwcCkKICAgICAgfSA6IHZvaWQgMCwKICAgICAgcmVsZXZhbnRTdGF0ZTogc2FuaXRpemVTdGF0ZShnZXRDdXJyZW50QXBwU3RhdGUoKT8uYXBwKSwKICAgICAgcHJldmlvdXNBdHRlbXB0czogZ2V0UmVjZW50QXR0ZW1wdHMoKQogICAgfTsKICB9CiAgY29uc3QgbWlzc2luZ0NvbXBvbmVudHMgPSBnZXRNaXNzaW5nQ29tcG9uZW50cygpOwogIGlmIChtaXNzaW5nQ29tcG9uZW50cy5sZW5ndGggPiAwKSB7CiAgICBjb25zdCB0YWdOYW1lID0gbWlzc2luZ0NvbXBvbmVudHNbMF07CiAgICByZXR1cm4gewogICAgICBpc3N1ZTogewogICAgICAgIHR5cGU6ICJtaXNzaW5nX2NvbXBvbmVudCIsCiAgICAgICAgZGVzY3JpcHRpb246IGBDdXN0b20gZWxlbWVudCA8JHt0YWdOYW1lfT4gdXNlZCBidXQgbm90IGRlZmluZWRgLAogICAgICAgIHN1Z2dlc3Rpb246IGBEZWZpbmUgY29tcG9uZW50OiBib3JlRE9NLmRlZmluZSgiJHt0YWdOYW1lfSIsICI8dGVtcGxhdGUtaHRtbD4iLCAoeyBzdGF0ZSB9KSA9PiAoeyBzbG90cyB9KSA9PiB7IC8qIHJlbmRlciAqLyB9KWAKICAgICAgfSwKICAgICAgcmVsZXZhbnRTdGF0ZTogc2FuaXRpemVTdGF0ZShnZXRDdXJyZW50QXBwU3RhdGUoKT8uYXBwKSwKICAgICAgcHJldmlvdXNBdHRlbXB0czogZ2V0UmVjZW50QXR0ZW1wdHMoKQogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIGlzc3VlOiB7CiAgICAgIHR5cGU6ICJub25lIiwKICAgICAgZGVzY3JpcHRpb246ICJObyBjdXJyZW50IGlzc3VlcyBkZXRlY3RlZCIKICAgIH0sCiAgICByZWxldmFudFN0YXRlOiBzYW5pdGl6ZVN0YXRlKGdldEN1cnJlbnRBcHBTdGF0ZSgpPy5hcHApCiAgfTsKfQpmdW5jdGlvbiBjb3B5KCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSB7CiAgICByZXR1cm4gInt9IjsKICB9CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgibGxtIikpIHsKICAgIHJldHVybiAie30iOwogIH0KICBjb25zdCBjdHggPSBmb2N1cygpOwogIGNvbnN0IGpzb24gPSBKU09OLnN0cmluZ2lmeShjdHgsIG51bGwsIDIpOwogIGlmICh0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIiAmJiBuYXZpZ2F0b3IuY2xpcGJvYXJkKSB7CiAgICBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dChqc29uKS50aGVuKCgpID0+IHsKICAgICAgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgICAgICBjb25zb2xlLmxvZygKICAgICAgICAgICIlY1x1ezFGNENCfSBib3JlRE9NOiBMTE0gY29udGV4dCBjb3BpZWQgdG8gY2xpcGJvYXJkIiwKICAgICAgICAgICJjb2xvcjogIzI3YWU2MDsgZm9udC13ZWlnaHQ6IGJvbGQiCiAgICAgICAgKTsKICAgICAgfQogICAgfSkuY2F0Y2goKCkgPT4gewogICAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICAgIGNvbnNvbGUubG9nKAogICAgICAgICAgIiVjXHV7MUY0Q0J9IGJvcmVET006IENsaXBib2FyZCBhY2Nlc3MgZmFpbGVkLCBjb250ZXh0IGxvZ2dlZCBiZWxvdzoiLAogICAgICAgICAgImNvbG9yOiAjZjM5YzEyOyBmb250LXdlaWdodDogYm9sZCIKICAgICAgICApOwogICAgICAgIGNvbnNvbGUubG9nKGpzb24pOwogICAgICB9CiAgICB9KTsKICB9IGVsc2UgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgIGNvbnNvbGUubG9nKAogICAgICAiJWNcdXsxRjRDQn0gYm9yZURPTTogQ2xpcGJvYXJkIHVuYXZhaWxhYmxlLCBjb250ZXh0IGxvZ2dlZCBiZWxvdzoiLAogICAgICAiY29sb3I6ICNmMzljMTI7IGZvbnQtd2VpZ2h0OiBib2xkIgogICAgKTsKICAgIGNvbnNvbGUubG9nKGpzb24pOwogIH0KICByZXR1cm4ganNvbjsKfQpmdW5jdGlvbiByZWNvcmRBdHRlbXB0KGNvZGUsIHJlc3VsdCwgZXJyb3IpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImxsbSIpKSByZXR1cm47CiAgYXR0ZW1wdHMucHVzaCh7CiAgICBjb2RlLAogICAgcmVzdWx0LAogICAgZXJyb3IsCiAgICB0aW1lc3RhbXA6IERhdGUubm93KCkKICB9KTsKICBpZiAoYXR0ZW1wdHMubGVuZ3RoID4gMTApIHsKICAgIGF0dGVtcHRzID0gYXR0ZW1wdHMuc2xpY2UoLTEwKTsKICB9Cn0KZnVuY3Rpb24gZ2V0UmVjZW50QXR0ZW1wdHMoKSB7CiAgcmV0dXJuIFsuLi5hdHRlbXB0c107Cn0KZnVuY3Rpb24gZ2V0QXR0ZW1wdHMoKSB7CiAgcmV0dXJuIFsuLi5hdHRlbXB0c107Cn0KZnVuY3Rpb24gY2xlYXJBdHRlbXB0cygpIHsKICBhdHRlbXB0cyA9IFtdOwp9CmZ1bmN0aW9uIGZvcm1hdEVycm9yRm9yTExNKGN0eCkgewogIHJldHVybiBKU09OLnN0cmluZ2lmeSh7CiAgICB0eXBlOiAiZXJyb3IiLAogICAgY29tcG9uZW50OiBjdHguY29tcG9uZW50LAogICAgZXJyb3I6IGN0eC5lcnJvci5tZXNzYWdlLAogICAgc3RhY2s6IGN0eC5zdGFjaywKICAgIHN0YXRlOiBzYW5pdGl6ZVN0YXRlKGN0eC5zdGF0ZSksCiAgICByZWZzOiBPYmplY3Qua2V5cyhjdHgucmVmcyksCiAgICBzbG90czogT2JqZWN0LmtleXMoY3R4LnNsb3RzKSwKICAgIHN1Z2dlc3Rpb246IGdlbmVyYXRlU3VnZ2VzdGlvbihjdHgpLAogICAgdGltZXN0YW1wOiBjdHgudGltZXN0YW1wCiAgfSk7Cn0KZnVuY3Rpb24gbGxtTG9nKHR5cGUsIGRhdGEpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGNvbnN0IGNvbmZpZyA9IGdldERlYnVnQ29uZmlnKCk7CiAgaWYgKGNvbmZpZy5vdXRwdXRGb3JtYXQgPT09ICJsbG0iKSB7CiAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeSh7IHR5cGUsIC4uLmRhdGEgfSkpOwogIH0KfQpmdW5jdGlvbiBpc0xMTU91dHB1dEZvcm1hdCgpIHsKICBjb25zdCBjb25maWcgPSBnZXREZWJ1Z0NvbmZpZygpOwogIHJldHVybiBjb25maWcub3V0cHV0Rm9ybWF0ID09PSAibGxtIjsKfQp2YXIgYXR0ZW1wdHMsIFNFTlNJVElWRV9LRVlTLCBDSVJDVUxBUl9DSEVDSywgbGxtQVBJOwp2YXIgaW5pdF9sbG0gPSBfX2VzbSh7CiAgInNyYy9sbG0udHMiKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgaW5pdF9kZWJ1ZygpOwogICAgaW5pdF9jb25zb2xlX2FwaSgpOwogICAgaW5pdF9pbnNpZGVfb3V0KCk7CiAgICBpbml0X3ZlcnNpb24oKTsKICAgIGluaXRfdHlwZV9pbmZlcmVuY2UoKTsKICAgIGluaXRfdmFsaWRhdGlvbigpOwogICAgYXR0ZW1wdHMgPSBbXTsKICAgIFNFTlNJVElWRV9LRVlTID0gWwogICAgICAicGFzc3dvcmQiLAogICAgICAidG9rZW4iLAogICAgICAic2VjcmV0IiwKICAgICAgImFwaUtleSIsCiAgICAgICJhcGlfa2V5IiwKICAgICAgImF1dGgiLAogICAgICAiY3JlZGVudGlhbCIsCiAgICAgICJwcml2YXRlIiwKICAgICAgImtleSIsCiAgICAgICJwYXNzIgogICAgXTsKICAgIENJUkNVTEFSX0NIRUNLID0gU3ltYm9sKCJfX2xsbV9jaXJjdWxhcl9jaGVja19fIik7CiAgICBsbG1BUEkgPSB7CiAgICAgIC8qKiBHZXQgY29tcGxldGUgc2Vzc2lvbiBjb250ZXh0ICovCiAgICAgIGNvbnRleHQsCiAgICAgIC8qKiBHZXQgZm9jdXNlZCBjb250ZXh0IGZvciBjdXJyZW50IGlzc3VlICovCiAgICAgIGZvY3VzLAogICAgICAvKiogQ29weSBjb250ZXh0IHRvIGNsaXBib2FyZCAqLwogICAgICBjb3B5LAogICAgICAvKiogR2V0IGFsbCByZWNvcmRlZCBhdHRlbXB0cyAqLwogICAgICBnZXQgYXR0ZW1wdHMoKSB7CiAgICAgICAgcmV0dXJuIGdldEF0dGVtcHRzKCk7CiAgICAgIH0sCiAgICAgIC8qKiBDbGVhciByZWNvcmRlZCBhdHRlbXB0cyAqLwogICAgICBjbGVhckF0dGVtcHRzLAogICAgICAvKiogQGludGVybmFsIFJlY29yZCBhbiBhdHRlbXB0ICovCiAgICAgIF9yZWNvcmRBdHRlbXB0OiByZWNvcmRBdHRlbXB0LAogICAgICAvLyBUeXBlIGluZmVyZW5jZSAoUGhhc2UgNSkKICAgICAgLyoqIEluZmVyIFR5cGVTY3JpcHQgdHlwZXMgZnJvbSBydW50aW1lIHVzYWdlICovCiAgICAgIGluZmVyVHlwZXMsCiAgICAgIC8qKiBHZXQgaW5mZXJyZWQgdHlwZSBmb3IgYSBzcGVjaWZpYyBwYXRoICovCiAgICAgIHR5cGVPZiwKICAgICAgLyoqIENsZWFyIHR5cGUgdHJhY2tpbmcgZGF0YSAoZm9yIHRlc3RpbmcpICovCiAgICAgIF9jbGVhclR5cGVzOiBjbGVhclR5cGVUcmFja2luZywKICAgICAgLy8gVmFsaWRhdGlvbiAmIEFwcGx5IChQaGFzZSA2KQogICAgICAvKiogVmFsaWRhdGUgY29kZSB3aXRob3V0IGV4ZWN1dGluZyAqLwogICAgICB2YWxpZGF0ZSwKICAgICAgLyoqIEV4ZWN1dGUgY29kZSB3aXRoIGF1dG9tYXRpYyByb2xsYmFjayBvbiBlcnJvciAqLwogICAgICBhcHBseSwKICAgICAgLyoqIEFwcGx5IG11bHRpcGxlIGNvZGUgYmxvY2tzIGF0b21pY2FsbHkgKi8KICAgICAgYXBwbHlCYXRjaCwKICAgICAgLyoqIEBpbnRlcm5hbCBTZXQgdmFsaWRhdGlvbiBhcHAgc3RhdGUgKHVzZWQgYnkgaW5mbGljdEJvcmVET00pICovCiAgICAgIF9zZXRWYWxpZGF0aW9uQXBwU3RhdGU6IHNldFZhbGlkYXRpb25BcHBTdGF0ZQogICAgfTsKICB9Cn0pOwoKLy8gc3JjL2RlYnVnLnRzCmZ1bmN0aW9uIGlzRGVidWdFbmFibGVkKGZlYXR1cmUpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgewogICAgaWYgKGZlYXR1cmUgPT09ICJlcnJvckJvdW5kYXJ5IikgewogICAgICByZXR1cm4gZGVidWdDb25maWcuZXJyb3JCb3VuZGFyeSA/PyB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICBjb25zdCB2YWx1ZSA9IGRlYnVnQ29uZmlnW2ZlYXR1cmVdOwogIGlmIChmZWF0dXJlID09PSAic3RyaWN0IikgewogICAgcmV0dXJuIHZhbHVlID8/IGZhbHNlOwogIH0KICByZXR1cm4gdmFsdWUgPz8gdHJ1ZTsKfQpmdW5jdGlvbiBzZXREZWJ1Z0NvbmZpZyhjb25maWcpIHsKICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gImJvb2xlYW4iKSB7CiAgICBjb25zdCBlbmFibGVkID0gY29uZmlnOwogICAgZGVidWdDb25maWcgPSB7CiAgICAgIGNvbnNvbGU6IGVuYWJsZWQsCiAgICAgIGdsb2JhbHM6IGVuYWJsZWQsCiAgICAgIGVycm9yQm91bmRhcnk6IHRydWUsCiAgICAgIC8vIEFsd2F5cyBrZWVwIGVycm9yIGJvdW5kYXJ5IGZvciBzYWZldHkKICAgICAgdmlzdWFsSW5kaWNhdG9yczogZW5hYmxlZCwKICAgICAgZXJyb3JIaXN0b3J5OiBlbmFibGVkLAogICAgICB2ZXJzaW9uTG9nOiBlbmFibGVkLAogICAgICBhcGk6IGVuYWJsZWQsCiAgICAgIG1ldGhvZE1pc3Npbmc6IGVuYWJsZWQsCiAgICAgIHRlbXBsYXRlSW5mZXJlbmNlOiBlbmFibGVkLAogICAgICBzdHJpY3Q6IGZhbHNlLAogICAgICAvLyBTdHJpY3QgbW9kZSBvbmx5IGVuYWJsZWQgZXhwbGljaXRseQogICAgICBvdXRwdXRGb3JtYXQ6ICJodW1hbiIsCiAgICAgIC8vIEFsd2F5cyBodW1hbiBmb3JtYXQgYnkgZGVmYXVsdAogICAgICBsbG06IGVuYWJsZWQKICAgICAgLy8gTExNIEFQSSBmb2xsb3dzIGRlYnVnIG1vZGUKICAgIH07CiAgfSBlbHNlIHsKICAgIGRlYnVnQ29uZmlnID0geyAuLi5kZWJ1Z0NvbmZpZywgLi4uY29uZmlnIH07CiAgfQp9CmZ1bmN0aW9uIGdldERlYnVnQ29uZmlnKCkgewogIHJldHVybiB7IC4uLmRlYnVnQ29uZmlnIH07Cn0KZnVuY3Rpb24gZXhwb3NlR2xvYmFscyhjdHgpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImdsb2JhbHMiKSkgcmV0dXJuOwogIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgcmV0dXJuOwogIGNvbnN0IHcgPSB3aW5kb3c7CiAgdy4kc3RhdGUgPSBjdHguc3RhdGU7CiAgdy4kcmVmcyA9IGN0eC5yZWZzOwogIHcuJHNsb3RzID0gY3R4LnNsb3RzOwogIHcuJHNlbGYgPSBjdHguZWxlbWVudDsKICB3LiRlcnJvciA9IGN0eC5lcnJvcjsKICB3LiRjb21wb25lbnQgPSBjdHguY29tcG9uZW50OwogIHcuJHJlcmVuZGVyID0gY3R4LnJlcmVuZGVyOwp9CmZ1bmN0aW9uIGNsZWFyR2xvYmFscygpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgcmV0dXJuOwogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImdsb2JhbHMiKSkgcmV0dXJuOwogIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgcmV0dXJuOwogIGNvbnN0IHcgPSB3aW5kb3c7CiAgZGVsZXRlIHcuJHN0YXRlOwogIGRlbGV0ZSB3LiRyZWZzOwogIGRlbGV0ZSB3LiRzbG90czsKICBkZWxldGUgdy4kc2VsZjsKICBkZWxldGUgdy4kZXJyb3I7CiAgZGVsZXRlIHcuJGNvbXBvbmVudDsKICBkZWxldGUgdy4kcmVyZW5kZXI7Cn0KZnVuY3Rpb24gbG9nRXJyb3IoY3R4KSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHJldHVybjsKICBpZiAoZGVidWdDb25maWcub3V0cHV0Rm9ybWF0ID09PSAibGxtIikgewogICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiAoaW5pdF9sbG0oKSwgbGxtX2V4cG9ydHMpKS50aGVuKCh7IGZvcm1hdEVycm9yRm9yTExNOiBmb3JtYXRFcnJvckZvckxMTTIgfSkgPT4gewogICAgICBjb25zb2xlLmxvZyhmb3JtYXRFcnJvckZvckxMTTIoY3R4KSk7CiAgICB9KTsKICAgIHJldHVybjsKICB9CiAgY29uc29sZS5sb2coCiAgICAiJWNcdXsxRjUzNH0gYm9yZURPTTogRXJyb3IgaW4gJWM8JXM+JWMgcmVuZGVyIiwKICAgICJjb2xvcjogI2ZmNmI2YjsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgImNvbG9yOiAjNGVjZGM0OyBmb250LXdlaWdodDogYm9sZCIsCiAgICBjdHguY29tcG9uZW50LAogICAgImNvbG9yOiAjZmY2YjZiIgogICk7CiAgY29uc29sZS5lcnJvcihjdHguZXJyb3IpOwogIGlmIChpc0RlYnVnRW5hYmxlZCgiZ2xvYmFscyIpKSB7CiAgICBjb25zb2xlLmxvZygiJWNcdXsxRjRDQn0gRGVidWcgY29udGV4dCBsb2FkZWQ6IiwgImNvbG9yOiAjOTVhNWE2OyBmb250LXdlaWdodDogYm9sZCIpOwogICAgY29uc29sZS5sb2coIiAgICRzdGF0ZSAgICAgXHUyMTkyIiwgY3R4LnN0YXRlKTsKICAgIGNvbnNvbGUubG9nKCIgICAkcmVmcyAgICAgIFx1MjE5MiIsIGN0eC5yZWZzKTsKICAgIGNvbnNvbGUubG9nKCIgICAkc2xvdHMgICAgIFx1MjE5MiIsIGN0eC5zbG90cyk7CiAgICBjb25zb2xlLmxvZygiICAgJHNlbGYgICAgICBcdTIxOTIiLCBjdHguZWxlbWVudCk7CiAgICBjb25zb2xlLmxvZygiJWNcdXsxRjRBMX0gUXVpY2sgZml4ZXM6IiwgImNvbG9yOiAjZjM5YzEyOyBmb250LXdlaWdodDogYm9sZCIpOwogICAgY29uc29sZS5sb2coIiAgICRzdGF0ZS5wcm9wZXJ0eU5hbWUgPSB2YWx1ZSIpOwogICAgY29uc29sZS5sb2coIiAgICRyZXJlbmRlcigpIik7CiAgICBjb25zb2xlLmxvZygiJWNcdXsxRjRFNH0gV2hlbiBmaXhlZDoiLCAiY29sb3I6ICMyN2FlNjA7IGZvbnQtd2VpZ2h0OiBib2xkIik7CiAgICBjb25zb2xlLmxvZyhgICAgYm9yZURPTS5leHBvcnQoJyR7Y3R4LmNvbXBvbmVudH0nKWApOwogIH0KfQpmdW5jdGlvbiBsb2dFcnJvck1pbmltYWwoY29tcG9uZW50MiwgZXJyb3IpIHsKICBjb25zb2xlLmVycm9yKGBbYm9yZURPTV0gUmVuZGVyIGVycm9yIGluIDwke2NvbXBvbmVudDJ9PjogJHtlcnJvci5tZXNzYWdlfWApOwp9CmZ1bmN0aW9uIGxvZ0luaXRFcnJvcihjb21wb25lbnQyLCBlcnJvcikgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSByZXR1cm47CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgiY29uc29sZSIpKSByZXR1cm47CiAgY29uc29sZS5sb2coCiAgICAiJWNcdXsxRjUzNH0gYm9yZURPTTogRXJyb3IgaW4gJWM8JXM+JWMgaW5pdCIsCiAgICAiY29sb3I6ICNmZjZiNmI7IGZvbnQtd2VpZ2h0OiBib2xkIiwKICAgICJjb2xvcjogIzRlY2RjNDsgZm9udC13ZWlnaHQ6IGJvbGQiLAogICAgY29tcG9uZW50MiwKICAgICJjb2xvcjogI2ZmNmI2YiIKICApOwogIGNvbnNvbGUuZXJyb3IoZXJyb3IpOwp9CmZ1bmN0aW9uIHN0b3JlRXJyb3IoY3R4KSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJlcnJvckhpc3RvcnkiKSkgcmV0dXJuOwogIGVycm9ycy5zZXQoY3R4LmNvbXBvbmVudCwgY3R4KTsKICBsYXN0RXJyb3IgPSBjdHg7Cn0KZnVuY3Rpb24gY2xlYXJFcnJvcihjb21wb25lbnQyKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJlcnJvckhpc3RvcnkiKSkgcmV0dXJuOwogIGlmIChjb21wb25lbnQyKSB7CiAgICBlcnJvcnMuZGVsZXRlKGNvbXBvbmVudDIpOwogICAgaWYgKGxhc3RFcnJvcj8uY29tcG9uZW50ID09PSBjb21wb25lbnQyKSB7CiAgICAgIGxhc3RFcnJvciA9IG51bGw7CiAgICB9CiAgfSBlbHNlIGlmIChsYXN0RXJyb3IpIHsKICAgIGVycm9ycy5kZWxldGUobGFzdEVycm9yLmNvbXBvbmVudCk7CiAgICBsYXN0RXJyb3IgPSBudWxsOwogIH0KfQpmdW5jdGlvbiBtYXJrQ29tcG9uZW50RXJyb3IoZWxlbWVudCkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSByZXR1cm47CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgidmlzdWFsSW5kaWNhdG9ycyIpKSByZXR1cm47CiAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoImRhdGEtYm9yZWRvbS1lcnJvciIsICJ0cnVlIik7Cn0KZnVuY3Rpb24gY2xlYXJDb21wb25lbnRFcnJvck1hcmsoZWxlbWVudCkgewogIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCJkYXRhLWJvcmVkb20tZXJyb3IiKTsKfQpmdW5jdGlvbiBleHBvcnRTdGF0ZSh0YWdOYW1lKSB7CiAgY29uc3QgY3R4ID0gdGFnTmFtZSA/IGVycm9ycy5nZXQodGFnTmFtZSkgOiBsYXN0RXJyb3I7CiAgaWYgKCFjdHgpIHJldHVybiBudWxsOwogIHRyeSB7CiAgICByZXR1cm4gewogICAgICBjb21wb25lbnQ6IGN0eC5jb21wb25lbnQsCiAgICAgIHN0YXRlOiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGN0eC5zdGF0ZSkpLAogICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKGN0eC50aW1lc3RhbXApLnRvSVNPU3RyaW5nKCksCiAgICAgIGVycm9yOiBjdHguZXJyb3IubWVzc2FnZQogICAgfTsKICB9IGNhdGNoIChlKSB7CiAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICBjb25zb2xlLndhcm4oCiAgICAgICAgYFtib3JlRE9NXSBleHBvcnRTdGF0ZTogVW5hYmxlIHRvIHNlcmlhbGl6ZSBzdGF0ZSBmb3IgPCR7Y3R4LmNvbXBvbmVudH0+OmAsCiAgICAgICAgZSBpbnN0YW5jZW9mIEVycm9yID8gZS5tZXNzYWdlIDogZQogICAgICApOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgY29tcG9uZW50OiBjdHguY29tcG9uZW50LAogICAgICBzdGF0ZTogIltVbmFibGUgdG8gc2VyaWFsaXplIC0gY29udGFpbnMgY2lyY3VsYXIgcmVmZXJlbmNlcyBvciBmdW5jdGlvbnNdIiwKICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZShjdHgudGltZXN0YW1wKS50b0lTT1N0cmluZygpLAogICAgICBlcnJvcjogY3R4LmVycm9yLm1lc3NhZ2UKICAgIH07CiAgfQp9CnZhciBkZWJ1Z0NvbmZpZywgZXJyb3JzLCBsYXN0RXJyb3IsIGRlYnVnQVBJOwp2YXIgaW5pdF9kZWJ1ZyA9IF9fZXNtKHsKICAic3JjL2RlYnVnLnRzIigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGRlYnVnQ29uZmlnID0gewogICAgICBjb25zb2xlOiB0cnVlLAogICAgICBnbG9iYWxzOiB0cnVlLAogICAgICBlcnJvckJvdW5kYXJ5OiB0cnVlLAogICAgICB2aXN1YWxJbmRpY2F0b3JzOiB0cnVlLAogICAgICBlcnJvckhpc3Rvcnk6IHRydWUsCiAgICAgIHZlcnNpb25Mb2c6IHRydWUsCiAgICAgIGFwaTogdHJ1ZSwKICAgICAgbWV0aG9kTWlzc2luZzogdHJ1ZSwKICAgICAgdGVtcGxhdGVJbmZlcmVuY2U6IHRydWUsCiAgICAgIHN0cmljdDogZmFsc2UsCiAgICAgIG91dHB1dEZvcm1hdDogImh1bWFuIiwKICAgICAgbGxtOiB0cnVlCiAgICB9OwogICAgZXJyb3JzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGxhc3RFcnJvciA9IG51bGw7CiAgICBkZWJ1Z0FQSSA9IHsKICAgICAgLyoqIE1hcCBvZiBhbGwgY3VycmVudCBlcnJvcnMgYnkgY29tcG9uZW50IG5hbWUgKi8KICAgICAgZ2V0IGVycm9ycygpIHsKICAgICAgICByZXR1cm4gZXJyb3JzOwogICAgICB9LAogICAgICAvKiogTW9zdCByZWNlbnQgZXJyb3IgY29udGV4dCAqLwogICAgICBnZXQgbGFzdEVycm9yKCkgewogICAgICAgIHJldHVybiBsYXN0RXJyb3I7CiAgICAgIH0sCiAgICAgIC8qKiBSZS1yZW5kZXIgYSBzcGVjaWZpYyBjb21wb25lbnQgb3IgdGhlIGxhc3QgZXJyb3JlZCBvbmUgKi8KICAgICAgcmVyZW5kZXIodGFnTmFtZSkgewogICAgICAgIGNvbnN0IGN0eCA9IHRhZ05hbWUgPyBlcnJvcnMuZ2V0KHRhZ05hbWUpIDogbGFzdEVycm9yOwogICAgICAgIGlmIChjdHgpIHsKICAgICAgICAgIGN0eC5yZXJlbmRlcigpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oIltib3JlRE9NXSBObyBlcnJvciBjb250ZXh0IGZvdW5kIHRvIHJlcmVuZGVyIik7CiAgICAgICAgfQogICAgICB9LAogICAgICAvKiogQ2xlYXIgZXJyb3Igc3RhdGUgZm9yIGEgY29tcG9uZW50ICovCiAgICAgIGNsZWFyRXJyb3IodGFnTmFtZSkgewogICAgICAgIGNvbnN0IGN0eCA9IHRhZ05hbWUgPyBlcnJvcnMuZ2V0KHRhZ05hbWUpIDogbGFzdEVycm9yOwogICAgICAgIGlmIChjdHgpIHsKICAgICAgICAgIGNsZWFyQ29tcG9uZW50RXJyb3JNYXJrKGN0eC5lbGVtZW50KTsKICAgICAgICAgIGNsZWFyRXJyb3IodGFnTmFtZSk7CiAgICAgICAgICBjbGVhckdsb2JhbHMoKTsKICAgICAgICB9IGVsc2UgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgICAgICAgIGNvbnNvbGUud2FybigKICAgICAgICAgICAgdGFnTmFtZSA/IGBbYm9yZURPTV0gY2xlYXJFcnJvcjogTm8gZXJyb3IgZm91bmQgZm9yIDwke3RhZ05hbWV9PmAgOiAiW2JvcmVET01dIGNsZWFyRXJyb3I6IE5vIGVycm9yIHRvIGNsZWFyIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIC8qKiBFeHBvcnQgc3RhdGUgc25hcHNob3QgKi8KICAgICAgZXhwb3J0OiBleHBvcnRTdGF0ZSwKICAgICAgLyoqIEN1cnJlbnQgZGVidWcgY29uZmlndXJhdGlvbiAocmVhZC1vbmx5KSAqLwogICAgICBnZXQgY29uZmlnKCkgewogICAgICAgIHJldHVybiBnZXREZWJ1Z0NvbmZpZygpOwogICAgICB9CiAgICB9OwogIH0KfSk7CgovLyBzcmMvdHlwZS1pbmZlcmVuY2UudHMKZnVuY3Rpb24gaW5mZXJUeXBlRnJvbVZhbHVlKHZhbHVlLCBzZWVuID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCkpIHsKICBpZiAodmFsdWUgPT09IG51bGwpIHJldHVybiB7IGtpbmQ6ICJwcmltaXRpdmUiLCB2YWx1ZTogIm51bGwiIH07CiAgaWYgKHZhbHVlID09PSB2b2lkIDApIHJldHVybiB7IGtpbmQ6ICJwcmltaXRpdmUiLCB2YWx1ZTogInVuZGVmaW5lZCIgfTsKICBjb25zdCB0eXBlID0gdHlwZW9mIHZhbHVlOwogIGlmICh0eXBlID09PSAic3RyaW5nIikgcmV0dXJuIHsga2luZDogInByaW1pdGl2ZSIsIHZhbHVlOiAic3RyaW5nIiB9OwogIGlmICh0eXBlID09PSAibnVtYmVyIikgcmV0dXJuIHsga2luZDogInByaW1pdGl2ZSIsIHZhbHVlOiAibnVtYmVyIiB9OwogIGlmICh0eXBlID09PSAiYm9vbGVhbiIpIHJldHVybiB7IGtpbmQ6ICJwcmltaXRpdmUiLCB2YWx1ZTogImJvb2xlYW4iIH07CiAgaWYgKHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiB7IGtpbmQ6ICJmdW5jdGlvbiIsIHBhcmFtczogW10sIHJldHVyblR5cGU6IHsga2luZDogInVua25vd24iIH0gfTsKICB9CiAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuIHsga2luZDogImRhdGUiIH07CiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICBpZiAodmFsdWUubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB7IGtpbmQ6ICJhcnJheSIsIGVsZW1lbnRUeXBlOiB7IGtpbmQ6ICJ1bmtub3duIiB9IH07CiAgICB9CiAgICBjb25zdCBzYW1wbGVTaXplID0gTWF0aC5taW4oNSwgdmFsdWUubGVuZ3RoKTsKICAgIGNvbnN0IGVsZW1lbnRUeXBlcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzYW1wbGVTaXplOyBpKyspIHsKICAgICAgZWxlbWVudFR5cGVzLnB1c2goaW5mZXJUeXBlRnJvbVZhbHVlKHZhbHVlW2ldLCBzZWVuKSk7CiAgICB9CiAgICByZXR1cm4geyBraW5kOiAiYXJyYXkiLCBlbGVtZW50VHlwZTogbWVyZ2VUeXBlcyhlbGVtZW50VHlwZXMpIH07CiAgfQogIGlmICh0eXBlID09PSAib2JqZWN0IikgewogICAgaWYgKHNlZW4uaGFzKHZhbHVlKSkgewogICAgICByZXR1cm4geyBraW5kOiAidW5rbm93biIgfTsKICAgIH0KICAgIHNlZW4uYWRkKHZhbHVlKTsKICAgIGNvbnN0IHByb3BlcnRpZXMgPSB7fTsKICAgIGZvciAoY29uc3QgW2tleSwgdmFsXSBvZiBPYmplY3QuZW50cmllcyh2YWx1ZSkpIHsKICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICJzeW1ib2wiKSBjb250aW51ZTsKICAgICAgcHJvcGVydGllc1trZXldID0gaW5mZXJUeXBlRnJvbVZhbHVlKHZhbCwgc2Vlbik7CiAgICB9CiAgICByZXR1cm4geyBraW5kOiAib2JqZWN0IiwgcHJvcGVydGllcyB9OwogIH0KICByZXR1cm4geyBraW5kOiAidW5rbm93biIgfTsKfQpmdW5jdGlvbiBtZXJnZVR5cGVzKHR5cGVzKSB7CiAgY29uc3Qga25vd24gPSB0eXBlcy5maWx0ZXIoKHQpID0+IHQua2luZCAhPT0gInVua25vd24iKTsKICBpZiAoa25vd24ubGVuZ3RoID09PSAwKSByZXR1cm4geyBraW5kOiAidW5rbm93biIgfTsKICBpZiAoa25vd24ubGVuZ3RoID09PSAxKSByZXR1cm4ga25vd25bMF07CiAgaWYgKGtub3duLmV2ZXJ5KCh0KSA9PiB0LmtpbmQgPT09ICJwcmltaXRpdmUiKSkgewogICAgY29uc3QgcHJpbWl0aXZlcyA9IGtub3duOwogICAgY29uc3QgdW5pcXVlID0gWy4uLm5ldyBTZXQocHJpbWl0aXZlcy5tYXAoKHApID0+IHAudmFsdWUpKV07CiAgICBpZiAodW5pcXVlLmxlbmd0aCA9PT0gMSkgcmV0dXJuIGtub3duWzBdOwogICAgcmV0dXJuIHsKICAgICAga2luZDogInVuaW9uIiwKICAgICAgdHlwZXM6IHVuaXF1ZS5tYXAoKHYpID0+ICh7IGtpbmQ6ICJwcmltaXRpdmUiLCB2YWx1ZTogdiB9KSkKICAgIH07CiAgfQogIGlmIChrbm93bi5ldmVyeSgodCkgPT4gdC5raW5kID09PSAib2JqZWN0IikpIHsKICAgIGNvbnN0IG9iamVjdHMgPSBrbm93bjsKICAgIGNvbnN0IG1lcmdlZFByb3BzID0ge307CiAgICBmb3IgKGNvbnN0IG9iaiBvZiBvYmplY3RzKSB7CiAgICAgIGZvciAoY29uc3QgW2tleSwgdHlwZV0gb2YgT2JqZWN0LmVudHJpZXMob2JqLnByb3BlcnRpZXMpKSB7CiAgICAgICAgaWYgKG1lcmdlZFByb3BzW2tleV0pIHsKICAgICAgICAgIG1lcmdlZFByb3BzW2tleV0gPSBtZXJnZVR5cGVzKFttZXJnZWRQcm9wc1trZXldLCB0eXBlXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1lcmdlZFByb3BzW2tleV0gPSB0eXBlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHsga2luZDogIm9iamVjdCIsIHByb3BlcnRpZXM6IG1lcmdlZFByb3BzIH07CiAgfQogIGlmIChrbm93bi5ldmVyeSgodCkgPT4gdC5raW5kID09PSAiYXJyYXkiKSkgewogICAgY29uc3QgYXJyYXlzID0ga25vd247CiAgICBjb25zdCBlbGVtZW50VHlwZXMgPSBhcnJheXMubWFwKChhKSA9PiBhLmVsZW1lbnRUeXBlKTsKICAgIHJldHVybiB7IGtpbmQ6ICJhcnJheSIsIGVsZW1lbnRUeXBlOiBtZXJnZVR5cGVzKGVsZW1lbnRUeXBlcykgfTsKICB9CiAgY29uc3QgZGVkdXBlZCA9IGRlZHVwbGljYXRlVHlwZXMoa25vd24pOwogIGlmIChkZWR1cGVkLmxlbmd0aCA9PT0gMSkgcmV0dXJuIGRlZHVwZWRbMF07CiAgcmV0dXJuIHsga2luZDogInVuaW9uIiwgdHlwZXM6IGRlZHVwZWQgfTsKfQpmdW5jdGlvbiBkZWR1cGxpY2F0ZVR5cGVzKHR5cGVzKSB7CiAgY29uc3Qgc2VlbiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgY29uc3QgcmVzdWx0ID0gW107CiAgZm9yIChjb25zdCB0eXBlIG9mIHR5cGVzKSB7CiAgICBjb25zdCBrZXkgPSB0eXBlTm9kZVRvS2V5KHR5cGUpOwogICAgaWYgKCFzZWVuLmhhcyhrZXkpKSB7CiAgICAgIHNlZW4uYWRkKGtleSk7CiAgICAgIHJlc3VsdC5wdXNoKHR5cGUpOwogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIHR5cGVOb2RlVG9LZXkobm9kZSkgewogIHN3aXRjaCAobm9kZS5raW5kKSB7CiAgICBjYXNlICJwcmltaXRpdmUiOgogICAgICByZXR1cm4gYHA6JHtub2RlLnZhbHVlfWA7CiAgICBjYXNlICJsaXRlcmFsIjoKICAgICAgcmV0dXJuIGBsOiR7dHlwZW9mIG5vZGUudmFsdWV9OiR7bm9kZS52YWx1ZX1gOwogICAgY2FzZSAiYXJyYXkiOgogICAgICByZXR1cm4gYGE6JHt0eXBlTm9kZVRvS2V5KG5vZGUuZWxlbWVudFR5cGUpfWA7CiAgICBjYXNlICJvYmplY3QiOgogICAgICBjb25zdCBwcm9wcyA9IE9iamVjdC5lbnRyaWVzKG5vZGUucHJvcGVydGllcykuc29ydCgoW2FdLCBbYl0pID0+IGEubG9jYWxlQ29tcGFyZShiKSkubWFwKChbaywgdl0pID0+IGAke2t9OiR7dHlwZU5vZGVUb0tleSh2KX1gKS5qb2luKCIsIik7CiAgICAgIHJldHVybiBgbzp7JHtwcm9wc319YDsKICAgIGNhc2UgInVuaW9uIjoKICAgICAgcmV0dXJuIGB1Olske25vZGUudHlwZXMubWFwKHR5cGVOb2RlVG9LZXkpLnNvcnQoKS5qb2luKCJ8Iil9XWA7CiAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgIGNvbnN0IHBhcmFtcyA9IG5vZGUucGFyYW1zLm1hcCgocCkgPT4gYCR7cC5uYW1lfToke3R5cGVOb2RlVG9LZXkocC50eXBlKX1gKS5qb2luKCIsIik7CiAgICAgIHJldHVybiBgZjooJHtwYXJhbXN9KT0+JHt0eXBlTm9kZVRvS2V5KG5vZGUucmV0dXJuVHlwZSl9YDsKICAgIGNhc2UgImRhdGUiOgogICAgICByZXR1cm4gImRhdGUiOwogICAgY2FzZSAidW5rbm93biI6CiAgICAgIHJldHVybiAidW5rbm93biI7CiAgfQp9CmZ1bmN0aW9uIG1lcmdlUGFyYW1UeXBlcyhhLCBiKSB7CiAgY29uc3QgbWF4TGVuID0gTWF0aC5tYXgoYS5sZW5ndGgsIGIubGVuZ3RoKTsKICBjb25zdCByZXN1bHQgPSBbXTsKICBmb3IgKGxldCBpID0gMDsgaSA8IG1heExlbjsgaSsrKSB7CiAgICBjb25zdCBwYXJhbUEgPSBhW2ldOwogICAgY29uc3QgcGFyYW1CID0gYltpXTsKICAgIGlmIChwYXJhbUEgJiYgcGFyYW1CKSB7CiAgICAgIHJlc3VsdC5wdXNoKHsKICAgICAgICBuYW1lOiBwYXJhbUEubmFtZSwKICAgICAgICB0eXBlOiBtZXJnZVR5cGVzKFtwYXJhbUEudHlwZSwgcGFyYW1CLnR5cGVdKSwKICAgICAgICBvcHRpb25hbDogcGFyYW1BLm9wdGlvbmFsIHx8IHBhcmFtQi5vcHRpb25hbAogICAgICB9KTsKICAgIH0gZWxzZSBpZiAocGFyYW1BKSB7CiAgICAgIHJlc3VsdC5wdXNoKHsgLi4ucGFyYW1BLCBvcHRpb25hbDogdHJ1ZSB9KTsKICAgIH0gZWxzZSBpZiAocGFyYW1CKSB7CiAgICAgIHJlc3VsdC5wdXNoKHsgLi4ucGFyYW1CLCBvcHRpb25hbDogdHJ1ZSB9KTsKICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiB0cmFja1N0YXRlQWNjZXNzKHBhdGgsIHZhbHVlKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybjsKICBpZiAoIWlzRGVidWdFbmFibGVkKCJsbG0iKSkgcmV0dXJuOwogIGNvbnN0IGV4aXN0aW5nID0gc3RhdGVBY2Nlc3Nlcy5nZXQocGF0aCk7CiAgY29uc3QgaW5mZXJyZWRUeXBlID0gaW5mZXJUeXBlRnJvbVZhbHVlKHZhbHVlKTsKICBpZiAoZXhpc3RpbmcpIHsKICAgIGNvbnN0IG1lcmdlZCA9IG1lcmdlVHlwZXMoW2V4aXN0aW5nLnR5cGUsIGluZmVycmVkVHlwZV0pOwogICAgc3RhdGVBY2Nlc3Nlcy5zZXQocGF0aCwgewogICAgICBwYXRoLAogICAgICB0eXBlOiBtZXJnZWQsCiAgICAgIGFjY2Vzc0NvdW50OiBleGlzdGluZy5hY2Nlc3NDb3VudCArIDEKICAgIH0pOwogIH0gZWxzZSB7CiAgICBzdGF0ZUFjY2Vzc2VzLnNldChwYXRoLCB7CiAgICAgIHBhdGgsCiAgICAgIHR5cGU6IGluZmVycmVkVHlwZSwKICAgICAgYWNjZXNzQ291bnQ6IDEKICAgIH0pOwogIH0KfQpmdW5jdGlvbiB0cmFja0Z1bmN0aW9uQ2FsbChuYW1lLCBhcmdzLCByZXR1cm5WYWx1ZSkgewogIGlmICh0eXBlb2YgX19ERUJVR19fICE9PSAidW5kZWZpbmVkIiAmJiAhX19ERUJVR19fKSByZXR1cm47CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgibGxtIikpIHJldHVybjsKICBjb25zdCBleGlzdGluZyA9IGZ1bmN0aW9uQ2FsbHMuZ2V0KG5hbWUpOwogIGNvbnN0IGFyZ1R5cGVzID0gYXJncy5tYXAoKGFyZywgaSkgPT4gKHsKICAgIG5hbWU6IGluZmVyQXJnTmFtZShhcmcsIGkpLAogICAgdHlwZTogaW5mZXJUeXBlRnJvbVZhbHVlKGFyZyksCiAgICBvcHRpb25hbDogZmFsc2UKICB9KSk7CiAgY29uc3QgcmV0dXJuVHlwZSA9IGluZmVyVHlwZUZyb21WYWx1ZShyZXR1cm5WYWx1ZSk7CiAgaWYgKGV4aXN0aW5nKSB7CiAgICBjb25zdCBtZXJnZWRQYXJhbXMgPSBtZXJnZVBhcmFtVHlwZXMoZXhpc3RpbmcucGFyYW1zLCBhcmdUeXBlcyk7CiAgICBjb25zdCBtZXJnZWRSZXR1cm4gPSBtZXJnZVR5cGVzKFtleGlzdGluZy5yZXR1cm5UeXBlLCByZXR1cm5UeXBlXSk7CiAgICBmdW5jdGlvbkNhbGxzLnNldChuYW1lLCB7CiAgICAgIHBhcmFtczogbWVyZ2VkUGFyYW1zLAogICAgICByZXR1cm5UeXBlOiBtZXJnZWRSZXR1cm4sCiAgICAgIGNhbGxDb3VudDogZXhpc3RpbmcuY2FsbENvdW50ICsgMQogICAgfSk7CiAgfSBlbHNlIHsKICAgIGZ1bmN0aW9uQ2FsbHMuc2V0KG5hbWUsIHsKICAgICAgcGFyYW1zOiBhcmdUeXBlcywKICAgICAgcmV0dXJuVHlwZSwKICAgICAgY2FsbENvdW50OiAxCiAgICB9KTsKICB9Cn0KZnVuY3Rpb24gaW5mZXJBcmdOYW1lKHZhbHVlLCBpbmRleCkgewogIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdm9pZCAwKSByZXR1cm4gYGFyZyR7aW5kZXh9YDsKICBjb25zdCB0eXBlID0gdHlwZW9mIHZhbHVlOwogIGlmICh0eXBlID09PSAic3RyaW5nIikgewogICAgaWYgKHZhbHVlLmluY2x1ZGVzKCJAIikpIHJldHVybiAiZW1haWwiOwogICAgaWYgKHZhbHVlLm1hdGNoKC9eXGR7NH0tXGR7Mn0tXGR7Mn0vKSkgcmV0dXJuICJkYXRlIjsKICAgIGlmICh2YWx1ZS5sZW5ndGggPiAxMDApIHJldHVybiAidGV4dCI7CiAgICByZXR1cm4gInN0ciI7CiAgfQogIGlmICh0eXBlID09PSAibnVtYmVyIikgewogICAgaWYgKE51bWJlci5pc0ludGVnZXIodmFsdWUpKSB7CiAgICAgIGlmICh2YWx1ZSA+IDFlMTIpIHJldHVybiAidGltZXN0YW1wIjsKICAgICAgcmV0dXJuICJjb3VudCI7CiAgICB9CiAgICByZXR1cm4gInZhbHVlIjsKICB9CiAgaWYgKHR5cGUgPT09ICJib29sZWFuIikgcmV0dXJuICJmbGFnIjsKICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHJldHVybiAiaXRlbXMiOwogIGlmICh0eXBlID09PSAib2JqZWN0IikgewogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkgcmV0dXJuICJkYXRlIjsKICAgIHJldHVybiAiZGF0YSI7CiAgfQogIHJldHVybiBgYXJnJHtpbmRleH1gOwp9CmZ1bmN0aW9uIHR5cGVOb2RlVG9TdHJpbmcobm9kZSwgaW5kZW50ID0gMCkgewogIGNvbnN0IHBhZCA9ICIgICIucmVwZWF0KGluZGVudCk7CiAgc3dpdGNoIChub2RlLmtpbmQpIHsKICAgIGNhc2UgInByaW1pdGl2ZSI6CiAgICAgIHJldHVybiBub2RlLnZhbHVlOwogICAgY2FzZSAibGl0ZXJhbCI6CiAgICAgIHJldHVybiB0eXBlb2Ygbm9kZS52YWx1ZSA9PT0gInN0cmluZyIgPyBgIiR7bm9kZS52YWx1ZS5yZXBsYWNlKC9cXC9nLCAiXFxcXCIpLnJlcGxhY2UoLyIvZywgJ1xcIicpfSJgIDogU3RyaW5nKG5vZGUudmFsdWUpOwogICAgY2FzZSAiYXJyYXkiOgogICAgICBjb25zdCBlbGVtU3RyID0gdHlwZU5vZGVUb1N0cmluZyhub2RlLmVsZW1lbnRUeXBlLCBpbmRlbnQpOwogICAgICBpZiAobm9kZS5lbGVtZW50VHlwZS5raW5kID09PSAicHJpbWl0aXZlIiB8fCBub2RlLmVsZW1lbnRUeXBlLmtpbmQgPT09ICJ1bmtub3duIikgewogICAgICAgIHJldHVybiBgJHtlbGVtU3RyfVtdYDsKICAgICAgfQogICAgICByZXR1cm4gYEFycmF5PCR7ZWxlbVN0cn0+YDsKICAgIGNhc2UgIm9iamVjdCI6IHsKICAgICAgY29uc3QgZW50cmllcyA9IE9iamVjdC5lbnRyaWVzKG5vZGUucHJvcGVydGllcyk7CiAgICAgIGlmIChlbnRyaWVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuICJ7fSI7CiAgICAgIGNvbnN0IHByb3BzID0gZW50cmllcy5tYXAoKFtrLCB2XSkgPT4gYCR7cGFkfSAgJHtrfTogJHt0eXBlTm9kZVRvU3RyaW5nKHYsIGluZGVudCArIDEpfTtgKS5qb2luKCJcbiIpOwogICAgICByZXR1cm4gYHsKJHtwcm9wc30KJHtwYWR9fWA7CiAgICB9CiAgICBjYXNlICJ1bmlvbiI6CiAgICAgIGNvbnN0IHR5cGVzID0gbm9kZS50eXBlcy5tYXAoKHQpID0+IHR5cGVOb2RlVG9TdHJpbmcodCwgaW5kZW50KSk7CiAgICAgIHJldHVybiB0eXBlcy5qb2luKCIgfCAiKTsKICAgIGNhc2UgImZ1bmN0aW9uIjogewogICAgICBjb25zdCBwYXJhbXMgPSBub2RlLnBhcmFtcy5tYXAoKHApID0+IGAke3AubmFtZX0ke3Aub3B0aW9uYWwgPyAiPyIgOiAiIn06ICR7dHlwZU5vZGVUb1N0cmluZyhwLnR5cGUpfWApLmpvaW4oIiwgIik7CiAgICAgIHJldHVybiBgKCR7cGFyYW1zfSkgPT4gJHt0eXBlTm9kZVRvU3RyaW5nKG5vZGUucmV0dXJuVHlwZSl9YDsKICAgIH0KICAgIGNhc2UgImRhdGUiOgogICAgICByZXR1cm4gIkRhdGUiOwogICAgY2FzZSAidW5rbm93biI6CiAgICAgIHJldHVybiAidW5rbm93biI7CiAgfQp9CmZ1bmN0aW9uIGJ1aWxkU3RhdGVUeXBlTm9kZSgpIHsKICBjb25zdCByb290ID0ge307CiAgZm9yIChjb25zdCBbcGF0aCwgYWNjZXNzMl0gb2Ygc3RhdGVBY2Nlc3NlcykgewogICAgc2V0TmVzdGVkVHlwZShyb290LCBwYXRoLCBhY2Nlc3MyLnR5cGUpOwogIH0KICByZXR1cm4gYnVpbGRUeXBlRnJvbU5lc3RlZChyb290KTsKfQpmdW5jdGlvbiBzZXROZXN0ZWRUeXBlKG9iaiwgcGF0aCwgdHlwZSkgewogIGNvbnN0IHBhcnRzID0gcGF0aC5zcGxpdCgiLiIpOwogIGxldCBjdXJyZW50ID0gb2JqOwogIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICBjb25zdCBwYXJ0ID0gcGFydHNbaV07CiAgICBjb25zdCBhcnJheU1hdGNoMiA9IHBhcnQubWF0Y2goL14oLispXFsoXGQrKVxdJC8pOwogICAgaWYgKGFycmF5TWF0Y2gyKSB7CiAgICAgIGNvbnN0IFssIG5hbWVdID0gYXJyYXlNYXRjaDI7CiAgICAgIGlmICghY3VycmVudFtuYW1lXSkgY3VycmVudFtuYW1lXSA9IHsgX19pc0FycmF5OiB0cnVlLCBfX2VsZW1lbnRUeXBlOiB7fSB9OwogICAgICBjdXJyZW50ID0gY3VycmVudFtuYW1lXS5fX2VsZW1lbnRUeXBlOwogICAgfSBlbHNlIHsKICAgICAgaWYgKCFjdXJyZW50W3BhcnRdKSBjdXJyZW50W3BhcnRdID0ge307CiAgICAgIGN1cnJlbnQgPSBjdXJyZW50W3BhcnRdOwogICAgfQogIH0KICBjb25zdCBsYXN0UGFydCA9IHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdOwogIGNvbnN0IGFycmF5TWF0Y2ggPSBsYXN0UGFydC5tYXRjaCgvXiguKylcWyhcZCspXF0kLyk7CiAgaWYgKGFycmF5TWF0Y2gpIHsKICAgIGNvbnN0IFssIG5hbWVdID0gYXJyYXlNYXRjaDsKICAgIGlmICghY3VycmVudFtuYW1lXSkgY3VycmVudFtuYW1lXSA9IHsgX19pc0FycmF5OiB0cnVlLCBfX2VsZW1lbnRUeXBlOiB7fSB9OwogICAgY29uc3QgZXhpc3RpbmcgPSBjdXJyZW50W25hbWVdLl9fZWxlbWVudFR5cGUuX190eXBlOwogICAgaWYgKGV4aXN0aW5nKSB7CiAgICAgIGN1cnJlbnRbbmFtZV0uX19lbGVtZW50VHlwZS5fX3R5cGUgPSBtZXJnZVR5cGVzKFtleGlzdGluZywgdHlwZV0pOwogICAgfSBlbHNlIHsKICAgICAgY3VycmVudFtuYW1lXS5fX2VsZW1lbnRUeXBlLl9fdHlwZSA9IHR5cGU7CiAgICB9CiAgfSBlbHNlIHsKICAgIGNvbnN0IGV4aXN0aW5nID0gY3VycmVudFtsYXN0UGFydF0/Ll9fdHlwZTsKICAgIGlmIChleGlzdGluZykgewogICAgICBjdXJyZW50W2xhc3RQYXJ0XSA9IHsgX190eXBlOiBtZXJnZVR5cGVzKFtleGlzdGluZywgdHlwZV0pIH07CiAgICB9IGVsc2UgewogICAgICBjdXJyZW50W2xhc3RQYXJ0XSA9IHsgX190eXBlOiB0eXBlIH07CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGJ1aWxkVHlwZUZyb21OZXN0ZWQob2JqKSB7CiAgaWYgKG9iai5fX3R5cGUpIHJldHVybiBvYmouX190eXBlOwogIGlmIChvYmouX19pc0FycmF5KSB7CiAgICByZXR1cm4gewogICAgICBraW5kOiAiYXJyYXkiLAogICAgICBlbGVtZW50VHlwZTogYnVpbGRUeXBlRnJvbU5lc3RlZChvYmouX19lbGVtZW50VHlwZSkKICAgIH07CiAgfQogIGNvbnN0IHByb3BlcnRpZXMgPSB7fTsKICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmopKSB7CiAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoIl9fIikpIGNvbnRpbnVlOwogICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHsKICAgICAgcHJvcGVydGllc1trZXldID0gYnVpbGRUeXBlRnJvbU5lc3RlZCh2YWx1ZSk7CiAgICB9CiAgfQogIGlmIChPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKS5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB7IGtpbmQ6ICJ1bmtub3duIiB9OwogIH0KICByZXR1cm4geyBraW5kOiAib2JqZWN0IiwgcHJvcGVydGllcyB9Owp9CmZ1bmN0aW9uIGJ1aWxkU3RhdGVJbnRlcmZhY2UoKSB7CiAgY29uc3Qgc3RhdGVUeXBlID0gYnVpbGRTdGF0ZVR5cGVOb2RlKCk7CiAgaWYgKHN0YXRlVHlwZS5raW5kID09PSAidW5rbm93biIpIHsKICAgIHJldHVybiAiaW50ZXJmYWNlIFN0YXRlIHt9IjsKICB9CiAgcmV0dXJuIGBpbnRlcmZhY2UgU3RhdGUgJHt0eXBlTm9kZVRvU3RyaW5nKHN0YXRlVHlwZSl9YDsKfQpmdW5jdGlvbiBnZXRFbXB0eVR5cGVEZWZpbml0aW9ucygpIHsKICByZXR1cm4gewogICAgc3RhdGU6ICJpbnRlcmZhY2UgU3RhdGUge30iLAogICAgaGVscGVyczoge30sCiAgICBjb21wb25lbnRzOiB7fSwKICAgIGV2ZW50czoge30sCiAgICByYXc6IHsKICAgICAgc3RhdGU6IHsga2luZDogIm9iamVjdCIsIHByb3BlcnRpZXM6IHt9IH0sCiAgICAgIGhlbHBlcnM6IHt9LAogICAgICBjb21wb25lbnRzOiB7fSwKICAgICAgZXZlbnRzOiB7fQogICAgfQogIH07Cn0KZnVuY3Rpb24gaW5mZXJUeXBlcygpIHsKICBpZiAodHlwZW9mIF9fREVCVUdfXyAhPT0gInVuZGVmaW5lZCIgJiYgIV9fREVCVUdfXykgewogICAgcmV0dXJuIGdldEVtcHR5VHlwZURlZmluaXRpb25zKCk7CiAgfQogIGlmICghaXNEZWJ1Z0VuYWJsZWQoImxsbSIpKSB7CiAgICByZXR1cm4gZ2V0RW1wdHlUeXBlRGVmaW5pdGlvbnMoKTsKICB9CiAgY29uc3QgaGVscGVycyA9IHt9OwogIGZvciAoY29uc3QgW25hbWUsIGZuXSBvZiBmdW5jdGlvbkNhbGxzKSB7CiAgICBoZWxwZXJzW25hbWVdID0gdHlwZU5vZGVUb1N0cmluZyh7CiAgICAgIGtpbmQ6ICJmdW5jdGlvbiIsCiAgICAgIHBhcmFtczogZm4ucGFyYW1zLAogICAgICByZXR1cm5UeXBlOiBmbi5yZXR1cm5UeXBlCiAgICB9KTsKICB9CiAgY29uc3QgY29tcG9uZW50cyA9IHt9OwogIGZvciAoY29uc3QgW3RhZywgcHJvcHNdIG9mIGNvbXBvbmVudFByb3BzKSB7CiAgICBjb21wb25lbnRzW3RhZ10gPSB0eXBlTm9kZVRvU3RyaW5nKHsga2luZDogIm9iamVjdCIsIHByb3BlcnRpZXM6IHByb3BzIH0pOwogIH0KICBjb25zdCBldmVudHMgPSB7fTsKICBmb3IgKGNvbnN0IFtuYW1lLCBwYXlsb2FkXSBvZiBldmVudFBheWxvYWRzKSB7CiAgICBldmVudHNbbmFtZV0gPSB0eXBlTm9kZVRvU3RyaW5nKHBheWxvYWQpOwogIH0KICBjb25zdCByYXdIZWxwZXJzID0ge307CiAgZm9yIChjb25zdCBbbmFtZSwgZm5dIG9mIGZ1bmN0aW9uQ2FsbHMpIHsKICAgIHJhd0hlbHBlcnNbbmFtZV0gPSBmbjsKICB9CiAgY29uc3QgcmF3Q29tcG9uZW50cyA9IHt9OwogIGZvciAoY29uc3QgW3RhZywgcHJvcHNdIG9mIGNvbXBvbmVudFByb3BzKSB7CiAgICByYXdDb21wb25lbnRzW3RhZ10gPSB7IGtpbmQ6ICJvYmplY3QiLCBwcm9wZXJ0aWVzOiBwcm9wcyB9OwogIH0KICBjb25zdCByYXdFdmVudHMgPSB7fTsKICBmb3IgKGNvbnN0IFtuYW1lLCBwYXlsb2FkXSBvZiBldmVudFBheWxvYWRzKSB7CiAgICByYXdFdmVudHNbbmFtZV0gPSBwYXlsb2FkOwogIH0KICByZXR1cm4gewogICAgc3RhdGU6IGJ1aWxkU3RhdGVJbnRlcmZhY2UoKSwKICAgIGhlbHBlcnMsCiAgICBjb21wb25lbnRzLAogICAgZXZlbnRzLAogICAgcmF3OiB7CiAgICAgIHN0YXRlOiBidWlsZFN0YXRlVHlwZU5vZGUoKSwKICAgICAgaGVscGVyczogcmF3SGVscGVycywKICAgICAgY29tcG9uZW50czogcmF3Q29tcG9uZW50cywKICAgICAgZXZlbnRzOiByYXdFdmVudHMKICAgIH0KICB9Owp9CmZ1bmN0aW9uIHR5cGVPZihwYXRoKSB7CiAgaWYgKHR5cGVvZiBfX0RFQlVHX18gIT09ICJ1bmRlZmluZWQiICYmICFfX0RFQlVHX18pIHJldHVybiAidW5rbm93biI7CiAgaWYgKCFpc0RlYnVnRW5hYmxlZCgibGxtIikpIHJldHVybiAidW5rbm93biI7CiAgY29uc3QgYWNjZXNzMiA9IHN0YXRlQWNjZXNzZXMuZ2V0KHBhdGgpOwogIGlmIChhY2Nlc3MyKSB7CiAgICByZXR1cm4gdHlwZU5vZGVUb1N0cmluZyhhY2Nlc3MyLnR5cGUpOwogIH0KICBjb25zdCBzdGF0ZVR5cGUgPSBidWlsZFN0YXRlVHlwZU5vZGUoKTsKICBjb25zdCByZXN1bHQgPSBuYXZpZ2F0ZVRvUGF0aChzdGF0ZVR5cGUsIHBhdGgpOwogIGlmIChyZXN1bHQpIHsKICAgIHJldHVybiB0eXBlTm9kZVRvU3RyaW5nKHJlc3VsdCk7CiAgfQogIHJldHVybiAidW5rbm93biI7Cn0KZnVuY3Rpb24gbmF2aWdhdGVUb1BhdGgobm9kZSwgcGF0aCkgewogIGNvbnN0IHBhcnRzID0gcGF0aC5zcGxpdCgiLiIpOwogIGxldCBjdXJyZW50ID0gbm9kZTsKICBmb3IgKGNvbnN0IHBhcnQgb2YgcGFydHMpIHsKICAgIGNvbnN0IGFycmF5TWF0Y2ggPSBwYXJ0Lm1hdGNoKC9eKC4rKVxbKFxkKylcXSQvKTsKICAgIGlmIChhcnJheU1hdGNoKSB7CiAgICAgIGNvbnN0IFssIG5hbWVdID0gYXJyYXlNYXRjaDsKICAgICAgaWYgKGN1cnJlbnQua2luZCA9PT0gIm9iamVjdCIgJiYgY3VycmVudC5wcm9wZXJ0aWVzW25hbWVdKSB7CiAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucHJvcGVydGllc1tuYW1lXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBpZiAoY3VycmVudC5raW5kID09PSAiYXJyYXkiKSB7CiAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuZWxlbWVudFR5cGU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAocGFydC5lbmRzV2l0aCgiW10iKSkgewogICAgICBjb25zdCBuYW1lID0gcGFydC5zbGljZSgwLCAtMik7CiAgICAgIGlmIChjdXJyZW50LmtpbmQgPT09ICJvYmplY3QiICYmIGN1cnJlbnQucHJvcGVydGllc1tuYW1lXSkgewogICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LnByb3BlcnRpZXNbbmFtZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChjdXJyZW50LmtpbmQgPT09ICJvYmplY3QiICYmIGN1cnJlbnQucHJvcGVydGllc1twYXJ0XSkgewogICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LnByb3BlcnRpZXNbcGFydF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIGN1cnJlbnQ7Cn0KZnVuY3Rpb24gY2xlYXJUeXBlVHJhY2tpbmcoKSB7CiAgc3RhdGVBY2Nlc3Nlcy5jbGVhcigpOwogIGZ1bmN0aW9uQ2FsbHMuY2xlYXIoKTsKICBjb21wb25lbnRQcm9wcy5jbGVhcigpOwogIGV2ZW50UGF5bG9hZHMuY2xlYXIoKTsKfQp2YXIgc3RhdGVBY2Nlc3NlcywgZnVuY3Rpb25DYWxscywgY29tcG9uZW50UHJvcHMsIGV2ZW50UGF5bG9hZHM7CnZhciBpbml0X3R5cGVfaW5mZXJlbmNlID0gX19lc20oewogICJzcmMvdHlwZS1pbmZlcmVuY2UudHMiKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgaW5pdF9kZWJ1ZygpOwogICAgc3RhdGVBY2Nlc3NlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBmdW5jdGlvbkNhbGxzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGNvbXBvbmVudFByb3BzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGV2ZW50UGF5bG9hZHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIH0KfSk7CgovLyBzcmMvZG9tLnRzCnZhciBkeW5hbWljSW1wb3J0U2NyaXB0cyA9IGFzeW5jIChuYW1lcykgPT4gewogIGNvbnN0IHJlc3VsdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBuYW1lcy5sZW5ndGg7ICsraSkgewogICAgY29uc3Qgc2NyaXB0cyA9IEFycmF5LmZyb20ocXVlcnlBbGwoInNjcmlwdFtzcmNdIikpOwogICAgY29uc3QgbWF0Y2hpbmdTY3JpcHQgPSBzY3JpcHRzLmZpbmQoKHNjcmlwdCkgPT4gewogICAgICBjb25zdCBzcmMgPSBzY3JpcHQuZ2V0QXR0cmlidXRlKCJzcmMiKSA/PyAiIjsKICAgICAgY29uc3QgZmlsZW5hbWUgPSBzcmMuc3BsaXQoIi8iKS5wb3AoKSA/PyAiIjsKICAgICAgcmV0dXJuIGZpbGVuYW1lID09PSBgJHtuYW1lc1tpXX0uanNgOwogICAgfSk7CiAgICBjb25zdCBzY3JpcHRMb2NhdGlvbiA9IG1hdGNoaW5nU2NyaXB0Py5nZXRBdHRyaWJ1dGUoInNyYyIpOwogICAgbGV0IGYgPSBudWxsOwogICAgaWYgKHNjcmlwdExvY2F0aW9uKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgbW9kdWxlVXJsID0gbmV3IFVSTChzY3JpcHRMb2NhdGlvbiwgZG9jdW1lbnQuYmFzZVVSSSkuaHJlZjsKICAgICAgICBjb25zdCBleHBvcnRzID0gYXdhaXQgaW1wb3J0KG1vZHVsZVVybCk7CiAgICAgICAgZm9yIChjb25zdCBleHBvcnRlZCBvZiBPYmplY3Qua2V5cyhleHBvcnRzKSkgewogICAgICAgICAgZiA9IGV4cG9ydHNbZXhwb3J0ZWRdOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5zZXQobmFtZXNbaV0sIGYpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgVW5hYmxlIHRvIGltcG9ydCAiJHtzY3JpcHRMb2NhdGlvbn0iYCwgZSk7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfTsKdmFyIHNlYXJjaEZvckNvbXBvbmVudHMgPSAoKSA9PiB7CiAgcmV0dXJuIEFycmF5LmZyb20ocXVlcnlBbGwoInRlbXBsYXRlW2RhdGEtY29tcG9uZW50XSIpKS5maWx0ZXIoKGVsZW0pID0+IGVsZW0gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkubWFwKCh0KSA9PiB7CiAgICBjb25zdCByZXN1bHQgPSB7CiAgICAgIG5hbWU6ICIiLAogICAgICBhdHRyaWJ1dGVzOiBbXQogICAgfTsKICAgIGZvciAoY29uc3QgYXR0cmlidXRlIGluIHQuZGF0YXNldCkgewogICAgICBpZiAoYXR0cmlidXRlID09PSAiY29tcG9uZW50IikgewogICAgICAgIHJlc3VsdC5uYW1lID0gdC5kYXRhc2V0W2F0dHJpYnV0ZV0gPz8gIiI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0LmF0dHJpYnV0ZXMucHVzaChbCiAgICAgICAgICBkZWNhbWVsaXplKGF0dHJpYnV0ZSksCiAgICAgICAgICB0LmRhdGFzZXRbYXR0cmlidXRlXSA/PyAiIgogICAgICAgIF0pOwogICAgICB9CiAgICB9CiAgICBpZiAocmVzdWx0Lm5hbWUgPT09ICIiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICBgQSA8dGVtcGxhdGU+IHdhcyBmb3VuZCB3aXRoIGFuIGludmFsaWQgZGF0YS1jb21wb25lbnQ6ICIke3QuZGF0YXNldC5jb21wb25lbnR9ImAKICAgICAgKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfSkubWFwKCh7IG5hbWUsIGF0dHJpYnV0ZXMgfSkgPT4gewogICAgY29tcG9uZW50KG5hbWUsIHsgYXR0cmlidXRlcyB9KTsKICAgIHJldHVybiBuYW1lOwogIH0pOwp9Owp2YXIgY3JlYXRlQ29tcG9uZW50ID0gKG5hbWUsIHVwZGF0ZSkgPT4gewogIGNvbnN0IGVsZW1lbnQgPSBjcmVhdGUobmFtZSk7CiAgaWYgKCFpc0JvcmVkKGVsZW1lbnQpKSB7CiAgICBjb25zdCBlcnJvciA9IGBUaGUgdGFnIG5hbWUgIiR7bmFtZX0iIGlzIG5vdCBhIEJvcmVET00gIGNvbXBvbmVudC4KICAgICAgCiJjcmVhdGVDb21wb25lbnQiIG9ubHkgYWNjZXB0cyB0YWctbmFtZXMgd2l0aCBtYXRjaGluZyA8dGVtcGxhdGU+IHRhZ3MgdGhhdCBoYXZlIGEgZGF0YS1jb21wb25lbnQgYXR0cmlidXRlIGluIHRoZW0uYDsKICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpOwogICAgdGhyb3cgbmV3IEVycm9yKGVycm9yKTsKICB9CiAgaWYgKHVwZGF0ZSkgewogICAgZWxlbWVudC5yZW5kZXJDYWxsYmFjayA9IHVwZGF0ZTsKICB9CiAgcmV0dXJuIGVsZW1lbnQ7Cn07CnZhciBxdWVyeUNvbXBvbmVudCA9IChxKSA9PiB7CiAgY29uc3QgZWxlbSA9IHF1ZXJ5KHEpOwogIGlmIChlbGVtID09PSBudWxsIHx8ICFpc0JvcmVkKGVsZW0pKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZWxlbTsKfTsKdmFyIHF1ZXJ5ID0gKHF1ZXJ5MikgPT4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihxdWVyeTIpOwp2YXIgcXVlcnlBbGwgPSAocXVlcnkyKSA9PiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHF1ZXJ5Mik7CnZhciBjcmVhdGUgPSAodGFnTmFtZSwgY2hpbGRyZW4pID0+IHsKICBjb25zdCBlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKTsKICBpZiAoY2hpbGRyZW4gJiYgQXJyYXkuaXNBcnJheShjaGlsZHJlbikgJiYgY2hpbGRyZW4ubGVuZ3RoID4gMCkgewogICAgY2hpbGRyZW4ubWFwKChjKSA9PiBlLmFwcGVuZENoaWxkKGMpKTsKICB9CiAgcmV0dXJuIGU7Cn07CnZhciBkaXNwYXRjaCA9IChuYW1lLCBkZXRhaWwpID0+IHsKICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImxvYWRpbmciKSB7CiAgICBhZGRFdmVudExpc3RlbmVyKAogICAgICAiRE9NQ29udGVudExvYWRlZCIsCiAgICAgICgpID0+IGRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KG5hbWUsIHsgZGV0YWlsIH0pKQogICAgKTsKICB9IGVsc2UgewogICAgZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQobmFtZSwgeyBkZXRhaWwgfSkpOwogIH0KfTsKdmFyIGlzT2JqZWN0ID0gKHQpID0+IHR5cGVvZiB0ID09PSAib2JqZWN0IjsKdmFyIGlzRnVuY3Rpb24gPSAodCkgPT4gdHlwZW9mIHQgPT09ICJmdW5jdGlvbiI7CnZhciBpc0JvcmVkID0gKHQpID0+IGlzT2JqZWN0KHQpICYmICJpc0JvcmVkIiBpbiB0ICYmIEJvb2xlYW4odC5pc0JvcmVkKTsKdmFyIGRlY2FtZWxpemUgPSAoc3RyKSA9PiB7CiAgaWYgKHN0ciA9PT0gIiIgfHwgIXN0ci5zcGxpdCgiIikuc29tZSgoY2hhcikgPT4gY2hhciAhPT0gY2hhci50b0xvd2VyQ2FzZSgpKSkgewogICAgcmV0dXJuIHN0cjsKICB9CiAgbGV0IHJlc3VsdCA9ICIiOwogIGZvciAobGV0IGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBjaGFyID0gc3RyW2ldOwogICAgaWYgKGNoYXIgPT09IGNoYXIudG9VcHBlckNhc2UoKSAmJiBpICE9PSAwKSB7CiAgICAgIHJlc3VsdCArPSAiLSI7CiAgICB9CiAgICByZXN1bHQgKz0gY2hhci50b0xvd2VyQ2FzZSgpOwogIH0KICByZXR1cm4gcmVzdWx0Owp9Owp2YXIgaXNTdGFydHNXaXRoT24gPSAocykgPT4gcy5zdGFydHNXaXRoKCJvbiIpOwp2YXIgaXNTdGFydHNXaXRoUXVlcmllZE9uID0gKHMpID0+IHMuc3RhcnRzV2l0aCgicXVlcmllZE9uIik7CnZhciBnZXRFdmVudE5hbWUgPSAocykgPT4gewogIGlmIChpc1N0YXJ0c1dpdGhPbihzKSkgewogICAgcmV0dXJuIHMuc2xpY2UoMikudG9Mb3dlckNhc2UoKTsKICB9CiAgcmV0dXJuIHMuc2xpY2UoOSkudG9Mb3dlckNhc2UoKTsKfTsKdmFyIEJvcmVkID0gY2xhc3MgZXh0ZW5kcyBIVE1MRWxlbWVudCB7Cn07CnZhciBjb21wb25lbnQgPSAodGFnLCBwcm9wcyA9IHt9KSA9PiB7CiAgaWYgKGN1c3RvbUVsZW1lbnRzLmdldCh0YWcpKSByZXR1cm47CiAgY3VzdG9tRWxlbWVudHMuZGVmaW5lKAogICAgdGFnLAogICAgY2xhc3MgZXh0ZW5kcyBCb3JlZCB7CiAgICAgIC8vIFNwZWNpZnkgb2JzZXJ2ZWQgYXR0cmlidXRlcyBzbyB0aGF0CiAgICAgIC8vIGF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayB3aWxsIHdvcmsKICAgICAgc3RhdGljIGdldCBvYnNlcnZlZEF0dHJpYnV0ZXMoKSB7CiAgICAgICAgaWYgKHR5cGVvZiBwcm9wcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMocHJvcHMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHN1cGVyKCk7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIFVzZWZ1bCB0byBrbm93IGlmIGEgZ2l2ZW4gSFRNTEVsZW1lbnQgaXMgYSBCb3JlZCBjb21wb25lbnQuCiAgICAgICAqIEBzZWUgYGlzQm9yZWQoKWAgdHlwZWd1YXJkCiAgICAgICAqLwogICAgICBpc0JvcmVkID0gdHJ1ZTsKICAgICAgdHJhdmVyc2UoZiwgeyB0cmF2ZXJzZVNoYWRvd1Jvb3QsIHF1ZXJ5OiBxdWVyeTIgfSA9IHt9KSB7CiAgICAgICAgQXJyYXkuZnJvbSgKICAgICAgICAgIHRyYXZlcnNlU2hhZG93Um9vdCA/IHRoaXMuc2hhZG93Um9vdD8ucXVlcnlTZWxlY3RvckFsbChxdWVyeTIgPz8gIioiKSA/PyBbXSA6IFtdCiAgICAgICAgKS5jb25jYXQoQXJyYXkuZnJvbSh0aGlzLnF1ZXJ5U2VsZWN0b3JBbGwocXVlcnkyID8/ICIqIikpKS5maWx0ZXIoKG4pID0+IG4gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkuZm9yRWFjaChmKTsKICAgICAgfQogICAgICAvKioKICAgICAgICogUmV0dXJucyB0aGUgbGlzdCBvZiBjdXN0b20gZXZlbnQgbmFtZXMgZnJvbSBhIHN0cmluZyB0aGF0IGlzIHNoYXBlZCBsaWtlOgogICAgICAgKiBgImRpc3BhdGNoKCdldmVudDEnLCAnZXZlbnQyJywgLi4uKSJgCiAgICAgICAqCiAgICAgICAqIFRoaXMgaXMgdXNlZnVsIHdoZW4gdHJhdmVyc2luZyBmb3IgZXZlbnQgaGFuZGxlcnMgdG8gYmUgcmVwbGFjZWQKICAgICAgICogd2l0aCBjdXN0b20gZGlzcGF0Y2hlcnMuCiAgICAgICAqIEByZXR1cm5zIGFuIGFycmF5IG9mIHN0cmluZ3MKICAgICAgICovCiAgICAgIC8qKiBFeHRyYWN0cyBldmVudCBuYW1lcyBmcm9tIHN0cmluZ3MgbGlrZSAiZGlzcGF0Y2goJ2EnLCdiJykiICovCiAgICAgICNwYXJzZUN1c3RvbUV2ZW50TmFtZXMoc3RyKSB7CiAgICAgICAgcmV0dXJuIHN0ci5zcGxpdCgiJyIpLmZpbHRlcigKICAgICAgICAgIChzKSA9PiBzLmxlbmd0aCA+IDIgJiYgIShzLmluY2x1ZGVzKCIoIikgfHwgcy5pbmNsdWRlcygiLCIpIHx8IHMuaW5jbHVkZXMoIikiKSkKICAgICAgICApOwogICAgICB9CiAgICAgIC8qKgogICAgICAgKiBSZXBsYWNlcyBpbmxpbmUgb24qIGF0dHJpYnV0ZXMgd2l0aGluIHRoZSBjb21wb25lbnQgRE9NIHdpdGggcmVhbAogICAgICAgKiBsaXN0ZW5lcnMgdGhhdCBkaXNwYXRjaCBjdXN0b20gZXZlbnRzIHVzaW5nIGRpc3BhdGNoKCkuCiAgICAgICAqLwogICAgICAjY3JlYXRlRGlzcGF0Y2hlcnMoKSB7CiAgICAgICAgbGV0IGhvc3Q7CiAgICAgICAgdGhpcy50cmF2ZXJzZSgobm9kZSkgPT4gewogICAgICAgICAgaWYgKG5vZGUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgewogICAgICAgICAgICBjb25zdCBpc1dlYkNvbXBvbmVudCA9IGN1c3RvbUVsZW1lbnRzLmdldCgKICAgICAgICAgICAgICBub2RlLnRhZ05hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoaXNXZWJDb21wb25lbnQpIGhvc3QgPSBub2RlOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuYXR0cmlidXRlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IG5vZGUuYXR0cmlidXRlc1tpXTsKICAgICAgICAgICAgICBpZiAoaXNTdGFydHNXaXRoT24oYXR0cmlidXRlLm5hbWUpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBldmVudE5hbWVzID0gdGhpcy4jcGFyc2VDdXN0b21FdmVudE5hbWVzKGF0dHJpYnV0ZS52YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoZXZlbnROYW1lcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgIGV2ZW50TmFtZXMuZm9yRWFjaCgoY3VzdG9tRXZlbnROYW1lKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKAogICAgICAgICAgICAgICAgICAgICAgZ2V0RXZlbnROYW1lKGF0dHJpYnV0ZS5uYW1lKSwKICAgICAgICAgICAgICAgICAgICAgIChlKSA9PiBkaXNwYXRjaChjdXN0b21FdmVudE5hbWUsIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6IGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGRpc3BhdGNoZXI6IG5vZGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudDogdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6IHRoaXMucGFyZW50RWxlbWVudCA/IEFycmF5LmZyb20odGhpcy5wYXJlbnRFbGVtZW50LmNoaWxkcmVuKS5pbmRleE9mKAogICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMKICAgICAgICAgICAgICAgICAgICAgICAgKSA6IC0xCiAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoCiAgICAgICAgICAgICAgICAgIGBkYXRhLSR7YXR0cmlidXRlLm5hbWV9LWRpc3BhdGNoZXNgLAogICAgICAgICAgICAgICAgICBldmVudE5hbWVzLmpvaW4oKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZS5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCB7IHRyYXZlcnNlU2hhZG93Um9vdDogdHJ1ZSB9KTsKICAgICAgfQogICAgICBpc0luaXRpYWxpemVkID0gZmFsc2U7CiAgICAgICNpbml0KCkgewogICAgICAgIGxldCB0ZW1wbGF0ZSA9IHF1ZXJ5KGBbZGF0YS1jb21wb25lbnQ9IiR7dGFnfSJdYCkgPz8gY3JlYXRlKCJ0ZW1wbGF0ZSIpOwogICAgICAgIGNvbnN0IGlzVGVtcGxhdGVTaGFkb3dSb290ID0gdGVtcGxhdGUuZ2V0QXR0cmlidXRlKCJzaGFkb3dyb290bW9kZSIpOwogICAgICAgIGNvbnN0IGlzU2hhZG93Um9vdE5lZWRlZCA9IHByb3BzLnN0eWxlIHx8IHByb3BzLnNoYWRvdyB8fCBpc1RlbXBsYXRlU2hhZG93Um9vdDsKICAgICAgICBpZiAoaXNTaGFkb3dSb290TmVlZGVkKSB7CiAgICAgICAgICBjb25zdCBzaGFkb3dSb290TW9kZSA9IHByb3BzLnNoYWRvd3Jvb3Rtb2RlID8/IGlzVGVtcGxhdGVTaGFkb3dSb290ID8/ICJvcGVuIjsKICAgICAgICAgIGNvbnN0IHNoYWRvd1Jvb3QgPSB0aGlzLmF0dGFjaFNoYWRvdyh7IG1vZGU6IHNoYWRvd1Jvb3RNb2RlIH0pOwogICAgICAgICAgaWYgKHByb3BzLnN0eWxlKSB7CiAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gY3JlYXRlKCJzdHlsZSIpOwogICAgICAgICAgICBzdHlsZS50ZXh0Q29udGVudCA9IHByb3BzLnN0eWxlOwogICAgICAgICAgICBzaGFkb3dSb290LmFwcGVuZENoaWxkKHN0eWxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wcy5zaGFkb3cpIHsKICAgICAgICAgICAgY29uc3QgdG1wID0gY3JlYXRlKCJ0ZW1wbGF0ZSIpOwogICAgICAgICAgICB0bXAuaW5uZXJIVE1MID0gcHJvcHMuc2hhZG93OwogICAgICAgICAgICBzaGFkb3dSb290LmFwcGVuZENoaWxkKHRtcC5jb250ZW50LmNsb25lTm9kZSh0cnVlKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGVtcGxhdGVTaGFkb3dSb290KSB7CiAgICAgICAgICAgIHNoYWRvd1Jvb3QuYXBwZW5kQ2hpbGQodGVtcGxhdGUuY29udGVudC5jbG9uZU5vZGUodHJ1ZSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodGVtcGxhdGUgJiYgIWlzVGVtcGxhdGVTaGFkb3dSb290KSB7CiAgICAgICAgICB0aGlzLmFwcGVuZENoaWxkKHRlbXBsYXRlLmNvbnRlbnQuY2xvbmVOb2RlKHRydWUpKTsKICAgICAgICB9CiAgICAgICAgaWYgKHByb3BzLm9uU2xvdENoYW5nZSkgewogICAgICAgICAgdGhpcy50cmF2ZXJzZSgoZWxlbSkgPT4gewogICAgICAgICAgICBpZiAoIShlbGVtIGluc3RhbmNlb2YgSFRNTFNsb3RFbGVtZW50KSkgcmV0dXJuOwogICAgICAgICAgICBlbGVtLmFkZEV2ZW50TGlzdGVuZXIoInNsb3RjaGFuZ2UiLCAoZSkgPT4gcHJvcHMub25TbG90Q2hhbmdlPy4oZSkpOwogICAgICAgICAgfSwgeyB0cmF2ZXJzZVNoYWRvd1Jvb3Q6IHRydWUgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChpc0Z1bmN0aW9uKHByb3BzLm9uQ2xpY2spKSB7CiAgICAgICAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgcHJvcHMub25DbGljayk7CiAgICAgICAgfQogICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHByb3BzKSkgewogICAgICAgICAgaWYgKGlzU3RhcnRzV2l0aE9uKGtleSkpIHsKICAgICAgICAgICAgaWYgKCFpc0Z1bmN0aW9uKHZhbHVlKSkgY29udGludWU7CiAgICAgICAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcihnZXRFdmVudE5hbWUoa2V5KSwgdmFsdWUpOwogICAgICAgICAgfSBlbHNlIGlmIChpc1N0YXJ0c1dpdGhRdWVyaWVkT24oa2V5KSkgewogICAgICAgICAgICBjb25zdCBxdWVyaWVzID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghaXNPYmplY3QocXVlcmllcykpIGNvbnRpbnVlOwogICAgICAgICAgICBjb25zdCBldmVudE5hbWUgPSBnZXRFdmVudE5hbWUoa2V5KTsKICAgICAgICAgICAgZm9yIChjb25zdCBbcXVlcnkyLCBoYW5kbGVyXSBvZiBPYmplY3QuZW50cmllcyhxdWVyaWVzKSkgewogICAgICAgICAgICAgIHRoaXMudHJhdmVyc2UoKG5vZGUpID0+IHsKICAgICAgICAgICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGhhbmRsZXIpOwogICAgICAgICAgICAgIH0sIHsgdHJhdmVyc2VTaGFkb3dSb290OiB0cnVlLCBxdWVyeTogcXVlcnkyIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwcm9wcy5hdHRyaWJ1dGVzICYmIEFycmF5LmlzQXJyYXkocHJvcHMuYXR0cmlidXRlcykpIHsKICAgICAgICAgIHByb3BzLmF0dHJpYnV0ZXMubWFwKAogICAgICAgICAgICAoW2F0dHIsIHZhbHVlXSkgPT4gdGhpcy5zZXRBdHRyaWJ1dGUoYXR0ciwgdmFsdWUpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICB0aGlzLiNjcmVhdGVEaXNwYXRjaGVycygpOwogICAgICAgIHRoaXMuaXNJbml0aWFsaXplZCA9IHRydWU7CiAgICAgIH0KICAgICAgLyoqCiAgICAgICAqIFVzZXItcHJvdmlkZWQgcmVuZGVyZXIgaXMgYXNzaWduZWQgaGVyZSBieSBjcmVhdGVDb21wb25lbnQuCiAgICAgICAqIENhbGxlZCBvbiBjb25uZWN0IGFuZCB3aGVuZXZlciBzdGF0ZSB0cmlnZ2VycyBzdWJzY3JpcHRpb25zLgogICAgICAgKi8KICAgICAgcmVuZGVyQ2FsbGJhY2sgPSAoXykgPT4gewogICAgICB9OwogICAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICBpZiAoIXRoaXMuaXNJbml0aWFsaXplZCkgdGhpcy4jaW5pdCgpOwogICAgICAgIHRoaXMucmVuZGVyQ2FsbGJhY2sodGhpcyk7CiAgICAgICAgcHJvcHMuY29ubmVjdGVkQ2FsbGJhY2s/Lih0aGlzKTsKICAgICAgfQogICAgICBzbG90cyA9IGNyZWF0ZVNsb3RzQWNjZXNzb3IodGhpcyk7CiAgICAgIC8qCiAgICAgICAgICAgICNjcmVhdGVTbG90cygpIHsKICAgICAgICAgICAgICBjb25zdCBzbG90cyA9IEFycmF5LmZyb20odGhpcy5xdWVyeVNlbGVjdG9yQWxsKCJzbG90IikpOwogICAgICAgICAgICAgIGNvbnN0IHdlYkNvbXBvbmVudCA9IHRoaXM7CiAgICAgIAogICAgICAgICAgICAgIHNsb3RzLmZvckVhY2goKHNsb3QpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHNsb3ROYW1lID0gc2xvdC5nZXRBdHRyaWJ1dGUoIm5hbWUiKTsKICAgICAgICAgICAgICAgIGlmICghc2xvdE5hbWUpIHJldHVybjsKICAgICAgCiAgICAgICAgICAgICAgICBjb25zdCBjYW1lbGl6ZWRTbG90TmFtZSA9IGNhbWVsaXplKHNsb3ROYW1lKTsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3ZWJDb21wb25lbnQuc2xvdHMsIGNhbWVsaXplZFNsb3ROYW1lLCB7CiAgICAgICAgICAgICAgICAgIGdldCgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2ViQ29tcG9uZW50LnF1ZXJ5U2VsZWN0b3IoYFtkYXRhLXNsb3Q9IiR7c2xvdE5hbWV9Il1gKTsKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgc2V0KHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGVsZW0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgdmFsdWUuc2V0QXR0cmlidXRlKCJkYXRhLXNsb3QiLCBzbG90TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgICBlbGVtID0gY3JlYXRlKCJzcGFuIik7CiAgICAgICAgICAgICAgICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZSgiZGF0YS1zbG90Iiwgc2xvdE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgZWxlbS5pbm5lclRleHQgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgIAogICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nU2xvdCA9IHRoaXNbY2FtZWxpemVkU2xvdE5hbWVdOwogICAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ1Nsb3QpIHsKICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nU2xvdC5wYXJlbnRFbGVtZW50LnJlcGxhY2VDaGlsZChlbGVtLCBleGlzdGluZ1Nsb3QpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBzbG90LnBhcmVudEVsZW1lbnQ/LnJlcGxhY2VDaGlsZChlbGVtLCBzbG90KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAqLwogICAgICB1cGRhdGVTbG90KHNsb3ROYW1lLCBjb250ZW50LCB3aXRoaW5UYWcpIHsKICAgICAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHdpdGhpblRhZyk7CiAgICAgICAgY29udGFpbmVyLnNldEF0dHJpYnV0ZSgic2xvdCIsIHNsb3ROYW1lKTsKICAgICAgfQogICAgICAvKgogICAgICAgICAgICAjY3JlYXRlUHJvcGVydGllcygpIHsKICAgICAgICAgICAgICBjb25zdCBlbGVtZW50c0ZvdW5kID0gZG9jdW1lbnQuZXZhbHVhdGUoCiAgICAgICAgICAgICAgICAiLy8qW2NvbnRhaW5zKHRleHQoKSwndGhpcy4nKV0iLAogICAgICAgICAgICAgICAgZG9jdW1lbnQsCiAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgWFBhdGhSZXN1bHQuT1JERVJFRF9OT0RFX0lURVJBVE9SX1RZUEUsCiAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICk7CiAgICAgIAogICAgICAgICAgICAgIGxldCBlbGVtZW50ID0gbnVsbDsKICAgICAgICAgICAgICB3aGlsZSAoZWxlbWVudCA9IGVsZW1lbnRzRm91bmQuaXRlcmF0ZU5leHQoKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkZvdW5kICIsIGVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAqLwogICAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICBwcm9wcy5kaXNjb25uZWN0ZWRDYWxsYmFjaz8uKHRoaXMpOwogICAgICB9CiAgICAgIGFkb3B0ZWRDYWxsYmFjaygpIHsKICAgICAgICBwcm9wcy5hZG9wdGVkQ2FsbGJhY2s/Lih0aGlzKTsKICAgICAgfQogICAgICBhdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7CiAgICAgICAgaWYgKCFwcm9wcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2spIHJldHVybjsKICAgICAgICBwcm9wcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2tbbmFtZV0oewogICAgICAgICAgZWxlbWVudDogdGhpcywKICAgICAgICAgIG5hbWUsCiAgICAgICAgICBvbGRWYWx1ZSwKICAgICAgICAgIG5ld1ZhbHVlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICApOwp9Owp2YXIgcmVnaXN0ZXJDb21wb25lbnQgPSAodGFnTmFtZSkgPT4gewogIGNvbXBvbmVudCh0YWdOYW1lLCB7fSk7Cn07CgovLyBzcmMvdXRpbHMvYWNjZXNzLnRzCmZ1bmN0aW9uIGFjY2VzcyhwYXRoLCBvYmopIHsKICBsZXQgcmVzdWx0ID0gb2JqOwogIGlmIChvYmogPT09IG51bGwpIHJldHVybiByZXN1bHQ7CiAgcGF0aC5mb3JFYWNoKChhdHRyaWJ1dGUpID0+IHsKICAgIHJlc3VsdCA9IHJlc3VsdFthdHRyaWJ1dGVdOwogIH0pOwogIHJldHVybiByZXN1bHQ7Cn0KCi8vIHNyYy91dGlscy9mbGF0dGVuLnRzCmZ1bmN0aW9uIGZsYXR0ZW4ob2JqLCBpZ25vcmUgPSBbXSkgewogIGNvbnN0IHN0YWNrID0gW3sKICAgIHBhdGg6IFtdLAogICAgb2JqCiAgfV07CiAgY29uc3QgcmVzdWx0ID0gW107CiAgY29uc3QgdmlzaXRlZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpOwogIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICBjb25zdCB7IHBhdGgsIG9iajogb2JqMiB9ID0gc3RhY2sucG9wKCk7CiAgICBpZiAodmlzaXRlZC5oYXMob2JqMikpIGNvbnRpbnVlOwogICAgdmlzaXRlZC5hZGQob2JqMik7CiAgICBmb3IgKGNvbnN0IGtleSBpbiBvYmoyKSB7CiAgICAgIGlmIChpZ25vcmUuaW5jbHVkZXMoa2V5KSkgY29udGludWU7CiAgICAgIGNvbnN0IHZhbHVlID0gb2JqMltrZXldOwogICAgICBjb25zdCBuZXdQYXRoID0gcGF0aC5jb25jYXQoa2V5KTsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwgJiYgIXZpc2l0ZWQuaGFzKHZhbHVlKSkgewogICAgICAgIHN0YWNrLnB1c2goewogICAgICAgICAgcGF0aDogbmV3UGF0aCwKICAgICAgICAgIG9iajogdmFsdWUKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXN1bHQucHVzaCh7IHBhdGg6IG5ld1BhdGgsIHZhbHVlIH0pOwogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CgovLyBzcmMvdXRpbHMvaXNQb2pvLnRzCmZ1bmN0aW9uIGlzUE9KTyhhcmcpIHsKICBpZiAoYXJnID09IG51bGwgfHwgdHlwZW9mIGFyZyAhPT0gIm9iamVjdCIpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgY29uc3QgcHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoYXJnKTsKICBpZiAocHJvdG8gPT0gbnVsbCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBwcm90byA9PT0gT2JqZWN0LnByb3RvdHlwZTsKfQoKLy8gc3JjL2JvcmUudHMKaW5pdF90eXBlX2luZmVyZW5jZSgpOwpmdW5jdGlvbiBjcmVhdGVFdmVudHNIYW5kbGVyKGMsIGFwcCwgZGV0YWlsKSB7CiAgcmV0dXJuIChldmVudE5hbWUsIGhhbmRsZXIpID0+IHsKICAgIGFkZEV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCAoZXZlbnQpID0+IHsKICAgICAgbGV0IHRhcmdldCA9IGV2ZW50Py5kZXRhaWw/LmV2ZW50LmN1cnJlbnRUYXJnZXQ7CiAgICAgIGxldCBlbWl0ZXJFbGVtID0gdm9pZCAwOwogICAgICB3aGlsZSAodGFyZ2V0KSB7CiAgICAgICAgaWYgKHRhcmdldCA9PT0gYykgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgbWF5YmVQcm9taXNlID0gaGFuZGxlcih7CiAgICAgICAgICAgICAgc3RhdGU6IGFwcCwKICAgICAgICAgICAgICBlOiBldmVudC5kZXRhaWwsCiAgICAgICAgICAgICAgZGV0YWlsCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBQcm9taXNlLnJlc29sdmUobWF5YmVQcm9taXNlKS5jYXRjaCgoZXJyb3IpID0+IHsKICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKAogICAgICAgICAgICAgICAgYEVycm9yIGluIGFzeW5jIGhhbmRsZXIgZm9yICIke2V2ZW50TmFtZX0iIGV2ZW50YCwKICAgICAgICAgICAgICAgIGVycm9yCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBpbiBoYW5kbGVyIGZvciAiJHtldmVudE5hbWV9IiBldmVudGAsIGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHRhcmdldCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7CiAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50RWxlbWVudDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGFyZ2V0ID0gdm9pZCAwOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfTsKfQpmdW5jdGlvbiBjcmVhdGVSZWZzQWNjZXNzb3IoYykgewogIHJldHVybiBuZXcgUHJveHkoe30sIHsKICAgIGdldCh0YXJnZXQsIHByb3AsIHJlY2VpdmVyKSB7CiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKAogICAgICAgIGBSZWYgIiR7U3RyaW5nKHByb3ApfSIgbm90IGZvdW5kIGluIDwke2MudGFnTmFtZX0+YAogICAgICApOwogICAgICBpZiAodHlwZW9mIHByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgY29uc3Qgbm9kZUxpc3QgPSBjLnF1ZXJ5U2VsZWN0b3JBbGwoYFtkYXRhLXJlZj0iJHtwcm9wfSJdYCk7CiAgICAgICAgaWYgKCFub2RlTGlzdCkgdGhyb3cgZXJyb3I7CiAgICAgICAgY29uc3QgcmVmcyA9IEFycmF5LmZyb20obm9kZUxpc3QpLmZpbHRlcigKICAgICAgICAgIChyZWYpID0+IHJlZiBpbnN0YW5jZW9mIEhUTUxFbGVtZW50CiAgICAgICAgKTsKICAgICAgICBpZiAocmVmcy5sZW5ndGggPT09IDApIHRocm93IGVycm9yOwogICAgICAgIGlmIChyZWZzLmxlbmd0aCA9PT0gMSkgcmV0dXJuIHJlZnNbMF07CiAgICAgICAgcmV0dXJuIHJlZnM7CiAgICAgIH0KICAgIH0KICB9KTsKfQpmdW5jdGlvbiBjcmVhdGVTbG90c0FjY2Vzc29yKGMpIHsKICByZXR1cm4gbmV3IFByb3h5KHt9LCB7CiAgICBnZXQodGFyZ2V0LCBwcm9wLCByZWNpZXZlcikgewogICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcigKICAgICAgICBgU2xvdCAiJHtTdHJpbmcocHJvcCl9IiBub3QgZm91bmQgaW4gPCR7Yy50YWdOYW1lfT5gCiAgICAgICk7CiAgICAgIGlmICh0eXBlb2YgcHJvcCA9PT0gInN0cmluZyIpIHsKICAgICAgICBjb25zdCBub2RlTGlzdCA9IGMucXVlcnlTZWxlY3RvckFsbChgc2xvdFtuYW1lPSIke3Byb3B9Il1gKTsKICAgICAgICBpZiAoIW5vZGVMaXN0KSB0aHJvdyBlcnJvcjsKICAgICAgICBjb25zdCByZWZzID0gQXJyYXkuZnJvbShub2RlTGlzdCkuZmlsdGVyKAogICAgICAgICAgKHJlZikgPT4gcmVmIGluc3RhbmNlb2YgSFRNTFNsb3RFbGVtZW50CiAgICAgICAgKTsKICAgICAgICBpZiAocmVmcy5sZW5ndGggPT09IDApIHRocm93IGVycm9yOwogICAgICAgIGlmIChyZWZzLmxlbmd0aCA9PT0gMSkgcmV0dXJuIHJlZnNbMF07CiAgICAgICAgcmV0dXJuIHJlZnM7CiAgICAgIH0KICAgIH0sCiAgICBzZXQodGFyZ2V0LCBwcm9wLCB2YWx1ZSkgewogICAgICBpZiAodHlwZW9mIHByb3AgIT09ICJzdHJpbmciKSByZXR1cm4gZmFsc2U7CiAgICAgIGxldCBlbGVtID0gdmFsdWU7CiAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7CiAgICAgICAgdmFsdWUuc2V0QXR0cmlidXRlKCJkYXRhLXNsb3QiLCBwcm9wKTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgZWxlbSA9IGNyZWF0ZSgic3BhbiIpOwogICAgICAgIGVsZW0uc2V0QXR0cmlidXRlKCJkYXRhLXNsb3QiLCBwcm9wKTsKICAgICAgICBlbGVtLmlubmVyVGV4dCA9IHZhbHVlOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCB2YWx1ZSBmb3Igc2xvdCAke3Byb3B9IGluIDwke2MudGFnTmFtZX0+YCk7CiAgICAgIH0KICAgICAgY29uc3QgZXhpc3RpbmdTbG90cyA9IEFycmF5LmZyb20oCiAgICAgICAgYy5xdWVyeVNlbGVjdG9yQWxsKGBbZGF0YS1zbG90PSIke3Byb3B9Il1gKQogICAgICApOwogICAgICBpZiAoZXhpc3RpbmdTbG90cy5sZW5ndGggPiAwKSB7CiAgICAgICAgZXhpc3RpbmdTbG90cy5mb3JFYWNoKChzKSA9PiBzLnBhcmVudEVsZW1lbnQ/LnJlcGxhY2VDaGlsZChlbGVtLCBzKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc2xvdHMgPSBBcnJheS5mcm9tKGMucXVlcnlTZWxlY3RvckFsbChgc2xvdFtuYW1lPSIke3Byb3B9Il1gKSk7CiAgICAgICAgc2xvdHMuZm9yRWFjaCgocykgPT4gcy5wYXJlbnRFbGVtZW50Py5yZXBsYWNlQ2hpbGQoZWxlbSwgcykpOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIGNyZWF0ZVN0YXRlQWNjZXNzb3Ioc3RhdGUsIGxvZywgYWNjdW0pIHsKICBjb25zdCBjdXJyZW50ID0gYWNjdW0gfHwgeyB0YXJnZXRzOiAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKSwgcGF0aDogW10gfTsKICBpZiAoc3RhdGUgPT09IHZvaWQgMCkgcmV0dXJuIHZvaWQgMDsKICByZXR1cm4gbmV3IFByb3h5KHN0YXRlLCB7CiAgICAvLyBTdGF0ZSBhY2Nlc3NvcnMgYXJlIHJlYWQtb25seToKICAgIHNldCh0YXJnZXQsIHByb3AsIG5ld1ZhbHVlKSB7CiAgICAgIGlmICh0eXBlb2YgcHJvcCA9PT0gInN0cmluZyIpIHsKICAgICAgICBjb25zb2xlLmVycm9yKAogICAgICAgICAgYFN0YXRlIGlzIHJlYWQtb25seSBmb3Igd2ViIGNvbXBvbmVudHMuIFVuYWJsZSB0byBzZXQgJyR7cHJvcH0nLmAKICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICAvLyBSZWN1cnNpdmVseSBidWlsZCBhIHByb3h5IGZvciBlYWNoIHN0YXRlIHByb3AgYmVpbmcgcmVhZDoKICAgIGdldCh0YXJnZXQsIHByb3AsIHJlY2VpdmVyKSB7CiAgICAgIGNvbnN0IHZhbHVlID0gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wLCByZWNlaXZlcik7CiAgICAgIGNvbnN0IGlzUHJvdG8gPSBwcm9wID09PSAiX19wcm90b19fIjsKICAgICAgaWYgKHR5cGVvZiBwcm9wID09PSAic3RyaW5nIiAmJiAhaXNQcm90bykgewogICAgICAgIGlmICghY3VycmVudC50YXJnZXRzLmhhcyh0YXJnZXQpKSB7CiAgICAgICAgICBjdXJyZW50LnRhcmdldHMuc2V0KHRhcmdldCwgY3VycmVudC5wYXRoLmpvaW4oIi4iKSk7CiAgICAgICAgICBjdXJyZW50LnBhdGgucHVzaChwcm9wKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGlzUHJvdG8gfHwgQXJyYXkuaXNBcnJheSh2YWx1ZSkgfHwgaXNQT0pPKHZhbHVlKSkgewogICAgICAgIHJldHVybiBjcmVhdGVTdGF0ZUFjY2Vzc29yKHZhbHVlLCBsb2csIGN1cnJlbnQpOwogICAgICB9CiAgICAgIGxldCBwYXRoID0gY3VycmVudC50YXJnZXRzLmdldCh0YXJnZXQpID8/ICIiOwogICAgICBpZiAodHlwZW9mIHBhdGggPT09ICJzdHJpbmciICYmIHR5cGVvZiBwcm9wID09PSAic3RyaW5nIikgewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHRhcmdldCkpIHsKICAgICAgICAgIHBhdGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBhdGggKz0gcGF0aCAhPT0gIiIgPyBgLiR7cHJvcH1gIDogcHJvcDsKICAgICAgICB9CiAgICAgICAgaWYgKGxvZy5pbmRleE9mKHBhdGgpID09PSAtMSkgewogICAgICAgICAgbG9nLnB1c2gocGF0aCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGN1cnJlbnQucGF0aC5sZW5ndGggPSAwOwogICAgICBjdXJyZW50LnBhdGgucHVzaChwYXRoKTsKICAgICAgaWYgKHR5cGVvZiBfX0RFQlVHX18gPT09ICJ1bmRlZmluZWQiIHx8IF9fREVCVUdfXykgewogICAgICAgIGlmICh0eXBlb2YgcGF0aCA9PT0gInN0cmluZyIgJiYgcGF0aCAhPT0gIiIpIHsKICAgICAgICAgIHRyYWNrU3RhdGVBY2Nlc3MocGF0aCwgdmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gY3JlYXRlU3Vic2NyaWJlcnNEaXNwYXRjaGVyKHN0YXRlKSB7CiAgcmV0dXJuICgpID0+IHsKICAgIGNvbnN0IHVwZGF0ZXMgPSBzdGF0ZS5pbnRlcm5hbC51cGRhdGVzOwogICAgY29uc3Qgbm90aWZpZWQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgY29uc3Qgbm90aWZ5ID0gKGZucykgPT4gewogICAgICBpZiAoIWZucykgcmV0dXJuOwogICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGZucy5sZW5ndGg7IGorKykgewogICAgICAgIGNvbnN0IGZuID0gZm5zW2pdOwogICAgICAgIGlmIChub3RpZmllZC5oYXMoZm4pKSBjb250aW51ZTsKICAgICAgICBub3RpZmllZC5hZGQoZm4pOwogICAgICAgIHRyeSB7CiAgICAgICAgICBmbihzdGF0ZS5hcHApOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB1cGRhdGVzLnBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcGF0aCA9IHVwZGF0ZXMucGF0aFtpXTsKICAgICAgY29uc3QgcmVsYXRpdmVQYXRoID0gcGF0aC5zbGljZShwYXRoLmluZGV4T2YoIi4iKSArIDEpOwogICAgICBub3RpZnkodXBkYXRlcy5zdWJzY3JpYmVycy5nZXQocmVsYXRpdmVQYXRoKSk7CiAgICAgIGZvciAoY29uc3QgW3N1YnNjcmliZXJQYXRoLCBmbnNdIG9mIHVwZGF0ZXMuc3Vic2NyaWJlcnMuZW50cmllcygpKSB7CiAgICAgICAgaWYgKHN1YnNjcmliZXJQYXRoID09PSByZWxhdGl2ZVBhdGgpIGNvbnRpbnVlOwogICAgICAgIGNvbnN0IHN1YnNjcmliZXJXaXRoRG90ID0gYCR7c3Vic2NyaWJlclBhdGh9LmA7CiAgICAgICAgY29uc3QgcmVsYXRpdmVXaXRoRG90ID0gYCR7cmVsYXRpdmVQYXRofS5gOwogICAgICAgIGlmIChyZWxhdGl2ZVBhdGguc3RhcnRzV2l0aChzdWJzY3JpYmVyV2l0aERvdCkgfHwgc3Vic2NyaWJlclBhdGguc3RhcnRzV2l0aChyZWxhdGl2ZVdpdGhEb3QpKSB7CiAgICAgICAgICBub3RpZnkoZm5zKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHVwZGF0ZXMucGF0aCA9IFtdOwogICAgdXBkYXRlcy52YWx1ZSA9IFtdOwogICAgdXBkYXRlcy5yYWYgPSB2b2lkIDA7CiAgfTsKfQpmdW5jdGlvbiBwcm94aWZ5KGJvcmVkb20pIHsKICBjb25zdCBydW50aW1lID0gYm9yZWRvbS5pbnRlcm5hbDsKICBjb25zdCBzdGF0ZSA9IGJvcmVkb207CiAgaWYgKHN0YXRlID09PSB2b2lkIDApIHJldHVybiBib3JlZG9tOwogIGNvbnN0IG9iamVjdHNXaXRoUHJveGllcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpOwogIGNvbnN0IFBST1hZX01BUktFUiA9IFN5bWJvbCgiYm9yZWRvbS1wcm94eSIpOwogIGZ1bmN0aW9uIGNyZWF0ZVJlYWN0aXZlUHJveHkodmFsdWUsIGRvdHRlZFBhdGgpIHsKICAgIGlmIChvYmplY3RzV2l0aFByb3hpZXMuaGFzKHZhbHVlKSkgcmV0dXJuIHZhbHVlOwogICAgY29uc3QgcHJveHkgPSBuZXcgUHJveHkodmFsdWUsIHsKICAgICAgZ2V0KHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpIHsKICAgICAgICBpZiAocHJvcCA9PT0gUFJPWFlfTUFSS0VSKSByZXR1cm4gdHJ1ZTsKICAgICAgICByZXR1cm4gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wLCByZWNlaXZlcik7CiAgICAgIH0sCiAgICAgIHNldCh0YXJnZXQsIHByb3AsIG5ld1ZhbHVlKSB7CiAgICAgICAgY29uc3QgaXNDaGFuZ2VkID0gdGFyZ2V0W3Byb3BdICE9PSBuZXdWYWx1ZTsKICAgICAgICBpZiAoIWlzQ2hhbmdlZCkgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKHR5cGVvZiBwcm9wID09PSAic3RyaW5nIikgewogICAgICAgICAgY29uc3QgbmV3UGF0aCA9IEFycmF5LmlzQXJyYXkodmFsdWUpID8gZG90dGVkUGF0aCA6IGAke2RvdHRlZFBhdGh9LiR7cHJvcH1gOwogICAgICAgICAgY29uc3QgaXNBbHJlYWR5UHJveHkgPSBuZXdWYWx1ZSAmJiBuZXdWYWx1ZVtQUk9YWV9NQVJLRVJdID09PSB0cnVlOwogICAgICAgICAgaWYgKCFpc0FscmVhZHlQcm94eSAmJiAoQXJyYXkuaXNBcnJheShuZXdWYWx1ZSkgfHwgaXNQT0pPKG5ld1ZhbHVlKSkpIHsKICAgICAgICAgICAgbmV3VmFsdWUgPSBwcm94aWZ5VmFsdWUobmV3VmFsdWUsIG5ld1BhdGgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBSZWZsZWN0LnNldCh0YXJnZXQsIHByb3AsIG5ld1ZhbHVlKTsKICAgICAgICBpZiAodHlwZW9mIHByb3AgIT09ICJzdHJpbmciKSByZXR1cm4gdHJ1ZTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIHJ1bnRpbWUudXBkYXRlcy5wYXRoLnB1c2goYCR7ZG90dGVkUGF0aH1gKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcnVudGltZS51cGRhdGVzLnBhdGgucHVzaChgJHtkb3R0ZWRQYXRofS4ke3Byb3B9YCk7CiAgICAgICAgfQogICAgICAgIHJ1bnRpbWUudXBkYXRlcy52YWx1ZS5wdXNoKHRhcmdldCk7CiAgICAgICAgaWYgKCFydW50aW1lLnVwZGF0ZXMucmFmKSB7CiAgICAgICAgICBydW50aW1lLnVwZGF0ZXMucmFmID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKAogICAgICAgICAgICBjcmVhdGVTdWJzY3JpYmVyc0Rpc3BhdGNoZXIoYm9yZWRvbSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9KTsKICAgIG9iamVjdHNXaXRoUHJveGllcy5hZGQodmFsdWUpOwogICAgb2JqZWN0c1dpdGhQcm94aWVzLmFkZChwcm94eSk7CiAgICByZXR1cm4gcHJveHk7CiAgfQogIGZ1bmN0aW9uIHByb3hpZnlWYWx1ZSh2YWx1ZSwgYmFzZVBhdGgpIHsKICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgIWlzUE9KTyh2YWx1ZSkpIHJldHVybiB2YWx1ZTsKICAgIGlmIChvYmplY3RzV2l0aFByb3hpZXMuaGFzKHZhbHVlKSkgcmV0dXJuIHZhbHVlOwogICAgaWYgKHZhbHVlICYmIHZhbHVlW1BST1hZX01BUktFUl0gPT09IHRydWUpIHJldHVybiB2YWx1ZTsKICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgaXRlbSA9IHZhbHVlW2ldOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGl0ZW0pIHx8IGlzUE9KTyhpdGVtKSkgewogICAgICAgICAgdmFsdWVbaV0gPSBwcm94aWZ5VmFsdWUoaXRlbSwgYmFzZVBhdGgpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXModmFsdWUpKSB7CiAgICAgICAgY29uc3QgaXRlbSA9IHZhbHVlW2tleV07CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkgfHwgaXNQT0pPKGl0ZW0pKSB7CiAgICAgICAgICB2YWx1ZVtrZXldID0gcHJveGlmeVZhbHVlKGl0ZW0sIGAke2Jhc2VQYXRofS4ke2tleX1gKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjcmVhdGVSZWFjdGl2ZVByb3h5KHZhbHVlLCBiYXNlUGF0aCk7CiAgfQogIGZsYXR0ZW4oYm9yZWRvbSwgWyJpbnRlcm5hbCJdKS5mb3JFYWNoKCh7IHBhdGgsIHZhbHVlIH0pID0+IHsKICAgIGNvbnN0IG5lZWRzUHJveHkgPSBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCBpc1BPSk8odmFsdWUpICYmICFvYmplY3RzV2l0aFByb3hpZXMuaGFzKHZhbHVlKTsKICAgIGlmIChuZWVkc1Byb3h5KSB7CiAgICAgIGNvbnN0IGRvdHRlZFBhdGggPSBwYXRoLmpvaW4oIi4iKTsKICAgICAgY29uc3QgcGFyZW50ID0gYWNjZXNzKHBhdGguc2xpY2UoMCwgLTEpLCBzdGF0ZSk7CiAgICAgIGNvbnN0IGlzUm9vdCA9IHBhcmVudCA9PT0gdmFsdWU7CiAgICAgIGlmIChpc1Jvb3QpIHJldHVybjsKICAgICAgcGFyZW50W3BhdGguYXQoLTEpXSA9IGNyZWF0ZVJlYWN0aXZlUHJveHkodmFsdWUsIGRvdHRlZFBhdGgpOwogICAgfQogIH0pOwogIHJldHVybiBib3JlZG9tOwp9CmZ1bmN0aW9uIHJ1bkNvbXBvbmVudHNJbml0aWFsaXplcihzdGF0ZSkgewogIGNvbnN0IHRhZ3NJbkRvbSA9IHN0YXRlLmludGVybmFsLmN1c3RvbVRhZ3MuZmlsdGVyKAogICAgKHRhZykgPT4gKAogICAgICAvLyBBIHRhZyBpcyBjb25zaWRlcmVkIHByZXNlbnQgaWYgYXQgbGVhc3Qgb25lIGluc3RhbmNlIGV4aXN0cyBpbiB0aGUgRE9NCiAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodGFnKSAhPT0gbnVsbAogICAgKQogICk7CiAgY29uc3QgY29tcG9uZW50cyA9IHN0YXRlLmludGVybmFsLmNvbXBvbmVudHM7CiAgZm9yIChjb25zdCBbdGFnTmFtZSwgY29kZV0gb2YgY29tcG9uZW50cy5lbnRyaWVzKCkpIHsKICAgIGlmIChjb2RlID09PSBudWxsIHx8ICF0YWdzSW5Eb20uaW5jbHVkZXModGFnTmFtZSkpIGNvbnRpbnVlOwogICAgY29uc3QgZWxlbWVudHMgPSBBcnJheS5mcm9tKAogICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHRhZ05hbWUpCiAgICApLmZpbHRlcigoZWwpID0+IGlzQm9yZWQoZWwpKTsKICAgIGlmIChlbGVtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgY29udGludWU7CiAgICB9CiAgICBlbGVtZW50cy5mb3JFYWNoKChjb21wb25lbnRDbGFzcywgaW5kZXgpID0+IHsKICAgICAgY29kZShzdGF0ZSwgeyBpbmRleCwgbmFtZTogdGFnTmFtZSwgZGF0YTogdm9pZCAwIH0pKAogICAgICAgIGNvbXBvbmVudENsYXNzCiAgICAgICk7CiAgICB9KTsKICB9CiAgcmV0dXJuOwp9CmZ1bmN0aW9uIGNyZWF0ZUFuZFJ1bkNvZGUobmFtZSwgc3RhdGUsIGRldGFpbCkgewogIGNvbnN0IGNvZGUgPSBzdGF0ZS5pbnRlcm5hbC5jb21wb25lbnRzLmdldChuYW1lKTsKICBpZiAoY29kZSkgewogICAgY29uc3QgaW5mbyA9IHsgLi4uZGV0YWlsLCB0YWdOYW1lOiBuYW1lIH07CiAgICByZXR1cm4gY3JlYXRlQ29tcG9uZW50KG5hbWUsIGNvZGUoc3RhdGUsIGluZm8pKTsKICB9CiAgcmV0dXJuIGNyZWF0ZUNvbXBvbmVudChuYW1lKTsKfQoKLy8gc3JjL2luZGV4LnRzCmluaXRfZGVidWcoKTsKaW5pdF9jb25zb2xlX2FwaSgpOwppbml0X2luc2lkZV9vdXQoKTsKaW5pdF9sbG0oKTsKaW5pdF9kZWJ1ZygpOwppbml0X3ZlcnNpb24oKTsKaW5pdF92ZXJzaW9uKCk7CnZhciBoYXNMb2dnZWRWZXJzaW9uID0gZmFsc2U7CnZhciBib3JlRE9NID0gewogIC8qKiBNYXAgb2YgYWxsIGN1cnJlbnQgZXJyb3JzIGJ5IGNvbXBvbmVudCBuYW1lICovCiAgZ2V0IGVycm9ycygpIHsKICAgIHJldHVybiBkZWJ1Z0FQSS5lcnJvcnM7CiAgfSwKICAvKiogTW9zdCByZWNlbnQgZXJyb3IgY29udGV4dCAqLwogIGdldCBsYXN0RXJyb3IoKSB7CiAgICByZXR1cm4gZGVidWdBUEkubGFzdEVycm9yOwogIH0sCiAgLyoqIFJlLXJlbmRlciBhIHNwZWNpZmljIGNvbXBvbmVudCBvciB0aGUgbGFzdCBlcnJvcmVkIG9uZSAqLwogIHJlcmVuZGVyOiBkZWJ1Z0FQSS5yZXJlbmRlciwKICAvKiogQ2xlYXIgZXJyb3Igc3RhdGUgZm9yIGEgY29tcG9uZW50ICovCiAgY2xlYXJFcnJvcjogZGVidWdBUEkuY2xlYXJFcnJvciwKICAvKiogRXhwb3J0IHN0YXRlIHNuYXBzaG90ICovCiAgZXhwb3J0OiBkZWJ1Z0FQSS5leHBvcnQsCiAgLyoqIEN1cnJlbnQgZGVidWcgY29uZmlndXJhdGlvbiAocmVhZC1vbmx5KSAqLwogIGdldCBjb25maWcoKSB7CiAgICByZXR1cm4gZGVidWdBUEkuY29uZmlnOwogIH0sCiAgLyoqIEBpbnRlcm5hbCBTZXQgZGVidWcgY29uZmlndXJhdGlvbiAodXNlZCBieSB0ZXN0cyB3aXRoIG11bHRpcGxlIGJ1bmRsZXMpICovCiAgX3NldERlYnVnQ29uZmlnOiBzZXREZWJ1Z0NvbmZpZywKICAvKiogRnJhbWV3b3JrIHZlcnNpb24gKi8KICB2ZXJzaW9uOiBWRVJTSU9OLAogIC8vIENvbnNvbGUgQVBJIChQaGFzZSAyKQogIC8qKiBEZWZpbmUgYSBuZXcgY29tcG9uZW50IGF0IHJ1bnRpbWUgKi8KICBkZWZpbmU6IGNvbnNvbGVBUEkuZGVmaW5lLAogIC8qKiBHZXQgbGl2ZSBhY2Nlc3MgdG8gYSBjb21wb25lbnQncyBpbnRlcm5hbHMgKi8KICBvcGVyYXRlOiBjb25zb2xlQVBJLm9wZXJhdGUsCiAgLyoqIEV4cG9ydCBjb21wb25lbnQgc3RhdGUgYW5kIHRlbXBsYXRlICovCiAgZXhwb3J0Q29tcG9uZW50OiBjb25zb2xlQVBJLmV4cG9ydENvbXBvbmVudCwKICAvLyBJbnNpZGUtT3V0IEFQSSAoUGhhc2UgMykKICAvKiogTWFwIG9mIG1pc3NpbmcgZnVuY3Rpb24gY2FsbHMgYnkgZnVuY3Rpb24gbmFtZSAqLwogIGdldCBtaXNzaW5nRnVuY3Rpb25zKCkgewogICAgcmV0dXJuIGluc2lkZU91dEFQSS5taXNzaW5nRnVuY3Rpb25zOwogIH0sCiAgLyoqIE1vc3QgcmVjZW50IG1pc3NpbmcgZnVuY3Rpb24gY29udGV4dCAqLwogIGdldCBsYXN0TWlzc2luZygpIHsKICAgIHJldHVybiBpbnNpZGVPdXRBUEkubGFzdE1pc3Npbmc7CiAgfSwKICAvKiogRGVmaW5lIGEgaGVscGVyIGZ1bmN0aW9uIGF2YWlsYWJsZSB0byBhbGwgcmVuZGVyIGZ1bmN0aW9ucyAqLwogIGRlZmluZUhlbHBlcjogaW5zaWRlT3V0QVBJLmRlZmluZUhlbHBlciwKICAvKiogR2V0IGFsbCBkZWZpbmVkIGhlbHBlcnMgKi8KICBnZXQgaGVscGVycygpIHsKICAgIHJldHVybiBpbnNpZGVPdXRBUEkuaGVscGVyczsKICB9LAogIC8qKiBDbGVhciBhIGhlbHBlciBkZWZpbml0aW9uICovCiAgY2xlYXJIZWxwZXI6IGluc2lkZU91dEFQSS5jbGVhckhlbHBlciwKICAvKiogQ2xlYXIgYWxsIG1pc3NpbmcgZnVuY3Rpb24gcmVjb3JkcyAqLwogIGNsZWFyTWlzc2luZ0Z1bmN0aW9uczogaW5zaWRlT3V0QVBJLmNsZWFyTWlzc2luZ0Z1bmN0aW9ucywKICAvKiogTWFwIG9mIGluZmVycmVkIHRlbXBsYXRlcyBieSB0YWcgbmFtZSAqLwogIGdldCBpbmZlcnJlZFRlbXBsYXRlcygpIHsKICAgIHJldHVybiBpbnNpZGVPdXRBUEkuaW5mZXJyZWRUZW1wbGF0ZXM7CiAgfSwKICAvKiogTWFudWFsbHkgaW5mZXIgdGVtcGxhdGUgZm9yIGEgdGFnICovCiAgaW5mZXJUZW1wbGF0ZTogaW5zaWRlT3V0QVBJLmluZmVyVGVtcGxhdGUsCiAgLy8gTExNIEludGVncmF0aW9uIEFQSSAoUGhhc2UgNCkKICAvKiogTExNIGNvbnRleHQgYW5kIG91dHB1dCB1dGlsaXRpZXMgKi8KICBsbG06IGxsbUFQSQp9OwppZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIpIHsKICB3aW5kb3cuYm9yZURPTSA9IGJvcmVET007Cn0KYXN5bmMgZnVuY3Rpb24gaW5mbGljdEJvcmVET00oc3RhdGUsIGNvbXBvbmVudHNMb2dpYywgY29uZmlnKSB7CiAgaWYgKGNvbmZpZz8uZGVidWcgIT09IHZvaWQgMCkgewogICAgc2V0RGVidWdDb25maWcoY29uZmlnLmRlYnVnKTsKICB9CiAgaWYgKCFoYXNMb2dnZWRWZXJzaW9uICYmIGlzRGVidWdFbmFibGVkKCJ2ZXJzaW9uTG9nIikpIHsKICAgIGhhc0xvZ2dlZFZlcnNpb24gPSB0cnVlOwogICAgaWYgKHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgY29uc29sZS5pbmZvID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGNvbnNvbGUuaW5mbyhgW2JvcmVET01dIHYke1ZFUlNJT059YCk7CiAgICB9CiAgfQogIGNvbnN0IHJlZ2lzdGVyZWROYW1lcyA9IHNlYXJjaEZvckNvbXBvbmVudHMoKTsKICBjb25zdCBjb21wb25lbnRzQ29kZSA9IGF3YWl0IGR5bmFtaWNJbXBvcnRTY3JpcHRzKHJlZ2lzdGVyZWROYW1lcyk7CiAgaWYgKGNvbXBvbmVudHNMb2dpYykgewogICAgZm9yIChjb25zdCB0YWdOYW1lIG9mIE9iamVjdC5rZXlzKGNvbXBvbmVudHNMb2dpYykpIHsKICAgICAgY29tcG9uZW50c0NvZGUuc2V0KHRhZ05hbWUsIGNvbXBvbmVudHNMb2dpY1t0YWdOYW1lXSk7CiAgICB9CiAgfQogIGNvbnN0IGluaXRpYWxTdGF0ZSA9IHsKICAgIGFwcDogc3RhdGUsCiAgICBpbnRlcm5hbDogewogICAgICBjdXN0b21UYWdzOiByZWdpc3RlcmVkTmFtZXMsCiAgICAgIGNvbXBvbmVudHM6IGNvbXBvbmVudHNDb2RlLAogICAgICB1cGRhdGVzOiB7CiAgICAgICAgcGF0aDogW10sCiAgICAgICAgdmFsdWU6IFtdLAogICAgICAgIHJhZjogdm9pZCAwLAogICAgICAgIHN1YnNjcmliZXJzOiAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpCiAgICAgIH0KICAgIH0KICB9OwogIGNvbnN0IHByb3hpZmllZFN0YXRlID0gcHJveGlmeShpbml0aWFsU3RhdGUpOwogIHByb3hpZmllZFN0YXRlLmludGVybmFsLnVwZGF0ZXMucGF0aCA9IFtdOwogIHByb3hpZmllZFN0YXRlLmludGVybmFsLnVwZGF0ZXMudmFsdWUgPSBbXTsKICBpZiAocHJveGlmaWVkU3RhdGUuaW50ZXJuYWwudXBkYXRlcy5yYWYpIHsKICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHByb3hpZmllZFN0YXRlLmludGVybmFsLnVwZGF0ZXMucmFmKTsKICAgIHByb3hpZmllZFN0YXRlLmludGVybmFsLnVwZGF0ZXMucmFmID0gdm9pZCAwOwogIH0KICBzZXRDdXJyZW50QXBwU3RhdGUocHJveGlmaWVkU3RhdGUsIHdlYkNvbXBvbmVudCwgcmVnaXN0ZXJDb21wb25lbnQpOwogIHNldFZhbGlkYXRpb25BcHBTdGF0ZShwcm94aWZpZWRTdGF0ZSk7CiAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5ib3JlRE9NPy5sbG0/Ll9zZXRWYWxpZGF0aW9uQXBwU3RhdGUpIHsKICAgIHdpbmRvdy5ib3JlRE9NLmxsbS5fc2V0VmFsaWRhdGlvbkFwcFN0YXRlKHByb3hpZmllZFN0YXRlKTsKICB9CiAgcnVuQ29tcG9uZW50c0luaXRpYWxpemVyKHByb3hpZmllZFN0YXRlKTsKICBvYnNlcnZlVW5kZWZpbmVkRWxlbWVudHMoKTsKICByZXR1cm4gcHJveGlmaWVkU3RhdGUuYXBwOwp9CmZ1bmN0aW9uIHdlYkNvbXBvbmVudChpbml0RnVuY3Rpb24pIHsKICBsZXQgaXNJbml0aWFsaXplZCA9IG51bGw7CiAgbGV0IHJlbmRlckZ1bmN0aW9uOwogIGNvbnN0IHJlc3VsdCA9IChhcHBTdGF0ZSwgZGV0YWlsKSA9PiAoYykgPT4gewogICAgY29uc3QgeyBpbnRlcm5hbCwgYXBwIH0gPSBhcHBTdGF0ZTsKICAgIGxldCBsb2cgPSBbXTsKICAgIGNvbnN0IHN0YXRlID0gY3JlYXRlU3RhdGVBY2Nlc3NvcihhcHAsIGxvZyk7CiAgICBjb25zdCByZWZzID0gY3JlYXRlUmVmc0FjY2Vzc29yKGMpOwogICAgY29uc3Qgc2xvdHMgPSBjcmVhdGVTbG90c0FjY2Vzc29yKGMpOwogICAgY29uc3Qgb24gPSBjcmVhdGVFdmVudHNIYW5kbGVyKGMsIGFwcCwgZGV0YWlsKTsKICAgIGlmIChpc0luaXRpYWxpemVkICE9PSBjKSB7CiAgICAgIGNvbnN0IHVwZGF0ZVN1YnNjcmliZXJzID0gYXN5bmMgKCkgPT4gewogICAgICAgIGNvbnN0IHN1YnNjcmliZXJzID0gaW50ZXJuYWwudXBkYXRlcy5zdWJzY3JpYmVyczsKICAgICAgICBmb3IgKGxldCBwYXRoIG9mIGxvZykgewogICAgICAgICAgY29uc3QgZnVuY3Rpb25zID0gc3Vic2NyaWJlcnMuZ2V0KHBhdGgpOwogICAgICAgICAgaWYgKGZ1bmN0aW9ucykgewogICAgICAgICAgICBpZiAoIWZ1bmN0aW9ucy5pbmNsdWRlcyhyZW5kZXJGdW5jdGlvbikpIHsKICAgICAgICAgICAgICBmdW5jdGlvbnMucHVzaChyZW5kZXJGdW5jdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN1YnNjcmliZXJzLnNldChwYXRoLCBbcmVuZGVyRnVuY3Rpb25dKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIGxldCB1c2VyRGVmaW5lZFJlbmRlcmVyOwogICAgICB0cnkgewogICAgICAgIHVzZXJEZWZpbmVkUmVuZGVyZXIgPSBpbml0RnVuY3Rpb24oewogICAgICAgICAgZGV0YWlsLAogICAgICAgICAgc3RhdGUsCiAgICAgICAgICByZWZzLAogICAgICAgICAgb24sCiAgICAgICAgICBzZWxmOiBjCiAgICAgICAgfSk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgY29uc3QgZXJyID0gZXJyb3I7CiAgICAgICAgaWYgKGlzRGVidWdFbmFibGVkKCJjb25zb2xlIikpIHsKICAgICAgICAgIGxvZ0luaXRFcnJvcihkZXRhaWw/Lm5hbWUgPz8gYy50YWdOYW1lLnRvTG93ZXJDYXNlKCksIGVycik7CiAgICAgICAgfQogICAgICAgIHVzZXJEZWZpbmVkUmVuZGVyZXIgPSAoKSA9PiB7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZW5kZXJGdW5jdGlvbiA9IChyZW5kZXJTdGF0ZSkgPT4gewogICAgICAgIGNvbnN0IGNvbXBvbmVudE5hbWUgPSBkZXRhaWw/Lm5hbWUgPz8gYy50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgY29uc3QgaGVscGVycyA9IGNyZWF0ZVJlbmRlckhlbHBlcnMoCiAgICAgICAgICBjb21wb25lbnROYW1lLAogICAgICAgICAgYywKICAgICAgICAgICgpID0+IHJlbmRlckZ1bmN0aW9uKHJlbmRlclN0YXRlKQogICAgICAgICk7CiAgICAgICAgaWYgKGlzRGVidWdFbmFibGVkKCJlcnJvckJvdW5kYXJ5IikpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHVzZXJEZWZpbmVkUmVuZGVyZXIoewogICAgICAgICAgICAgIHN0YXRlOiByZW5kZXJTdGF0ZSwKICAgICAgICAgICAgICByZWZzLAogICAgICAgICAgICAgIHNsb3RzLAogICAgICAgICAgICAgIHNlbGY6IGMsCiAgICAgICAgICAgICAgZGV0YWlsLAogICAgICAgICAgICAgIG1ha2VDb21wb25lbnQ6ICh0YWcsIG9wdHMpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVBbmRSdW5Db2RlKHRhZywgYXBwU3RhdGUsIG9wdHM/LmRldGFpbCk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBoZWxwZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB1cGRhdGVTdWJzY3JpYmVycygpOwogICAgICAgICAgICBjbGVhckNvbXBvbmVudEVycm9yTWFyayhjKTsKICAgICAgICAgICAgY2xlYXJFcnJvcihjb21wb25lbnROYW1lKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGNvbnN0IGVyciA9IGVycm9yOwogICAgICAgICAgICBjb25zdCBjdHggPSB7CiAgICAgICAgICAgICAgY29tcG9uZW50OiBjb21wb25lbnROYW1lLAogICAgICAgICAgICAgIGVsZW1lbnQ6IGMsCiAgICAgICAgICAgICAgZXJyb3I6IGVyciwKICAgICAgICAgICAgICBzdGF0ZTogYXBwLAogICAgICAgICAgICAgIC8vIFdyaXRlIHByb3h5IC0gTVVUQUJMRQogICAgICAgICAgICAgIHJlZnMsCiAgICAgICAgICAgICAgc2xvdHMsCiAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLAogICAgICAgICAgICAgIHJlcmVuZGVyOiAoKSA9PiByZW5kZXJGdW5jdGlvbihyZW5kZXJTdGF0ZSksCiAgICAgICAgICAgICAgc3RhY2s6IGVyci5zdGFjayA/PyAiIgogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoaXNEZWJ1Z0VuYWJsZWQoImNvbnNvbGUiKSkgewogICAgICAgICAgICAgIGxvZ0Vycm9yKGN0eCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbG9nRXJyb3JNaW5pbWFsKGNvbXBvbmVudE5hbWUsIGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXhwb3NlR2xvYmFscyhjdHgpOwogICAgICAgICAgICBzdG9yZUVycm9yKGN0eCk7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRFcnJvcihjKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdXNlckRlZmluZWRSZW5kZXJlcih7CiAgICAgICAgICAgIHN0YXRlOiByZW5kZXJTdGF0ZSwKICAgICAgICAgICAgcmVmcywKICAgICAgICAgICAgc2xvdHMsCiAgICAgICAgICAgIHNlbGY6IGMsCiAgICAgICAgICAgIGRldGFpbCwKICAgICAgICAgICAgbWFrZUNvbXBvbmVudDogKHRhZywgb3B0cykgPT4gewogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVBbmRSdW5Db2RlKHRhZywgYXBwU3RhdGUsIG9wdHM/LmRldGFpbCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGhlbHBlcnMKICAgICAgICAgIH0pOwogICAgICAgICAgdXBkYXRlU3Vic2NyaWJlcnMoKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHN0b3JlQ29tcG9uZW50Q29udGV4dChjLCB7CiAgICAgICAgc3RhdGU6IGFwcCwKICAgICAgICByZWZzLAogICAgICAgIHNsb3RzLAogICAgICAgIHNlbGY6IGMsCiAgICAgICAgZGV0YWlsLAogICAgICAgIHJlcmVuZGVyOiAoKSA9PiByZW5kZXJGdW5jdGlvbihhcHApCiAgICAgIH0pOwogICAgfQogICAgcmVuZGVyRnVuY3Rpb24oc3RhdGUpOwogICAgaXNJbml0aWFsaXplZCA9IGM7CiAgfTsKICByZXN1bHRbV0VCX0NPTVBPTkVOVF9NQVJLRVJdID0gdHJ1ZTsKICByZXR1cm4gcmVzdWx0Owp9CmV4cG9ydCB7CiAgVkVSU0lPTiwKICBib3JlRE9NLAogIGNsZWFyR2xvYmFscywKICBnZXREZWJ1Z0NvbmZpZywKICBpbmZsaWN0Qm9yZURPTSwKICBpc0RlYnVnRW5hYmxlZCwKICBxdWVyeUNvbXBvbmVudCwKICByZWdpc3RlckNvbXBvbmVudCwKICBzZXREZWJ1Z0NvbmZpZywKICB3ZWJDb21wb25lbnQKfTsK
`;
var beautify = import_js_beautify.default.html;
var DEFAULT_COMPONENTS_DIR = "components";
var DEFAULT_STATIC_DIR = "src";
var DEFAULT_STATIC_SERVE = "";
var BUILD_DIR = "build";
var serverStarted = false;
var numberOfRefreshes = 0;
function collectMultiValue(value, previous) {
  const next = Array.isArray(previous) ? [...previous] : [];
  next.push(value);
  return next;
}
console.log("## boreDOM CLI options");
console.log(
  "## ",
  "--index <path to default html>",
  "The base HTML file to serve",
  "defaults to ./index.html"
);
console.log(
  "## ",
  "--html <folder>",
  "Folder containing HTML component files",
  'defaults to "./components"'
);
console.log(
  "## ",
  "--static <folder>",
  "Static files folder, all files in here are copied as is",
  'defaults to "./src"'
);
console.log(
  "## ",
  "--static-serve <folder>",
  "Build subfolder used to serve static assets",
  'defaults to "./"'
);
import_commander.program.option("--index <path to file>", "Index file to serve", "index.html").option(
  "--html <folder>",
  "Folder containing HTML component files",
  DEFAULT_COMPONENTS_DIR
).option(
  "--static <folder>",
  "Folder containing static files to be copied as is",
  collectMultiValue,
  [DEFAULT_STATIC_DIR]
).option(
  "--components-serve <folder>",
  "Build subfolder used to serve processed components",
  DEFAULT_COMPONENTS_DIR
).option(
  "--static-serve <folder>",
  "Build subfolder used to serve static assets",
  DEFAULT_STATIC_SERVE
);
var isTestMode = Boolean(process.env.BOREDOM_CLI_TEST_MODE);
if (isTestMode) {
  import_commander.program.parse([], { from: "user" });
} else {
  import_commander.program.parse(process.argv);
}
var options = import_commander.program.opts();
function sanitizeServeInput(value) {
  const normalizedSlashes = value.replace(/\\+/g, "/").trim();
  if (!normalizedSlashes) {
    return { fsPath: "", urlPath: "" };
  }
  if (["/", "./"].includes(normalizedSlashes)) {
    return { fsPath: "", urlPath: "/" };
  }
  let working = normalizedSlashes;
  while (working.startsWith("./")) {
    working = working.slice(2);
  }
  const isAbsolute = working.startsWith("/");
  if (isAbsolute) {
    working = working.replace(/^\/+/, "");
  }
  working = working.replace(/\/+$/, "");
  const fsPath = working;
  if (!fsPath) {
    return { fsPath: "", urlPath: isAbsolute ? "/" : "" };
  }
  const urlPath = isAbsolute ? `/${fsPath}` : fsPath;
  return { fsPath, urlPath };
}
function normalizeServePath(input, fallback) {
  if (typeof input === "undefined" || input === null) {
    return sanitizeServeInput(fallback);
  }
  const trimmed = String(input).trim();
  if (!trimmed) {
    return sanitizeServeInput(fallback);
  }
  return sanitizeServeInput(trimmed);
}
function buildRelativeServePath(base, ...segments) {
  const cleanSegments = segments.filter(Boolean).map((segment) => {
    return segment.replace(/^\/+/, "").replace(/\/+$/, "");
  });
  const ensureModuleRelative = (candidate) => {
    if (!candidate) {
      return candidate;
    }
    if (candidate.startsWith("/") || candidate.startsWith("./") || candidate.startsWith("../")) {
      return candidate;
    }
    return `./${candidate}`;
  };
  if (!base || base === ".") {
    return ensureModuleRelative(cleanSegments.join("/"));
  }
  if (base === "/") {
    const joined = cleanSegments.join("/");
    return joined ? `/${joined}` : "/";
  }
  const cleanBase = base.replace(/\/+$/, "");
  return ensureModuleRelative([cleanBase, ...cleanSegments].join("/"));
}
var componentsServePath;
var staticServePath;
var componentsServeUrlPath;
var staticServeUrlPath;
function setServePaths(currentOptions = options) {
  const componentsPaths = normalizeServePath(
    currentOptions.componentsServe,
    "components"
  );
  const staticPaths = normalizeServePath(
    currentOptions.staticServe,
    DEFAULT_STATIC_SERVE
  );
  componentsServePath = componentsPaths.fsPath;
  componentsServeUrlPath = componentsPaths.urlPath;
  staticServePath = staticPaths.fsPath;
  staticServeUrlPath = staticPaths.urlPath;
  return {
    componentsServePath,
    componentsServeUrlPath,
    staticServePath,
    staticServeUrlPath
  };
}
function getServePaths() {
  return {
    componentsServePath,
    componentsServeUrlPath,
    staticServePath,
    staticServeUrlPath
  };
}
setServePaths();
async function copyStatic() {
  const staticFolders = Array.isArray(options.static) ? options.static : [options.static].filter(Boolean);
  if (staticFolders.length === 0) {
    return;
  }
  for (const folder of staticFolders) {
    const staticDir = import_path.default.resolve(folder);
    if (await import_fs_extra.default.pathExists(staticDir)) {
      await import_fs_extra.default.copy(staticDir, import_path.default.join(BUILD_DIR, staticServePath), {
        overwrite: true,
        errorOnExist: false
      });
      console.log(`Static folder copied from ${folder}.`);
    }
  }
}
async function copyBoreDOM() {
  return import_fs_extra.default.writeFile(import_path.default.join(BUILD_DIR, "boreDOM.js"), atob(boredom));
}
async function processComponents() {
  let components = {};
  if (options.html) {
    const htmlFolder = import_path.default.resolve(options.html);
    const htmlFiles = glob.sync("**/*.html", { cwd: htmlFolder });
    for (const file of htmlFiles) {
      const filePath = import_path.default.join(htmlFolder, file);
      const content = await import_fs_extra.default.readFile(filePath, "utf-8");
      const $ = cheerio.load(content, { decodeEntities: false });
      const template = $("template[data-component]");
      if (template.length) {
        const componentName = template.attr("data-component");
        const fullTemplate = $.html(template);
        const componentBuildDir = import_path.default.join(
          BUILD_DIR,
          componentsServePath,
          componentName
        );
        await import_fs_extra.default.ensureDir(componentBuildDir);
        const destHtmlPath = import_path.default.join(
          componentBuildDir,
          `${componentName}.html`
        );
        await import_fs_extra.default.copy(filePath, destHtmlPath);
        const componentDir = import_path.default.dirname(filePath);
        const jsMatch = glob.sync(`**/${componentName}.js`, {
          cwd: componentDir
        });
        const cssMatch = glob.sync(`**/${componentName}.css`, {
          cwd: componentDir
        });
        const hasJS = jsMatch.length > 0;
        if (jsMatch.length > 0) {
          const jsSrc = import_path.default.join(componentDir, jsMatch[0]);
          const destJsPath = import_path.default.join(
            componentBuildDir,
            `${componentName}.js`
          );
          await import_fs_extra.default.copy(jsSrc, destJsPath);
          console.log(`Copied ${componentName}.js to ${componentBuildDir}`);
        }
        const hasCSS = cssMatch.length > 0;
        if (cssMatch.length > 0) {
          const cssSrc = import_path.default.join(componentDir, cssMatch[0]);
          const destCssPath = import_path.default.join(
            componentBuildDir,
            `${componentName}.css`
          );
          await import_fs_extra.default.copy(cssSrc, destCssPath);
          console.log(`Copied ${componentName}.css to ${componentBuildDir}`);
        }
        components[componentName] = {
          templateTag: fullTemplate,
          hasJS,
          hasCSS
        };
      }
    }
  }
  return components;
}
async function updateIndex(components) {
  console.log(
    "Updated index.html with components:\n\n",
    JSON.stringify(components, null, 2)
  );
  const indexPath = import_path.default.resolve(options.index);
  let indexContent = await import_fs_extra.default.readFile(indexPath, "utf-8");
  const $ = cheerio.load(indexContent, { decodeEntities: false });
  $("head").prepend(
    `
  <script type="importmap">{ "imports": {      "@mr_hugo/boredom/dist/boreDOM.full.js": "./boreDOM.js",
       "boredom": "./boreDOM.js"
     } }</script>`
  );
  $("body").append(`
  <script src="boreDOM.js" type="module"></script>`);
  Object.keys(components).forEach((component) => {
    const componentScriptPath = buildRelativeServePath(
      componentsServeUrlPath,
      component,
      `${component}.js`
    );
    const existingComponentScript = $(`script[src*="${component}.js"]`).first();
    const componentCssPath = buildRelativeServePath(
      componentsServeUrlPath,
      component,
      `${component}.css`
    );
    if (components[component].hasJS) {
      if (existingComponentScript.length > 0) {
        existingComponentScript.attr("src", componentScriptPath);
        existingComponentScript.attr("type", "module");
      } else if ($(`script[src="${componentScriptPath}"]`).length === 0) {
        $("body").append(
          `
  <script src="${componentScriptPath}" type="module"></script>`
        );
      }
    }
    if (components[component].hasCSS) {
      const existingComponentStylesheet = $(`link[href*="${component}.css"]`).first();
      if (existingComponentStylesheet.length > 0) {
        existingComponentStylesheet.attr("href", componentCssPath);
      } else if ($(`link[href="${componentCssPath}"]`).length === 0) {
        $("head").append(
          `
  <link rel="stylesheet" href="${componentCssPath}">`
        );
      }
    }
    if ($(`template[data-component="${component}"]`).length === 0) {
      const templateMarkup = `
  ${components[component].templateTag}`;
      const firstScript = $("body > script").first();
      if (firstScript.length > 0) {
        firstScript.before(templateMarkup);
      } else {
        $("body").prepend(templateMarkup);
      }
      console.log(`Injected template for ${component}`);
    }
  });
  $("template[data-component]").each((i, el) => {
    const comp = $(el).attr("data-component");
    if (!components[comp]) {
      $(el).remove();
      console.log(`Removed unused template for ${comp}`);
    }
  });
  const prettyHtml = beautify($.html(), {
    indent_size: 2,
    space_in_empty_paren: true
  });
  const buildIndex = import_path.default.join(BUILD_DIR, "index.html");
  await import_fs_extra.default.outputFile(buildIndex, prettyHtml);
  console.log("Index updated with pretty printed HTML.");
}
async function startServer() {
  if (serverStarted) return;
  function serveFile(req, res, opts) {
    let urlPath = decodeURIComponent(req.url.split(/[?#]/)[0]);
    if (urlPath === "/" || urlPath.endsWith("/")) {
      urlPath = import_path.default.posix.join(urlPath, "index.html");
    }
    const filePath = import_path.default.join(BUILD_DIR, urlPath);
    import_fs_extra.default.pathExists(filePath).then((exists) => {
      if (!exists) {
        res.writeHead(404, { "Content-Type": "text/plain" });
        return res.end("Not Found");
      }
      const contentType = import_mime_types.default.lookup(filePath) || "application/octet-stream";
      res.writeHead(200, { "Content-Type": contentType });
      import_fs_extra.default.createReadStream(filePath).pipe(res);
    }).catch((err) => {
      res.writeHead(500, { "Content-Type": "text/plain" });
      res.end("Internal Server Error");
    });
  }
  const server = import_http.default.createServer((req, res) => {
    return serveFile(req, res, {
      cleanUrls: true,
      public: import_path.default.resolve(BUILD_DIR)
    });
  });
  let port = process.env.PORT || 8080;
  const serverHandler = () => {
    const { port: actualPort } = server.address();
    console.log(`Server running at http://localhost:${actualPort}`);
  };
  server.listen(port, serverHandler);
  server.on("error", (e) => {
    if (e.code === "EADDRINUSE") {
      console.log(
        "\x1B[33m%s\x1B[0m",
        `\u26A0\uFE0F Warning: Port ${port} in use, starting with a OS assigned port.`
      );
      setTimeout(() => {
        server.close();
        server.listen(0);
      }, 1e3);
    }
  });
  serverStarted = true;
}
async function build() {
  await import_fs_extra.default.remove(BUILD_DIR);
  await import_fs_extra.default.ensureDir(BUILD_DIR);
  await copyStatic();
  await copyBoreDOM();
  const components = await processComponents();
  await updateIndex(components);
}
async function watchFiles() {
  const pathsToWatch = [];
  if (options.index) {
    pathsToWatch.push(import_path.default.resolve(options.index));
  }
  if (options.html) {
    pathsToWatch.push(import_path.default.resolve(options.html));
  }
  const staticFolders = Array.isArray(options.static) ? options.static : [options.static].filter(Boolean);
  for (const folder of staticFolders) {
    const staticDir = import_path.default.resolve(folder);
    if (await import_fs_extra.default.pathExists(staticDir)) {
      pathsToWatch.push(staticDir);
    }
  }
  console.log("Watching for file changes in:", pathsToWatch);
  const watcher = import_chokidar.default.watch(pathsToWatch, { ignoreInitial: true });
  let rebuildTimeout;
  watcher.on("all", (event, filePath) => {
    console.log(`Detected ${event} on ${filePath}. Scheduling rebuild...`);
    if (rebuildTimeout) clearTimeout(rebuildTimeout);
    rebuildTimeout = setTimeout(() => {
      build().then(() => {
        console.log(
          `#${++numberOfRefreshes} - ${(/* @__PURE__ */ new Date()).toISOString()} - Build refreshed.`
        );
      }).catch((err) => console.error("Error during rebuild:", err));
    }, 100);
  });
}
async function main() {
  console.log("The file used as the base for HTML is:", options.index);
  const indexPath = import_path.default.join(process.cwd(), options.index);
  import_fs_extra.default.ensureFile(indexPath, (err) => {
    if (err) {
      console.log(
        "\x1B[31m%s\x1B[0m",
        `\u274C Error: The file "${indexPath}" was not found.
Please specify a location for it with "--index"`
      );
      process.exit(1);
    }
  });
  await build();
  startServer();
  await watchFiles();
}
if (!isTestMode) {
  main().catch((err) => {
    console.error(err);
    process.exit(1);
  });
}
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  BUILD_DIR,
  build,
  buildRelativeServePath,
  copyBoreDOM,
  getServePaths,
  normalizeServePath,
  options,
  processComponents,
  setServePaths,
  updateIndex
});
