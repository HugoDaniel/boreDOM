<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>boreDOM MCP Test App</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
    }
    .card {
      border: 1px solid #ddd;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 8px;
    }
    button {
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      cursor: pointer;
    }
    .status {
      padding: 0.5rem;
      background: #f0f0f0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9rem;
    }
    .connected { background: #d4edda; color: #155724; }
    .disconnected { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>boreDOM MCP Test App</h1>

  <div class="card">
    <h3>Bridge Status</h3>
    <div id="bridge-status" class="status disconnected">Checking...</div>
  </div>

  <section class="card">
    <h3>Counter Component</h3>
    <my-counter></my-counter>
  </section>

  <section class="card">
    <h3>User List</h3>
    <user-list></user-list>
  </section>

  <section class="card">
    <h3>Dynamic Components</h3>
    <div id="dynamic-area"></div>
  </section>

  <!-- Templates -->
  <template data-component="my-counter">
    <p>Count: <strong data-slot="count">0</strong></p>
    <button onclick="dispatch('decrement')">-</button>
    <button onclick="dispatch('increment')">+</button>
    <button onclick="dispatch('reset')">Reset</button>
  </template>

  <template data-component="user-list">
    <div data-ref="container">
      <p>Users: <span data-slot="userCount">0</span></p>
      <ul data-ref="list"></ul>
      <button onclick="dispatch('addUser')">Add User</button>
    </div>
  </template>

  <!-- Load boreDOM from local build -->
  <script src="../../dist/boreDOM.full.js"></script>

  <!-- Load bridge script -->
  <script src="http://localhost:3117/bridge.js"></script>

  <script>
    // Initialize boreDOM
    inflictBoreDOM(
      {
        count: 0,
        users: [
          { id: 1, name: "Alice", email: "alice@example.com" },
          { id: 2, name: "Bob", email: "bob@example.com" }
        ],
        theme: "light",
        lastAction: null
      },
      {
        "my-counter": webComponent(({ on }) => {
          on("increment", ({ state }) => {
            state.count++;
            state.lastAction = "increment";
          });
          on("decrement", ({ state }) => {
            state.count--;
            state.lastAction = "decrement";
          });
          on("reset", ({ state }) => {
            state.count = 0;
            state.lastAction = "reset";
          });

          return ({ state, slots }) => {
            slots.count = String(state.count);
          };
        }),

        "user-list": webComponent(({ on, refs }) => {
          on("addUser", ({ state }) => {
            const id = state.users.length + 1;
            state.users.push({
              id,
              name: `User ${id}`,
              email: `user${id}@example.com`
            });
            state.lastAction = "addUser";
          });

          return ({ state, slots, refs }) => {
            slots.userCount = String(state.users.length);

            if (refs.list) {
              refs.list.innerHTML = state.users
                .map(u => `<li>${u.name} (${u.email})</li>`)
                .join("");
            }
          };
        })
      }
    ).then(() => {
      console.log("[Test App] boreDOM initialized");
      updateBridgeStatus();
    });

    // Update bridge status display
    function updateBridgeStatus() {
      const statusEl = document.getElementById("bridge-status");
      if (window.boredomBridge) {
        const status = boredomBridge.getStatus();
        if (status.connected) {
          statusEl.textContent = "Connected to MCP server";
          statusEl.className = "status connected";
        } else {
          statusEl.textContent = `Disconnected (attempts: ${status.reconnectAttempts})`;
          statusEl.className = "status disconnected";
        }
      } else {
        statusEl.textContent = "Bridge not loaded";
        statusEl.className = "status disconnected";
      }
    }

    // Check status periodically
    setInterval(updateBridgeStatus, 2000);
  </script>
</body>
</html>
